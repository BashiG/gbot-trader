(function(){function cb(a,b){for(var c=-1,d=b.length>>>0;++c<d;)if(a===b[c])return!0;return!1}var a,b,c,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,aa,ba,ca,da,ea,fa,ga,ha,ia,ja,ka,la,ma,na,oa,pa,qa,ra,sa,ta,ua,va,wa,xa,ya,za,Aa,Ba,Ca,Da,Ea,Fa,Ga,Ha,Ia,Ja,Ka,La,Ma,Na,Oa,Pa,Qa,Ra,Sa,Ta,Ua,Va,Wa,Xa,Ya,Za,$a,_a,ab,bb;if(a=require("./conf"),b=require("async"),c=require("lodash"),require("colors"),e=require("ms"),f=require("moment"),g=require("moment-range"),h=require("nodemailer"),i=require("btce-deal"),j=require("node-telegram-bot-api"),k=require("ta-lib"),f=g.extendMoment(f),!a.tokenTelegram)return void console.log("There is no token Telegram!".red);l=new i.Public(a.host),m=new i.Trade(a.key,a.secret,a.host),n=new j(a.tokenTelegram,{polling:!0}),o=function(b,c){b.length>4096&&(b="Слишком много информации для отображения"),n.sendMessage(a.myChatId,b,c)},p=h.createTransport(a.email),q=function(a,b){return p.sendMail(a,b)},r=function(){return a.tradeCurrency.pair.replace("_","/").toUpperCase()},s=function(b){return{from:a.email.auth.user,to:a.email.reportEmail,subject:"Error Script Trader",text:"time: "+(new Date).toString()+"\nPair: "+r()+"\n\nmessage: "+b+"\n\n---"}},t=function(){return(new Date).toLocaleTimeString("en-US",{timeZone:a.timeZone,hour12:!1})},u=function(){return Math.round((new Date).getTime()/1e3)},v=!0,w=null,x={name:0,nameTwo:0},y=u(),z=u(),A=u(),B=a.timeUpdateAutoSettings,C=!0,D=!1,E=0,F={all:null,buy:null,sell:null},G={extra:0,buy:0,sell:0},H=0,I=0,J=0,K={buy:0,sell:0},L=!1,M=0,N=0,O=0,P=0,Q=[],R=[],S="all",T=!1,U={ask:0,bid:0},V="normal",W=0,X=0,Y=0,Z=0,$=0,_=!1,aa=!1,ba=null!=(ca=a.notificationPair)?ca.toLowerCase().replace(/\//g,"_").split(/\s*,\s*/):void 0,da={spread:!1,eco:!1},ea={status:!1,interval:!1},fa={status:!1,interval:!1},ga={btc:"฿",usd:"$",eur:"€",rur:"₽",ltc:"L"},ha="-----------------------------------",ia=function(a,b){return u()-a>=60*b},ja=function(a,b){var c,d,e;return null!=b&&(c=b),c||(c=a>=1?["минута","минуты","минут"]:["секунда","секунды","секунд"],a=a<1?60*a:a),d=[2,0,1,1,1,2],e=c[a%100>4&&a%100<20?2:d[a%10<5?a%10:5]],a+" "+e},ka=function(a,b){return null==b&&(b=3),+(+a).toFixed(b)},la=function(a,b){return b>0?+(100*a/b).toFixed(1):0},ma=function(a,b){return null==b&&(b=W),ka(a/+("1e"+b),b)},na=function(a,b){return null==b&&(b=W),ka(a*+("1e"+b),b)},oa=function(a,b,c){var d,e,f;return null==b&&(b=0),null==c&&(c=W),d=a/100*Y*2,e=Math.ceil(d*+("1e"+c))/+("1e"+c),f=e*(1+b/100),ka(f,c)},pa=function(a,b){return ka(a/100*(100+b),W)},qa=function(a,b){return ka(100*a/(100+b),W)},ra=function(a,b){return a/b*(1-Y/100)},sa=function(a,b){return a*b*(1-Y/100)},ta=function(){a.bbands&&P>0&&(R.push(P),R.length>30&&R.splice(0,1))},ua=function(a,b){var c,d,e;return null==b&&(b=1),b=a<.001?1:b,c=a.toString().split(".")[0],d=a.toString().split(".")[1].length,e=c>0?c>1e4?+("1e"+(d+1)):c>1e3?+("1e"+d):c>100?+("1e"+(d-1)):c>10?+("1e"+(d-2)):d>3?+("1e"+(d-3)):1:1,b*=e,ka(b/+("1e"+d),d)},va=function(b,d,e){var f,g,h,i,j,l,m,n,p,q,s,w,x,y,J,K,L,M,ba,ca,da,ea,fa,ga,ia,ja,ma,ra,sa,ta,va,wa,xa,ya;if(A=u(),F={buy:null,sell:null},f=b.toString().length,g=d.toString().length,i={},i[f+""]=b,i[g+""]=d,h=i,j=Math.max(f,g),l=h[j],W=Pa.pairs[a.tradeCurrency.pair].decimal_places,Z=Pa.pairs[a.tradeCurrency.pair].min_amount,X=Pa.pairs[a.tradeCurrency.pair].min_price,Y=Pa.pairs[a.tradeCurrency.pair].fee,m=ka(b-d,W),n=oa(l,200),a.dynamicSettingsTime&&(Q.push(e),Q.length>50&&Q.splice(0,1),p=c.max(Q),q=c.min(Q),a.botLog&&console.log([ha,"price-array:","length: "+Q.length,"max: "+p,"min: "+q,"change-time-settings: "+(la(p,q)>102)].join("\n")),la(p,q)>102?B=.1:B!==a.timeUpdateAutoSettings&&(B=a.timeUpdateAutoSettings)),a.abruptChangeTrend&&(s=oa(l,500)),a.dangerPriceStop&&(w=pa(O,9),x=qa(N,9)),a.dynamicOffsetOrders&&(y={current:oa(l,450),prev:oa(l,380),prev_2:oa(l,300)},J=m>=y.current||m>=y.prev||m>=y.prev_2),a.dynamicOffsetOrders&&J?(console.log("["+t()+"]: Dynamic market"),K=na(y.current),L=1.3*K,M=1.5*a.stepBreakevenPercentConfig):(K=a.offsetMaxOneConfig,L=a.offsetMaxTwoConfig,M=a.stepBreakevenPercentConfig),H=oa(l,M),a.botLog&&(console.log(ha),console.log("current-spread:",(m+"")[m>H?"green":"white"]),console.log("spread-min-default:",H),console.log("trend-spread:",n),a.abruptChangeTrend&&console.log("immediate-spread:",s),console.log("trader-speed:",V),console.log("price-prev:",O+" - "+N),console.log("price-prev2:",U.ask+" - "+U.bid),a.dangerPriceStop&&(console.log("danger-price-ask:",w,!C&&b>=w?"Attention!".red:""),console.log("danger-price-bid:",x,!C&&d<=x?"Attention!".red:"")),a.dynamicOffsetOrders&&(console.log("spread_1_450:",y.current,m>=y.current?"Attention!".red:""),console.log("spread_2_380:",y.prev,m>=y.prev?"Attention!".red:""),console.log("spread_3_300:",y.prev_2,m>=y.prev_2?"Attention!".red:""),console.log("dynamic-market:",J))),a.dangerPriceStop&&!C&&(b>=w||d<=x))return b>=w&&(F.buy=1),z=0,D=!0,ba="DANGER PRICE: "+b+" - "+d+" | Bot Pause!",console.log("["+t()+"]: "+ba),void o(ba+"");ca=2,da=E>Math.round($/2)?L:K,a.botLog&&(console.log("offset-max-one:",(K+"")[K===a.offsetMaxOneConfig?"green":"yellow"]),console.log("offset-type-max:",da),console.log(ha)),_||(S="all",T=!1),C?ea=fa=da:a.bbands?(ea=fa=da,H=0,B=.1,ga=14,R.length>2*ga&&(i=k.BBANDS(R,20,a.bbandsDeviation),ia=i.middleband,ja=i.lowband,ma=i.highband,ra=k.RSI(c.clone(R).reverse(),ga),sa=k.average(ra).mean,ta=k.average(ia).mean,va=k.average(ma).mean,wa=k.average(ja).mean,xa=va>e&&e>ta,ya=ta>e&&e>wa,xa&&(S="sell"),ya&&(S="buy"),v=99>sa&&sa>68||1<sa&&sa<33,aa=xa&&ya,a.botLog&&console.log(["BBANDS:","highband: "+va,"middleband: "+ta,"lowband: "+wa,"rsa: "+sa,"sell: "+xa,"buy: "+ya,"bot trade: "+v,"orders-calculation-brake: "+aa,ha].join("\n")))):a.trendDefinition&&d>N&&b>O&&m>n&&"normal"===V?(console.log("["+t()+"]: Trend: UP"),ea=ca,fa=da,_||(S="buy",F.sell=1,z=0,a.abruptChangeTrend&&m>s&&(console.log("["+t()+"]: Spread Immediate"),T=!0,A=0))):a.trendDefinition&&d<N&&b<O&&m>n&&"normal"===V?(console.log("["+t()+"]: Trend: DOWN"),ea=da,fa=ca,_||(S="sell",F.buy=1,z=0,a.abruptChangeTrend&&m>s&&(console.log("["+t()+"]: Spread Immediate"),T=!0,A=0))):ea=fa=da,U={ask:O,bid:N},N=d,O=b,P=e,I=oa(l),G={buy:ua(l,ea),sell:ua(l,fa),extra:ua(l)},Na(),console.log("["+t()+"]: Update: "+S.toUpperCase()+" | "+b+" - "+d+" | "+e+" | "+r())},wa=function(a,b){var c,d;return c="name"===b?x.name:x.nameTwo,d=ka(a-ka(c,2),8),d>0?d:0},xa=function(c,d){return C?b.parallel([function(b){return a.botLog&&console.log(ha+"\nПолучение цен"),l.getTicker(c).then(function(a){return b(null,{price:a[c].buy})}).catch(function(a){return b(a)})},function(d){return b.series([function(b){return a.botLog&&console.log(ha+"\nЗакрытие всех позиций"),F.all=1,Ya(c,function(a){return b(null!=a?a:null)})},function(b){return a.botLog&&console.log(ha+"\nПолучение баланса"),Ua(a.tradeCurrency,function(c,d,e){return c?b(c):a.botTrade&&d<.1&&e<("btc"===a.tradeCurrency.nameTwo?.01:.1)?b({error:"Err: No money!"}):b(null,{balance:d,balanceTwo:e})})}],function(a,b){return a?d(a):d(null,{balance:b[1].balance,balanceTwo:b[1].balanceTwo})})}],function(b,c){var e,f,g,h,i,j,k,l,m,n;return b?d(b):(a.botLog&&console.log(ha+"\nРасчет депозита"),a.depositPercent=0<(e=a.depositPercent)&&e<=100?a.depositPercent:100,f=ka(c[1].balanceTwo/c[0].price+c[1].balance),g=ka(f*a.depositPercent/100),h=ka(c[1].balance*c[0].price+c[1].balanceTwo),i=ka(h*a.depositPercent/100),ka(c[1].balance)>=g&&ka(c[1].balanceTwo)>=i?(a.botLog&&console.log("type:",1),j=c[1].balance-g/2,k=c[1].balanceTwo-i/2):ka(c[1].balance)>=g&&ka(c[1].balanceTwo)<i?(a.botLog&&console.log("type:",2),j=c[1].balance-(i-c[1].balanceTwo)/c[0].price,k=0):ka(c[1].balance)<g&&ka(c[1].balanceTwo)>=i?(a.botLog&&console.log("type:",3),j=0,k=c[1].balanceTwo-(g-c[1].balance)*c[0].price):(a.botLog&&console.log("type:",4),j=0,k=0),a.botLog&&(l=la(j,c[1].balance),m=la(k,c[1].balanceTwo),console.log(["reserved-deposit:",a.tradeCurrency.name.toUpperCase(),l+"% / "+m+"%",a.tradeCurrency.nameTwo.toUpperCase()].join(" "))),x={name:j>0?j:0,nameTwo:k>0?k:0},a.countOrders?a.countOrders>=6||(a.countOrders=6):a.countOrders=g<=200?15:g<=500?18:g<=1e3?21:25,n=g>6?a.countOrders:Math.round(a.countOrders/2),$=n*a.multiplierOrdersExtra,J=(e=ka(g/n))>Z?e:Z,a.botLog&&console.log([ha+"\nРасчет переменных","balance: "+ka(c[1].balance)+" "+a.tradeCurrency.name.toUpperCase(),"balance-two: "+ka(c[1].balanceTwo)+" "+ga[a.tradeCurrency.nameTwo],"deposit: "+f+" "+a.tradeCurrency.name.toUpperCase()+" или "+h+" "+a.tradeCurrency.nameTwo.toUpperCase(),"percent-deposit: "+a.depositPercent+" %","trade-deposit: "+g+" "+a.tradeCurrency.name.toUpperCase()+" | "+i+" "+a.tradeCurrency.nameTwo.toUpperCase(),"reserved-deposit: "+ka(x.name)+" "+a.tradeCurrency.name.toUpperCase()+" | "+ka(x.nameTwo)+" "+a.tradeCurrency.nameTwo.toUpperCase(),"count-orders: "+n,"size-static-order: "+J,ha].join("\n")),d(null))}):d(null)},n.on("message",function(d){var f,g,h,i,j,k,l,p,q,s,t;if(f=d.chat.id,a.myChatId||n.sendMessage(f,"Install your Telegram id: "+f),f===a.myChatId&&("Ордера"===d.text&&(g=function(){b.series([function(b){return Ua(a.tradeCurrency,function(a,c,d){return a?b(a):b(null,{balance:c,balanceTwo:d})})},function(b){return Ta(a.tradeCurrency.pair,function(a,c){return a?b(a):b(null,{data:c})})}],function(b,d){var e,f,h,i,j,k,l,n,p,q,s;e=[r()+":",ha],f="Balance: "+(null!=(h=d[0])?h.balance.toFixed(3):void 0)+" "+a.tradeCurrency.name.toUpperCase()+" | "+ga[a.tradeCurrency.nameTwo]+(null!=(i=d[0])?i.balanceTwo.toFixed(3):void 0),b?0===b.success?(j=null!=(k=b.error)?k.split("send:")[1]:void 0,null!=j?(m.nonce=j,g()):(e.push(b.error+"\n"+ha+"\n"+f),o(e.join("\n")))):o(b):(l={},n=0,p=0,q={},Object.keys(d[1].data).forEach(function(b){var c,e,f;c=d[1].data[b].rate*+("1e"+W),null!=q[c]?(++l[c],e=" | "+l[c],f=ka(ka(q[c].split("|")[1].trim())+ka(d[1].data[b].amount)),q[c]=d[1].data[b].type+" | "+f+" | "+ga[a.tradeCurrency.nameTwo]+d[1].data[b].rate+e):(l[c]=1,q[c]=d[1].data[b].type+" | "+ka(d[1].data[b].amount)+" | "+ga[a.tradeCurrency.nameTwo]+d[1].data[b].rate),n+=d[1].data[b].amount,p+=d[1].data[b].amount*d[1].data[b].rate}),e=c.concat(e,c.values(q)),e.push(ha+"\nCount: "+ka(n)+" | Sum: "+ga[a.tradeCurrency.nameTwo]+ka(p)+"\n"+f),s=e.join("\n"),o(s))})})(),"История"===d.text&&(h=function(){m.getTradeHistory({pair:a.tradeCurrency.pair,count:10}).then(function(b){var c;return c=[],Object.keys(b).forEach(function(d){c.push(b[d].type+" | "+b[d].amount.toFixed(3)+" | "+ga[a.tradeCurrency.nameTwo]+b[d].rate)}),c.push(r()+":\n"+ha),c.reverse(),o(c.join("\n"))}).catch(function(a){var b,c;0===a.success?(b=null!=(c=a.error)?c.split("send:")[1]:void 0,null!=b?(m.nonce=b,h()):o(a.error)):o(a)})})(),"Закрыть активные ордера"===d.text&&(i=function(){D=!0,F.all=1,setTimeout(function(){Ya(a.tradeCurrency.pair,function(a){var b,c;a?0===a.success&&(b=null!=(c=a.error)?c.split("send:")[1]:void 0,null!=b?(m.nonce=b,i()):o(a.error)):o("Активные ордера закрыты на паре: "+r()),D=!1})},e("2s"))})(),"/config"===(null!=(j=d.text)?j.toLowerCase():void 0)&&(k=["Бот на паре "+r(),"TIME_UPDATE_AUTO_SETTINGS: "+B+" | время обновления авто настроек параметров (в мин)","DEPOSIT_LIMIT: "+a.depositPercent+" | процент использования депозита","NOTIFICATION_PAIR: "+a.notificationPair+" | пары для уведомления","NOTIFICATION_DEVIATION_PERCENT: "+a.notificationDeviation+" | процент отклонения от текущей цены чтобы сработало уведомление","COUNT_ORDERS: "+a.countOrders+" | количество ордеров","TIME_CLOSE_ORDERS: "+a.timeCloseOrdersDefault+" | сколько минут ждать перед закрытием неисполнившихся ордеров","TIME_CLOSE_ORDERS_INACTIVITY: "+a.timeCloseOrdersInactivity+" | закрытие после бездействия","OFFSET_MAX_ONE: "+a.offsetMaxOneConfig+" | отступ для 1 типа ордеров","OFFSET_MAX_TWO: "+a.offsetMaxTwoConfig+" | отступ для 2 типа ордеров","STEP_BREAKEVEN_PERCENT: "+a.stepBreakevenPercentConfig+" | процент отступа безубытка для торгов","DANGER_PRICE_STOP: "+a.dangerPriceStop+" | остановка бота при большом изменении цены","DYNAMIC_SETTINGS_TIME: "+a.dynamicSettingsTime+" | динамическое время обновления настроек","DYNAMIC_OFFSET_ORDERS: "+a.dynamicOffsetOrders+" | динамическое распределение ордеров","TREND_DEFINITION: "+a.trendDefinition+" | определение тренда","ABRUPT_CHANGE_TREND: "+a.abruptChangeTrend+" | быстрое изменение направления тренда","BBANDS: "+a.bbands+" | полосы Боллинджера","BBANDS_DEVIATION: "+a.bbandsDeviation+" | Отклонение","BBANDS_INTERVAL: "+a.bbandsInterval+" | Таймфрейм (в мин)"],o(k.join("\n\n"))),"/version"===(null!=(l=d.text)?l.toLowerCase():void 0)&&o("Версия бота: "+a.versionBot),a.masterWorker))return"/start"!==(p=null!=(q=d.text)?q.toLowerCase():void 0)&&"главное меню"!==p||(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({keyboard:[[{text:"Ордера"},{text:"Котировки"},{text:"История"}],[{text:"Контроль"},{text:"Нотис"},{text:"Торговля"}],[{text:"Закрыть активные ордера"}]],resize_keyboard:!0})},o("Выберите:",s)),"Котировки"===d.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({keyboard:[[{text:"USD"},{text:"BTC"},{text:"OTHER"}],[{text:"Главное меню"}]],resize_keyboard:!0})},o("Валюта:",s)),"Торговля"===d.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({keyboard:[[{text:"Сменить пару"},{text:"Тип"}],[{text:"Главное меню"}]],resize_keyboard:!0})},o("Выберите:",s)),"USD"===d.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"NMC",callback_data:"nmc_usd"},{text:"PPC",callback_data:"ppc_usd"},{text:"NVC",callback_data:"nvc_usd"},{text:"LTC",callback_data:"ltc_usd"},{text:"BTC",callback_data:"btc_usd"}],[{text:"DSH",callback_data:"dsh_usd"},{text:"ETH",callback_data:"eth_usd"},{text:"EUR",callback_data:"eur_usd"},{text:"RUR",callback_data:"usd_rur"}]]})},o("Символ:",s)),"BTC"===d.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"NMC",callback_data:"nmc_btc"},{text:"PPC",callback_data:"ppc_btc"},{text:"NVC",callback_data:"nvc_btc"},{text:"LTC",callback_data:"ltc_btc"}],[{text:"DSH",callback_data:"dsh_btc"},{text:"ETH",callback_data:"eth_btc"},{text:"RUR",callback_data:"btc_rur"},{text:"EUR",callback_data:"btc_eur"}]]})},o("Символ:",s)),"OTHER"===d.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"ETH/LTC",callback_data:"eth_ltc"},{text:"ETH/EUR",callback_data:"eth_eur"},{text:"ETH/RUR",callback_data:"eth_rur"}],[{text:"LTC/RUR",callback_data:"ltc_rur"},{text:"LTC/EUR",callback_data:"ltc_eur"},{text:"EUR/RUR",callback_data:"eur_rur"}]]})},o("Пара:",s)),"Контроль"===d.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({keyboard:[[{text:"Скорость"},{text:"Состояние"},{text:"Модули"}],[{text:"Главное меню"}]],resize_keyboard:!0})},o("Выберите:",s)),"Нотис"===d.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({keyboard:[[{text:"Мониторинг"},{text:"Уведомление"}],[{text:"Круг"}],[{text:"Главное меню"}]],resize_keyboard:!0})},o("Выберите:",s)),"Мониторинг"===d.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Старт",callback_data:"monitoring start"},{text:"Стоп",callback_data:"monitoring stop"}]]})},t=fa.status?"Работает.":"Остановлен.",k=["Включает мониторинг возможных торговых пар. Уведомление раз в 5 минут.","Текущие состояние: "+t],o(k.join("\n"),s)),"Уведомление"===d.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Старт",callback_data:"notification start"},{text:"Стоп",callback_data:"notification stop"}]]})},t=ea.status?"Работает.":"Остановлен.",k=["Включает уведомления о скачках курса.","Текущие состояние: "+t],o(k.join("\n"),s)),"Круг"===d.text&&Ia(),"Тип"===d.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Only buy",callback_data:"type buy"},{text:"Only sell",callback_data:"type sell"},{text:"Buy & Sell",callback_data:"type all"}]]})},k=["Текущий тип торговли "+S.toUpperCase(),"Новый тип:"],o(k.join("\n"),s)),"Сменить пару"===d.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"BTC/USD",callback_data:"trade btc_usd"},{text:"BTC/RUR",callback_data:"trade btc_rur"},{text:"BTC/EUR",callback_data:"trade btc_eur"}],[{text:"LTC/BTC",callback_data:"trade ltc_btc"},{text:"LTC/USD",callback_data:"trade ltc_usd"},{text:"LTC/RUR",callback_data:"trade ltc_rur"}],[{text:"LTC/EUR",callback_data:"trade ltc_eur"},{text:"NMC/BTC",callback_data:"trade nmc_btc"},{text:"NMC/USD",callback_data:"trade nmc_usd"}],[{text:"NVC/BTC",callback_data:"trade nvc_btc"},{text:"NVC/USD",callback_data:"trade nvc_usd"},{text:"PPC/BTC",callback_data:"trade ppc_btc"}],[{text:"PPC/USD",callback_data:"trade ppc_usd"},{text:"DSH/BTC",callback_data:"trade dsh_btc"},{text:"DSH/USD",callback_data:"trade dsh_usd"}],[{text:"ETH/BTC",callback_data:"trade eth_btc"},{text:"ETH/USD",callback_data:"trade eth_usd"},{text:"ETH/EUR",callback_data:"trade eth_eur"}],[{text:"ETH/LTC",callback_data:"trade eth_ltc"},{text:"ETH/RUR",callback_data:"trade eth_rur"},{text:"USD/RUR",callback_data:"trade usd_rur"}],[{text:"EUR/USD",callback_data:"trade eur_usd"},{text:"EUR/RUR",callback_data:"trade eur_rur"}]]})},k=["Текущая пара "+r(),"Внимание! На новой паре должны быть средства для торгов, иначе переключение завершится ошибкой!","Новая торгая пара:"],o(k.join("\n"),s)),"Скорость"===d.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Normal",callback_data:"speed normal"},{text:"Extra",callback_data:"speed extra"}]]})},k=["Влияет на плотность стека ордеров, размер спреда и время закрытия неиспользованных ордеров","Время действия "+ja(B)+".","Текущая скорость: "+V].join("\n"),o(k,s)),"Состояние"===d.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Пауза",callback_data:"worker pause"},{text:"Продолжить",callback_data:"worker continued"}]]})},t=D?"Пауза":"Работает",o("Текущие состояние: "+t,s)),"Модули"===d.text?(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Динам. время обновления "+(a.dynamicSettingsTime?"[Выкл]":"[Вкл]"),callback_data:"modules dynamic-settings-time"}],[{text:"Динам. распределение ордеров "+(a.dynamicOffsetOrders?"[Выкл]":"[Вкл]"),callback_data:"modules dynamic-offset-orders"}],[{text:"Определение тренда "+(a.trendDefinition?"[Выкл]":"[Вкл]"),callback_data:"modules trend-definition"}],[{text:"Контроль смены тренда "+(a.abruptChangeTrend?"[Выкл]":"[Вкл]"),callback_data:"modules abrupt-change-trend"}],[{text:"Стоп при большом изменении цены "+(a.dangerPriceStop?"[Выкл]":"[Вкл]"),callback_data:"modules danger-price-stop"}],[{text:"Включить все",callback_data:"modules all-modules-on"},{text:"Выключить все",callback_data:"modules all-modules-off"}],[{text:"Полосы Боллинджера "+(a.bbands?"[Выкл]":"[Вкл]"),callback_data:"modules bbands"}],[{text:"Вывод лога "+(a.botLog?"[Выкл]":"[Вкл]"),callback_data:"modules bot-log"}]]})},o("*Модули обновления настроек:*",s)):void 0}),n.on("callback_query",function(b){b.from.id===a.myChatId&&(/trade (\w*_(usd|rur|eur|btc|ltc))/.test(b.data)?ya(b.data.substr(6)):/speed (normal|extra)/.test(b.data)?Aa(b.data.substr(6)):/worker (continued|pause)/.test(b.data)?Ba(b.data.substr(7)):/monitoring (start|stop)/.test(b.data)?Ea(b.data.substr(11)):/notification (start|stop)/.test(b.data)?Fa(b.data.substr(13)):/type (buy|sell|all)/.test(b.data)?za(b.data.substr(5)):/modules (\w*)/.test(b.data)?Ca(b.data.substr(8)):Da(b.data))}),ya=function(b){var c,d;a.masterWorker&&(o("Инициализировано изменение пары..."),D=!0,c=b.split("_")[0],d=b.split("_")[1],a.tradeCurrency.name===c&&a.tradeCurrency.nameTwo!==d?F.sell=1:a.tradeCurrency.name!==c&&a.tradeCurrency.nameTwo===d&&(F.buy=1),setTimeout(function(){Ya(a.tradeCurrency.pair,function(){a.tradeCurrency={name:c,nameTwo:d,pair:[c,d].join("_")},C=!0,Ra(a.tradeCurrency.pair,function(a){var b;a?(console.log(("["+t()+"]: Ошибка получения данных с сервера!\n"+a.error).red),b=["Critical error: Ошибка получения данных с сервера!","Бот поставлен на паузу, после обновления баланса необходимо перезапустить пару!","Ошибка: "+a.error].join("\n"),o(b),D=!0):(E=0,D=!1,o("Выполнено! Новая пара "+r()))})})},e("5s")))},za=function(b){a.masterWorker&&(S=b,_="all"!==b,o("Выполнено! Новый тип "+S.toUpperCase()))},Aa=function(a){var b;Na(a),b=["Режим "+a.toUpperCase()+" включен.","Пара: "+r()],A=u(),console.log(("\n["+t()+"]: "+b[0]+"\n").green),o(b.join(" "))},Ba=function(a){var b;D="pause"===a,b=D?"Пауза":"Работает",o("Новое состояние: "+b+". Пара: "+r())},Ca=function(b){var c,d;/\all-modules/.test(b)?(c="all-modules-on"===b,a.dynamicSettingsTime=c,a.dynamicOffsetOrders=c,a.trendDefinition=c,a.abruptChangeTrend=c,a.dangerPriceStop=c,a.dynamicSettingsTime||(B=a.timeUpdateAutoSettings),o("Все модули "+(c?"включены":"выключены")+"!")):(d=b.replace(/\-./g,function(a,b,c){return a.replace("-","").toUpperCase()}),a[d]=!a[d],o(b.replace(/\-/g,"_").toUpperCase()+": "+a[d]))},Da=function(b){a.masterWorker&&l.getTicker(b).then(function(c){var d,e,f,g,h,i,j,k,l,m,n;return d=Pa.pairs[b].decimal_places,e=c[b].last,f=c[b].sell,g=c[b].buy,h=ka(c[b].avg,d),i=ka(g-f,d),j=b.split("_")[1],k=oa(g,a.stepBreakevenPercentConfig,d),l=i>k?"✔":"✗",m=e>h?"↑":"↓",n=[b.replace("_","/").toUpperCase()+":","sell: "+ga[j]+f,"buy: "+ga[j]+g,"last: "+ga[j]+e,"avg: "+ga[j]+h+" | "+m,"spread:   "+i+" | "+(i/k*100-100).toFixed()+"%","required: "+k+" "+l],o(n.join("\n"))}).catch(function(a){o(a.error)})},Ea=function(b){var c;a.masterWorker&&(fa.status="start"===b,clearInterval(fa.interval),fa.status?(c="Работает",Ga(),fa.interval=setInterval(function(){Ga()},e("5m"))):c="Остановлен",o("Новое состояние: "+c))},Fa=function(b){var c;if(a.masterWorker){if(null==ba||!ba.length)return void o("Внимание! Конфиг для уведомлений не задан!");ea.status="start"===b,clearInterval(ea.interval),ea.status?(c="Работает",Ha()):c="Остановлен",o("Новое состояние: "+c)}},Ga=function(){var c;c=Qa.join("-"),b.parallel([function(a){return l.getTicker(c).then(function(b){return a(null,b)}).catch(function(b){return a(b)})},function(a){return l.getTrades(c,{limit:2}).then(function(b){return a(null,b)}).catch(function(b){return a(b)})}],function(c,d){var g,h,i,j;if(c)return g="Error trading pairs available: "+c.error,o(g),void console.log(g.red);h=[],i=(new Date).getTime(),j=f.range(i-e("1m"),i),b.each(Qa,function(b,c){var e,f,g,i,k,l,m,n;return e=Pa.pairs[b].decimal_places,f=d[0][b].last,g=d[0][b].sell,i=d[0][b].buy,k=ka(d[0][b].avg,e),l=ka(i-g,e),m=oa(i,a.stepBreakevenPercentConfig,e),n=f>k?"↑":"↓",l>m&&j.contains(1e3*d[1][b][0].timestamp)&&j.contains(1e3*d[1][b][1].timestamp)?(h.push(b.replace("_","/").toUpperCase()+"\nprice: "+i+" - "+g+"\navg:   "+k+" | "+n+"\nspread:   "+l+" | "+(l/m*100-100).toFixed()+"%\nrequired: "+m+"\n"),c(null)):c(null)}),setTimeout(function(){h.length&&(h.push("Доступные пары для торгов:\n"),h.reverse(),o(h.join("\n")))},e("2s"))})},Ha=function(){var c,d;a.masterWorker&&null!=ba&&ba.length&&(c=ba.join("-"),d={},ea.interval=setInterval(function(){l.getTicker(c).then(function(c){return b.each(ba,function(b,f){var g,h,i,j,k,l,m,n,p,q,r;return a.tradeCurrency.pair===b?f(null):(g=Pa.pairs[b].decimal_places,h=c[b].sell,i=c[b].buy,j=c[b].last,k=ka(c[b].avg,g),l=ka(i-h,g),m=oa(h,a.notificationDeviation,g),l>m&&(n=b.split("_")[1],p=j<=h||j<=h+ma(3,g)?"down ↓":"up ↑",q=j>k?"↑":"↓",r=["Уведомление "+b.replace("_","/").toUpperCase()+":","directions: "+p,"sell: "+ga[n]+h,"buy: "+ga[n]+i,"last: "+ga[n]+j,"avg: "+ga[n]+k+" | "+q,"spread: "+l],d[b]||(d[b]=!0,o(r.join("\n")),setTimeout(function(){d[b]=!1,d.error=!1},e("15m")))),f(null))})}).catch(function(a){var b;if(b="Error notification price: "+a.error,console.log(b.red),!d.error)return o(b),d.error=!0})},e("2s")))},Ia=function(a,b){var c,d,e,f;null==a&&(a=.993),null==b&&(b=!1),c={},d={},e={},f={},Qa.forEach(function(a){var b;b=a.split(/\s*_\s*/),c[b[0]]?c[b[0]].push(b[1]):c[b[0]]=[b[1]]}),l.getTicker(Qa.join("-")).then(function(g){var h,i,j;if(Qa.forEach(function(a){d[a]=ra(1,g[a].buy)}),Qa.forEach(function(a){var b;b=a.split(/\s*_\s*/),c[b[0]].forEach(function(c){c!==b[1]&&(e[b[1]+"_"+b[0]+"_"+c]=sa(d[a],g[b[0]+"_"+c].sell))})}),Object.keys(e).forEach(function(b){var c,d;c=b.split(/\s*_\s*/),cb(c[0]+"_"+c[2],Qa)&&(d=ra(e[b],g[c[0]+"_"+c[2]].buy)),cb(c[2]+"_"+c[0],Qa)&&(d=sa(e[b],g[c[2]+"_"+c[0]].buy)),d>a&&(f[b+"_"+c[0]]=ka(d,5))}),h=["Проверка возможных вариантов перепродаж.","Показаны значения больше: "+a,"Значения меньше 1 убыточны:\n"],i=[],Object.keys(f).forEach(function(a){i.push([a.replace(/\_/g,"->"),f[a]])}),i.length?(j=i.sort(function(a,b){return b[1]-a[1]}),j.forEach(function(a){h.push(a.join(": "))})):h.push("Нет подходящих вариантов"),!b||i.length)return o(h.join("\n"))}).catch(function(a){return o("Error: "+a.error)})},Na=function(b){var c;null!=b&&(c=b),c||(c=E>$?"extra":"normal"),E=0,"extra"===c?(Ja=G.extra,Ka=G.extra,Ma=I,La=60*a.timeCloseOrdersExtra):(Ja=G.buy,Ka=G.sell,Ma=H,La=60*a.timeCloseOrdersDefault),V=c},Oa=0,Ra=function(a,b){return l.getInfo().then(function(c){return Pa=c,Qa=Object.keys(c.pairs),W=c.pairs[a].decimal_places,Z=c.pairs[a].min_amount,X=c.pairs[a].min_price,Y=c.pairs[a].fee,xa(a,function(c){var d,e;return c?(d=null!=(e=c.error)?e.split("send:")[1]:void 0,null!=d?(m.nonce=d,Ra(a,b)):(Oa++,Oa>5?(Oa=0,b(c)):Ra(a,b))):b(null)})}).catch(function(a){return b(a)})},Sa=function(a,b){return l.getTicker(a).then(function(c){var d,e,f,g;return d=c[a].last,e=c[a].sell,f=c[a].buy,g=ka(f-e,W),L=Ma<=ma(2)?g>=Ma:g>Ma,b(null,{lastPrice:d,bidPrice:e,askPrice:f,spread:g})}).catch(function(a){return b(a)})},Ta=function(a,b){return m.getActiveOrders(a).then(function(a){return b(null,a)}).catch(function(a){return b(a)})},Ua=function(a,b){return m.getInfo().then(function(c){return b(null,c.funds[a.name],c.funds[a.nameTwo])}).catch(function(a){return b(a)})},Va=function(b,c){return L?Ua(b,function(b,d,e){return b?c(b):(d=wa(d,"name"),e=wa(e,"nameTwo"),"all"===S?d<Z&&e<Z?M<a.ecoCountCycle&&M++:M>0&&(M=0):M=a.ecoCountCycle,c(null,{balance:d,balanceTwo:e}))}):c(null)},Wa=function(c,d,e,f,g){var h;return d<Z?g(null):aa?g(null):(K={buy:0,sell:0},"all"===S||S===c?d>=J?(void 0!==h&&null!==h||(h=e),b.doWhilst(function(a){return T?("sell"===c&&(h-=Ka),"buy"===c&&(h+=Ja),d=ka(d/2),Xa(c,h,d,f,a)):("buy"===c?(h-=Ja,d=ka(K.buy/h)||d):(h+=Ka,d=K.sell||d),d>J?Xa(c,h,J,f,a):Xa(c,h,ka(d/2),f,a))},function(){return d>ka(J/2)},function(a){return g(null!=a?a:null)})):(a.bbands&&("sell"===c&&(e+=ma(1)),"buy"===c&&(e-=ma(1))),Xa(c,e,d,f,g)):g(null))},Xa=function(b,c,d,e,f){return d<Z?f(null):(c=ka(c,W),c>=X||(c=X),d=ka(d,8),m.trade({pair:e,type:b,rate:c,amount:d}).then(function(e){var g;return g="["+t()+"]: Open: "+b+" | rate: "+c+" | amount: "+d,"buy"===b?K.buy=wa(e.funds[a.tradeCurrency.nameTwo],"nameTwo"):K.sell=wa(e.funds[a.tradeCurrency.name],"name"),console.log("buy"===b?g.green:g.yellow),E++,f(null)}).catch(function(a){return console.log(("["+t()+"]: Error: "+b+" | rate: "+c+" | amount: "+d).red),f(a)}))},Ya=function(a,c){return Ta(a,function(a,d){var e,f;return z=u(),a?0===a.success&&null==(null!=(e=a.error)?e.split("send:")[1]:void 0)?(console.log(("["+t()+"] Cancel orders: "+a.error).yellow),c(null)):c(a):(f=Object.keys(d),b.eachSeries(f,function(a,b){return null!=F.buy&&"sell"===d[a].type?b(null):null!=F.sell&&"buy"===d[a].type?b(null):z-d[a].timestamp_created>(F.buy||F.sell||F.all||60)?Za(a,d[a].type,d[a].amount,d[a].rate,b):b(null)},function(a){return F={all:null,buy:null,sell:null},c(null!=a?a:null)}))})},Za=function(a,b,c,d,e){return m.cancelOrder({order_id:a}).then(function(){return console.log(("["+t()+"]: Close: "+b+" | rate: "+d+" | amount: "+c).cyan),E>0&&E--,e(null)}).catch(function(a){return e(a)})},$a=function(){_||ia(z,a.timeCloseOrdersInactivity)&&Ya(a.tradeCurrency.pair,function(a){})},_a=function(){var a;ia(y,10)&&(a="Unknown error: Worker Stop!",console.log(("["+t()+"]: "+a).red),bb({error:a}))},ab=function(){y=u(),D?setTimeout(function(){ab()},e("30s")):b.series([function(b){return Sa(a.tradeCurrency.pair,b)},function(b){return Va(a.tradeCurrency,b)}],function(c,d){var f;c?(f="object"==typeof c?c.error:c,console.log(("Error: "+f).red),bb(c)):(C&&(va(d[0].askPrice,d[0].bidPrice,d[0].lastPrice),C=!1),L?b.series([function(a){return B>0&&y-A>60*B&&va(d[0].askPrice,d[0].bidPrice,d[0].lastPrice),a(null)},function(b){return y-z>La?Ya(a.tradeCurrency.pair,b):b(null)},function(b){var c,e;return a.botTrade&&v?(c=ka(d[1].balanceTwo/d[0].askPrice),e=T?U.bid:d[0].bidPrice,Wa("buy",c,e,a.tradeCurrency.pair,b)):b(null)},function(b){var c;return a.botTrade&&v?(c=T?U.ask:d[0].askPrice,Wa("sell",d[1].balance,c,a.tradeCurrency.pair,b)):b(null)}],function(b){var c;b?(c="object"==typeof b?b.error:b,console.log(("ErrorTrader: "+c).red),bb(b)):M===a.ecoCountCycle?(clearTimeout(da.eco),da.eco=setTimeout(function(){ab()},e("2s"))):ab()}):(clearTimeout(da.spread),da.spread=setTimeout(function(){ab()},e(a.restartServerTime+"s"))))})},bb=function(b){var c,d,f;c="restart using "+a.restartServerTime+" sec ...",console.log("["+t()+"]: "+c),d=null!=(f=b.error)?f.split("send:")[1]:void 0,null==d&&w!==b.error&&(w=b.error,a.emailS&&"production"===process.env.NODE_ENV&&q(s(b.error+"\n\n"+c),function(a,b){})),setTimeout(function(){console.log(("["+t()+"]: trader restart").bgGreen),null!=d&&(m.nonce=d),ab()},e(a.restartServerTime+"s"))},function(){a.myChatId&&(console.log("["+t()+"]: Trader Bot starting..."),Ra(a.tradeCurrency.pair,function(b){return b&&(console.log(("["+t()+"]: Error getting parameters from the server!\n"+b.error).red),process.exit(0)),ab(),a.botTrade&&setInterval(function(){$a(),_a()},e("5m")),setInterval(function(){ta()},e(10*a.bbandsInterval+"s")),"production"===process.env.NODE_ENV&&o("Trader Bot started. Pair "+r()),console.log("["+t()+"]: Trader Bot started")}))}()}).call(this);