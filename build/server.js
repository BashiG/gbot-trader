(function(){function e(e,t){for(var n=-1,r=t.length>>>0;++n<r;)if(e===t[n])return!0;return!1}var t,n,r,a,l,o,i,c,s,u,d,p,b,f,_,g,m,y,O,T,E,x,C,S,v,k,h,R,N,I,P,D,w,L,U,B,F,j,A,M,q,z,H,J,G,V,K,Y,W,X,Q,Z,$,ee,te,ne,re,ae,le,oe,ie,ce,se,ue,de,pe,be,fe,_e,ge,me,ye,Oe,Te,Ee,xe,Ce,Se,ve,ke,he,Re,Ne,Ie,Pe,De,we,Le,Ue,Be,Fe,je,Ae,Me,qe,ze,He,Je,Ge,Ve,Ke,Ye,We,Xe,Qe,Ze,$e,et,tt,nt,rt,at,lt,ot,it,ct,st,ut,dt,pt,bt,ft,_t,gt,mt,yt,Ot,Tt,Et,xt,Ct,St,vt;if(t=require("./conf"),n=require("./api-btc-e"),r=require("./api-poloniex"),a=require("async"),l=require("lodash"),require("colors"),o=require("ms"),i=require("moment"),c=require("moment-range"),s=require("nodemailer"),u=require("node-telegram-bot-api"),d=require("ta-lib"),i=c.extendMoment(i),!t.tokenTelegram)return void console.log("There is no token Telegram!".red);p="poloniex"===t.exchange?new r:new n,b=new u(t.tokenTelegram,{polling:!0}),f=function(e,n){null==n&&(n={}),e.length>4096&&(e="*Слишком много информации для отображения*"),e.length||(e="*Error: Не удалось обработать ошибку*"),!1!==n.format&&(n.parse_mode="markdown"),delete n.format,b.sendMessage(t.myChatId,e,n)},_=s.createTransport(t.email),g=function(e,t){return _.sendMail(e,t)},m=function(){return t.tradeCurrency.pair.replace("_","/").toUpperCase()},y=function(e){return{from:t.email.auth.user,to:t.email.reportEmail,subject:"Error Script Trader",text:"time: "+(new Date).toString()+"\nPair: "+m()+"\n\nmessage: "+e+"\n\n---"}},O=function(){return(new Date).toLocaleTimeString("en-US",{timeZone:t.timeZone,hour12:!1})},T=function(){return Math.round((new Date).getTime()/1e3)},E=function(e){var t;return t="",Object.keys(e).forEach(function(n){if(e.hasOwnProperty(n))return t+=n+" :: "+e[n]+"\n"}),t},x=function(e){return"object"==typeof e?e.hasOwnProperty("error")?e.error:e.hasOwnProperty("message")?e.message:E(e):e},C=!0,S={count:0,text:""},v=!1,k={name:0,nameTwo:0},h=T(),R=T(),N=T(),I=t.timeUpdateAutoSettings,P=!0,D=!1,w=0,L={all:null,buy:null,sell:null},U={extra:0,buy:0,sell:0,first:0},B=t.oneOrdersSellPercent,F=0,j=0,A=0,M={buy:0,sell:0},q={buy:0,sell:0},z={buy:0,sell:0},H={},J={},G={id:0,priceBuy:0,amount:0},V={},K=!1,Y=0,W=0,X=!1,Q=0,Z=0,$=0,ee=0,te=[],ne=[],re={},ae="all",le=!1,oe={ask:0,bid:0},ie="normal",ce=0,se=0,ue=0,de=0,pe=0,be=!1,fe=!1,_e=!1,ge=null!=(me=t.notificationPair)?me.toLowerCase().replace(/\//g,"_").split(/\s*,\s*/):void 0,ye={status:!1,interval:!1},Oe={status:!1,interval:!1},Te={btc:"฿",usd:"$",eur:"€",rur:"₽",ltc:"L"},Ee="-----------------------------------",xe=function(e){return Te.hasOwnProperty(e)?Te[e]:e+" "},Ce=function(e,t){return T()-e>=60*t},Se=function(e,t){var n,r,a;return null!=t&&(n=t),n||(n=e>=1?["минута","минуты","минут"]:["секунда","секунды","секунд"],e=e<1?60*e:e),r=[2,0,1,1,1,2],a=n[e%100>4&&e%100<20?2:r[e%10<5?e%10:5]],e+" "+a},ve=function(e,t){return null==t&&(t=3),+(+e).toFixed(t)},ke=function(e){return e.toFixed(10).replace(/(.*0\.0*[1-9]*)0+\d*/g,"$1")},he=function(e,t){var n,r,a;return n=[],l.forIn(e,function(e,t){n.push(e)}),r=n.sort(function(e,t){return t.rate-e.rate}),a=l.findKey(r,function(e){return e.rate<=t}),r[a]},Re=function(e,t){var n,r;return n=[],l.forIn(e,function(e,r){"min"===t&&"buy"!==e.type||"max"===t&&"sell"!==e.type||n.push(e)}),r=n.sort(function(e,t){return t.rate-e.rate}),"min"===t?l.last(r):l.head(r)},Ne=function(e,t){return t>0?+(100*e/t).toFixed(1):0},Ie=function(e,t){return e*(1+t/100)},Pe=function(e,t){return e*(1-t/100)},De=function(e,t){return null==t&&(t=ce),ve(e/+("1e"+t),t)},we=function(e,t){return null==t&&(t=ce),ve(e*+("1e"+t),t)},Le=function(e,t,n){var r,a;return null==t&&(t=0),null==n&&(n=ce),r=e/100*ue*2,a=Math.ceil(r*+("1e"+n))/+("1e"+n),ve(Ie(a,t),n)},Ue=function(e,t){return ve(Ie(e,t),ce)},Be=function(e,t){return ve(Pe(e,t),ce)},Fe=function(e,t){return Pe(e/t,ue)},je=function(e,t){return Pe(e*t,ue)},Ae=function(){t.bbands&&ee>0&&(ne.push(ee),ne.length>30&&ne.splice(0,1))},Me=function(e,t){var n,r;return null==t&&(t=.1),n=e/100*t,r=1/+("1e"+ce),n>=r||(n=r),ve(n,ce)},qe=function(e,t){var n,r,a;null==t&&(t=1),n=e.toString().split(".")[0];try{r=e.toString().split(".")[1].length}catch(e){r=1}return a=n>0?n>1e4?+("1e"+(r+1)):n>1e3?+("1e"+r):n>100?+("1e"+(r-1)):n>10?+("1e"+(r-2)):r>3?+("1e"+(r-3)):1:1,t*=a,ve(t/+("1e"+r),r)},ze=function(e,n,r){var a,o,i,c,s,u,p,b,_,g,y,E,x,S,v,k,h,B,A,M,q,z,H,J,K,Y,W,X,Q,re,_e,ge,me,ye,Oe,Te,xe;if(N=T(),L={buy:null,sell:null},a=e.toString().length,o=n.toString().length,c={},c[a+""]=e,c[o+""]=n,i=c,s=Math.max(a,o),u=i[s],ce=st.pairs[t.tradeCurrency.pair].decimal_places,de=st.pairs[t.tradeCurrency.pair].min_amount,se=st.pairs[t.tradeCurrency.pair].min_price,ue=st.pairs[t.tradeCurrency.pair].fee,p=ve(e-n,ce),b=Le(u,200),t.dynamicSettingsTime&&(te.push(r),te.length>50&&te.splice(0,1),_=l.max(te),g=l.min(te),t.botLog&&console.log([Ee,"price-array:","length: "+te.length,"max: "+_,"min: "+g,"change-time-settings: "+(Ne(_,g)>102)].join("\n")),Ne(_,g)>102?I=.1:I!==t.timeUpdateAutoSettings&&(I=t.timeUpdateAutoSettings)),t.abruptChangeTrend&&(y=Le(u,500)),t.dangerPriceStop&&(E=Ue($,9),x=Be(Z,9)),t.dynamicOffsetOrders&&(S={current:Le(u,450),prev:Le(u,380),prev_2:Le(u,300)},v=p>=S.current||p>=S.prev||p>=S.prev_2),t.dynamicOffsetOrders&&v?(console.log("["+O()+"]: Dynamic market"),k=qe(u,we(S.current)),h=1.5*t.stepBreakevenPercent):(k=qe(u,t.offsetOrdersPoints),h=t.stepBreakevenPercent),k=function(){switch(!1){case!t.offsetOrdersPercent:return Me(u,t.offsetOrdersPercent);case!t.rangeOffset:return Me(u,ve(t.rangeOffset/t.countOrders,2));default:return k}}(),B=1.3*k,A=Me(u,t.offsetFirstOrdersPercent),M=t.offsetOrdersPercent?Me(u):2,F=function(){switch(!1){case!t.bbands:case!t.oneOrdersSell:return 0;default:return Le(u,h)}}(),t.botLog&&(console.log(Ee),console.log("current-spread:",(ke(p)+"")[p>F?"green":"white"]),console.log("spread-min-default:",ke(F)),console.log("trend-spread:",ke(b)),t.abruptChangeTrend&&console.log("immediate-spread:",y),console.log("trader-speed:",ie),console.log("price-prev:",$+" - "+Z),console.log("price-prev2:",oe.ask+" - "+oe.bid),t.dangerPriceStop&&(console.log("danger-price-ask:",E,!P&&e>=E?"Attention!".red:""),console.log("danger-price-bid:",x,!P&&n<=x?"Attention!".red:"")),t.dynamicOffsetOrders&&(console.log("spread_1_450:",S.current,p>=S.current?"Attention!".red:""),console.log("spread_2_380:",S.prev,p>=S.prev?"Attention!".red:""),console.log("spread_3_300:",S.prev_2,p>=S.prev_2?"Attention!".red:""),console.log("dynamic-market:",v))),t.dangerPriceStop&&!P&&(e>=E||n<=x))return e>=E&&(L.buy=1),R=0,D=!0,q="DANGER PRICE: "+e+" - "+n+" | Bot Pause!",console.log("["+O()+"]: "+q),void f("`"+q+"`");z=M,H=w>Math.round(pe/2)?B:k,t.botLog&&(console.log("offset-max-one:",(ke(k)+"")[k===H?"green":"yellow"]),console.log("offset-type-max:",ke(H)),t.offsetFirstOrdersPercent&&console.log("offset-first-orders:",ke(A)),console.log(Ee)),be||(ae="all",le=!1),P?(t.bbands&&(C=!1),J=K=H):t.oneOrdersSell?(J=K=H,t.timeCloseOrders=1e5,t.timeCloseOrdersInactivity=t.timeCloseOrders,(Y=he(V,n))&&n>Ue(Y.rate,t.oneOrdersSellOffset)&&!G.id&&(L.buy=1,R=0)):t.bbands?(J=K=H,I=.1,W=14,ne.length>2*W&&(c=d.BBANDS(ne,20,t.bbandsDeviation),X=c.middleband,Q=c.lowband,re=c.highband,_e=d.RSI(l.clone(ne).reverse(),W),ge=d.average(_e).mean,me=d.average(X).mean,ye=d.average(re).mean,Oe=d.average(Q).mean,Te=ye>r&&r>me,xe=me>r&&r>Oe,Te&&(be||(ae="sell"),C=99>ge&&ge>70),xe&&(be||(ae="buy"),C=1<ge&&ge<30),fe=Te&&xe,t.botLog&&console.log(["BBANDS:","highband: "+ye,"middleband: "+me,"lowband: "+Oe,"rsa: "+ge,"sell: "+Te,"buy: "+xe,"bot trade: "+C,"orders-calculation-brake: "+fe,Ee].join("\n")))):t.trendDefinition&&n>Z&&e>$&&p>b&&"normal"===ie?(console.log("["+O()+"]: Trend: UP"),J=z,K=H,be||(ae="buy",L.sell=1,R=0,t.abruptChangeTrend&&p>y&&(console.log("["+O()+"]: Spread Immediate"),le=!0,N=0))):t.trendDefinition&&n<Z&&e<$&&p>b&&"normal"===ie?(console.log("["+O()+"]: Trend: DOWN"),J=H,K=z,be||(ae="sell",L.buy=1,R=0,t.abruptChangeTrend&&p>y&&(console.log("["+O()+"]: Spread Immediate"),le=!0,N=0))):J=K=H,oe={ask:$,bid:Z},Z=n,$=e,ee=r,j=Le(u),U={buy:J,sell:K,extra:qe(u),first:A},it(),console.log("["+O()+"]: Update: "+ae.toUpperCase()+" | "+e+" - "+n+" | "+r+" | "+m())},He=function(e,t){var n,r;return n="name"===t?k.name:k.nameTwo,r=e-n,r>0?r:0},Je=function(e,n){return a.parallel([function(n){return t.botLog&&console.log(Ee+"\nПолучение цен"),p.getTicker(e,function(r,a){return null!=r?(t.botLog&&(console.log("Price: "+a[e].buy),console.log(x(r))),n(r)):n(null,{price:a[e].buy})})},function(n){return a.series([function(n){return t.botLog&&console.log(Ee+"\nЗакрытие всех позиций"),L.all=1,Tt(e,function(e){return n(null!=e?e:null)})},function(e){return t.botLog&&console.log(Ee+"\nПолучение баланса"),p.balanceRequest(t.tradeCurrency,function(n,r,a){return null!=n?(t.botLog&&(console.log("balance: "+r+" | balance-two: "+a),console.log(x(n))),e(n)):t.botTrade&&r<.001&&a<.001?(t.botLog&&console.log("balance: "+r+" | balance-two: "+a),e({error:"Err: No money!"})):e(null,{balance:r,balanceTwo:a})})}],function(e,t){return null!=e?n(e):n(null,{balance:t[1].balance,balanceTwo:t[1].balanceTwo})})}],function(e,r){var a,l,o,i,c,s,u,d,p,b,f,_,g,m,y;return null!=e?n(e):(re=r[1],t.botLog&&console.log(Ee+"\nРасчет депозита"),a=0<(l=t.depositLimit)&&l<100?t.depositLimit:100,t.oneOrdersSell&&("poloniex"===t.exchange?(o=r[1].balanceTwo,r[1].balanceTwo=0):(o=r[1].balance,r[1].balance=0)),"poloniex"===t.exchange?(i=r[1].balanceTwo*r[0].price+r[1].balance,c=r[1].balance/r[0].price+r[1].balanceTwo):(i=r[1].balanceTwo/r[0].price+r[1].balance,c=r[1].balance*r[0].price+r[1].balanceTwo),s=i*a/100,u=c*a/100,100===a?(t.botLog&&console.log("type:",0),d=0,p=0):r[1].balance>=s&&r[1].balanceTwo>=u?(t.botLog&&console.log("type:",1),d=r[1].balance-s/2,p=r[1].balanceTwo-u/2):r[1].balance>=s&&r[1].balanceTwo<u?(t.botLog&&console.log("type:",2),d="poloniex"===t.exchange?r[1].balance-(u-r[1].balanceTwo)*r[0].price:r[1].balance-(u-r[1].balanceTwo)/r[0].price,p=0):r[1].balance<s&&r[1].balanceTwo>=u?(t.botLog&&console.log("type:",3),d=0,p="poloniex"===t.exchange?r[1].balanceTwo-(s-r[1].balance)/r[0].price:r[1].balanceTwo-(s-r[1].balance)*r[0].price):r[1].balance<s&&r[1].balanceTwo<u&&(t.botLog&&console.log("type:",4),"poloniex"===t.exchange?(d=r[1].balance-(u-r[1].balanceTwo)*r[0].price,p=r[1].balanceTwo-(s-r[1].balance)/r[0].price):(d=r[1].balance-(u-r[1].balanceTwo)/r[0].price,p=r[1].balanceTwo-(s-r[1].balance)*r[0].price)),t.botLog&&(b=Ne(d,r[1].balance),f=Ne(p,r[1].balanceTwo),console.log(["reserved-deposit:",t.tradeCurrency.name.toUpperCase(),b+"% / "+f+"%",t.tradeCurrency.nameTwo.toUpperCase()].join(" "))),t.oneOrdersSell&&("poloniex"===t.exchange?p=o:d=o),k={name:d>0?d:0,nameTwo:p>0?p:0},_="poloniex"===t.exchange?u:s,t.countOrders?t.countOrders>=3||(t.countOrders=3):t.countOrders=_<=10?6:_<=200?15:_<=500?18:_<=1e3?21:25,g="poloniex"===t.exchange?t.poloniexMinOrders/r[0].price:de,pe=t.countOrders*t.multiplierOrdersExtra,t.sizeOrdersMartingale?1===t.martingaleType?(m=1+t.sizeOrdersMartingale/100,y=_/((Math.pow(m,t.countOrders)-1)/(m-1))):(W=r[0].price-Pe(r[0].price,t.sizeOrdersMartingale),y=_/t.countOrders-(t.countOrders-1)*W/2):y=_/t.countOrders,A=ve(y>g?y:g,ce),t.botLog&&console.log([Ee+"\nРасчет переменных","balance: "+ve(r[1].balance)+" "+t.tradeCurrency.name.toUpperCase(),"balance-two: "+ve(r[1].balanceTwo)+" "+xe(t.tradeCurrency.nameTwo),"deposit: "+i+" "+t.tradeCurrency.name.toUpperCase()+" или "+c+" "+t.tradeCurrency.nameTwo.toUpperCase(),"percent-deposit: "+t.depositLimit+" %","trade-deposit: "+s+" "+t.tradeCurrency.name.toUpperCase()+" | "+u+" "+t.tradeCurrency.nameTwo.toUpperCase(),"reserved-deposit: "+ve(k.name)+" "+t.tradeCurrency.name.toUpperCase()+" | "+ve(k.nameTwo)+" "+t.tradeCurrency.nameTwo.toUpperCase(),"count-orders: "+t.countOrders,"quantity-orders-in-blocks: "+(t.quantityOrdersInBlocks?t.quantityOrdersInBlocks:"OFF"),"size-static-order: "+A,"size-orders-martingale: "+(t.sizeOrdersMartingale?t.sizeOrdersMartingale:"OFF")+"    Тип: "+(1===t.martingaleType?"Exponential":"Linear"),Ee].join("\n")),n(null))})},b.on("message",function(e){var n,r,o,i,c,s,u,d,_,g,y,O;if(n=e.chat.id,t.myChatId||b.sendMessage(n,"Install your Telegram id: `"+n+"`",{parse_mode:"markdown"}),n===t.myChatId){if("Ордера"===e.text&&(r=function(){a.series([function(e){return p.balanceRequest(t.tradeCurrency,function(t,n,r){return null!=t?e(t):e(null,{balance:n,balanceTwo:r})})},function(e){return p.ordersRequest(t.tradeCurrency.pair,function(t,n){return null!=t?e(t):e(null,{data:n})})}],function(e,n){var a,o,i,c,s,u,d,b,_,g,y,O;a=[m()+":",Ee],o="Balance: "+(null!=(i=n[0])?i.balance.toFixed(3):void 0)+" "+t.tradeCurrency.name.toUpperCase()+" | "+xe(t.tradeCurrency.nameTwo)+(null!=(c=n[0])?c.balanceTwo.toFixed(3):void 0),null!=e?0===e.success?(s=null!=(u=e.error)?u.split("send:")[1]:void 0,null!=s?(p.setNonce(s),r()):(d=x(e),a.push(d+"\n"+Ee+"\n"+o),f(a.join("\n")))):f(e):(b={},_=0,g=0,y={},Object.keys(n[1].data).forEach(function(e){var r,a,l;r=n[1].data[e].rate*+("1e"+ce),null!=y[r]?(++b[r],a=" | "+b[r],l=ve(ve(y[r].split("|")[1].trim())+ve(n[1].data[e].amount)),y[r]=n[1].data[e].type+" | "+l+" | "+xe(t.tradeCurrency.nameTwo)+n[1].data[e].rate+a):(b[r]=1,y[r]=n[1].data[e].type+" | "+ve(n[1].data[e].amount)+" | "+xe(t.tradeCurrency.nameTwo)+n[1].data[e].rate),_+=n[1].data[e].amount,g+=n[1].data[e].amount*n[1].data[e].rate}),a=l.concat(a,l.values(y)),a.push(Ee+"\nCount: "+ve(_)+" | Sum: "+xe(t.tradeCurrency.nameTwo)+ve(g)+"\n"+o),O=a.join("\n"),f(O))})})(),"История"===e.text&&(o=function(){p.tradeGetHistory(t.tradeCurrency.pair,10,function(e,n){var r,a,l;return null!=e?0===e.success?(r=null!=(a=e.error)?a.split("send:")[1]:void 0,null!=r?(p.setNonce(r),o()):f(x(e))):f(x(e)):(l=[],Object.keys(n).forEach(function(e){l.push(n[e].type+" | "+n[e].amount.toFixed(3)+" | "+xe(t.tradeCurrency.nameTwo)+n[e].rate)}),l.push(m()+":\n"+Ee),l.reverse(),f(l.join("\n")))})})(),"Закрыть активные ордера"===e.text&&(i={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Закрыть ордера!",callback_data:"close_orders_now"}]]})},f("*Вы уверены что хотите закрыть ордера?*",i)),"/config"===(null!=(c=e.text)?c.toLowerCase():void 0)&&(s=["Бот на паре: "+m(),"EXCHANGE: "+t.exchange+" | Выбор биржи btc-e или poloniex","POLONIEX_FEE: "+t.poloniexFee+" | Комиссия на сделки биржи POLONIEX","TIME_UPDATE_AUTO_SETTINGS: "+I+" | время обновления авто настроек параметров (в мин)","DEPOSIT_LIMIT: "+t.depositLimit+" | процент использования депозита","NOTIFICATION_PAIR: "+t.notificationPair+" | пары для уведомления (или all/all для всех)","NOTIFICATION_DEVIATION_PERCENT: "+t.notificationDeviation+" | насколько процентов должен увеличиться спред чтобы сработало уведомление","COUNT_ORDERS: "+t.countOrders+" | количество ордеров","QUANTITY_ORDERS_IN_BLOCKS: "+t.quantityOrdersInBlocks+" | количество ордеров в блоке","TIME_CLOSE_ORDERS: "+t.timeCloseOrders+" | сколько минут ждать перед закрытием неисполнившихся ордеров","TIME_CLOSE_ORDERS_INACTIVITY: "+t.timeCloseOrdersInactivity+" | закрытие после бездействия","OFFSET_ORDERS_POINTS: "+t.offsetOrdersPoints+" | отступ ордеров в пунктах","OFFSET_ORDERS_PERCENT: "+t.offsetOrdersPercent+" | отступ для ордеров в %","OFFSET_ORDERS_EXPONENTIAL: "+t.offsetOrdersExponential+" | отступ для ордеров по экспоненте в %","OFFSET_FIRST_ORDERS_PERCENT: "+t.offsetFirstOrdersPercent+" | отступ первого ордера в %","RANGE_OFFSET: "+t.rangeOffset+" | диапазон смещения ордеров в %","SIZE_ORDERS_MARTINGALE: "+t.sizeOrdersMartingale+" | размер ордера в % Мартингейла","MARTINGALE_TYPE: "+t.martingaleType+" | тип Мартингейла","STEP_BREAKEVEN_PERCENT: "+t.stepBreakevenPercent+" | процент отступа безубытка для торгов","DANGER_PRICE_STOP: "+t.dangerPriceStop+" | остановка бота при большом изменении цены","DYNAMIC_SETTINGS_TIME: "+t.dynamicSettingsTime+" | динамическое время обновления настроек","DYNAMIC_OFFSET_ORDERS: "+t.dynamicOffsetOrders+" | динамическое распределение ордеров","TREND_DEFINITION: "+t.trendDefinition+" | определение тренда","ABRUPT_CHANGE_TREND: "+t.abruptChangeTrend+" | быстрое изменение направления тренда","BBANDS: "+t.bbands+" | Стратегия Полосы Боллинджера","BBANDS_DEVIATION: "+t.bbandsDeviation+" | Отклонение","BBANDS_INTERVAL: "+t.bbandsInterval+" | Таймфрейм (в мин)","ONE_ORDERS_SELL: "+t.oneOrdersSell+" | Стратегия One Sell a lot Buy","ONE_ORDERS_SELL_PERCENT: "+B+" | Задает процент желаемой прибыли","ONE_ORDERS_SELL_OFFSET: "+t.oneOrdersSellOffset+" | Разница между ценой LastPrice и первым ордером buy в стеке ордеров в %"],f(s.join("\n\n"),{format:!1})),"/version"===(null!=(u=e.text)?u.toLowerCase():void 0)&&f("Версия бота: `"+t.versionBot+"`"),"/start"!==(d=null!=(_=e.text)?_.toLowerCase():void 0)&&"главное меню"!==d||(i={reply_markup:JSON.stringify({keyboard:[[{text:"Ордера"},{text:"Котировки"},{text:"История"}],[{text:"Контроль"},{text:"Нотис"},{text:"Торговля"}],[{text:"Закрыть активные ордера"}]],resize_keyboard:!0})},f("Выберите:",i)),"Котировки"===e.text){if("btc-e"!==t.exchange)return void f("*Этот пункт не доступен для данной биржи*");i={reply_markup:JSON.stringify({keyboard:[[{text:"USD"},{text:"BTC"},{text:"OTHER"}],[{text:"Главное меню"}]],resize_keyboard:!0})},f("Валюта:",i)}if("Торговля"===e.text&&(i={reply_markup:JSON.stringify({keyboard:[[{text:"Сменить пару"},{text:"Тип"}],[{text:"Авто выход из пары"}],[{text:"Главное меню"}]],resize_keyboard:!0})},f("Выберите:",i)),"USD"===e.text&&(i={reply_markup:JSON.stringify({inline_keyboard:[[{text:"NMC",callback_data:"nmc_usd"},{text:"PPC",callback_data:"ppc_usd"},{text:"NVC",callback_data:"nvc_usd"},{text:"LTC",callback_data:"ltc_usd"},{text:"BTC",callback_data:"btc_usd"}],[{text:"DSH",callback_data:"dsh_usd"},{text:"ETH",callback_data:"eth_usd"},{text:"EUR",callback_data:"eur_usd"},{text:"RUR",callback_data:"usd_rur"}]]})},f("Символ:",i)),"BTC"===e.text&&(i={reply_markup:JSON.stringify({inline_keyboard:[[{text:"NMC",callback_data:"nmc_btc"},{text:"PPC",callback_data:"ppc_btc"},{text:"NVC",callback_data:"nvc_btc"},{text:"LTC",callback_data:"ltc_btc"}],[{text:"DSH",callback_data:"dsh_btc"},{text:"ETH",callback_data:"eth_btc"},{text:"RUR",callback_data:"btc_rur"},{text:"EUR",callback_data:"btc_eur"}]]})},f("Символ:",i)),"OTHER"===e.text&&(i={reply_markup:JSON.stringify({inline_keyboard:[[{text:"ETH/LTC",callback_data:"eth_ltc"},{text:"ETH/EUR",callback_data:"eth_eur"},{text:"ETH/RUR",callback_data:"eth_rur"}],[{text:"LTC/RUR",callback_data:"ltc_rur"},{text:"LTC/EUR",callback_data:"ltc_eur"},{text:"EUR/RUR",callback_data:"eur_rur"}]]})},f("Пара:",i)),"Контроль"===e.text&&(i={reply_markup:JSON.stringify({keyboard:[[{text:"Скорость"},{text:"Состояние"},{text:"Модули"}],[{text:"Главное меню"}]],resize_keyboard:!0})},f("Выберите:",i)),"Нотис"===e.text&&(i={reply_markup:JSON.stringify({keyboard:[[{text:"Мониторинг"},{text:"Уведомление"}],[{text:"Круг"}],[{text:"Главное меню"}]],resize_keyboard:!0})},f("Выберите:",i)),"Мониторинг"===e.text&&(i={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Старт",callback_data:"monitoring start"},{text:"Стоп",callback_data:"monitoring stop"}]]})},g=Oe.status?"Работает.":"Остановлен.",s=["Включает мониторинг возможных торговых пар. Уведомление раз в 5 минут.","Текущие состояние: "+g],f(s.join("\n"),i)),"Уведомление"===e.text&&(i={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Старт",callback_data:"notification start"},{text:"Стоп",callback_data:"notification stop"}]]})},g=ye.status?"Работает.":"Остановлен.",s=["Включает уведомления о скачках курса.","Текущие состояние: "+g],f(s.join("\n"),i)),"Круг"===e.text&&nt(),"Тип"===e.text&&(i={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Only buy",callback_data:"type buy"},{text:"Only sell",callback_data:"type sell"},{text:"Buy & Sell",callback_data:"type all"}]]})},s=["Текущий тип торговли "+ae.toUpperCase(),"Новый тип:"],f(s.join("\n"),i)),"Сменить пару"===e.text){if("btc-e"!==t.exchange)return void f("*Этот пункт не доступен для данной биржи*");i={reply_markup:JSON.stringify({inline_keyboard:[[{text:"BTC/USD",callback_data:"trade btc_usd"},{text:"BTC/RUR",callback_data:"trade btc_rur"},{text:"BTC/EUR",callback_data:"trade btc_eur"}],[{text:"LTC/BTC",callback_data:"trade ltc_btc"},{text:"LTC/USD",callback_data:"trade ltc_usd"},{text:"LTC/RUR",callback_data:"trade ltc_rur"}],[{text:"LTC/EUR",callback_data:"trade ltc_eur"},{text:"NMC/BTC",callback_data:"trade nmc_btc"},{text:"NMC/USD",callback_data:"trade nmc_usd"}],[{text:"NVC/BTC",callback_data:"trade nvc_btc"},{text:"NVC/USD",callback_data:"trade nvc_usd"},{text:"PPC/BTC",callback_data:"trade ppc_btc"}],[{text:"PPC/USD",callback_data:"trade ppc_usd"},{text:"DSH/BTC",callback_data:"trade dsh_btc"},{text:"DSH/USD",callback_data:"trade dsh_usd"}],[{text:"ETH/BTC",callback_data:"trade eth_btc"},{text:"ETH/USD",callback_data:"trade eth_usd"},{text:"ETH/EUR",callback_data:"trade eth_eur"}],[{text:"ETH/LTC",callback_data:"trade eth_ltc"},{text:"ETH/RUR",callback_data:"trade eth_rur"},{text:"USD/RUR",callback_data:"trade usd_rur"}],[{text:"EUR/USD",callback_data:"trade eur_usd"},{text:"EUR/RUR",callback_data:"trade eur_rur"}]]})},s=["Текущая пара: *"+m()+"*","`Внимание! На новой паре должны быть средства для торгов, иначе переключение завершится ошибкой!`","Новая торгая пара:"],f(s.join("\n"),i)}return"Авто выход из пары"===e.text&&(t.oneOrdersSell?(B=0,_e=!0,s="Авто выход включен!"):s="На текущей стратегии данная функция недоступна!",f(s)),"Скорость"===e.text&&(i={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Normal",callback_data:"speed normal"},{text:"Extra",callback_data:"speed extra"}]]})},s=["Влияет на плотность стека ордеров, размер спреда и время закрытия неиспользованных ордеров","Время действия "+Se(I)+".","Текущая скорость: *"+ie+"*"].join("\n"),f(s,i)),"Состояние"===e.text&&(i={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Пауза",callback_data:"worker pause"},{text:"Продолжить",callback_data:"worker continued"}]]})},g=D?"Пауза":"Работает",f("Текущие состояние: "+g,i)),"Модули"===e.text&&(i={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Динам. время обновления "+(t.dynamicSettingsTime?"[Вкл]":"[Выкл]"),callback_data:"modules dynamic-settings-time"}],[{text:"Динам. распределение ордеров "+(t.dynamicOffsetOrders?"[Вкл]":"[Выкл]"),callback_data:"modules dynamic-offset-orders"}],[{text:"Определение тренда "+(t.trendDefinition?"[Вкл]":"[Выкл]"),callback_data:"modules trend-definition"}],[{text:"Контроль смены тренда "+(t.abruptChangeTrend?"[Вкл]":"[Выкл]"),callback_data:"modules abrupt-change-trend"}],[{text:"Стоп при большом изменении цены "+(t.dangerPriceStop?"[Вкл]":"[Выкл]"),callback_data:"modules danger-price-stop"}],[{text:"Включить все",callback_data:"modules all-modules-on"},{text:"Выключить все",callback_data:"modules all-modules-off"}],[{text:"Полосы Боллинджера "+(t.bbands?"[Вкл]":"[Выкл]"),callback_data:"modules bbands"}],[{text:"One Sell a lot Buy "+(t.oneOrdersSell?"[Вкл]":"[Выкл]"),callback_data:"modules one-orders-sell"}],[{text:"Лог "+(t.botLog?"[Вкл]":"[Выкл]"),callback_data:"modules bot-log"},{text:"Дебаг лог "+(t.logDebug?"[Вкл]":"[Выкл]"),callback_data:"modules log-debug"}]]})},f("*Модули обновления настроек:*",i)),"/info"===(null!=(d=e.text)?d.toLowerCase():void 0)&&(s=["Список команд:\n","/version - версия бота","/help - параметры которые можно менять через телеграм","/config - возможные параметры конфигурации через конфигурационный файл","/martin - теоретический расчет ордеров мартингейла (параметры берутся из конфига)"],f(s.join("\n"))),"/help"===(null!=(y=e.text)?y.toLowerCase():void 0)&&(s=["Бот на паре: "+m(),"Exchange: "+t.exchange.toUpperCase(),"TIME_UPDATE_AUTO_SETTINGS="+I+" | время обновления авто настроек параметров (в мин)","OFFSET_ORDERS_POINTS="+t.offsetOrdersPoints+" | отступ для ордеров в пунктах","OFFSET_ORDERS_PERCENT="+t.offsetOrdersPercent+" | отступ для ордеров в процентах","OFFSET_FIRST_ORDERS_PERCENT="+t.offsetFirstOrdersPercent+" | отступ первого ордера в процентах","STEP_BREAKEVEN_PERCENT="+t.stepBreakevenPercent+" | процент отступа безубытка для торгов","TIME_CLOSE_ORDERS="+t.timeCloseOrders+" | сколько минут ждать перед закрытием неисполнившихся ордеров","COUNT_ORDERS="+t.countOrders+" | количество ордеров (бот будет переазгружен)","QUANTITY_ORDERS_IN_BLOCKS="+t.quantityOrdersInBlocks+" | количество ордеров в блоке","DEPOSIT_LIMIT="+t.depositLimit+" | процент использования депозита (бот будет перезагружен)","ONE_ORDERS_SELL_PERCENT="+B+" | Задает процент желаемой прибыли","ONE_ORDERS_SELL_OFFSET="+t.oneOrdersSellOffset+" | Разница между ценой LastPrice и первым ордером buy в стеке ордеров в процентах"],f(s.join("\n\n"),{format:!1})),/(\D+)=(\d+)/.test(e.text)&&function(){var n,r,a;n=e.text.split("="),n[0]=n[0].toUpperCase(),"OFFSET_ORDERS_POINTS"!==(r=n[0])&&"TIME_UPDATE_AUTO_SETTINGS"!==r&&"OFFSET_ORDERS_PERCENT"!==r&&"OFFSET_FIRST_ORDERS_PERCENT"!==r&&"TIME_CLOSE_ORDERS"!==r&&"STEP_BREAKEVEN_PERCENT"!==r&&"DEPOSIT_LIMIT"!==r&&"COUNT_ORDERS"!==r&&"QUANTITY_ORDERS_IN_BLOCKS"!==r&&"ONE_ORDERS_SELL_PERCENT"!==r&&"ONE_ORDERS_SELL_OFFSET"!==r||(a=l.camelCase(n[0]),"ONE_ORDERS_SELL_PERCENT"===n[0]?B=+n[1]:t[a]=+n[1],console.log("SET "+n[0]+"="+n[1]),f("Настройки обновлены!"),"DEPOSIT_LIMIT"!==(r=n[0])&&"COUNT_ORDERS"!==r||(D=!0,Je(t.tradeCurrency.pair,function(e){D=!1,f("*Бот перезапущен!*")})))}(),"/martin"===(null!=(O=e.text)?O.toLowerCase():void 0)?function(){var e,n,r,l,o,i,c;return e="poloniex"===t.exchange?He(re.balance,"name"):He(re.balanceTwo,"nameTwo"),n=Z,r=!0,l=0,o=0,i=0,c=0,a.doWhilst(function(a){var s;return t.offsetFirstOrdersPercent&&r?(n-=U.first,r=!1):t.offsetOrdersExponential?(i+=t.offsetOrdersExponential,n=Pe(n,i)):n-=rt,l=e/n,t.sizeOrdersMartingale&&(o=o?1===t.martingaleType?Ie(o,t.sizeOrdersMartingale):o+W:A),s=l>o?o:l,e=(l-s)*n,c++,a(null)},function(){return l>A},function(){var t,r;return t=ve(Ne(Z,n)-100,2),r=["*Данные расчета Мартингейла*:"],1===c&&e<=0?r.push("`Недостаточно средств!`"):(r.push(["Количество ордеров: "+c,"Последняя цена: "+ve(n,ce),"*Разница между LastPrice и последним ордером: "+t+"%*"].join("\n")),0<t&&t<=2&&r.push("`Юный друг при таких настройках тебе хватит депо на "+t+"% хода цены вниз!!! очнись бля`")),f(r.join("\n\n"))})}():void 0}}),b.on("callback_query",function(e){e.from.id===t.myChatId&&(/trade (\w*_(usd|rur|eur|btc|ltc))/.test(e.data)?Ve(e.data.substr(6)):/speed (normal|extra)/.test(e.data)?Ye(e.data.substr(6)):/worker (continued|pause)/.test(e.data)?We(e.data.substr(7)):/monitoring (start|stop)/.test(e.data)?Ze(e.data.substr(11)):/notification (start|stop)/.test(e.data)?$e(e.data.substr(13)):/type (buy|sell|all)/.test(e.data)?Ke(e.data.substr(5)):/modules (\w*)/.test(e.data)?Xe(e.data.substr(8)):/close_orders_now/.test(e.data)?Ge():Qe(e.data))}),Ge=function(){f("Начато закрытие ордеров."),D=!0,L.all=1,setTimeout(function(){Tt(t.tradeCurrency.pair,function(e){var t,n;null!=e?0===e.success&&(t=null!=(n=e.error)?n.split("send:")[1]:void 0,null!=t?(p.setNonce(t),Ge()):f(x(e))):f("Активные ордера закрыты на паре: "+m()),D=!1})},o("2s"))},Ve=function(e){var n,r;f("Инициализировано изменение пары..."),D=!0,n=e.split("_")[0],r=e.split("_")[1],t.tradeCurrency.name===n&&t.tradeCurrency.nameTwo!==r?L.sell=1:t.tradeCurrency.name!==n&&t.tradeCurrency.nameTwo===r&&(L.buy=1),setTimeout(function(){Tt(t.tradeCurrency.pair,function(){t.tradeCurrency={name:n,nameTwo:r,pair:[n,r].join("_")},P=!0,dt(t.tradeCurrency.pair,function(e){var t,n;null!=e?(t=x(e),console.log(("["+O()+"]: Ошибка получения данных с сервера!\n"+t).red),n=["`Critical error: Ошибка получения данных с сервера!`","Бот поставлен на паузу, после обновления баланса необходимо перезапустить пару!","Ошибка: "+t].join("\n"),f(n),D=!0):(w=0,D=!1,f("Выполнено! Новая пара: "+m()))})})},o("5s"))},Ke=function(e){ae=e,be="all"!==e,f("Выполнено! Новый тип "+ae.toUpperCase())},Ye=function(e){var t;it(e),t=["Режим "+e.toUpperCase()+" включен.","Пара: "+m()],N=T(),console.log(("\n["+O()+"]: "+t[0]+"\n").green),f(t.join(" "))},We=function(e){var t;D="pause"===e,t=D?"Пауза":"Работает",f("Новое состояние: "+t+". Пара: "+m())},Xe=function(e){var n,r;/\all-modules/.test(e)?(n="all-modules-on"===e,t.dynamicSettingsTime=n,t.dynamicOffsetOrders=n,t.trendDefinition=n,t.abruptChangeTrend=n,t.dangerPriceStop=n,t.dynamicSettingsTime||(I=t.timeUpdateAutoSettings),f("Все модули "+(n?"включены":"выключены")+"!")):("one-orders-sell"===e&&(t.bbands=!1),"bbands"===e&&(t.oneOrdersSell=!1),r=e.replace(/\-./g,function(e,t,n){return e.replace("-","").toUpperCase()}),t[r]=!t[r],f(e.replace(/\-/g,"_").toUpperCase()+": "+t[r],{format:!1}))},Qe=function(e){p.getTicker(e,function(n,r){var a,l,o,i,c,s,u,d,p,b,_;return null!=n?f(x(n)):(a=st.pairs[e].decimal_places,l=r[e].last,o=r[e].sell,i=r[e].buy,c=ve(r[e].avg,a),s=ve(i-o,a),u=e.split("_")[1],d=Le(i,t.stepBreakevenPercent,a),p=s>d?"✔":"`✗`",b=l>c?"↑":"↓",_=[e.replace("_","/").toUpperCase()+":","sell: "+xe(u)+o,"buy: "+xe(u)+i,"last: "+xe(u)+l,"avg: "+xe(u)+c+" | "+b,"spread:   "+s+" | "+(s/d*100-100).toFixed()+"%","required: "+d+" "+p],f(_.join("\n")))})},Ze=function(e){var t;Oe.status="start"===e,clearInterval(Oe.interval),Oe.status?(t="Работает",et(),Oe.interval=setInterval(function(){et()},o("5m"))):t="Остановлен",f("Новое состояние: "+t)},$e=function(e){var t;if(null==ge||!ge.length)return void f("`Внимание! Конфиг для уведомлений не задан!`");ye.status="start"===e,clearInterval(ye.interval),ye.status?(t="Работает",tt()):t="Остановлен",f("Новое состояние: "+t)},et=function(){var e;e=ut.join("-"),a.parallel([function(t){return p.getTicker(e,function(e,n){return null!=e?t(e):t(null,n)})},function(t){return p.getTrades(e,{limit:2},function(e,n){return null!=e?t(e):t(null,n)})}],function(e,n){var r,a,l,c,s,u;if(null!=e)return r=x(e),a="Error trading pairs available: "+r,f(a),void console.log(a.red);l=["Доступные пары для торгов:\n"],c=(new Date).getTime(),s=i.range(c-o("1m"),c),u=0,ut.forEach(function(e){var r,a,o,i,c,d,p,b,_,g,m,y,O;r=e.split("_")[1],a=e.split("_")[0],o=st.pairs[e].decimal_places,i=n[0][e].last,c=n[0][e].sell,d=n[0][e].buy,p=n[0][e].vol,b=n[0][e].vol_cur,_=n[0][e].avg?n[0][e].avg:(c+d)/2,_=ve(_,o),g=ve(d-c,o),m=Le(d,t.stepBreakevenPercent,o),y=i>_?"↑":"↓",O=!n[1][e][0].timestamp||s.contains(1e3*n[1][e][0].timestamp)&&s.contains(1e3*n[1][e][1].timestamp),g>m&&O&&(u++,l.push(e.replace("_","/").toUpperCase()+"\nprice: "+d+" - "+c+"\navg:   "+_+" | "+y+"\nvol: "+b+" "+xe(a)+"\nvol:        "+p+" "+xe(r)+"\nspread:   "+ke(g)+" | "+(g/m*100-100).toFixed()+"%\nrequired: "+ke(m)+"\n")),u>=20&&(f(l.join("\n")),u=0,l=[])}),setTimeout(function(){l.length&&f(l.join("\n"))},o("2s"))})},tt=function(){var n,r;null!=ge&&ge.length&&("all_all"===ge[0]&&(ge=ut),n=ge.join("-"),r={},ye.interval=setInterval(function(){p.getTicker(n,function(n,a){var l,i,c;return null==n?(c=0,i=[],ge.forEach(function(n){var l,s,u,d,p,b,_,g,m,y,O,T,E;t.tradeCurrency.pair!==n&&e(n,ut)&&(r[n]||(l=st.pairs[n].decimal_places,s=a[n].sell,u=a[n].buy,d=a[n].last,p=a[n].vol,b=a[n].vol_cur,_=a[n].avg?a[n].avg:(s+u)/2,_=ve(_,l),g=ve(u-s,l),m=Le(s,t.notificationDeviation,l),g>m&&(c++,r[n]=!0,y=n.split("_")[1],O=n.split("_")[0],T=d<=s||d<=s+De(3,l)?"down ↓":"up ↑",E=d>_?"↑":"↓",i.push(["Уведомление "+n.replace("_","/").toUpperCase()+":","directions: "+T,"sell: "+xe(y)+s,"buy: "+xe(y)+u,"last: "+xe(y)+d,"avg: "+xe(y)+_+" | "+E,"vol: "+b+" "+xe(O),"vol: "+p+" "+xe(y),"spread: "+ke(g)+"\n"].join("\n"))),c>=15&&(f(i.join("\n")),c=0,i=[]),setTimeout(function(){r[n]=!1,r.error=!1},o("15m"))))}),setTimeout(function(){i.length&&f(i.join("\n"))},o("2s"))):(l=x(n),i="Error notification price: "+l,console.log(i.red),r.error?void 0:(f(i),r.error=!0))})},o("5s")))},nt=function(t,n){var r,a,l,o;null==t&&(t=.993),null==n&&(n=!1),r={},a={},l={},o={},ut.forEach(function(e){var t;t=e.split(/\s*_\s*/),r[t[0]]?r[t[0]].push(t[1]):r[t[0]]=[t[1]]}),p.getTicker(ut.join("-"),function(i,c){var s,u,d,p;return null!=i?(s=x(i),
f("Error: "+s)):(ut.forEach(function(e){a[e]=Fe(1,c[e].buy)}),ut.forEach(function(e){var t;t=e.split(/\s*_\s*/),r[t[0]].forEach(function(n){n!==t[1]&&(l[t[1]+"_"+t[0]+"_"+n]=je(a[e],c[t[0]+"_"+n].sell))})}),Object.keys(l).forEach(function(n){var r,a;r=n.split(/\s*_\s*/),e(r[0]+"_"+r[2],ut)&&(a=Fe(l[n],c[r[0]+"_"+r[2]].buy)),e(r[2]+"_"+r[0],ut)&&(a=je(l[n],c[r[2]+"_"+r[0]].buy)),a>t&&(o[n+"_"+r[0]]=ve(a,5))}),u=["Проверка возможных вариантов перепродаж.","Показаны значения больше: "+t,"Значения меньше 1 убыточны:\n"],d=[],Object.keys(o).forEach(function(e){d.push([e.replace(/\_/g,"->"),o[e]])}),d.length?(p=d.sort(function(e,t){return t[1]-e[1]}),p.forEach(function(e){u.push(e.join(": "))})):u.push("Нет подходящих вариантов"),!n||d.length?f(u.join("\n")):void 0)})},it=function(e){var n;null!=e&&(n=e),n||(n=w>pe?"extra":"normal"),w=0,"extra"===n?(rt=U.extra,at=U.extra,ot=j,lt=60*t.timeCloseOrdersExtra):(rt=U.buy,at=U.sell,ot=F,lt=60*t.timeCloseOrders),ie=n},ct=0,dt=function(e,t){return p.getInfo(function(n,r){if(null!=n)return t(n);try{st=r,ut=Object.keys(r.pairs),ce=r.pairs[e].decimal_places,de=r.pairs[e].min_amount,se=r.pairs[e].min_price,ue=r.pairs[e].fee}catch(e){t("Not valid pair")}return Je(e,function(n){var r,a;return n?(r=null!=(a=n.error)?a.split("send:")[1]:void 0,null!=r?(p.setNonce(r),dt(e,t)):(ct++,ct>5?(ct=0,t(n)):dt(e,t))):t(null)})})},pt=function(e,t){return p.getTicker(e,function(n,r){var a,l,o,i;return null!=n?t(n):(a=r[e].last,l=r[e].sell,o=r[e].buy,i=ve(o-l,ce),X=ot<=De(2)?i>=ot:i>ot,t(null,{lastPrice:a,bidPrice:l,askPrice:o,spread:i}))})},bt=function(e,n){return X?p.balanceRequest(e,function(e,r,a){return null!=e?n(e):(r=He(r,"name"),a=He(a,"nameTwo"),"all"===ae?r<de&&a<de?Q<t.ecoCountCycle&&Q++:Q>0&&(Q=0):Q=t.ecoCountCycle,n(null,{balance:r,balanceTwo:a}))}):n(null)},ft=function(e){return p.ordersRequest(t.tradeCurrency.pair,function(n,r){var a,o;return V=null!=r?r:{},t.quantityOrdersInBlocks&&(Y=l.size(V)),a=l.findKey(V,["type","sell"]),a&&ve(G.amount-1e-7,8)>V[a].amount&&(console.log("SELL partially executed"),t.logDebug&&(o=[Ee,"Старый sell: "+ve(G.amount-1e-7,8)+"  Новый sell: "+V[a].amount,"Продано: "+ve(ve(G.amount-1e-7,8)-V[a].amount,8)+" "]),J=V,G.amount=V[a].amount,J["0000000001"]={rate:G.priceBuy,amount:G.amount},delete J[a],M={buy:0,sell:0},z={buy:0,sell:0},t.logDebug&&(o.push("Новый кэш: "+J),console.log(o.join("\n")))),K=!1,!a&&G.id&&(console.log("SELL executed!"),L.buy=1,K=!0,G={},J={},R=0,M={buy:0,sell:0},q={buy:0,sell:0},z={buy:0,sell:0},_e&&(D=!0,_e=!1,B=t.oneOrdersSellPercent,Tt(t.tradeCurrency.pair,function(){f("*Авто выход завершен!\nБот поставлен на паузу!*")}))),e(null)})},_t=0,gt=0,mt=function(e,n,r,o,i){var c;return c="poloniex"===t.exchange?n*r<t.poloniexMinOrders:n<de,c?i(null):0===l.size(J)?i(null):fe?i(null):a.series([function(e){return L.sell=1,Tt(o,e)},function(e){var r,a,o,i,c,s,u,d,p;return r=[],a=l.keys(V),o=l.keys(J),i=l.difference(o,a),t.logDebug&&r.push([Ee,"Открытые ордера: "+a,"В кэше: "+o,"Купленные: "+i].join("\n")),c=0,s=0,u=0,i.forEach(function(e){u++,c+=+J[e].amount,s+=+J[e].amount*+J[e].rate,t.logDebug&&r.push("Ордер "+u+": "+e+"  Количество: "+ +J[e].amount+"  Цена: "+ +J[e].rate)}),u>0?(G.priceBuy=s/c,t.logDebug&&r.push(["Сумма: "+s+"  Общий объем: "+c,"Средняя цена покупки: "+G.priceBuy].join("\n")),d=Ie(s,2.5*ue+B)/c,t.logDebug&&r.push(["Коммисия: "+ue+"  Процент юзера: "+B+"   Общий процент: "+(2*ue+B),"Увеличенная сумма на процент: "+Ie(s,2*ue+B),"Цена продажи: "+d].join("\n")),p=l.findKey(V,["type","sell"]),t.logDebug&&r.push(["Сумма с баланса биржи: "+n,p?"Сумма на открытом ордере SELL: "+V[p].amount:void 0].join("\n")),p&&(n+=V[p].amount),gt&&(t.logDebug&&r.push("Уменьшить сумму "+n+" на "+gt+"%"),n=Pe(n,gt)),t.logDebug&&(r.push("Общая сумма продажи: "+n),console.log(r.join("\n"))),G.amount=n,e(null,{rate:d})):e(null,{rate:0})}],function(a,l){return null!=a?i(a):l[1].rate>0?Ot(e,l[1].rate,n,o,function(a){return null!=a?(_t++,_t>5?(_t=0,i(a)):(t.logDebug&&console.log("Попытка установить SELL №: "+_t+"}"),gt=.1,mt(e,n,r,o,i))):(_t=0,gt=0,i(null))}):i(null)})},yt=function(e,n,r,o,i){var c,s,u,d;if(n<de)return i(null);if(fe)return i(null);if(t.quantityOrdersInBlocks){if(t.quantityOrdersInBlocks<=Y)return i(null);c=!0}return s=!0,H={buy:-1,sell:-1},"all"===ae||ae===e?n>=A?(void 0!==u&&null!==u||(u=r),a.doWhilst(function(a){var i,d;return le?("sell"===e&&(u-=at),"buy"===e&&(u+=rt),n/=2,Ot(e,u,n,o,a)):("buy"===e?((v||c)&&(v=!1,c=!1,l.isEmpty(V)||(s=!1,"object"==typeof(i=Re(V,"min"))&&i.rate<r&&(u=i.rate))),t.offsetFirstOrdersPercent&&s?(u-=U.first,s=!1):t.offsetOrdersExponential?(z[e]=z[e]+t.offsetOrdersExponential,u=Pe(u,z[e])):u-=rt,n=-1===H.buy?n:H.buy/u):(t.offsetFirstOrdersPercent&&s?(u+=U.first,s=!1):t.offsetOrdersExponential?(z[e]=z[e]+t.offsetOrdersExponential,u=Ie(u,z[e])):u+=at,n=-1===H.sell?n:H.sell),t.sizeOrdersMartingale?(M[e]?M[e]=1===t.martingaleType?Ie(M[e],t.sizeOrdersMartingale):M[e]+W:M[e]=A,q[e]&&(M[e]=q[e],q[e]=0),d=n>M[e]?M[e]:n):d=n>A?A:n,Ot(e,u,d,o,a))},function(){return!(t.quantityOrdersInBlocks&&t.quantityOrdersInBlocks<=Y)&&n>A},function(e){return i(null!=e?e:null)})):(t.oneOrdersSell&&"buy"===e&&"object"==typeof(d=Re(V,"min"))&&d.rate<r&&(r=d.rate),t.offsetOrdersPercent&&("sell"===e&&(r+=at),"buy"===e&&(r-=rt)),t.offsetOrdersExponential&&(z[e]=z[e]+t.offsetOrdersExponential,"sell"===e&&(r=Pe(r,z[e])),"buy"===e&&(r=Ie(r,z[e]))),t.dynamicOffsetOrders&&("sell"===e&&(r+=De(1)),"buy"===e&&(r-=De(1))),Ot(e,r,n,o,i)):i(null)},Ot=function(e,n,r,a,o){var i;return n=ve(n,ce),n>=se||(n=se),r=ve(r-1e-7,8),i="poloniex"===t.exchange?r*n<t.poloniexMinOrders:r<de,i?o(null):p.tradeSetOrder(a,e,n,r,function(a,i){var c,s,u;return null!=a?(t.sizeOrdersMartingale&&(q[e]=M[e]),v=!0,c=x(a),console.log(("["+O()+"]: Error: "+c+" | "+e+" | rate: "+n+" | amount: "+r).red),o(a)):(s="["+O()+"]: Open: "+e+" | rate: "+n+" | amount: "+r,t.oneOrdersSell&&(u=0==i.order_id?l.random(1e8,2e8).toString():i.order_id,"buy"===e?(J[u]={rate:n,amount:r},t.quantityOrdersInBlocks&&Y++):G.id=u),"buy"===e?H.buy="poloniex"===t.exchange?He(i.funds[t.tradeCurrency.name],"name"):He(i.funds[t.tradeCurrency.nameTwo],"nameTwo"):H.sell="poloniex"===t.exchange?He(i.funds[t.tradeCurrency.nameTwo],"nameTwo"):He(i.funds[t.tradeCurrency.name],"name"),console.log("buy"===e?s.green:s.yellow),w++,o(null))})},Tt=function(e,t){return p.ordersRequest(e,function(e,n){var r,l,o;return R=T(),null!=e?0===e.success&&null==(null!=(r=e.error)?r.split("send:")[1]:void 0)?(l=x(e),console.log(("["+O()+"] Cancel orders: "+l).yellow),t(null)):t(e):(o=Object.keys(n),a.eachSeries(o,function(e,t){return null!=L.buy&&"sell"===n[e].type?t(null):null!=L.sell&&"buy"===n[e].type?t(null):R-n[e].timestamp_created>(L.buy||L.sell||L.all||60)?Et(e,n[e].type,n[e].amount,n[e].rate,t):t(null)},function(e){return L={all:null,buy:null,sell:null},t(null!=e?e:null)}))})},Et=function(e,n,r,a,l){return p.tradeCancelOrder({order_id:e},function(o,i){return null!=o?l(o):(t.oneOrdersSell&&delete J[e],console.log(("["+O()+"]: Close: "+n+" | rate: "+a+" | amount: "+r).cyan),w>0&&w--,l(null))})},xt=function(){be||Ce(R,t.timeCloseOrdersInactivity)&&Tt(t.tradeCurrency.pair,function(e){null!=e&&console.log("["+O()+"]: Orders inactivity: "+x(e))})},Ct=function(){var e;Ce(h,10)&&(e="Unknown error: Worker does not meet!",console.log(("["+O()+"]: "+e).red),vt({error:e}))},St=function(){h=T(),D?setTimeout(function(){St()},o("30s")):a.series([function(e){return pt(t.tradeCurrency.pair,e)},function(e){return bt(t.tradeCurrency,e)}],function(e,n){var r;null!=e?(r=x(e),console.log(("Error: "+r).red),vt(e)):(P&&(ze(n[0].askPrice,n[0].bidPrice,n[0].lastPrice),P=!1),X?a.series([function(e){return I>0&&h-N>60*I&&ze(n[0].askPrice,n[0].bidPrice,n[0].lastPrice),e(null)},function(e){return h-R>lt?Tt(t.tradeCurrency.pair,e):e(null)},function(e){return t.botTrade&&C&&t.oneOrdersSell?l.delay(ft,o("2s"),e):e(null)},function(e){var r,a;return t.oneOrdersSell&&K?e(null):t.botTrade&&C?(r=le?oe.ask:n[0].askPrice,a="poloniex"===t.exchange?n[1].balanceTwo:n[1].balance,t.oneOrdersSell?mt("sell",a,r,t.tradeCurrency.pair,e):(M.sell=0,z.sell=0,yt("sell",a,r,t.tradeCurrency.pair,e))):e(null)},function(e){var r,a;return t.oneOrdersSell&&K?e(null):t.botTrade&&C?(r=le?oe.bid:n[0].bidPrice,a="poloniex"===t.exchange?n[1].balance/r:n[1].balanceTwo/r,t.oneOrdersSell?v||Y||(M.buy=0,z.buy=0):(M.buy=0,z.buy=0),yt("buy",a,r,t.tradeCurrency.pair,e)):e(null)}],function(e){var n;null!=e?(n=x(e),console.log(("ErrorTrader: "+n).red),vt(e)):Q===t.ecoCountCycle?setTimeout(function(){St()},o("2s")):St()}):setTimeout(function(){St()},o("5s")))})},vt=function(e){var n,r,a,l;n="restart after "+parseInt(t.restartTraderTime)+" sec ...",console.log("["+O()+"]: "+n),r=null!=(a=e.error)?a.split("send:")[1]:void 0,null==r&&(l=x(e),S.count++,S.text!==l&&(S.text=l,t.emailS&&"production"===process.env.NODE_ENV&&g(y(l+"\n\n"+n),function(e,t){})),t.notificationErrorCount&&S.count>t.notificationErrorCount&&(f("`Слишком много ошибок API. Требуется внимание пользователя!`"),S.count=0)),setTimeout(function(){console.log(("["+O()+"]: trader restart").bgGreen),null!=r&&p.setNonce(r),St()},o(parseInt(t.restartTraderTime)+"s"))},function(){if(!t.myChatId)return void console.log("Get the user id in the Telegram".yellow);console.log("["+O()+"]: Trader Bot starting..."),console.log("["+O()+"]: Exchange: "+t.exchange.toUpperCase()+" | v."+t.versionBot),dt(t.tradeCurrency.pair,function(e){var n;return null!=e&&(n=x(e),console.log(("["+O()+"]: Error getting parameters from the server!\n"+n).red),process.exit(0)),St(),t.botTrade&&setInterval(function(){xt(),Ct(),S.count=0},o("5m")),setInterval(function(){Ae()},o(10*t.bbandsInterval+"s")),"production"===process.env.NODE_ENV&&f("Trader Bot started. Pair "+m()),console.log("["+O()+"]: Trader Bot started")})}()}).call(this);