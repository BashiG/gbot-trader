(function(){function fb(a,b){for(var c=-1,d=b.length>>>0;++c<d;)if(a===b[c])return!0;return!1}var a,b,c,d,e,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,aa,ba,ca,da,ea,fa,ga,ha,ia,ja,ka,la,ma,na,oa,pa,qa,ra,sa,ta,ua,va,wa,xa,ya,za,Aa,Ba,Ca,Da,Ea,Fa,Ga,Ha,Ia,Ja,Ka,La,Ma,Na,Oa,Pa,Qa,Ra,Sa,Ta,Ua,Va,Wa,Xa,Ya,Za,$a,_a,ab,bb,cb,db;if(a=require("./conf"),b=require("./api-btc-e"),c=require("./api-poloniex"),d=require("async"),e=require("lodash"),require("colors"),g=require("ms"),h=require("moment"),i=require("moment-range"),j=require("nodemailer"),k=require("node-telegram-bot-api"),l=require("ta-lib"),h=i.extendMoment(h),!a.tokenTelegram)return void console.log("There is no token Telegram!".red);m="poloniex"===a.exchange?new c:new b,n=new k(a.tokenTelegram,{polling:!0}),o=function(b,c){b.length>4096&&(b="Слишком много информации для отображения"),b.length||(b="Error: Не удалось обработать ошибку"),n.sendMessage(a.myChatId,b,c)},p=j.createTransport(a.email),q=function(a,b){return p.sendMail(a,b)},r=function(){return a.tradeCurrency.pair.replace("_","/").toUpperCase()},s=function(b){return{from:a.email.auth.user,to:a.email.reportEmail,subject:"Error Script Trader",text:"time: "+(new Date).toString()+"\nPair: "+r()+"\n\nmessage: "+b+"\n\n---"}},t=function(){return(new Date).toLocaleTimeString("en-US",{timeZone:a.timeZone,hour12:!1})},u=function(){return Math.round((new Date).getTime()/1e3)},v=function(a){var b;return b="",Object.keys(a).forEach(function(c){if(a.hasOwnProperty(c))return b+=c+" :: "+a[c]+"\n"}),b},w=function(a){return"object"==typeof a?a.hasOwnProperty("error")?a.error:a.hasOwnProperty("message")?a.message:v(a):a},x=!0,y=null,z={name:0,nameTwo:0},A=u(),B=u(),C=u(),D=a.timeUpdateAutoSettings,E=!0,F=!1,G=0,H={all:null,buy:null,sell:null},I={extra:0,buy:0,sell:0},J=0,K=0,L=0,M={buy:0,sell:0},N=!1,O=0,P=0,Q=0,R=0,S=[],T=[],U="all",V=!1,W={ask:0,bid:0},X="normal",Y=0,Z=0,$=0,_=0,aa=0,ba=!1,ca=!1,da=null!=(ea=a.notificationPair)?ea.toLowerCase().replace(/\//g,"_").split(/\s*,\s*/):void 0,fa={spread:!1,eco:!1},ga={status:!1,interval:!1},ha={status:!1,interval:!1},ia={btc:"฿",usd:"$",eur:"€",rur:"₽",ltc:"L"},ja="-----------------------------------",ka=function(a){return ia.hasOwnProperty(a)?ia[a]:a+" "},la=function(a,b){return u()-a>=60*b},ma=function(a,b){var c,d,e;return null!=b&&(c=b),c||(c=a>=1?["минута","минуты","минут"]:["секунда","секунды","секунд"],a=a<1?60*a:a),d=[2,0,1,1,1,2],e=c[a%100>4&&a%100<20?2:d[a%10<5?a%10:5]],a+" "+e},na=function(a,b){return null==b&&(b=3),+(+a).toFixed(b)},oa=function(a){return a.toFixed(10).replace(/(.*0\.0*[1-9]*)0+\d*/g,"$1")},pa=function(a,b){return b>0?+(100*a/b).toFixed(1):0},qa=function(a,b){return null==b&&(b=Y),na(a/+("1e"+b),b)},ra=function(a,b){return null==b&&(b=Y),na(a*+("1e"+b),b)},sa=function(a,b,c){var d,e,f;return null==b&&(b=0),null==c&&(c=Y),d=a/100*$*2,e=Math.ceil(d*+("1e"+c))/+("1e"+c),f=e*(1+b/100),na(f,c)},ta=function(a,b){return na(a/100*(100+b),Y)},ua=function(a,b){return na(100*a/(100+b),Y)},va=function(a,b){return a/b*(1-$/100)},wa=function(a,b){return a*b*(1-$/100)},xa=function(){a.bbands&&R>0&&(T.push(R),T.length>30&&T.splice(0,1))},ya=function(a,b){var c,d,e;return null==b&&(b=1),c=a.toString().split(".")[0],d=a.toString().split(".")[1].length,e=c>0?c>1e4?+("1e"+(d+1)):c>1e3?+("1e"+d):c>100?+("1e"+(d-1)):c>10?+("1e"+(d-2)):d>3?+("1e"+(d-3)):1:1,b*=e,na(b/+("1e"+d),d)},za=function(b,c,d){var f,g,h,i,j,k,m,n,p,q,s,v,w,y,z,A,L,M,N,O,da,ea,fa,ga,ha,ia,ka,la,ma,qa,va,wa,xa,za;if(C=u(),H={buy:null,sell:null},f=b.toString().length,g=c.toString().length,i={},i[f+""]=b,i[g+""]=c,h=i,j=Math.max(f,g),k=h[j],Y=Ta.pairs[a.tradeCurrency.pair].decimal_places,_=Ta.pairs[a.tradeCurrency.pair].min_amount,Z=Ta.pairs[a.tradeCurrency.pair].min_price,$=Ta.pairs[a.tradeCurrency.pair].fee,m=na(b-c,Y),n=sa(k,200),a.dynamicSettingsTime&&(S.push(d),S.length>50&&S.splice(0,1),p=e.max(S),q=e.min(S),a.botLog&&console.log([ja,"price-array:","length: "+S.length,"max: "+p,"min: "+q,"change-time-settings: "+(pa(p,q)>102)].join("\n")),pa(p,q)>102?D=.1:D!==a.timeUpdateAutoSettings&&(D=a.timeUpdateAutoSettings)),a.abruptChangeTrend&&(s=sa(k,500)),a.dangerPriceStop&&(v=ta(Q,9),w=ua(P,9)),a.dynamicOffsetOrders&&(y={current:sa(k,450),prev:sa(k,380),prev_2:sa(k,300)},z=m>=y.current||m>=y.prev||m>=y.prev_2),a.dynamicOffsetOrders&&z?(console.log("["+t()+"]: Dynamic market"),A=ra(y.current),L=1.3*A,M=1.5*a.stepBreakevenPercentConfig):(A=a.offsetMaxOneConfig,L=a.offsetMaxTwoConfig,M=a.stepBreakevenPercentConfig),J=sa(k,M),a.botLog&&(console.log(ja),console.log("current-spread:",(oa(m)+"")[m>J?"green":"white"]),console.log("spread-min-default:",oa(J)),console.log("trend-spread:",oa(n)),a.abruptChangeTrend&&console.log("immediate-spread:",s),console.log("trader-speed:",X),console.log("price-prev:",Q+" - "+P),console.log("price-prev2:",W.ask+" - "+W.bid),a.dangerPriceStop&&(console.log("danger-price-ask:",v,!E&&b>=v?"Attention!".red:""),console.log("danger-price-bid:",w,!E&&c<=w?"Attention!".red:"")),a.dynamicOffsetOrders&&(console.log("spread_1_450:",y.current,m>=y.current?"Attention!".red:""),console.log("spread_2_380:",y.prev,m>=y.prev?"Attention!".red:""),console.log("spread_3_300:",y.prev_2,m>=y.prev_2?"Attention!".red:""),console.log("dynamic-market:",z))),a.dangerPriceStop&&!E&&(b>=v||c<=w))return b>=v&&(H.buy=1),B=0,F=!0,N="DANGER PRICE: "+b+" - "+c+" | Bot Pause!",console.log("["+t()+"]: "+N),void o(N+"");O=2,da=G>Math.round(aa/2)?L:A,a.botLog&&(console.log("offset-max-one:",(A+"")[A===a.offsetMaxOneConfig?"green":"yellow"]),console.log("offset-type-max:",da),console.log(ja)),ba||(U="all",V=!1),E?ea=fa=da:a.bbands?(ea=fa=da,J=0,D=.1,ga=14,T.length>2*ga&&(i=l.BBANDS(T,20,a.bbandsDeviation),ha=i.middleband,ia=i.lowband,ka=i.highband,la=l.RSI(e.clone(T).reverse(),ga),ma=l.average(la).mean,qa=l.average(ha).mean,va=l.average(ka).mean,wa=l.average(ia).mean,xa=va>d&&d>qa,za=qa>d&&d>wa,xa&&(U="sell"),za&&(U="buy"),x=99>ma&&ma>68||1<ma&&ma<33,ca=xa&&za,a.botLog&&console.log(["BBANDS:","highband: "+va,"middleband: "+qa,"lowband: "+wa,"rsa: "+ma,"sell: "+xa,"buy: "+za,"bot trade: "+x,"orders-calculation-brake: "+ca,ja].join("\n")))):a.trendDefinition&&c>P&&b>Q&&m>n&&"normal"===X?(console.log("["+t()+"]: Trend: UP"),ea=O,fa=da,ba||(U="buy",H.sell=1,B=0,a.abruptChangeTrend&&m>s&&(console.log("["+t()+"]: Spread Immediate"),V=!0,C=0))):a.trendDefinition&&c<P&&b<Q&&m>n&&"normal"===X?(console.log("["+t()+"]: Trend: DOWN"),ea=da,fa=O,ba||(U="sell",H.buy=1,B=0,a.abruptChangeTrend&&m>s&&(console.log("["+t()+"]: Spread Immediate"),V=!0,C=0))):ea=fa=da,W={ask:Q,bid:P},P=c,Q=b,R=d,K=sa(k),I={buy:ya(k,ea),sell:ya(k,fa),extra:ya(k)},Ra(),console.log("["+t()+"]: Update: "+U.toUpperCase()+" | "+b+" - "+c+" | "+d+" | "+r())},Aa=function(a,b){var c,d;return c="name"===b?z.name:z.nameTwo,d=na(a-na(c,2),8),d>0?d:0},Ba=function(b,c){return E?d.parallel([function(c){return a.botLog&&console.log(ja+"\nПолучение цен"),m.getTicker(b,function(d,e){return null!=d?(a.botLog&&(console.log("Price: "+e[b].buy),console.log(w(d))),c(d)):c(null,{price:e[b].buy})})},function(c){return d.series([function(c){return a.botLog&&console.log(ja+"\nЗакрытие всех позиций"),H.all=1,$a(b,function(a){return c(null!=a?a:null)})},function(b){return a.botLog&&console.log(ja+"\nПолучение баланса"),m.balanceRequest(a.tradeCurrency,function(c,d,e){return null!=c?(a.botLog&&(console.log("balance: "+d+" | balance-two: "+e),console.log(w(c))),b(c)):a.botTrade&&d<("btc"===a.tradeCurrency.name.toLowerCase()?.01:.1)&&e<("btc"===a.tradeCurrency.nameTwo.toLowerCase()?.01:.1)?(a.botLog&&console.log("balance: "+d+" | balance-two: "+e),b({error:"Err: No money!"})):b(null,{balance:d,balanceTwo:e})})}],function(a,b){return null!=a?c(a):c(null,{balance:b[1].balance,balanceTwo:b[1].balanceTwo})})}],function(b,d){var e,f,g,h,i,j,k,l,m,n,o,p,q;return null!=b?c(b):(a.botLog&&console.log(ja+"\nРасчет депозита"),e=0<(f=a.depositPercent)&&f<100?a.depositPercent:100,"poloniex"===a.exchange?(g=na(d[1].balanceTwo*d[0].price+d[1].balance),h=na(d[1].balance/d[0].price+d[1].balanceTwo)):(g=na(d[1].balanceTwo/d[0].price+d[1].balance),h=na(d[1].balance*d[0].price+d[1].balanceTwo)),i=na(g*e/100),j=na(h*e/100),na(d[1].balance)>=i&&na(d[1].balanceTwo)>=j?(a.botLog&&console.log("type:",1),k=d[1].balance-i/2,l=d[1].balanceTwo-j/2):na(d[1].balance)>=i&&na(d[1].balanceTwo)<j?(a.botLog&&console.log("type:",2),k="poloniex"===a.exchange?d[1].balance-(j-d[1].balanceTwo)*d[0].price:d[1].balance-(j-d[1].balanceTwo)/d[0].price,l=0):na(d[1].balance)<i&&na(d[1].balanceTwo)>=j?(a.botLog&&console.log("type:",3),k=0,l="poloniex"===a.exchange?d[1].balanceTwo-(i-d[1].balance)/d[0].price:d[1].balanceTwo-(i-d[1].balance)*d[0].price):100!==e&&na(d[1].balance)<i&&na(d[1].balanceTwo)<j?(a.botLog&&console.log("type:",4),"poloniex"===a.exchange?(k=d[1].balance-(j-d[1].balanceTwo)*d[0].price,l=d[1].balanceTwo-(i-d[1].balance)/d[0].price):(k=d[1].balance-(j-d[1].balanceTwo)/d[0].price,l=d[1].balanceTwo-(i-d[1].balance)*d[0].price)):(a.botLog&&console.log("type:",5),k=0,l=0),a.botLog&&(m=pa(k,d[1].balance),n=pa(l,d[1].balanceTwo),console.log(["reserved-deposit:",a.tradeCurrency.name.toUpperCase(),m+"% / "+n+"%",a.tradeCurrency.nameTwo.toUpperCase()].join(" "))),z={name:k>0?k:0,nameTwo:l>0?l:0},a.countOrders?a.countOrders>=6||(a.countOrders=6):(o="poloniex"===a.exchange?j:i,a.countOrders=o<=200?15:o<=500?18:o<=1e3?21:25),p="poloniex"===a.exchange?1e-4/d[0].price:_,q=o>6?a.countOrders:Math.round(a.countOrders/2),aa=q*a.multiplierOrdersExtra,L=(f=na(o/q))>p?f:p,a.botLog&&console.log([ja+"\nРасчет переменных","balance: "+na(d[1].balance)+" "+a.tradeCurrency.name.toUpperCase(),"balance-two: "+na(d[1].balanceTwo)+" "+ka(a.tradeCurrency.nameTwo),"deposit: "+g+" "+a.tradeCurrency.name.toUpperCase()+" или "+h+" "+a.tradeCurrency.nameTwo.toUpperCase(),"percent-deposit: "+a.depositPercent+" %","trade-deposit: "+i+" "+a.tradeCurrency.name.toUpperCase()+" | "+j+" "+a.tradeCurrency.nameTwo.toUpperCase(),"reserved-deposit: "+na(z.name)+" "+a.tradeCurrency.name.toUpperCase()+" | "+na(z.nameTwo)+" "+a.tradeCurrency.nameTwo.toUpperCase(),"count-orders: "+q,"size-static-order: "+L,ja].join("\n")),c(null))}):c(null)},n.on("message",function(b){var c,f,h,i,j,k,l,p,q,s,t;if(c=b.chat.id,a.myChatId||n.sendMessage(c,"Install your Telegram id: "+c),c===a.myChatId&&("Ордера"===b.text&&(f=function(){d.series([function(b){return m.balanceRequest(a.tradeCurrency,function(a,c,d){return null!=a?b(a):b(null,{balance:c,balanceTwo:d})})},function(b){return m.ordersRequest(a.tradeCurrency.pair,function(a,c){return null!=a?b(a):b(null,{data:c})})}],function(b,c){var d,g,h,i,j,k,l,n,p,q,s,t;d=[r()+":",ja],g="Balance: "+(null!=(h=c[0])?h.balance.toFixed(3):void 0)+" "+a.tradeCurrency.name.toUpperCase()+" | "+ka(a.tradeCurrency.nameTwo)+(null!=(i=c[0])?i.balanceTwo.toFixed(3):void 0),null!=b?0===b.success?(j=null!=(k=b.error)?k.split("send:")[1]:void 0,null!=j?(m.setNonce(j),f()):(l=w(b),d.push(l+"\n"+ja+"\n"+g),o(d.join("\n")))):o(b):(n={},p=0,q=0,s={},Object.keys(c[1].data).forEach(function(b){var d,e,f;d=c[1].data[b].rate*+("1e"+Y),null!=s[d]?(++n[d],e=" | "+n[d],f=na(na(s[d].split("|")[1].trim())+na(c[1].data[b].amount)),s[d]=c[1].data[b].type+" | "+f+" | "+ka(a.tradeCurrency.nameTwo)+c[1].data[b].rate+e):(n[d]=1,s[d]=c[1].data[b].type+" | "+na(c[1].data[b].amount)+" | "+ka(a.tradeCurrency.nameTwo)+c[1].data[b].rate),p+=c[1].data[b].amount,q+=c[1].data[b].amount*c[1].data[b].rate}),d=e.concat(d,e.values(s)),d.push(ja+"\nCount: "+na(p)+" | Sum: "+ka(a.tradeCurrency.nameTwo)+na(q)+"\n"+g),t=d.join("\n"),o(t))})})(),"История"===b.text&&(h=function(){m.tradeGetHistory(a.tradeCurrency.pair,10,function(b,c){var d,e,f;return null!=b?0===b.success?(d=null!=(e=b.error)?e.split("send:")[1]:void 0,null!=d?(m.setNonce(d),h()):o(w(b))):o(w(b)):(f=[],Object.keys(c).forEach(function(b){f.push(c[b].type+" | "+c[b].amount.toFixed(3)+" | "+ka(a.tradeCurrency.nameTwo)+c[b].rate)}),f.push(r()+":\n"+ja),f.reverse(),o(f.join("\n")))})})(),"Закрыть активные ордера"===b.text&&(i=function(){F=!0,H.all=1,setTimeout(function(){$a(a.tradeCurrency.pair,function(a){var b,c;null!=a?0===a.success&&(b=null!=(c=a.error)?c.split("send:")[1]:void 0,null!=b?(m.setNonce(b),i()):o(w(a))):o("Активные ордера закрыты на паре: "+r()),F=!1})},g("2s"))})(),"/config"===(null!=(j=b.text)?j.toLowerCase():void 0)&&(k=["Бот на паре "+r(),"TIME_UPDATE_AUTO_SETTINGS: "+D+" | время обновления авто настроек параметров (в мин)","DEPOSIT_LIMIT: "+a.depositPercent+" | процент использования депозита","NOTIFICATION_PAIR: "+a.notificationPair+" | пары для уведомления","NOTIFICATION_DEVIATION_PERCENT: "+a.notificationDeviation+" | процент отклонения от текущей цены чтобы сработало уведомление","COUNT_ORDERS: "+a.countOrders+" | количество ордеров","TIME_CLOSE_ORDERS: "+a.timeCloseOrdersDefault+" | сколько минут ждать перед закрытием неисполнившихся ордеров","TIME_CLOSE_ORDERS_INACTIVITY: "+a.timeCloseOrdersInactivity+" | закрытие после бездействия","OFFSET_MAX_ONE: "+a.offsetMaxOneConfig+" | отступ для 1 типа ордеров","OFFSET_MAX_TWO: "+a.offsetMaxTwoConfig+" | отступ для 2 типа ордеров","STEP_BREAKEVEN_PERCENT: "+a.stepBreakevenPercentConfig+" | процент отступа безубытка для торгов","DANGER_PRICE_STOP: "+a.dangerPriceStop+" | остановка бота при большом изменении цены","DYNAMIC_SETTINGS_TIME: "+a.dynamicSettingsTime+" | динамическое время обновления настроек","DYNAMIC_OFFSET_ORDERS: "+a.dynamicOffsetOrders+" | динамическое распределение ордеров","TREND_DEFINITION: "+a.trendDefinition+" | определение тренда","ABRUPT_CHANGE_TREND: "+a.abruptChangeTrend+" | быстрое изменение направления тренда","BBANDS: "+a.bbands+" | полосы Боллинджера","BBANDS_DEVIATION: "+a.bbandsDeviation+" | Отклонение","BBANDS_INTERVAL: "+a.bbandsInterval+" | Таймфрейм (в мин)","EXCHANGE: "+a.exchange+" | Выбор биржи btc-e or poloniex","POLONIEX_FEE: "+a.poloniexFee+" | Комиссия на сделки биржи POLONIEX"],o(k.join("\n\n"))),"/version"===(null!=(l=b.text)?l.toLowerCase():void 0)&&o("Версия бота: "+a.versionBot),a.masterWorker)){if("/start"!==(p=null!=(q=b.text)?q.toLowerCase():void 0)&&"главное меню"!==p||(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({keyboard:[[{text:"Ордера"},{text:"Котировки"},{text:"История"}],[{text:"Контроль"},{text:"Нотис"},{text:"Торговля"}],[{text:"Закрыть активные ордера"}]],resize_keyboard:!0})},o("Выберите:",s)),"Котировки"===b.text){if("btc-e"!==a.exchange)return void o("Этот пункт не доступен для данной биржи");s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({keyboard:[[{text:"USD"},{text:"BTC"},{text:"OTHER"}],[{text:"Главное меню"}]],resize_keyboard:!0})},o("Валюта:",s)}if("Торговля"===b.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({keyboard:[[{text:"Сменить пару"},{text:"Тип"}],[{text:"Главное меню"}]],resize_keyboard:!0})},o("Выберите:",s)),"USD"===b.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"NMC",callback_data:"nmc_usd"},{text:"PPC",callback_data:"ppc_usd"},{text:"NVC",callback_data:"nvc_usd"},{text:"LTC",callback_data:"ltc_usd"},{text:"BTC",callback_data:"btc_usd"}],[{text:"DSH",callback_data:"dsh_usd"},{text:"ETH",callback_data:"eth_usd"},{text:"EUR",callback_data:"eur_usd"},{text:"RUR",callback_data:"usd_rur"}]]})},o("Символ:",s)),"BTC"===b.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"NMC",callback_data:"nmc_btc"},{text:"PPC",callback_data:"ppc_btc"},{text:"NVC",callback_data:"nvc_btc"},{text:"LTC",callback_data:"ltc_btc"}],[{text:"DSH",callback_data:"dsh_btc"},{text:"ETH",callback_data:"eth_btc"},{text:"RUR",callback_data:"btc_rur"},{text:"EUR",callback_data:"btc_eur"}]]})},o("Символ:",s)),"OTHER"===b.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"ETH/LTC",callback_data:"eth_ltc"},{text:"ETH/EUR",callback_data:"eth_eur"},{text:"ETH/RUR",callback_data:"eth_rur"}],[{text:"LTC/RUR",callback_data:"ltc_rur"},{text:"LTC/EUR",callback_data:"ltc_eur"},{text:"EUR/RUR",callback_data:"eur_rur"}]]})},o("Пара:",s)),"Контроль"===b.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({keyboard:[[{text:"Скорость"},{text:"Состояние"},{text:"Модули"}],[{text:"Главное меню"}]],resize_keyboard:!0})},o("Выберите:",s)),"Нотис"===b.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({keyboard:[[{text:"Мониторинг"},{text:"Уведомление"}],[{text:"Круг"}],[{text:"Главное меню"}]],resize_keyboard:!0})},o("Выберите:",s)),"Мониторинг"===b.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Старт",callback_data:"monitoring start"},{text:"Стоп",callback_data:"monitoring stop"}]]})},t=ha.status?"Работает.":"Остановлен.",k=["Включает мониторинг возможных торговых пар. Уведомление раз в 5 минут.","Текущие состояние: "+t],o(k.join("\n"),s)),"Уведомление"===b.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Старт",callback_data:"notification start"},{text:"Стоп",callback_data:"notification stop"}]]})},t=ga.status?"Работает.":"Остановлен.",k=["Включает уведомления о скачках курса.","Текущие состояние: "+t],o(k.join("\n"),s)),"Круг"===b.text&&Ma(),"Тип"===b.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Only buy",callback_data:"type buy"},{text:"Only sell",callback_data:"type sell"},{text:"Buy & Sell",callback_data:"type all"}]]})},k=["Текущий тип торговли "+U.toUpperCase(),"Новый тип:"],o(k.join("\n"),s)),"Сменить пару"===b.text){if("btc-e"!==a.exchange)return void o("Этот пункт не доступен для данной биржи");s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"BTC/USD",callback_data:"trade btc_usd"},{text:"BTC/RUR",callback_data:"trade btc_rur"},{text:"BTC/EUR",callback_data:"trade btc_eur"}],[{text:"LTC/BTC",callback_data:"trade ltc_btc"},{text:"LTC/USD",callback_data:"trade ltc_usd"},{text:"LTC/RUR",callback_data:"trade ltc_rur"}],[{text:"LTC/EUR",callback_data:"trade ltc_eur"},{text:"NMC/BTC",callback_data:"trade nmc_btc"},{text:"NMC/USD",callback_data:"trade nmc_usd"}],[{text:"NVC/BTC",callback_data:"trade nvc_btc"},{text:"NVC/USD",callback_data:"trade nvc_usd"},{text:"PPC/BTC",callback_data:"trade ppc_btc"}],[{text:"PPC/USD",callback_data:"trade ppc_usd"},{text:"DSH/BTC",callback_data:"trade dsh_btc"},{text:"DSH/USD",callback_data:"trade dsh_usd"}],[{text:"ETH/BTC",callback_data:"trade eth_btc"},{text:"ETH/USD",callback_data:"trade eth_usd"},{text:"ETH/EUR",callback_data:"trade eth_eur"}],[{text:"ETH/LTC",callback_data:"trade eth_ltc"},{text:"ETH/RUR",callback_data:"trade eth_rur"},{text:"USD/RUR",callback_data:"trade usd_rur"}],[{text:"EUR/USD",callback_data:"trade eur_usd"},{text:"EUR/RUR",callback_data:"trade eur_rur"}]]})},k=["Текущая пара "+r(),"Внимание! На новой паре должны быть средства для торгов, иначе переключение завершится ошибкой!","Новая торгая пара:"],o(k.join("\n"),s)}return"Скорость"===b.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Normal",callback_data:"speed normal"},{text:"Extra",callback_data:"speed extra"}]]})},k=["Влияет на плотность стека ордеров, размер спреда и время закрытия неиспользованных ордеров","Время действия "+ma(D)+".","Текущая скорость: "+X].join("\n"),o(k,s)),"Состояние"===b.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Пауза",callback_data:"worker pause"},{text:"Продолжить",callback_data:"worker continued"}]]})},t=F?"Пауза":"Работает",o("Текущие состояние: "+t,s)),"Модули"===b.text?(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Динам. время обновления "+(a.dynamicSettingsTime?"[Выкл]":"[Вкл]"),callback_data:"modules dynamic-settings-time"}],[{text:"Динам. распределение ордеров "+(a.dynamicOffsetOrders?"[Выкл]":"[Вкл]"),callback_data:"modules dynamic-offset-orders"}],[{text:"Определение тренда "+(a.trendDefinition?"[Выкл]":"[Вкл]"),callback_data:"modules trend-definition"}],[{text:"Контроль смены тренда "+(a.abruptChangeTrend?"[Выкл]":"[Вкл]"),callback_data:"modules abrupt-change-trend"}],[{text:"Стоп при большом изменении цены "+(a.dangerPriceStop?"[Выкл]":"[Вкл]"),callback_data:"modules danger-price-stop"}],[{text:"Включить все",callback_data:"modules all-modules-on"},{text:"Выключить все",callback_data:"modules all-modules-off"}],[{text:"Полосы Боллинджера "+(a.bbands?"[Выкл]":"[Вкл]"),callback_data:"modules bbands"}],[{text:"Вывод лога "+(a.botLog?"[Выкл]":"[Вкл]"),callback_data:"modules bot-log"}]]})},o("*Модули обновления настроек:*",s)):void 0}}),n.on("callback_query",function(b){b.from.id===a.myChatId&&(/trade (\w*_(usd|rur|eur|btc|ltc))/.test(b.data)?Ca(b.data.substr(6)):/speed (normal|extra)/.test(b.data)?Ea(b.data.substr(6)):/worker (continued|pause)/.test(b.data)?Fa(b.data.substr(7)):/monitoring (start|stop)/.test(b.data)?Ia(b.data.substr(11)):/notification (start|stop)/.test(b.data)?Ja(b.data.substr(13)):/type (buy|sell|all)/.test(b.data)?Da(b.data.substr(5)):/modules (\w*)/.test(b.data)?Ga(b.data.substr(8)):Ha(b.data))}),Ca=function(b){var c,d;a.masterWorker&&(o("Инициализировано изменение пары..."),F=!0,c=b.split("_")[0],d=b.split("_")[1],a.tradeCurrency.name===c&&a.tradeCurrency.nameTwo!==d?H.sell=1:a.tradeCurrency.name!==c&&a.tradeCurrency.nameTwo===d&&(H.buy=1),setTimeout(function(){$a(a.tradeCurrency.pair,function(){a.tradeCurrency={name:c,nameTwo:d,pair:[c,d].join("_")},E=!0,Va(a.tradeCurrency.pair,function(a){var b,c;null!=a?(b=w(a),console.log(("["+t()+"]: Ошибка получения данных с сервера!\n"+b).red),c=["Critical error: Ошибка получения данных с сервера!","Бот поставлен на паузу, после обновления баланса необходимо перезапустить пару!","Ошибка: "+b].join("\n"),o(c),F=!0):(G=0,F=!1,o("Выполнено! Новая пара "+r()))})})},g("5s")))},Da=function(b){a.masterWorker&&(U=b,ba="all"!==b,o("Выполнено! Новый тип "+U.toUpperCase()))},Ea=function(a){var b;Ra(a),b=["Режим "+a.toUpperCase()+" включен.","Пара: "+r()],C=u(),console.log(("\n["+t()+"]: "+b[0]+"\n").green),o(b.join(" "))},Fa=function(a){var b;F="pause"===a,b=F?"Пауза":"Работает",o("Новое состояние: "+b+". Пара: "+r())},Ga=function(b){var c,d;/\all-modules/.test(b)?(c="all-modules-on"===b,a.dynamicSettingsTime=c,a.dynamicOffsetOrders=c,a.trendDefinition=c,a.abruptChangeTrend=c,a.dangerPriceStop=c,a.dynamicSettingsTime||(D=a.timeUpdateAutoSettings),o("Все модули "+(c?"включены":"выключены")+"!")):(d=b.replace(/\-./g,function(a,b,c){return a.replace("-","").toUpperCase()}),a[d]=!a[d],o(b.replace(/\-/g,"_").toUpperCase()+": "+a[d]))},Ha=function(b){a.masterWorker&&m.getTicker(b,function(c,d){var e,f,g,h,i,j,k,l,m,n,p;return null!=c?o(w(c)):(e=Ta.pairs[b].decimal_places,f=d[b].last,g=d[b].sell,h=d[b].buy,i=na(d[b].avg,e),j=na(h-g,e),k=b.split("_")[1],l=sa(h,a.stepBreakevenPercentConfig,e),m=j>l?"✔":"✗",n=f>i?"↑":"↓",p=[b.replace("_","/").toUpperCase()+":","sell: "+ka(k)+g,"buy: "+ka(k)+h,"last: "+ka(k)+f,"avg: "+ka(k)+i+" | "+n,"spread:   "+j+" | "+(j/l*100-100).toFixed()+"%","required: "+l+" "+m],o(p.join("\n")))})},Ia=function(b){var c;a.masterWorker&&(ha.status="start"===b,clearInterval(ha.interval),ha.status?(c="Работает",Ka(),ha.interval=setInterval(function(){Ka()},g("5m"))):c="Остановлен",o("Новое состояние: "+c))},Ja=function(b){var c;if(a.masterWorker){if(null==da||!da.length)return void o("Внимание! Конфиг для уведомлений не задан!");ga.status="start"===b,clearInterval(ga.interval),ga.status?(c="Работает",La()):c="Остановлен",o("Новое состояние: "+c)}},Ka=function(){var b;b=Ua.join("-"),d.parallel([function(a){return m.getTicker(b,function(b,c){return null!=b?a(b):a(null,c)})},function(a){return m.getTrades(b,{limit:2},function(b,c){return null!=b?a(b):a(null,c)})}],function(b,c){var e,f,i,j,k;if(null!=b)return e=w(b),f="Error trading pairs available: "+e,o(f),void console.log(f.red);i=[],j=(new Date).getTime(),k=h.range(j-g("1m"),j),d.eachSeries(Ua,function(b,d){var e,f,g,h,j,l,m,n,o;return e=Ta.pairs[b].decimal_places,f=c[0][b].last,g=c[0][b].sell,h=c[0][b].buy,j=c[0][b].avg?c[0][b].avg:(g+h)/2,j=na(j,e),l=na(h-g,e),m=sa(h,a.stepBreakevenPercentConfig,e),n=f>j?"↑":"↓",o=!c[1][b][0].timestamp||k.contains(1e3*c[1][b][0].timestamp)&&k.contains(1e3*c[1][b][1].timestamp),l>m&&o?(i.push(b.replace("_","/").toUpperCase()+"\nprice: "+h+" - "+g+"\navg:   "+j+" | "+n+"\nspread:   "+oa(l)+" | "+(l/m*100-100).toFixed()+"%\nrequired: "+oa(m)+"\n"),d(null)):d(null)}),setTimeout(function(){i.length&&(i.push("Доступные пары для торгов:\n"),i.reverse(),o(i.join("\n")))},g("2s"))})},La=function(){var b,c;a.masterWorker&&null!=da&&da.length&&("all_all"===da[0]&&(da=Ua),b=da.join("-"),c={},ga.interval=setInterval(function(){m.getTicker(b,function(b,e){var f,h;return null==b?d.eachSeries(da,function(b,d){var f,h,i,j,k,l,m,n,p,q,r;return a.tradeCurrency.pair===b?d(null):fb(b,Ua)?c[b]?d(null):(f=Ta.pairs[b].decimal_places,h=e[b].sell,i=e[b].buy,j=e[b].last,k=e[b].avg?e[b].avg:(h+i)/2,k=na(k,f),l=na(i-h,f),m=sa(h,a.notificationDeviation,f),l>m&&(n=b.split("_")[1],p=j<=h||j<=h+qa(3,f)?"down ↓":"up ↑",q=j>k?"↑":"↓",r=["Уведомление "+b.replace("_","/").toUpperCase()+":","directions: "+p,"sell: "+ka(n)+h,"buy: "+ka(n)+i,"last: "+ka(n)+j,"avg: "+ka(n)+k+" | "+q,"spread: "+oa(l)],c[b]||(c[b]=!0,o(r.join("\n")),setTimeout(function(){c[b]=!1,c.error=!1},g("15m")))),d(null)):d(null)}):(f=w(b),h="Error notification price: "+f,console.log(h.red),c.error?void 0:(o(h),c.error=!0))})},g("5s")))},Ma=function(a,b){var c,d,e,f;null==a&&(a=.993),null==b&&(b=!1),c={},d={},e={},f={},Ua.forEach(function(a){var b;b=a.split(/\s*_\s*/),c[b[0]]?c[b[0]].push(b[1]):c[b[0]]=[b[1]]}),m.getTicker(Ua.join("-"),function(g,h){var i,j,k,l;if(null!=g)return i=w(g),o("Error: "+i);if(Ua.forEach(function(a){d[a]=va(1,h[a].buy)}),Ua.forEach(function(a){var b;b=a.split(/\s*_\s*/),c[b[0]].forEach(function(c){c!==b[1]&&(e[b[1]+"_"+b[0]+"_"+c]=wa(d[a],h[b[0]+"_"+c].sell))})}),Object.keys(e).forEach(function(b){var c,d;c=b.split(/\s*_\s*/),fb(c[0]+"_"+c[2],Ua)&&(d=va(e[b],h[c[0]+"_"+c[2]].buy)),fb(c[2]+"_"+c[0],Ua)&&(d=wa(e[b],h[c[2]+"_"+c[0]].buy)),d>a&&(f[b+"_"+c[0]]=na(d,5))}),j=["Проверка возможных вариантов перепродаж.","Показаны значения больше: "+a,"Значения меньше 1 убыточны:\n"],k=[],Object.keys(f).forEach(function(a){k.push([a.replace(/\_/g,"->"),f[a]])}),k.length?(l=k.sort(function(a,b){return b[1]-a[1]}),l.forEach(function(a){j.push(a.join(": "))})):j.push("Нет подходящих вариантов"),!b||k.length)return o(j.join("\n"))})},Ra=function(b){var c;null!=b&&(c=b),c||(c=G>aa?"extra":"normal"),G=0,"extra"===c?(Na=I.extra,Oa=I.extra,Qa=K,Pa=60*a.timeCloseOrdersExtra):(Na=I.buy,Oa=I.sell,Qa=J,Pa=60*a.timeCloseOrdersDefault),X=c},Sa=0,Va=function(a,b){return m.getInfo(function(c,d){if(null!=c)return b(c);try{Ta=d,Ua=Object.keys(d.pairs),Y=d.pairs[a].decimal_places,_=d.pairs[a].min_amount,Z=d.pairs[a].min_price,$=d.pairs[a].fee}catch(a){a,b("Not valid pair")}return Ba(a,function(c){var d,e;return c?(d=null!=(e=c.error)?e.split("send:")[1]:void 0,null!=d?(m.setNonce(d),Va(a,b)):(Sa++,Sa>5?(Sa=0,b(c)):Va(a,b))):b(null)})})},Wa=function(a,b){return m.getTicker(a,function(c,d){var e,f,g,h;return null!=c?b(c):(e=d[a].last,f=d[a].sell,g=d[a].buy,h=na(g-f,Y),N=Qa<=qa(2)?h>=Qa:h>Qa,b(null,{lastPrice:e,bidPrice:f,askPrice:g,spread:h}))})},Xa=function(b,c){return N?m.balanceRequest(b,function(b,d,e){return null!=b?c(b):(d=Aa(d,"name"),e=Aa(e,"nameTwo"),"all"===U?d<_&&e<_?O<a.ecoCountCycle&&O++:O>0&&(O=0):O=a.ecoCountCycle,c(null,{balance:d,balanceTwo:e}))}):c(null)},Ya=function(b,c,e,f,g){var h;return c<_?g(null):ca?g(null):(M={buy:0,sell:0},"all"===U||U===b?c>=L?(void 0!==h&&null!==h||(h=e),d.doWhilst(function(a){return V?("sell"===b&&(h-=Oa),"buy"===b&&(h+=Na),c=na(c/2),Za(b,h,c,f,a)):("buy"===b?(h-=Na,c=na(M.buy/h)||c):(h+=Oa,c=M.sell||c),c>L?Za(b,h,L,f,a):Za(b,h,na(c/2),f,a))},function(){return c>na(L/2)},function(a){return g(null!=a?a:null)})):(a.bbands&&("sell"===b&&(e+=qa(1)),"buy"===b&&(e-=qa(1))),Za(b,e,c,f,g)):g(null))},Za=function(b,c,d,e,f){return d<_?f(null):(c=na(c,Y),c>=Z||(c=Z),d=na(d,8),m.tradeSetOrder(e,b,c,d,function(e,g){var h,i;return null!=e?(h=w(e),console.log(("["+t()+"]: Error: "+h+" | "+b+" | rate: "+c+" | amount: "+d).red),f(e)):(i="["+t()+"]: Open: "+b+" | rate: "+c+" | amount: "+d,"buy"===b?M.buy="poloniex"===a.exchange?Aa(g.funds[a.tradeCurrency.name],"name"):Aa(g.funds[a.tradeCurrency.nameTwo],"nameTwo"):M.sell="poloniex"===a.exchange?Aa(g.funds[a.tradeCurrency.nameTwo],"nameTwo"):Aa(g.funds[a.tradeCurrency.name],"name"),console.log("buy"===b?i.green:i.yellow),G++,f(null))}))},$a=function(a,b){return m.ordersRequest(a,function(a,c){var e,f,g;return B=u(),null!=a?0===a.success&&null==(null!=(e=a.error)?e.split("send:")[1]:void 0)?(f=w(a),console.log(("["+t()+"] Cancel orders: "+f).yellow),b(null)):b(a):(g=Object.keys(c),d.eachSeries(g,function(a,b){return null!=H.buy&&"sell"===c[a].type?b(null):null!=H.sell&&"buy"===c[a].type?b(null):B-c[a].timestamp_created>(H.buy||H.sell||H.all||60)?_a(a,c[a].type,c[a].amount,c[a].rate,b):b(null)},function(a){return H={all:null,buy:null,sell:null},b(null!=a?a:null)}))})},_a=function(a,b,c,d,e){return m.tradeCancelOrder({order_id:a},function(a,f){return null!=a?e(a):(console.log(("["+t()+"]: Close: "+b+" | rate: "+d+" | amount: "+c).cyan),G>0&&G--,e(null))})},ab=function(){ba||la(B,a.timeCloseOrdersInactivity)&&$a(a.tradeCurrency.pair,function(a){})},bb=function(){var a;la(A,10)&&(a="Unknown error: Worker Stop!",console.log(("["+t()+"]: "+a).red),db({error:a}))},cb=function(){A=u(),F?setTimeout(function(){cb()},g("30s")):d.series([function(b){return Wa(a.tradeCurrency.pair,b)},function(b){return Xa(a.tradeCurrency,b)}],function(b,c){var e;null!=b?(e=w(b),console.log(("Error: "+e).red),db(b)):(E&&(za(c[0].askPrice,c[0].bidPrice,c[0].lastPrice),E=!1),N?d.series([function(a){return D>0&&A-C>60*D&&za(c[0].askPrice,c[0].bidPrice,c[0].lastPrice),a(null)},function(b){return A-B>Pa?$a(a.tradeCurrency.pair,b):b(null)},function(b){var d,e;return a.botTrade&&x?(d=V?W.bid:c[0].bidPrice,e=na("poloniex"===a.exchange?c[1].balance/d:c[1].balanceTwo/d),Ya("buy",e,d,a.tradeCurrency.pair,b)):b(null)},function(b){var d,e;return a.botTrade&&x?(d=V?W.ask:c[0].askPrice,e="poloniex"===a.exchange?c[1].balanceTwo:c[1].balance,Ya("sell",e,d,a.tradeCurrency.pair,b)):b(null)}],function(b){var c;null!=b?(c=w(b),console.log(("ErrorTrader: "+c).red),db(b)):O===a.ecoCountCycle?(clearTimeout(fa.eco),fa.eco=setTimeout(function(){cb()},g("2s"))):cb()}):(clearTimeout(fa.spread),fa.spread=setTimeout(function(){cb()},g(a.restartServerTime+"s"))))})},db=function(b){var c,d,e,f;c="restart using "+a.restartServerTime+" sec ...",console.log("["+t()+"]: "+c),d=null!=(e=b.error)?e.split("send:")[1]:void 0,null==d&&(f=w(b),y!==f&&(y=f,a.emailS&&"production"===process.env.NODE_ENV&&q(s(f+"\n\n"+c),function(a,b){}))),setTimeout(function(){console.log(("["+t()+"]: trader restart").bgGreen),null!=d&&m.setNonce(d),cb()},g(a.restartServerTime+"s"))},function(){a.myChatId&&(console.log("["+t()+"]: Trader Bot starting..."),console.log("["+t()+"]: Exchange: "+a.exchange.toUpperCase()+" | v."+a.versionBot),Va(a.tradeCurrency.pair,function(b){var c;return null!=b&&(c=w(b),console.log(("["+t()+"]: Error getting parameters from the server!\n"+c).red),process.exit(0)),cb(),a.botTrade&&setInterval(function(){ab(),bb()},g("5m")),setInterval(function(){xa()},g(10*a.bbandsInterval+"s")),"production"===process.env.NODE_ENV&&o("Trader Bot started. Pair "+r()),console.log("["+t()+"]: Trader Bot started")}))}()}).call(this);