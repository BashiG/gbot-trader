(function(){function e(e,r){for(var t=-1,n=r.length>>>0;++t<n;)if(e===r[t])return!0;return!1}var r,t,n,a,o,i,l,u,s,c,d,f,p,b,_,m,y,O,T,E,g,C,v,S,x,R,k,P,h,N,I,w,D,L,U,B,F,A,M,j,q,z,G,H,J,Y,V,K,W,X,Z,Q,$,ee,re,te,ne,ae,oe,ie,le,ue,se,ce,de,fe,pe,be,_e,me,ye,Oe,Te,Ee,ge,Ce,ve,Se,xe,Re,ke,Pe,he,Ne,Ie,we,De,Le,Ue,Be,Fe,Ae,Me,je,qe,ze,Ge,He,Je,Ye,Ve,Ke,We,Xe,Ze,Qe,$e,er,rr,tr,nr,ar,or,ir,lr,ur,sr,cr,dr,fr,pr,br,_r,mr,yr,Or,Tr;r=require("./conf"),t=require("./utils"),n=require("./log"),a=require("async"),o=require("lodash"),require("colors"),i=require("ms"),l=require("moment"),u=require("moment-range"),s=require("nodemailer"),c=require("node-telegram-bot-api"),d=require("ta-lib"),f=new n;try{p=require("./api/"+r.exchange),b=new p}catch(e){return void f.error("Не найдено Api биржи!")}l=u.extendMoment(l),r.tokenTelegram||r.telegramOff?(_=r.tokenTelegram&&!r.telegramOff?new c(r.tokenTelegram,{polling:!0}):new(function(){function e(){}return e.prototype,e.prototype.on=function(){},e.prototype.sendMessage=function(){},e}()),m=function(e,t){null==t&&(t={}),e.length>4096&&(e="*Слишком много информации для отображения*"),e.length||(e="*Error: Не удалось обработать ошибку*"),!1!==t.format&&(t.parse_mode="markdown"),delete t.format,_.sendMessage(r.myChatId,e,t)},y=s.createTransport(r.email),O=function(e,r){return y.sendMail(e,r)},T=function(){return r.tradeCurrency.pair.replace("_","/").toUpperCase()},E=function(e){return{from:r.email.auth.user,to:r.email.reportEmail,subject:"Error Script Trader",text:"time: "+(new Date).toString()+"\nPair: "+T()+"\n\nmessage: "+e+"\n\n---"}},g=function(e){return o.isObject(e)?e.hasOwnProperty("error")?e.error:e.hasOwnProperty("message")?e.message:t.objToString(e):e},C=!0,v={count:0,text:""},S=!1,x={},R={name:0,nameTwo:0},k=t.currentTime(),P=t.currentTime(),h=t.currentTime(),N={min60:{time:0,price:0}},I=r.timeUpdateAutoSettings,w=!0,D=!1,L={all:null,buy:null,sell:null},U={extra:0,buy:0,sell:0,first:0},B={buy:0,sell:0},F={id:0,priceBuy:0,amount:0},A=r.oneOrdersSellPercent,M=0,j=0,q=0,z={buy:0,sell:0},G=0,H={buy:0,sell:0},J={},Y={},V={},K=!1,W={buy:0,sell:0},X=0,Z=0,Q=!1,$=0,ee=0,re=0,te=0,ne=[],ae=[],oe="all",ie=!1,le={ask:0,bid:0},ue="normal",se=0,ce=0,de=0,fe=0,pe=!1,be=!1,_e=!1,me=null!=(ye=r.notificationPair)?ye.toLowerCase().replace(/\//g,"_").split(/\s*,\s*/):void 0,Oe={status:!1,interval:!1},Te={status:!1,interval:!1},Ee={ordersAll:0,ordersExecuted:0,error:0},ge="-----------------------------------",Ce=function(e){return r.symbol.hasOwnProperty(e)?r.symbol[e.toLowerCase()]:e.toUpperCase()+" "},ve=function(e,r){return null==r&&(r=se),t.rounded(e/+("1e"+r),r)},Se=function(e,r){return null==r&&(r=se),t.rounded(e*+("1e"+r),r)},xe=function(e,r,n){var a;return null==r&&(r=0),null==n&&(n=se),a=e/100*de*2,t.rounded(t.amountPlusPercent(t.rounding(a,n),r),n)},Re=function(e,r){return t.rounded(t.amountPlusPercent(e,r),se)},ke=function(e,r){return t.rounded(t.amountMinusPercent(e,r),se)},Pe=function(e,r){return t.amountMinusPercent(e/r,de)},he=function(e,r){return t.amountMinusPercent(e*r,de)},Ne=function(e,t,n,a){var o,i;return null==a&&(a=0),"inverse"===r.directionCurrency?(o=(t+=a)*n+e,i=e/n+t):(o=t/n+(e+=a),i=e*n+t),{deposit:o,depositTwo:i}},Ie=function(){r.bbands&&te>0&&(ae.push(te),ae.length>30&&ae.splice(0,1))},we=function(e,r){var n,a;return n=e/100*r,a=1/+("1e"+se),r>0&&(n>=a||(n=a)),t.rounded(n,se)},De=function(e,r){var n,a,o;null==r&&(r=1),n=e.toString().split(".")[0];try{a=e.toString().split(".")[1].length}catch(e){a=1}return o=n>0?n>1e4?+("1e"+(a+1)):n>1e3?+("1e"+a):n>100?+("1e"+(a-1)):n>10?+("1e"+(a-2)):a>3?+("1e"+(a-3)):1:1,r*=o,t.rounded(r/+("1e"+a),a)},Le=function(e,n,a,i){var l,u,s,c,p,b,_,y,O,E,g,v,S,x,R,k,B,A,q,G,H,J,Y,K,W,Q,$,_e,me,ye,Oe,Te,Ee,Ce,ve,Pe,he,Ne;return h=t.currentTime(),L={buy:null,sell:null},t.timeIsOver(N.min60.time,60)&&(N.min60={time:t.currentTime(),price:a}),l=e.toString().length,u=n.toString().length,c={},c[l+""]=e,c[u+""]=n,s=c,p=Math.max(l,u),b=s[p],se=tr.pairs[r.tradeCurrency.pair].decimal_places,fe=tr.pairs[r.tradeCurrency.pair].min_amount,ce=tr.pairs[r.tradeCurrency.pair].min_price,de=tr.pairs[r.tradeCurrency.pair].fee,_=t.rounded(e-n,se),y=xe(b,200),r.dynamicSettingsTime&&(ne.push(a),ne.length>50&&ne.splice(0,1),O=o.max(ne),E=o.min(ne),r.botLog&&f.info([ge,"price-array:","length: "+ne.length,"max: "+O,"min: "+E,"change-time-settings: "+(t.percentageBetweenNumbers(O,E)>2)].join("\n")),t.percentageBetweenNumbers(O,E)>2?I=.1:I!==r.timeUpdateAutoSettings&&(I=r.timeUpdateAutoSettings)),r.abruptChangeTrend&&(g=xe(b,400)),r.dangerPriceStop&&(v=Re(re,9),S=ke(ee,9)),r.dynamicOffsetOrders&&(R=_>=(x={current:xe(b,450),prev:xe(b,380),prev_2:xe(b,300)}).current||_>=x.prev||_>=x.prev_2),r.dynamicOffsetOrders&&R?(f.info("Dynamic market"),k=De(b,Se(x.current)),B=1.5*r.stepBreakevenPercent):(k=De(b,r.offsetOrdersPoints),B=r.stepBreakevenPercent),k=function(){switch(!1){case!r.offsetOrdersPercent:return we(b,r.offsetOrdersPercent);case!r.rangeOffset:return we(b,t.rounded(r.rangeOffset/r.countOrders,2));default:return k}}(),(r.offsetOrdersPercent||r.rangeOffset)&&(A=a>N.min60.price?Math.abs(t.percentageBetweenNumbers(N.min60.price,a)):Math.abs(t.percentageBetweenNumbers(a,N.min60.price)),k>=(c=we(b,t.rounded(A/r.countOrders,2)))||(k=c)),q=1.3*k,G=we(b,r.offsetFirstOrdersPercent),H=r.offsetOrdersPercent?we(b):2,M=function(){switch(!1){case!r.bbands:case!r.oneOrdersSell:return 0;default:return xe(b,B)}}(),r.botLog&&(f.info(ge),f.info("current-spread:",(t.noExp(_)+"")[_>M?"green":"white"]),f.info("spread-min-default:",t.noExp(M)),f.info("trend-spread:",t.noExp(y)),r.abruptChangeTrend&&f.info("immediate-spread:",g),f.info("trader-speed:",ue),f.info("price-prev:",re+" - "+ee),f.info("price-prev2:",le.ask+" - "+le.bid),r.dangerPriceStop&&(f.info("danger-price-ask:",v,!w&&e>=v?"Attention!".red:""),f.info("danger-price-bid:",S,!w&&n<=S?"Attention!".red:"")),r.dynamicOffsetOrders&&(f.info("spread_1_450:",x.current,_>=x.current?"Attention!".red:""),f.info("spread_2_380:",x.prev,_>=x.prev?"Attention!".red:""),f.info("spread_3_300:",x.prev_2,_>=x.prev_2?"Attention!".red:""),f.info("dynamic-market:",R))),r.dangerPriceStop&&!w&&(e>=v||n<=S)?(e>=v&&(L.buy=1),P=0,D=!0,J="DANGER PRICE: "+e+" - "+n+" | Bot Pause!",f.warn(J),void m("`"+J+"`")):(Y=H,K=X>Math.round(Z/2)?q:k,r.botLog&&(f.info("offset-max-one:",(t.noExp(k)+"")[k===K?"green":"yellow"]),f.info("offset-type-max:",t.noExp(K)),r.offsetFirstOrdersPercent&&f.info("offset-first-orders:",t.noExp(G)),f.info(ge)),pe||(oe="all",ie=!1),w?(r.bbands&&(C=!1),W=Q=K):r.oneOrdersSell?(W=Q=K,r.timeCloseOrders=1e5,r.timeCloseOrdersInactivity=r.timeCloseOrders,($=t.searchFirstRate(V,n))&&n>Re($.rate,r.oneOrdersSellOffset)&&!F.id&&(L.buy=1,P=0,z={buy:0,sell:0})):r.bbands?(W=Q=K,I=.1,_e=14,ae.length>2*_e&&(me=(c=d.BBANDS(ae,20,r.bbandsDeviation)).middleband,ye=c.lowband,Oe=c.highband,Te=d.RSI(o.clone(ae).reverse(),_e),Ee=d.average(Te).mean,Ce=d.average(me).mean,ve=d.average(Oe).mean,Pe=d.average(ye).mean,he=ve>a&&a>Ce,Ne=Ce>a&&a>Pe,he&&(pe||(oe="sell"),C=99>Ee&&Ee>70),Ne&&(pe||(oe="buy"),C=1<Ee&&Ee<30),be=he&&Ne,r.botLog&&f.info(["BBANDS:","highband: "+ve,"middleband: "+Ce,"lowband: "+Pe,"rsa: "+Ee,"sell: "+he,"buy: "+Ne,"bot trade: "+C,"orders-calculation-brake: "+be,ge].join("\n")))):r.trendDefinition&&n>ee&&e>re&&_>y&&"normal"===ue?(f.info("Trend: UP"),W=Y,Q=K,pe||(oe="buy",L.sell=1,P=0,r.abruptChangeTrend&&_>g&&(f.info("Spread Immediate"),ie=!0,h=0))):r.trendDefinition&&n<ee&&e<re&&_>y&&"normal"===ue?(f.info("Trend: DOWN"),W=K,Q=Y,pe||(oe="sell",L.buy=1,P=0,r.abruptChangeTrend&&_>g&&(f.info("Spread Immediate"),ie=!0,h=0))):W=Q=K,le={ask:re,bid:ee},ee=n,re=e,te=a,j=xe(b),U={buy:W,sell:Q,extra:De(b),first:G},er(null,function(){return f.info("Update: "+oe.toUpperCase()+" | "+e+" - "+n+" | "+a+" | "+T()),i(null)}))},Ue=function(e,r){var t,n;return t="name"===r?R.name:R.nameTwo,n=e-t,n>0?n:0},Be=function(e,n){return a.parallel([function(t){return r.botLog&&f.info(ge+"\nПолучение цен"),b.getTicker(e,function(n,a){return null!=n?(r.botLog&&(f.error("Price: "+a[e].buy),f.error(g(n))),t(n)):t(null,{price:a[e].buy})})},function(n){return a.series([function(t){return r.botLog&&f.info(ge+"\nЗакрытие всех позиций"),L.all=1,br(e,function(e){return t(null!=e?e:null)})},function(e){return r.botLog&&f.info(ge+"\nПолучение баланса"),o.delay(b.balanceRequest,i("500"),r.tradeCurrency,function(t,n,a){return null!=t?(r.botLog&&(f.error("balance: "+n+" | balance-two: "+a),f.error(g(t))),e(t)):r.botTrade&&n<r.minAvailableBalance&&a<r.minAvailableBalance?(r.botLog&&f.error("balance: "+n+" | balance-two: "+a),e({error:"Err: No money!"})):e(null,{balance:n,balanceTwo:a})})},function(e){return r.oneOrdersSell&&r.firstLoadingHistory?(r.botLog&&f.info(ge+"\nПолучение истории"),b.tradeGetHistory(r.tradeCurrency.pair,30,function(n,a){var i;return null!=n?e(n):(r.botLog&&f.info(ge+"\nСоздание кэша"),i=0,o.forOwnRight(a,function(e,r){if("buy"===e.type&&(Y[r]={rate:e.rate,amount:e.amount},i+=e.amount),"sell"===e.type)return!1}),e(null,{cache:t.amountMinusPercent(i,de)}))})):e(null,{cache:0})}],function(e,r){return null!=e?n(e):n(null,{balance:r[1].balance,balanceTwo:r[1].balanceTwo,cache:r[2].cache})})}],function(e,a){var i,l,u,s,c,d,p,b,_,m,y,O,T,E,g,C,v,S,k,P;return null!=e?n(e):(i=a[0],l=a[1],x=o.clone(l),r.botLog&&f.info(ge+"\nРасчет депозита"),r.oneOrdersSell&&("inverse"===r.directionCurrency?(u=l.balanceTwo,l.balanceTwo=0):(u=l.balance,l.balance=0),u-=l.cache),s=Ne(l.balance,l.balanceTwo,i.price,l.cache),c=s.deposit,d=s.depositTwo,b=r.depositLimit.currency?d>(p="inverse"===r.directionCurrency?r.depositLimit.currency/i.price:r.depositLimit.currency)?t.rounded(100/(d/p),2):100:r.depositLimit.percent,_=0<b&&b<100?b:100,m=c*_/100,y=d*_/100,100===_?(r.botLog&&f.info("type:",0),O=0,T=0):l.balance>=m&&l.balanceTwo>=y?(r.botLog&&f.info("type:",1),O=l.balance-m/2,T=l.balanceTwo-y/2):l.balance>=m&&l.balanceTwo<y?(r.botLog&&f.info("type:",2),O="inverse"===r.directionCurrency?l.balance-(y-l.balanceTwo)*i.price:l.balance-(y-l.balanceTwo)/i.price,T=0):l.balance<m&&l.balanceTwo>=y?(r.botLog&&f.info("type:",3),O=0,T="inverse"===r.directionCurrency?l.balanceTwo-(m-l.balance)/i.price:l.balanceTwo-(m-l.balance)*i.price):l.balance<m&&l.balanceTwo<y&&(r.botLog&&f.info("type:",4),"inverse"===r.directionCurrency?(O=l.balance-(y-l.balanceTwo)*i.price,T=l.balanceTwo-(m-l.balance)/i.price):(O=l.balance-(y-l.balanceTwo)/i.price,T=l.balanceTwo-(m-l.balance)*i.price)),r.botLog&&(E=(s=t.percentageBetweenNumbers(O,l.balance))>0?s:0,g=(s=t.percentageBetweenNumbers(T,l.balanceTwo))>0?s:0,f.info(["reserved-deposit:",r.tradeCurrency.name.toUpperCase(),E+"% / "+g+"%",r.tradeCurrency.nameTwo.toUpperCase()].join(" "))),r.oneOrdersSell&&("inverse"===r.directionCurrency?T=u:O=u),R={name:O>0?O:0,nameTwo:T>0?T:0},C="inverse"===r.directionCurrency?y:m,r.countOrders?r.countOrders>=3||(r.countOrders=3):r.countOrders=function(){switch(!1){case!(C<=10):return 6;case!(C<=200):return 15;case!(C<=500):return 18;case!(C<=1e3):return 21;default:return 25}}(),v="inverse"===r.directionCurrency?r.minSizeOrder/i.price:fe+.001,Z=r.countOrders*r.multiplierOrdersExtra,r.sizeOrdersMartingale?1===r.martingaleType?(S=1+r.sizeOrdersMartingale/100,k=C/((Math.pow(S,r.countOrders)-1)/(S-1))):(G=r.sizeOrdersMartingale,k=C/r.countOrders-(r.countOrders-1)*G/2):k=C/r.countOrders,q=t.rounded(k>v?k:v,se),r.botLog&&(P=r.depositLimit.currency?r.depositLimit.currency+" "+("inverse"===r.directionCurrency?r.tradeCurrency.name.toUpperCase():r.tradeCurrency.nameTwo.toUpperCase()):r.depositLimit.percent+" %",f.info([ge+"\nРасчет переменных","Strategy: "+function(){switch(!1){case!r.oneOrdersSell:return"One Sell a lot Buy";case!r.bbands:return"BBANDS";default:return"Scalper"}}(),"balance: "+t.rounded(l.balance)+" "+r.tradeCurrency.name.toUpperCase(),"balance-two: "+t.rounded(l.balanceTwo)+" "+Ce(r.tradeCurrency.nameTwo),"amount-orders-cache: "+t.rounded(l.cache)+" "+r.tradeCurrency.name.toUpperCase(),"deposit: "+c+" "+r.tradeCurrency.name.toUpperCase()+" или "+d+" "+r.tradeCurrency.nameTwo.toUpperCase(),"deposit-limit: "+P,"trade-deposit: "+m+" "+r.tradeCurrency.name.toUpperCase()+" | "+y+" "+r.tradeCurrency.nameTwo.toUpperCase(),"reserved-deposit: "+t.rounded(R.name)+" "+r.tradeCurrency.name.toUpperCase()+" | "+t.rounded(R.nameTwo)+" "+r.tradeCurrency.nameTwo.toUpperCase(),"count-orders: "+r.countOrders,"quantity-orders-in-blocks: "+(r.quantityOrdersInBlocks?r.quantityOrdersInBlocks:"OFF"),"size-static-order: "+q,"size-orders-martingale: "+(r.sizeOrdersMartingale?r.sizeOrdersMartingale:"OFF")+"    Тип: "+(1===r.martingaleType?"Exponential":"Linear"),ge].join("\n"))),(m<r.minAvailableBalance&&y<r.minAvailableBalance||m<q&&y<q)&&(f.warn(ge),f.warn("Недостаточно доступных средств для торговли!"),f.warn(ge)),n(null))})},_.on("message",function(e){var n,i,l,u,s,c,d,p,y,O;if(n=e.chat.id,r.myChatId||_.sendMessage(n,"Install your Telegram id: `"+n+"`",{parse_mode:"markdown"}),n===r.myChatId)return"Ордера"===e.text&&(i=function(){a.series([function(e){return b.balanceRequest(r.tradeCurrency,function(r,t,n){return null!=r?e(r):e(null,{balance:t,balanceTwo:n})})},function(e){return b.ordersRequest(r.tradeCurrency.pair,function(r,t){return null!=r?e(r):e(null,{data:t})})}],function(e,n){var a,l,u,s,c,d,f,p,_,y,O,E;a=[T()+":",ge],l="Balance: "+(null!=(u=n[0])?u.balance.toFixed(3):void 0)+" "+r.tradeCurrency.name.toUpperCase()+" | "+Ce(r.tradeCurrency.nameTwo)+" "+(null!=(s=n[0])?s.balanceTwo.toFixed(3):void 0),null!=e?0===e.success?null!=(c=null!=(d=e.error)?d.split("send:")[1]:void 0)?(b.setNonce(c),i()):(f=g(e),a.push(f+"\n"+ge+"\n"+l),m(a.join("\n"))):m("`"+g(e)+"`"):(p={},_=0,y=0,O={},Object.keys(n[1].data).forEach(function(e){var a,o,i,l;a=n[1].data[e].rate*+("1e"+se),o="sell"===n[1].data[e].type?"`sell`":"buy",null!=O[a]?(i=" | "+ ++p[a],l=t.rounded(t.rounded(O[a].split("|")[1].trim())+t.rounded(n[1].data[e].amount)),O[a]=o+" | "+l+" | "+Ce(r.tradeCurrency.nameTwo)+" "+n[1].data[e].rate+i):(p[a]=1,O[a]=o+" | "+t.rounded(n[1].data[e].amount)+" | "+Ce(r.tradeCurrency.nameTwo)+" "+n[1].data[e].rate),_+=n[1].data[e].amount,y+=n[1].data[e].amount*n[1].data[e].rate}),(a=o.concat(a,o.values(O))).push(ge+"\nCount: "+t.rounded(_)+" | Sum: "+Ce(r.tradeCurrency.nameTwo)+" "+t.rounded(y)+"\n"+l),E=a.join("\n"),m(E))})})(),"История"===e.text&&(l=function(){b.tradeGetHistory(r.tradeCurrency.pair,15,function(e,t){var n,a,o;return null!=e?0===e.success?(n=null!=(a=e.error)?a.split("send:")[1]:void 0,null!=n?(b.setNonce(n),l()):m("`"+g(e)+"`")):m("`"+g(e)+"`"):(o=[],Object.keys(t).forEach(function(e){var n;n="sell"===t[e].type?"`sell`":"buy",o.push(n+" | "+t[e].amount.toFixed(3)+" | "+Ce(r.tradeCurrency.nameTwo)+t[e].rate)}),o.push(T()+":\n"+ge),o.reverse(),m(o.join("\n")))})})(),"Закрыть активные ордера"===e.text&&function(){var e;e={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Закрыть ордера!",callback_data:"close_orders_now"}]]})},m("*Вы уверены что хотите закрыть ордера?*",e)}(),"/start"!==(u=null!=(s=e.text)?s.toLowerCase():void 0)&&"главное меню"!==u||function(){var e;e={reply_markup:JSON.stringify({keyboard:[[{text:"Ордера"},{text:"Котировки"},{text:"История"}],[{text:"Контроль"},{text:"Нотис"},{text:"Торговля"}],[{text:"Закрыть активные ордера"}]],resize_keyboard:!0})},m("Выберите:",e)}(),"Котировки"===e.text&&function(){var e;"btc-e"===r.exchange?(e={reply_markup:JSON.stringify({keyboard:[[{text:"USD"},{text:"BTC"},{text:"OTHER"}],[{text:"Главное меню"}]],resize_keyboard:!0})},m("Валюта:",e)):m("*Этот пункт не доступен для данной биржи* \nИспользуйте команду:\n */ticker coin_name*")}(),"Торговля"===e.text&&function(){var e;e={reply_markup:JSON.stringify({keyboard:[[{text:"Сменить пару"},{text:"Тип"}],[{text:"Изменить отступ"},{text:"Авто выход из пары"}],[{text:"Главное меню"}]],resize_keyboard:!0})},m("Выберите:",e)}(),"USD"===e.text&&function(){var e;e={reply_markup:JSON.stringify({inline_keyboard:[[{text:"NMC",callback_data:"nmc_usd"},{text:"PPC",callback_data:"ppc_usd"},{text:"NVC",callback_data:"nvc_usd"},{text:"LTC",callback_data:"ltc_usd"},{text:"BTC",callback_data:"btc_usd"}],[{text:"DSH",callback_data:"dsh_usd"},{text:"ETH",callback_data:"eth_usd"},{text:"EUR",callback_data:"eur_usd"},{text:"RUR",callback_data:"usd_rur"}]]})},m("Символ:",e)}(),"BTC"===e.text&&function(){var e;e={reply_markup:JSON.stringify({inline_keyboard:[[{text:"NMC",callback_data:"nmc_btc"},{text:"PPC",callback_data:"ppc_btc"},{text:"NVC",callback_data:"nvc_btc"},{text:"LTC",callback_data:"ltc_btc"}],[{text:"DSH",callback_data:"dsh_btc"},{text:"ETH",callback_data:"eth_btc"},{text:"RUR",callback_data:"btc_rur"},{text:"EUR",callback_data:"btc_eur"}]]})},m("Символ:",e)}(),"OTHER"===e.text&&function(){var e;e={reply_markup:JSON.stringify({inline_keyboard:[[{text:"ETH/LTC",callback_data:"eth_ltc"},{text:"ETH/EUR",callback_data:"eth_eur"},{text:"ETH/RUR",callback_data:"eth_rur"}],[{text:"LTC/RUR",callback_data:"ltc_rur"},{text:"LTC/EUR",callback_data:"ltc_eur"},{text:"EUR/RUR",callback_data:"eur_rur"}]]})},m("Пара:",e)}(),"Контроль"===e.text&&function(){var e;e={reply_markup:JSON.stringify({keyboard:[[{text:"Скорость"},{text:"Состояние"},{text:"Модули"}],[{text:"Главное меню"}]],resize_keyboard:!0})},m("Выберите:",e)}(),"Нотис"===e.text&&function(){var e;e={reply_markup:JSON.stringify({keyboard:[[{text:"Мониторинг"},{text:"Уведомление"}],[{text:"Круг"}],[{text:"Главное меню"}]],resize_keyboard:!0})},m("Выберите:",e)}(),"Мониторинг"===e.text&&function(){var e,r;e={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Старт",callback_data:"monitoring start"},{text:"Стоп",callback_data:"monitoring stop"}]]})},r=Te.status?"Работает.":"Остановлен.",m(["Включает мониторинг возможных торговых пар. Уведомление раз в 5 минут.","Текущие состояние: "+r].join("\n"),e)}(),"Уведомление"===e.text&&function(){var e,r;e={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Старт",callback_data:"notification start"},{text:"Стоп",callback_data:"notification stop"}]]})},r=Oe.status?"Работает.":"Остановлен.",m(["Включает уведомления о скачках курса.","Текущие состояние: "+r].join("\n"),e)}(),"Круг"===e.text&&function(){We()}(),"Тип"===e.text&&function(){var e,r;e={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Only buy",callback_data:"type buy"},{text:"Only sell",callback_data:"type sell"},{text:"Buy & Sell",callback_data:"type all"}]]})},r=["Текущий тип торговли "+oe.toUpperCase(),"Новый тип:"],m(r.join("\n"),e)}(),"Сменить пару"===e.text&&function(){var e,t;"btc-e"===r.exchange?(e={reply_markup:JSON.stringify({inline_keyboard:[[{text:"BTC/USD",callback_data:"trade btc_usd"},{text:"BTC/RUR",callback_data:"trade btc_rur"},{text:"BTC/EUR",callback_data:"trade btc_eur"}],[{text:"LTC/BTC",callback_data:"trade ltc_btc"},{text:"LTC/USD",callback_data:"trade ltc_usd"},{text:"LTC/RUR",callback_data:"trade ltc_rur"}],[{text:"LTC/EUR",callback_data:"trade ltc_eur"},{text:"NMC/BTC",callback_data:"trade nmc_btc"},{text:"NMC/USD",callback_data:"trade nmc_usd"}],[{text:"NVC/BTC",callback_data:"trade nvc_btc"},{text:"NVC/USD",callback_data:"trade nvc_usd"},{text:"PPC/BTC",callback_data:"trade ppc_btc"}],[{text:"PPC/USD",callback_data:"trade ppc_usd"},{text:"DSH/BTC",callback_data:"trade dsh_btc"},{text:"DSH/USD",callback_data:"trade dsh_usd"}],[{text:"ETH/BTC",callback_data:"trade eth_btc"},{text:"ETH/USD",callback_data:"trade eth_usd"},{text:"ETH/EUR",callback_data:"trade eth_eur"}],[{text:"ETH/LTC",callback_data:"trade eth_ltc"},{text:"ETH/RUR",callback_data:"trade eth_rur"},{text:"USD/RUR",callback_data:"trade usd_rur"}],[{text:"EUR/USD",callback_data:"trade eur_usd"},{text:"EUR/RUR",callback_data:"trade eur_rur"}]]})},t=["Текущая пара: *"+T()+"*","`Внимание! На новой паре должны быть средства для торгов, иначе переключение завершится ошибкой!`","Новая торгая пара:"],m(t.join("\n"),e)):m("*Этот пункт не доступен для данной биржи*")}(),"Изменить отступ"===e.text&&function(){var e,t,n,a,o;r.offsetOrdersExponential?(e="%",t="Изменяет отсуп ордеров по экспоненте в %",n="Остальные: *"+r.offsetOrdersExponential+"%*"):r.offsetOrdersPercent?(e="%",t="Изменяет отсуп ордеров в процентах",n="Остальные: *"+r.offsetOrdersPercent+"%*"):r.rangeOffset?(e="%",t="Изменяет размер сетки ордеров в процентах",n="Разер сетки: *"+r.rangeOffset+"%*"):(e="",t="Изменяет отсуп первого ордера в процентах, всех остальных в пунктах.",n="Остальные: *"+r.offsetOrdersPoints+"*"),a={reply_markup:JSON.stringify({inline_keyboard:[[{text:"+ 0.1% First",callback_data:"offset_orders first_plus"},{text:"- 0.1% First",callback_data:"offset_orders first_minus"}],[{text:"+ 0.1"+e,callback_data:"offset_orders plus"},{text:"- 0.1"+e,callback_data:"offset_orders minus"}]]})},o=[t,"Текущий отступ:","Первый: *"+r.offsetFirstOrdersPercent+"%*",n].join("\n"),m(o,a)}(),"Авто выход из пары"===e.text&&function(){var e;r.oneOrdersSell?(A=0,_e=!0,e="Авто выход включен!"):e="На текущей стратегии данная функция недоступна!",m(e)}(),"Скорость"===e.text&&function(){var e,r;e={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Normal",callback_data:"speed normal"},{text:"Extra",callback_data:"speed extra"}]]})},r=["Влияет на плотность стека ордеров, размер спреда и время закрытия неиспользованных ордеров","Время действия "+t.declOfNum(I)+".","Текущая скорость: *"+ue+"*"].join("\n"),m(r,e)}(),"Состояние"===e.text&&function(){var e;e={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Пауза",callback_data:"worker pause"},{text:"Продолжить",callback_data:"worker continued"}]]})},m("Текущие состояние: "+(D?"Пауза":"Работает"),e)}(),"Модули"===e.text&&function(){var e;e={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Динам. время обновления "+(r.dynamicSettingsTime?"[Вкл]":"[Выкл]"),callback_data:"modules dynamic-settings-time"}],[{text:"Динам. распределение ордеров "+(r.dynamicOffsetOrders?"[Вкл]":"[Выкл]"),callback_data:"modules dynamic-offset-orders"}],[{text:"Определение тренда "+(r.trendDefinition?"[Вкл]":"[Выкл]"),callback_data:"modules trend-definition"}],[{text:"Контроль смены тренда "+(r.abruptChangeTrend?"[Вкл]":"[Выкл]"),callback_data:"modules abrupt-change-trend"}],[{text:"Стоп при большом изменении цены "+(r.dangerPriceStop?"[Вкл]":"[Выкл]"),callback_data:"modules danger-price-stop"}],[{text:"Включить все",callback_data:"modules all-modules-on"},{text:"Выключить все",callback_data:"modules all-modules-off"}],[{text:"Полосы Боллинджера "+(r.bbands?"[Вкл]":"[Выкл]"),callback_data:"modules bbands"}],[{text:"One Sell a lot Buy "+(r.oneOrdersSell?"[Вкл]":"[Выкл]"),callback_data:"modules one-orders-sell"}],[{text:"Лог "+(r.botLog?"[Вкл]":"[Выкл]"),callback_data:"modules bot-log"},{text:"Дебаг лог "+(r.logDebug?"[Вкл]":"[Выкл]"),callback_data:"modules log-debug"}]]})},m("*Модули обновления настроек:*",e)}(),"/info"===(null!=(u=e.text)?u.toLowerCase():void 0)&&function(){m(["Список команд:\n","/version - версия бота","/help - параметры которые можно менять через Telegram","/config - возможные параметры конфигурации через конфигурационный файл","/martin - теоретический расчет ордеров Мартингейла (параметры берутся из конфига)","/ticker coin_name - показывает котировку пары coin_name"].join("\n"),{format:!1})}(),"/version"===(null!=(c=e.text)?c.toLowerCase():void 0)&&function(){m("Версия бота: `"+r.versionBot+"`")}(),"/config"===(null!=(d=e.text)?d.toLowerCase():void 0)&&function(){var e;e=["Бот на паре: "+T(),"EXCHANGE: "+r.exchange+" | Выбор биржи btc-e или poloniex","POLONIEX_FEE: "+r.poloniexFee+" | Комиссия на сделки биржи POLONIEX","TIME_UPDATE_AUTO_SETTINGS: "+I+" | время обновления авто настроек параметров (в мин)","DEPOSIT_LIMIT_PERCENT: "+r.depositLimit.percent+" | процент использования депозита","DEPOSIT_LIMIT_CURRENCY: "+r.depositLimit.currency+" | использования депозита в валюте","NOTIFICATION_PAIR: "+r.notificationPair+" | пары для уведомления (или all/all для всех)","NOTIFICATION_DEVIATION_PERCENT: "+r.notificationDeviation+" | насколько процентов должен увеличиться спред чтобы сработало уведомление","COUNT_ORDERS: "+r.countOrders+" | количество ордеров","QUANTITY_ORDERS_IN_BLOCKS: "+r.quantityOrdersInBlocks+" | количество ордеров в блоке","TIME_CLOSE_ORDERS: "+r.timeCloseOrders+" | сколько минут ждать перед закрытием неисполнившихся ордеров","TIME_CLOSE_ORDERS_INACTIVITY: "+r.timeCloseOrdersInactivity+" | закрытие после бездействия","OFFSET_ORDERS_POINTS: "+r.offsetOrdersPoints+" | отступ ордеров в пунктах","OFFSET_ORDERS_PERCENT: "+r.offsetOrdersPercent+" | отступ для ордеров в %","OFFSET_ORDERS_EXPONENTIAL: "+r.offsetOrdersExponential+" | отступ для ордеров по экспоненте в %","OFFSET_FIRST_ORDERS_PERCENT: "+r.offsetFirstOrdersPercent+" | отступ первого ордера в %","RANGE_OFFSET: "+r.rangeOffset+" | диапазон смещения ордеров в %","SIZE_ORDERS_MARTINGALE: "+G+" | размер ордера в % Мартингейла","MARTINGALE_TYPE: "+r.martingaleType+" | тип Мартингейла","STEP_BREAKEVEN_PERCENT: "+r.stepBreakevenPercent+" | процент отступа безубытка для торгов","DANGER_PRICE_STOP: "+r.dangerPriceStop+" | остановка бота при большом изменении цены","DYNAMIC_SETTINGS_TIME: "+r.dynamicSettingsTime+" | динамическое время обновления настроек","DYNAMIC_OFFSET_ORDERS: "+r.dynamicOffsetOrders+" | динамическое распределение ордеров","TREND_DEFINITION: "+r.trendDefinition+" | определение тренда","ABRUPT_CHANGE_TREND: "+r.abruptChangeTrend+" | быстрое изменение направления тренда","BBANDS: "+r.bbands+" | Стратегия Полосы Боллинджера","BBANDS_DEVIATION: "+r.bbandsDeviation+" | Отклонение","BBANDS_INTERVAL: "+r.bbandsInterval+" | Таймфрейм (в мин)","ONE_ORDERS_SELL: "+r.oneOrdersSell+" | Стратегия One Sell a lot Buy","ONE_ORDERS_SELL_PERCENT: "+A+" | Задает процент желаемой прибыли","ONE_ORDERS_SELL_OFFSET: "+r.oneOrdersSellOffset+" | Разница между ценой LastPrice и первым ордером buy в стеке ордеров в %","INTEGRITY_CONTROL_ORDERS: "+r.integrityControlOrders+" | Контроль целостности ордеров (soft - мягкий, hard - жесткий)"],m(e.join("\n\n"),{format:!1})}(),"/help"===(null!=(p=e.text)?p.toLowerCase():void 0)&&function(){var e;e=["Бот на паре: "+T()+" | Exchange: "+r.exchange.toUpperCase(),"TIME_UPDATE_AUTO_SETTINGS="+I+" | время обновления авто настроек параметров (в мин)","OFFSET_ORDERS_POINTS="+r.offsetOrdersPoints+" | отступ для ордеров в пунктах","OFFSET_ORDERS_PERCENT="+r.offsetOrdersPercent+" | отступ для ордеров в процентах","RANGE_OFFSET= "+r.rangeOffset+" | диапазон смещения ордеров в %","OFFSET_FIRST_ORDERS_PERCENT="+r.offsetFirstOrdersPercent+" | отступ первого ордера в процентах","STEP_BREAKEVEN_PERCENT="+r.stepBreakevenPercent+" | процент отступа безубытка для торгов","TIME_CLOSE_ORDERS="+r.timeCloseOrders+" | сколько минут ждать перед закрытием неисполнившихся ордеров","COUNT_ORDERS="+r.countOrders+" | количество ордеров (бот будет переазгружен)","QUANTITY_ORDERS_IN_BLOCKS="+r.quantityOrdersInBlocks+" | количество ордеров в блоке","SIZE_ORDERS_MARTINGALE="+G+" | размер ордера мартингейла (проценты или абсолютное число)","DEPOSIT_LIMIT_PERCENT="+r.depositLimit.percent+" | процент использования депозита (бот будет перезагружен)","DEPOSIT_LIMIT_CURRENCY="+r.depositLimit.currency+" | использования депозита в валюте (бот будет перезагружен)","ONE_ORDERS_SELL_PERCENT="+A+" | Задает процент желаемой прибыли","ONE_ORDERS_SELL_OFFSET="+r.oneOrdersSellOffset+" | Разница между ценой LastPrice и первым ордером buy в стеке ордеров в процентах","RESTART_TRADER_TIME="+r.restartTraderTime+" | Через сколько секунд рестартовать воркер после ошибки","INTEGRITY_CONTROL_ORDERS="+r.integrityControlOrders+" | Контроль целостности ордеров (soft - мягкий, hard - жесткий)"],m(e.join("\n\n"),{format:!1})}(),/(\D+)=(\w+)/.test(e.text)&&function(){var t,n,a;if(t=e.text.split("="),t[0]=t[0].toUpperCase(),"TIME_UPDATE_AUTO_SETTINGS"===(n=t[0])||"OFFSET_ORDERS_POINTS"===n||"OFFSET_ORDERS_PERCENT"===n||"RANGE_OFFSET"===n||"OFFSET_FIRST_ORDERS_PERCENT"===n||"TIME_CLOSE_ORDERS"===n||"STEP_BREAKEVEN_PERCENT"===n||"DEPOSIT_LIMIT_PERCENT"===n||"DEPOSIT_LIMIT_CURRENCY"===n||"COUNT_ORDERS"===n||"QUANTITY_ORDERS_IN_BLOCKS"===n||"ONE_ORDERS_SELL_PERCENT"===n||"ONE_ORDERS_SELL_OFFSET"===n||"SIZE_ORDERS_MARTINGALE"===n||"RESTART_TRADER_TIME"===n||"INTEGRITY_CONTROL_ORDERS"===n){switch(a=o.camelCase(t[0]),t[0]){case"ONE_ORDERS_SELL_PERCENT":A=+t[1];break;case"SIZE_ORDERS_MARTINGALE":G=+t[1];break;case"DEPOSIT_LIMIT_PERCENT":r.depositLimit.percent=+t[1];break;case"DEPOSIT_LIMIT_CURRENCY":r.depositLimit.currency=+t[1];break;case"INTEGRITY_CONTROL_ORDERS":r.integrityControlOrders=t[1];break;default:r[a]=+t[1]}f.warn("SET "+t[0]+"="+t[1]),m("Настройки обновлены!"),"DEPOSIT_LIMIT_PERCENT"!==(n=t[0])&&"DEPOSIT_LIMIT_CURRENCY"!==n&&"COUNT_ORDERS"!==n||(D=!0,Be(r.tradeCurrency.pair,function(e){var r;null!=e?(r=g(e),f.error(r),m("`"+r+"`")):(D=!1,m("*Бот перезапущен!*"))}))}}(),"/martin"===(null!=(y=e.text)?y.toLowerCase():void 0)&&function(){var e,n,o,i,l,u,s;e=ee,n=!0,o=0,i=0,l=0,u=0,s="inverse"===r.directionCurrency?Ue(x.balance,"name"):Ue(x.balanceTwo,"nameTwo"),s+=x.cache*e,a.doWhilst(function(a){var c;return r.offsetFirstOrdersPercent&&n?(e-=U.first,n=!1):r.offsetOrdersExponential?(l+=r.offsetOrdersExponential,e=t.amountMinusPercent(e,l)):e-=Xe,o=s/e,r.sizeOrdersMartingale&&(i=i?1===r.martingaleType?t.amountPlusPercent(i,r.sizeOrdersMartingale):i+G:q),c=o>i?i:o,s=(o-c)*e,u++,a(null)},function(){return o>q},function(){var r,n;return r=t.percentageBetweenNumbers(ee,e),n=["*Данные расчета Мартингейла*:"],1===u&&s<=0?n.push("`Недостаточно средств!`"):(n.push(["Количество ордеров: "+u,"Последняя цена: "+t.rounded(e,se),"*Разница между LastPrice и последним ордером: "+r+"%*"].join("\n")),0<r&&r<=2&&n.push("`При таких настройках депозита хватит на "+r+"% хода цены вниз!!! Не мало ли?`")),m(n.join("\n\n"))})}(),/\/ticker (\w+)/.test(null!=(O=e.text)?O.toLowerCase():void 0)?function(){He(e.text.replace(/-|\//,"_").toLowerCase().substr(7).trim())}():void 0}),_.on("callback_query",function(e){if(e.from.id===r.myChatId)switch(!1){case!/trade (\w*_(usd|rur|eur|btc|ltc))/.test(e.data):Ae(e.data.substr(6));break;case!/speed (normal|extra)/.test(e.data):je(e.data.substr(6));break;case!/worker (continued|pause)/.test(e.data):qe(e.data.substr(7));break;case!/monitoring (start|stop)/.test(e.data):Je(e.data.substr(11));break;case!/notification (start|stop)/.test(e.data):Ye(e.data.substr(13));break;case!/type (buy|sell|all)/.test(e.data):Me(e.data.substr(5));break;case!/modules (\w*)/.test(e.data):Ge(e.data.substr(8));break;case!/offset_orders (plus|minus)/.test(e.data):case!/offset_orders (first_plus|first_minus)/.test(e.data):ze(e.data.substr(14));break;case!/close_orders_now/.test(e.data):Fe();break;default:He(e.data)}}),Fe=function(){m("Начато закрытие ордеров."),D=!0,L.all=1,setTimeout(function(){br(r.tradeCurrency.pair,function(e){var r,t;null!=e?0===e.success&&(null!=(r=null!=(t=e.error)?t.split("send:")[1]:void 0)?(b.setNonce(r),Fe()):m("`"+g(e)+"`")):(m("Активные ордера закрыты на паре: "+T()),ur(function(e){if(null!=e)return m("`"+g(e)+"`")})),D=!1})},i("2s"))},Ae=function(e){var t,n;m("Инициализировано изменение пары..."),D=!0,t=e.split("_")[0],n=e.split("_")[1],r.tradeCurrency.name===t&&r.tradeCurrency.nameTwo!==n?L.sell=1:r.tradeCurrency.name!==t&&r.tradeCurrency.nameTwo===n&&(L.buy=1),setTimeout(function(){br(r.tradeCurrency.pair,function(){r.tradeCurrency={name:t,nameTwo:n,pair:[t,n].join("_")},w=!0,ar(r.tradeCurrency.pair,function(e){var r,t;null!=e?(r=g(e),f.error(("Ошибка получения данных с сервера!\n"+r).red),t=["`Critical error: Ошибка получения данных с сервера!`","Бот поставлен на паузу, после обновления баланса необходимо перезапустить пару!","Ошибка: "+r].join("\n"),m(t),D=!0):(X=0,D=!1,m("Выполнено! Новая пара: "+T()))})})},i("5s"))},Me=function(e){pe="all"!==e,m("Выполнено! Новый тип "+(oe=e).toUpperCase())},je=function(e){er(e,function(){var r;return r=["Режим "+e.toUpperCase()+" включен.","Пара: "+T()],h=t.currentTime(),f.info(r[0]),m(r.join(" "))})},qe=function(e){m("Новое состояние: `"+((D="pause"===e)?"Пауза":"Работает")+"`. Пара: "+T())},ze=function(e){var n,a,o;n="plus"===e||"first_plus"===e?.1:-.1,"plus"!==e&&"minus"!==e||(r.offsetOrdersExponential?(r.offsetOrdersExponential=t.rounded(r.offsetOrdersExponential+n,1),r.offsetOrdersExponential>=.1||(r.offsetOrdersExponential=.1),a="Остальные: *"+r.offsetOrdersExponential+"%*"):r.offsetOrdersPercent?(r.offsetOrdersPercent=t.rounded(r.offsetOrdersPercent+n,1),r.offsetOrdersPercent>=.1||(r.offsetOrdersPercent=.1),a="Остальные: *"+r.offsetOrdersPercent+"%*"):r.rangeOffset?(r.rangeOffset=t.rounded(r.rangeOffset+n,1),r.rangeOffset>=.1||(r.rangeOffset=.1),a="Размер сетки: *"+r.rangeOffset+"%*"):(r.offsetOrdersPoints=t.rounded(r.offsetOrdersPoints+n,1),r.offsetOrdersPoints>=.1||(r.offsetOrdersPoints=.1),a="Остальные: *"+r.offsetOrdersPoints+"*")),"first_plus"!==e&&"first_minus"!==e||(r.offsetFirstOrdersPercent=t.rounded(r.offsetFirstOrdersPercent+n,1),r.offsetFirstOrdersPercent>=0||(r.offsetFirstOrdersPercent=0)),o=["Новый отступ на паре "+T()+":","Первый: *"+r.offsetFirstOrdersPercent+"%*",a||void 0].join("\n"),m(o+"")},Ge=function(e){var t,n;/\all-modules/.test(e)?(t="all-modules-on"===e,r.dynamicSettingsTime=t,r.dynamicOffsetOrders=t,r.trendDefinition=t,r.abruptChangeTrend=t,r.dangerPriceStop=t,r.dynamicSettingsTime||(I=r.timeUpdateAutoSettings),m("Все модули "+(t?"включены":"выключены")+"!")):("one-orders-sell"===e&&(r.bbands=!1),"bbands"===e&&(r.oneOrdersSell=!1),n=e.replace(/\-./g,function(e,r,t){return e.replace("-","").toUpperCase()}),r[n]=!r[n],m(e.replace(/\-/g,"_").toUpperCase()+": "+r[n],{format:!1}))},He=function(e){b.getTicker(e,function(n,a){var o,i,l,u,s,c,d,f,p,b,_;return null!=n?m("`"+g(n)+"`"):(o=tr.pairs[e].decimal_places,i=a[e].last,l=a[e].sell,u=a[e].buy,s=a[e].avg?a[e].avg:(l+u)/2,s=t.rounded(s,o),c=t.rounded(u-l,o),d=e.split("_")[1],f=xe(u,r.stepBreakevenPercent,o),p=c>f?"✔":"`✗`",b=i>s?"↑":"`↓`",_=[e.replace("_","/").toUpperCase()+":","sell: "+Ce(d)+l,"buy: "+Ce(d)+u,"last: "+Ce(d)+i,"avg: "+Ce(d)+s+" | "+b,"spread:   "+c+" | "+(c/f*100-100).toFixed()+"%","required: "+f+" "+p],m(_.join("\n")))})},Je=function(e){var r;Te.status="start"===e,clearInterval(Te.interval),Te.status?(r="Работает",Ve(),Te.interval=setInterval(function(){Ve()},i("5m"))):r="Остановлен",m("Новое состояние: "+r)},Ye=function(e){var r;null!=me&&me.length?(Oe.status="start"===e,clearInterval(Oe.interval),Oe.status?(r="Работает",Ke()):r="Остановлен",m("Новое состояние: "+r)):m("`Внимание! Конфиг для уведомлений не задан!`")},Ve=function(){var e;e=nr.join("-"),a.parallel([function(r){return b.getTicker(e,function(e,t){return null!=e?r(e):r(null,t)})},function(r){return b.getTrades(e,{limit:2},function(e,t){return null!=e?r(e):r(null,t)})}],function(e,n){var a,u,s,c,d,p;if(null!=e)return a=g(e),u="Error trading pairs available: "+a,m(u),void f.error(u.red);s=["Доступные пары для торгов:\n"],c=o.now(),d=l.range(c-i("1m"),c),p=0,nr.forEach(function(e){var a,o,i,l,u,c,f,b,_,y,O,T,E;a=e.split("_")[1],o=e.split("_")[0],i=tr.pairs[e].decimal_places,l=n[0][e].last,u=n[0][e].sell,c=n[0][e].buy,f=n[0][e].vol,b=n[0][e].vol_cur,_=n[0][e].avg?n[0][e].avg:(u+c)/2,_=t.rounded(_,i),y=t.rounded(c-u,i),O=xe(c,r.stepBreakevenPercent,i),T=l>_?"↑":"`↓`",E=!n[1][e][0].timestamp||d.contains(1e3*n[1][e][0].timestamp)&&d.contains(1e3*n[1][e][1].timestamp),y>O&&E&&(p++,s.push(e.replace("_","/").toUpperCase()+"\nprice: "+c+" - "+u+"\navg:   "+_+" | "+T+"\nvol:  "+b+" "+Ce(o)+"\nvol:  "+f+" "+Ce(a)+"\nspread:   "+t.noExp(y)+" | "+(y/O*100-100).toFixed()+"%\nrequired: "+t.noExp(O)+"\n")),p>=20&&(m(s.join("\n")),p=0,s=[])}),setTimeout(function(){s.length&&m(s.join("\n"))},i("2s"))})},Ke=function(){var n,a;null!=me&&me.length&&("all_all"===me[0]&&(me=nr),n=me.join("-"),a={},Oe.interval=setInterval(function(){b.getTicker(n,function(n,o){var l,u,s;return null==n?(s=0,u=[],me.forEach(function(n){var l,c,d,f,p,b,_,y,O,T,E,g;r.tradeCurrency.pair!==n&&e(n,nr)&&(a[n]||(l=tr.pairs[n].decimal_places,c=o[n].sell,d=o[n].buy,f=o[n].last,p=o[n].vol,b=o[n].vol_cur,_=o[n].avg?o[n].avg:(c+d)/2,_=t.rounded(_,l),(y=t.rounded(d-c,l))>xe(c,r.notificationDeviation,l)&&(s++,a[n]=!0,O=n.split("_")[1],T=n.split("_")[0],E=f<=c||f<=c+ve(3,l)?"down ↓":"up ↑",g=f>_?"↑":"`↓`",u.push(["Уведомление "+n.replace("_","/").toUpperCase()+":","directions: "+E,"sell: "+Ce(O)+c,"buy: "+Ce(O)+d,"last: "+Ce(O)+f,"avg: "+Ce(O)+_+" | "+g,"vol: "+b+" "+Ce(T),"vol: "+p+" "+Ce(O),"spread: "+t.noExp(y)+"\n"].join("\n"))),s>=15&&(m(u.join("\n")),s=0,u=[]),setTimeout(function(){a[n]=!1,a.error=!1},i("15m"))))}),setTimeout(function(){u.length&&m(u.join("\n"))},i("2s"))):(l=g(n),u="Error notification price: "+l,f.error(u.red),a.error?void 0:(m(u),a.error=!0))})},i("5s")))},We=function(r,n){var a,o,i,l;null==r&&(r=.993),null==n&&(n=!1),a={},o={},i={},l={},nr.forEach(function(e){var r;r=e.split(/\s*_\s*/),a[r[0]]?a[r[0]].push(r[1]):a[r[0]]=[r[1]]}),b.getTicker(nr.join("-"),function(u,s){var c,d,f;return null!=u?(c=g(u),m("`Error: "+c+"`")):(nr.forEach(function(e){o[e]=Pe(1,s[e].buy)}),nr.forEach(function(e){var r;r=e.split(/\s*_\s*/),a[r[0]].forEach(function(t){t!==r[1]&&(i[r[1]+"_"+r[0]+"_"+t]=he(o[e],s[r[0]+"_"+t].sell))})}),Object.keys(i).forEach(function(n){var a,o;e((a=n.split(/\s*_\s*/))[0]+"_"+a[2],nr)&&(o=Pe(i[n],s[a[0]+"_"+a[2]].buy)),e(a[2]+"_"+a[0],nr)&&(o=he(i[n],s[a[2]+"_"+a[0]].buy)),o>r&&(l[n+"_"+a[0]]=t.rounded(o,5))}),d=["Проверка возможных вариантов перепродаж.","Показаны значения больше: "+r,"Значения меньше 1 убыточны:\n"],f=[],Object.keys(l).forEach(function(e){f.push([e.replace(/\_/g,"->"),l[e]])}),f.length?f.sort(function(e,r){return r[1]-e[1]}).forEach(function(e){d.push(e.join(": "))}):d.push("Нет подходящих вариантов"),!n||f.length?m(d.join("\n")):void 0)})},er=function(e,t){var n;return null!=e&&(n=e),null==t&&(t=function(){}),n||(n=X>Z?"extra":"normal"),X=0,"extra"===n?(Xe=U.extra,Ze=U.extra,$e=j,Qe=60*r.timeCloseOrdersExtra):(Xe=U.buy,Ze=U.sell,$e=M,Qe=60*r.timeCloseOrders),ue=n,t()},rr=0,ar=function(e,r){return b.getInfo(function(t,n){if(null!=t)return r(t);try{tr=n,nr=Object.keys(n.pairs),se=n.pairs[e].decimal_places,fe=n.pairs[e].min_amount,ce=n.pairs[e].min_price,de=n.pairs[e].fee}catch(e){r("Not valid pair")}return o.delay(Be,i("3s"),e,function(t){var n,a;return t?(n=null!=(a=t.error)?a.split("send:")[1]:void 0,null!=n?(b.setNonce(n),ar(e,r)):(rr++,rr>=5?(rr=0,r(t)):ar(e,r))):r(null)})})},or=function(e,r){return b.ordersRequest(e,function(e,t){return null!=e&&"no orders"!==e.error?r(e):r(null,t)})},ir=function(e,r){return b.getTicker(e,function(n,a){var o,i,l,u;return null!=n?r(n):(o=a[e].last,i=a[e].sell,l=a[e].buy,u=t.rounded(l-i,se),Q=$e<=ve(2)?u>=$e:u>$e,r(null,{lastPrice:o,bidPrice:i,askPrice:l,spread:u}))})},lr=function(e,t){return Q?b.balanceRequest(e,function(e,n,a){return null!=e?t(e):(n=Ue(n,"name"),a=Ue(a,"nameTwo"),"all"===oe?n<fe&&a<fe?$<r.ecoCountCycle&&$++:$>0&&($=0):$=r.ecoCountCycle,t(null,{balance:n,balanceTwo:a}))}):t(null)},ur=function(e){return te?o.delay(b.balanceRequest,i("3s"),r.tradeCurrency,function(n,a,o){var i,l,u,s,c,d,f,p,b;return null!=n?e(n):(i=Ne(Ue(x.balance,"name"),Ue(x.balanceTwo,"nameTwo"),te),l=Ne(Ue(a,"name"),Ue(o,"nameTwo"),te),u=t.rounded(l.deposit-i.deposit,5),s=t.rounded(l.depositTwo-i.depositTwo,5),c=u>=0?u:"`"+u+"`",d=s>=0?s:"`"+s+"`",f=t.percentageBetweenNumbers(l.deposit,i.deposit),p=t.percentageBetweenNumbers(l.depositTwo,i.depositTwo),b=["*Анализ торговли за сессию:*",c+" "+Ce(r.tradeCurrency.name)+" | "+f+"%",d+" "+Ce(r.tradeCurrency.nameTwo)+" | "+p+"%","Установлено ордеров: "+Ee.ordersAll,"Исполнено ордеров: "+Ee.ordersExecuted,"Перезапусков: "+Ee.error],m(b.join("\n")),e(null))}):e(null)},sr=function(e,r){return or(e,function(e,n){var a;return null!=e?r(e):(V=null!=n?n:{},a=t.quantityOrdersType(V),W={buy:a.buy,sell:a.sell},r(null))})},cr=function(e,n){var a,i;return(a=o.findKey(V,["type","sell"]))&&t.rounded(F.amount-1e-7,8)>V[a].amount&&(f.info("SELL partially executed"),r.logDebug&&(i=[ge,"Старый sell: "+t.rounded(F.amount-1e-7,8)+"  Новый sell: "+V[a].amount,"Продано: "+t.rounded(t.rounded(F.amount-1e-7,8)-V[a].amount,8)+" "]),Y=V,F.amount=V[a].amount,Y["0000000001"]={rate:F.priceBuy,amount:F.amount},delete Y[a],z={buy:0,sell:0},B={buy:0,sell:0},r.logDebug&&f.info(i.join("\n"))),K=!1,!a&&F.id&&(f.info("SELL executed!"),L.buy=1,K=!0,F={},Y={},P=0,z={buy:0,sell:0},H={buy:0,sell:0},B={buy:0,sell:0},_e&&(D=!0,_e=!1,A=r.oneOrdersSellPercent,br(e,function(e){var r;null!=e&&f.error(g(e)),r="Авто выход завершен!  Бот поставлен на паузу!",f.warn(r),m("*"+r+"*"),ur(function(){})}))),n(null)},dr=function(e,n,i,l,u){var s;return s="inverse"===r.directionCurrency?n<fe||n*i<r.minSizeOrder:n<fe,s?u(null):0===o.size(Y)?u(null):a.series([function(e){return L.sell=1,br(l,e)},function(e){var a,i,l,u,s,c,d,p,b,_,m;return a=[],i=o.keys(V),l=o.keys(Y),u=o.difference(l,i),r.logDebug&&a.push([ge,"Открытые ордера: "+i,"В кэше: "+l,"Купленные: "+u].join("\n")),s=0,c=0,d=0,u.forEach(function(e){d++,s+=+Y[e].amount,c+=+Y[e].amount*+Y[e].rate,r.logDebug&&a.push("Ордер "+d+": "+e+"  Количество: "+ +Y[e].amount+"  Цена: "+ +Y[e].rate)}),d>0?(F.priceBuy=c/s,r.logDebug&&a.push(["Сумма: "+c+"  Общий объем: "+s+"  Объем с комиссией: "+t.rounded(t.amountMinusPercent(s,de),8),"Средняя цена покупки: "+F.priceBuy].join("\n")),p=t.amountPlusPercent(c,2.5*de+A)/s,r.logDebug&&a.push(["Коммисия: "+de+"  Процент юзера: "+A+"   Общий процент: "+(2*de+A),"Увеличенная сумма на процент: "+t.amountPlusPercent(c,2*de+A),"Цена продажи: "+p].join("\n")),b=o.findKey(V,["type","sell"]),r.logDebug&&a.push(["Сумма с баланса биржи: "+n,b?"Сумма на открытом ордере SELL: "+V[b].amount:void 0].join("\n")),_=n,"hard"===r.integrityControlOrders&&(m=t.amountMinusPercent(s,de),_=n>=m?n:m,a.push("Разница между кэшем и балансом биржи: "+t.rounded(m-n))),b&&(_=n+V[b].amount),r.logDebug&&(a.push("Общая сумма продажи: "+_),f.info(a.join("\n"))),F.amount=_,e(null,{rate:p,amount:_})):e(null,{rate:0,amount:0})}],function(r,t){return null!=r?u(r):t[1].rate>0?pr(e,t[1].rate,t[1].amount,l,function(e){return u(null!=e?e:null)}):u(null)})},fr=function(e,n,i,l,u){var s,c,d;if("inverse"===r.directionCurrency?n<fe||n*i<r.minSizeOrder:n<fe)return u(null);if(be)return u(null);if(r.quantityOrdersInBlocks){if(r.quantityOrdersInBlocks<=W[e])return u(null);s=!0}return c=!0,J={buy:-1,sell:-1},"all"===oe||oe===e?(void 0!==d&&null!==d||(d=i),a.doWhilst(function(a){var u,p,b;return ie?("sell"===e&&(d-=Ze),"buy"===e&&(d+=Xe),n/=2,pr(e,d,n,l,a)):(r.logDebug&&(u=[ge]),"buy"===e?(r.oneOrdersSell&&(S||s)&&(S=!1,s=!1,o.isEmpty(V)||(c=!1,p=t.searchRate(V,"min"),o.isObject(p)&&p.rate<i&&(d=p.rate),r.logDebug&&u.push("Последняя цена в стеке: "+d))),r.offsetFirstOrdersPercent&&c?(d-=U.first,r.logDebug&&u.push("Цена рынка: "+i+"   Цена First ордера: "+d),c=!1):r.offsetOrdersExponential?(r.logDebug&&u.push(["Отступ Exponential: Прошлый: "+B[e],"Новый: "+t.rounded(B[e]+r.offsetOrdersExponential,8)].join("  ")),B[e]=B[e]+r.offsetOrdersExponential,d=t.amountMinusPercent(d,B[e])):d-=Xe,n=-1===J.buy?n:J.buy/d,r.logDebug&&(-1===J.buy?u.push("Общий объем: "+n):u.push(["Остаточный баланс: "+J.buy,"Цена: "+t.rounded(d,8),"Общий объем: "+t.rounded(J.buy/d,8)].join("   ")))):(r.offsetFirstOrdersPercent&&c?(d+=U.first,r.logDebug&&u.push("Цена First ордера: "+t.rounded(d,8)),c=!1):r.offsetOrdersExponential?(r.logDebug&&u.push(["Отступ Exponential: Прошлый: "+B[e],"Новый: "+t.rounded(B[e]+r.offsetOrdersExponential,8)].join("  ")),B[e]=B[e]+r.offsetOrdersExponential,d=t.amountPlusPercent(d,B[e])):d+=Ze,n=-1===J.sell?n:J.sell,r.logDebug&&(-1===J.sell?u.push("Общий объем: "+n):u.push(["Остаточный баланс: "+J.sell,"Цена: "+t.rounded(d,8),"Общий объем: "+J.sell].join("  ")))),r.sizeOrdersMartingale?(z[e]?(r.logDebug&&(1===r.martingaleType?u.push(["Размер ордера: "+t.rounded(z[e],8),"Размер мартина: "+r.sizeOrdersMartingale,"Новый размер ордера: "+t.rounded(t.amountPlusPercent(z[e],r.sizeOrdersMartingale),8)].join("  ")):u.push(["Размер ордера: "+t.rounded(z[e],8),"Размер мартина: "+G,"Новый размер ордера: "+t.rounded(z[e]+G,8)].join("  "))),z[e]=1===r.martingaleType?t.amountPlusPercent(z[e],r.sizeOrdersMartingale):z[e]+G):z[e]=q,H[e]&&(r.logDebug&&u.push(["Кеш мартина: "+t.rounded(H[e],8),"Старый размер ордера: "+t.rounded(z[e],8)].join("  ")),z[e]=H[e],H[e]=0),b=n>z[e]?z[e]:n,r.logDebug&&u.push(["Баланс: "+t.rounded(n,8),"Размер ордера: "+t.rounded(z[e],8)].join("  "))):(b=n>q?q:n,r.logDebug&&u.push(["Баланс: "+t.rounded(n,8),"Размер ордера: "+t.rounded(q,8)].join("  "))),r.logDebug&&(u.push("Новый размер ордера: "+t.rounded(b,8)+"  "+(t.rounded(b,8)<.01?"| Ордер не установлен":"")),f.info(u.join("\n"))),pr(e,d,b,l,a))},function(){return!(r.quantityOrdersInBlocks&&r.quantityOrdersInBlocks<=W[e])&&n>q},function(e){return u(null!=e?e:null)})):u(null)},pr=function(e,n,a,i,l){var u;return(n=t.rounded(n,se))>=ce||(n=ce),a=t.rounded(a-1e-7,8),u="inverse"===r.directionCurrency?a<fe||a*n<r.minSizeOrder:a<fe,u?l(null):b.tradeSetOrder(i,e,n,a,function(t,i){var u,s,c;return null!=t?(r.sizeOrdersMartingale&&(H[e]=z[e]),S=!0,u=g(t),f.error(("Error: "+u+" | "+e+" | rate: "+n+" | amount: "+a).red),l(t)):(s=0!=i.order_id?i.order_id:o.random(1e3,2e3),r.oneOrdersSell&&("buy"===e&&(Y[s]={rate:n,amount:a}),"sell"===e&&(F.id=s)),r.quantityOrdersInBlocks&&W[e]++,c="Open: "+e+" | id: "+s+" | rate: "+n+" | amount: "+a,f.info("buy"===e?c.green:c.yellow),"buy"===e?J.buy="inverse"===r.directionCurrency?Ue(i.funds[r.tradeCurrency.name],"name"):Ue(i.funds[r.tradeCurrency.nameTwo],"nameTwo"):J.sell="inverse"===r.directionCurrency?Ue(i.funds[r.tradeCurrency.nameTwo],"nameTwo"):Ue(i.funds[r.tradeCurrency.name],"name"),X++,Ee.ordersAll++,Ee.ordersExecuted++,l(null))})},br=function(e,r){return b.ordersRequest(e,function(e,n){var o,i,l;return P=t.currentTime(),null!=e?0===e.success&&null==(null!=(o=e.error)?o.split("send:")[1]:void 0)?(i=g(e),f.warn(("Cancel orders: "+i).yellow),r(null)):r(e):(l=Object.keys(n),a.eachSeries(l,function(e,r){if(null==L.all){if(null!=L.buy&&"sell"===n[e].type)return r(null);if(null!=L.sell&&"buy"===n[e].type)return r(null)}return P-n[e].timestamp_created>(L.buy||L.sell||L.all||60)?_r(e,n[e].type,n[e].amount,n[e].rate,r):r(null)},function(e){return L={all:null,buy:null,sell:null},r(null!=e?e:null)}))})},_r=function(e,t,n,a,o){return b.tradeCancelOrder({order_id:e},function(i,l){return null!=i?o(i):(r.oneOrdersSell&&(delete Y[e],"sell"===t&&(F.id=0)),f.info(("Close: "+t+" | id: "+e+" | rate: "+a+" | amount: "+n).cyan),X>0&&X--,Ee.ordersExecuted>0&&Ee.ordersExecuted--,o(null))})},mr=function(){pe||t.timeIsOver(P,r.timeCloseOrdersInactivity)&&br(r.tradeCurrency.pair,function(e){null!=e&&f.error("Orders inactivity: "+g(e))})},yr=function(){var e;t.timeIsOver(k,10)&&(e="Unknown error: Worker does not meet!",f.warn(e.red),Tr({error:e}))},Or=function(){k=t.currentTime(),D?setTimeout(function(){Or()},i("30s")):a.series([function(e){return ir(r.tradeCurrency.pair,e)},function(e){return lr(r.tradeCurrency,e)}],function(e,t){var n,l,u,s;n=t[0],l=t[1],null!=e?(u=g(e),null!=(null!=(s=e.error)?s.split("send:")[1]:void 0)?f.warn(u):f.error(("ErrorData: "+u).red),Tr(e)):(w&&Le(n.askPrice,n.bidPrice,n.lastPrice,function(){return w=!1}),Q?a.series([function(e){return I>0&&k-h>60*I?Le(n.askPrice,n.bidPrice,n.lastPrice,e):e(null)},function(e){return k-P>Qe?br(r.tradeCurrency.pair,e):e(null)},function(e){return r.quantityOrdersInBlocks||r.oneOrdersSell?o.delay(sr,i("3s"),r.tradeCurrency.pair,e):e(null)},function(e){return r.botTrade&&C&&r.oneOrdersSell?cr(r.tradeCurrency.pair,e):e(null)},function(e){var t,a;return r.oneOrdersSell&&K?e(null):r.botTrade&&C?(t=ie?le.ask:n.askPrice,a="inverse"===r.directionCurrency?l.balanceTwo:l.balance,r.oneOrdersSell?dr("sell",a,t,r.tradeCurrency.pair,e):(z.sell=0,B.sell=0,fr("sell",a,t,r.tradeCurrency.pair,e))):e(null)},function(e){var t,a;return r.oneOrdersSell&&K?e(null):r.botTrade&&C?(t=ie?le.bid:n.bidPrice,a="inverse"===r.directionCurrency?l.balance/t:l.balanceTwo/t,r.oneOrdersSell?S||W.buy||(z.buy=0,B.buy=0):(z.buy=0,B.buy=0),fr("buy",a,t,r.tradeCurrency.pair,e)):e(null)}],function(e){var t;null!=e?(t=g(e),f.error(("ErrorTrader: "+t).red),Tr(e)):$===r.ecoCountCycle?setTimeout(function(){Or()},i("2s")):Or()}):setTimeout(function(){Or()},i("5s")))})},Tr=function(e){var t,n,a,l,u;a="restart after "+(n=null!=(n=(t=g(e)).match(/timeout to (.*) seconds/))?o.parseInt(n[1])+10:r.restartTraderTime)+" sec ...",f.warn(a),null==(l=null!=(u=e.error)?u.split("send:")[1]:void 0)&&(v.count++,v.text!==t&&(v.text=t,r.isEmail&&"production"===process.env.NODE_ENV&&O(E(t+"\n\n"+a),function(e,r){})),r.notificationErrorCount&&v.count>r.notificationErrorCount&&(m("`Слишком много ошибок API. Требуется внимание пользователя!`"),v.count=0)),setTimeout(function(){f.warn("trader restart"),Ee.error++,null!=l&&b.setNonce(l),Or()},i(n+"s"))},function(){r.myChatId||r.telegramOff?(f.info("Trader Bot starting..."),f.info("Exchange: "+r.exchange.toUpperCase()+" | v."+r.versionBot),ar(r.tradeCurrency.pair,function(e){var t;return null!=e&&(t=g(e),f.error(("Error getting parameters from the server!\n"+t).red),process.exit(0)),Or(),r.botTrade&&setInterval(function(){mr(),yr(),v.count=0},i("5m")),setInterval(function(){Ie()},i(10*r.bbandsInterval+"s")),"production"===process.env.NODE_ENV&&m("Trader Bot started. Pair "+T()),f.info("Trader Bot started")})):f.warn("Get the user id in the Telegram")}()):f.warn("There is no token Telegram!")}).call(this);