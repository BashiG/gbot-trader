(function(){function e(e,t){for(var r=-1,n=t.length>>>0;++r<n;)if(e===t[r])return!0;return!1}var t,r,n,a,l,o,i,u,c,s,d,p,f,b,_,y,m,T,O,E,g,x,C,S,R,k,v,h,I,N,D,P,w,L,U,B,F,j,A,M,q,z,G,H,J,Y,V,K,W,X,Z,Q,$,ee,te,re,ne,ae,le,oe,ie,ue,ce,se,de,pe,fe,be,_e,ye,me,Te,Oe,Ee,ge,xe,Ce,Se,Re,ke,ve,he,Ie,Ne,De,Pe,we,Le,Ue,Be,Fe,je,Ae,Me,qe,ze,Ge,He,Je,Ye,Ve,Ke,We,Xe,Ze,Qe,$e,et,tt,rt,nt,at,lt,ot,it,ut,ct,st,dt,pt,ft,bt,_t,yt,mt,Tt,Ot,Et,gt,xt,Ct,St,Rt,kt,vt,ht,It;t=require("./conf"),r=require("./api-btc-e"),n=require("./api-poloniex"),a=require("./log"),l=require("async"),o=require("lodash"),require("colors"),i=require("ms"),u=require("moment"),c=require("moment-range"),s=require("nodemailer"),d=require("node-telegram-bot-api"),p=require("ta-lib"),f=new a,u=c.extendMoment(u),t.tokenTelegram||t.telegramOff?(b="poloniex"===t.exchange?new n:new r,_=t.tokenTelegram&&!t.telegramOff?new d(t.tokenTelegram,{polling:!0}):new(function(){function e(){}e.prototype;return e.prototype.on=function(){},e.prototype.sendMessage=function(){},e}()),y=function(e,r){null==r&&(r={}),e.length>4096&&(e="*Слишком много информации для отображения*"),e.length||(e="*Error: Не удалось обработать ошибку*"),!1!==r.format&&(r.parse_mode="markdown"),delete r.format,_.sendMessage(t.myChatId,e,r)},m=s.createTransport(t.email),T=function(e,t){return m.sendMail(e,t)},O=function(){return t.tradeCurrency.pair.replace("_","/").toUpperCase()},E=function(e){return{from:t.email.auth.user,to:t.email.reportEmail,subject:"Error Script Trader",text:"time: "+(new Date).toString()+"\nPair: "+O()+"\n\nmessage: "+e+"\n\n---"}},x=function(e){var t;return t="",Object.keys(e).forEach(function(r){if(e.hasOwnProperty(r))return t+=r+" :: "+e[r]+"\n"}),t},C=function(e){return"object"==typeof e?e.hasOwnProperty("error")?e.error:e.hasOwnProperty("message")?e.message:x(e):e},S=!0,R={count:0,text:""},k=!1,v={name:0,nameTwo:0},h=(g=function(){return Math.round((new Date).getTime()/1e3)})(),I=g(),N=g(),D=t.timeUpdateAutoSettings,P=!0,w=!1,L=0,U={all:null,buy:null,sell:null},B={extra:0,buy:0,sell:0,first:0},F=t.oneOrdersSellPercent,j=0,A=0,M=0,q={buy:0,sell:0},z={buy:0,sell:0},G={buy:0,sell:0},H={},J={},Y={id:0,priceBuy:0,amount:0},V={},K=!1,W={buy:0,sell:0},X=0,Z=!1,Q=0,$=0,ee=0,te=0,re=[],ne=[],ae={},le="all",oe=!1,ie={ask:0,bid:0},ue="normal",ce=0,se=0,de=0,pe=0,fe=0,be=!1,_e=!1,ye=!1,me=null!=(Te=t.notificationPair)?Te.toLowerCase().replace(/\//g,"_").split(/\s*,\s*/):void 0,Oe={status:!1,interval:!1},Ee={status:!1,interval:!1},ge={btc:"฿",usd:"$",eur:"€",rur:"₽",ltc:"L"},xe="-----------------------------------",Ce=function(e){return ge.hasOwnProperty(e)?ge[e]:e+" "},Se=function(e,t){return g()-e>=60*t},Re=function(e,t){var r,n,a;return null!=t&&(r=t),r||(r=e>=1?["минута","минуты","минут"]:["секунда","секунды","секунд"],e=e<1?60*e:e),n=[2,0,1,1,1,2],a=r[e%100>4&&e%100<20?2:n[e%10<5?e%10:5]],e+" "+a},ke=function(e,t){return null==t&&(t=3),+(+e).toFixed(t)},ve=function(e){return e.toFixed(10).replace(/(.*0\.0*[1-9]*)0+\d*/g,"$1")},he=function(e,t){var r,n,a;return r=[],o.forIn(e,function(e,t){r.push(e)}),n=r.sort(function(e,t){return t.rate-e.rate}),a=o.findKey(n,function(e){return e.rate<=t}),n[a]},Ie=function(e){var t,r;return t=0,r=0,o.forIn(e,function(e,n){"buy"===e.type&&t++,"sell"===e.type&&r++}),{buy:t,sell:r}},Ne=function(e,t){var r,n;return r=[],o.forIn(e,function(e,n){"min"===t&&"buy"!==e.type||"max"===t&&"sell"!==e.type||r.push(e)}),n=r.sort(function(e,t){return t.rate-e.rate}),"min"===t?o.last(n):o.head(n)},De=function(e,t){return t>0?+(100*e/t).toFixed(1):0},Pe=function(e,t){return e*(1+t/100)},we=function(e,t){return e*(1-t/100)},Le=function(e,t){return null==t&&(t=ce),ke(e/+("1e"+t),t)},Ue=function(e,t){return null==t&&(t=ce),ke(e*+("1e"+t),t)},Be=function(e,t,r){var n,a;return null==t&&(t=0),null==r&&(r=ce),n=e/100*de*2,a=Math.ceil(n*+("1e"+r))/+("1e"+r),ke(Pe(a,t),r)},Fe=function(e,t){return ke(Pe(e,t),ce)},je=function(e,t){return ke(we(e,t),ce)},Ae=function(e,t){return we(e/t,de)},Me=function(e,t){return we(e*t,de)},qe=function(){t.bbands&&te>0&&(ne.push(te),ne.length>30&&ne.splice(0,1))},ze=function(e,t){var r,n;return r=e/100*t,n=1/+("1e"+ce),t>0&&(r>=n||(r=n)),ke(r,ce)},Ge=function(e,t){var r,n,a;null==t&&(t=1),r=e.toString().split(".")[0];try{n=e.toString().split(".")[1].length}catch(e){e,n=1}return a=r>0?r>1e4?+("1e"+(n+1)):r>1e3?+("1e"+n):r>100?+("1e"+(n-1)):r>10?+("1e"+(n-2)):n>3?+("1e"+(n-3)):1:1,t*=a,ke(t/+("1e"+n),n)},He=function(e,r,n,a){var l,i,u,c,s,d,b,_,m,T,E,x,C,R,k,v,h,F,M,z,G,H,J,K,W,X,Z,Q,ae,ye,me,Te,Oe,Ee,ge,Ce,Se;return N=g(),U={buy:null,sell:null},l=e.toString().length,i=r.toString().length,c={},c[l+""]=e,c[i+""]=r,u=c,s=Math.max(l,i),d=u[s],ce=dt.pairs[t.tradeCurrency.pair].decimal_places,pe=dt.pairs[t.tradeCurrency.pair].min_amount,se=dt.pairs[t.tradeCurrency.pair].min_price,de=dt.pairs[t.tradeCurrency.pair].fee,b=ke(e-r,ce),_=Be(d,200),t.dynamicSettingsTime&&(re.push(n),re.length>50&&re.splice(0,1),m=o.max(re),T=o.min(re),t.botLog&&f.info([xe,"price-array:","length: "+re.length,"max: "+m,"min: "+T,"change-time-settings: "+(De(m,T)>102)].join("\n")),De(m,T)>102?D=.1:D!==t.timeUpdateAutoSettings&&(D=t.timeUpdateAutoSettings)),t.abruptChangeTrend&&(E=Be(d,500)),t.dangerPriceStop&&(x=Fe(ee,9),C=je($,9)),t.dynamicOffsetOrders&&(k=b>=(R={current:Be(d,450),prev:Be(d,380),prev_2:Be(d,300)}).current||b>=R.prev||b>=R.prev_2),t.dynamicOffsetOrders&&k?(f.info("Dynamic market"),v=Ge(d,Ue(R.current)),h=1.5*t.stepBreakevenPercent):(v=Ge(d,t.offsetOrdersPoints),h=t.stepBreakevenPercent),v=function(){switch(!1){case!t.offsetOrdersPercent:return ze(d,t.offsetOrdersPercent);case!t.rangeOffset:return ze(d,ke(t.rangeOffset/t.countOrders,2));default:return v}}(),F=1.3*v,M=ze(d,t.offsetFirstOrdersPercent),z=t.offsetOrdersPercent?ze(d):2,j=function(){switch(!1){case!t.bbands:case!t.oneOrdersSell:return 0;default:return Be(d,h)}}(),t.botLog&&(f.info(xe),f.info("current-spread:",(ve(b)+"")[b>j?"green":"white"]),f.info("spread-min-default:",ve(j)),f.info("trend-spread:",ve(_)),t.abruptChangeTrend&&f.info("immediate-spread:",E),f.info("trader-speed:",ue),f.info("price-prev:",ee+" - "+$),f.info("price-prev2:",ie.ask+" - "+ie.bid),t.dangerPriceStop&&(f.info("danger-price-ask:",x,!P&&e>=x?"Attention!".red:""),f.info("danger-price-bid:",C,!P&&r<=C?"Attention!".red:"")),t.dynamicOffsetOrders&&(f.info("spread_1_450:",R.current,b>=R.current?"Attention!".red:""),f.info("spread_2_380:",R.prev,b>=R.prev?"Attention!".red:""),f.info("spread_3_300:",R.prev_2,b>=R.prev_2?"Attention!".red:""),f.info("dynamic-market:",k))),t.dangerPriceStop&&!P&&(e>=x||r<=C)?(e>=x&&(U.buy=1),I=0,w=!0,G="DANGER PRICE: "+e+" - "+r+" | Bot Pause!",f.warn(G),void y("`"+G+"`")):(H=z,J=L>Math.round(fe/2)?F:v,t.botLog&&(f.info("offset-max-one:",(ve(v)+"")[v===J?"green":"yellow"]),f.info("offset-type-max:",ve(J)),t.offsetFirstOrdersPercent&&f.info("offset-first-orders:",ve(M)),f.info(xe)),be||(le="all",oe=!1),P?(t.bbands&&(S=!1),K=W=J):t.oneOrdersSell?(K=W=J,t.timeCloseOrders=1e5,t.timeCloseOrdersInactivity=t.timeCloseOrders,(X=he(V,r))&&r>Fe(X.rate,t.oneOrdersSellOffset)&&!Y.id&&(U.buy=1,I=0,q={buy:0,sell:0})):t.bbands?(K=W=J,D=.1,Z=14,ne.length>2*Z&&(Q=(c=p.BBANDS(ne,20,t.bbandsDeviation)).middleband,ae=c.lowband,ye=c.highband,me=p.RSI(o.clone(ne).reverse(),Z),Te=p.average(me).mean,Oe=p.average(Q).mean,Ee=p.average(ye).mean,ge=p.average(ae).mean,Ce=Ee>n&&n>Oe,Se=Oe>n&&n>ge,Ce&&(be||(le="sell"),S=99>Te&&Te>70),Se&&(be||(le="buy"),S=1<Te&&Te<30),_e=Ce&&Se,t.botLog&&f.info(["BBANDS:","highband: "+Ee,"middleband: "+Oe,"lowband: "+ge,"rsa: "+Te,"sell: "+Ce,"buy: "+Se,"bot trade: "+S,"orders-calculation-brake: "+_e,xe].join("\n")))):t.trendDefinition&&r>$&&e>ee&&b>_&&"normal"===ue?(f.info("Trend: UP"),K=H,W=J,be||(le="buy",U.sell=1,I=0,t.abruptChangeTrend&&b>E&&(f.info("Spread Immediate"),oe=!0,N=0))):t.trendDefinition&&r<$&&e<ee&&b>_&&"normal"===ue?(f.info("Trend: DOWN"),K=J,W=H,be||(le="sell",U.buy=1,I=0,t.abruptChangeTrend&&b>E&&(f.info("Spread Immediate"),oe=!0,N=0))):K=W=J,ie={ask:ee,bid:$},$=r,ee=e,te=n,A=Be(d),B={buy:K,sell:W,extra:Ge(d),first:M},ct(null,function(){return f.info("Update: "+le.toUpperCase()+" | "+e+" - "+r+" | "+n+" | "+O()),a(null)}))},Je=function(e,t){var r,n;return r="name"===t?v.name:v.nameTwo,n=e-r,n>0?n:0},Ye=function(e,r){return l.parallel([function(r){return t.botLog&&f.info(xe+"\nПолучение цен"),b.getTicker(e,function(n,a){return null!=n?(t.botLog&&(f.error("Price: "+a[e].buy),f.error(C(n))),r(n)):r(null,{price:a[e].buy})})},function(r){return l.series([function(r){return t.botLog&&f.info(xe+"\nЗакрытие всех позиций"),U.all=1,St(e,function(e){return r(null!=e?e:null)})},function(e){return t.botLog&&f.info(xe+"\nПолучение баланса"),o.delay(b.balanceRequest,i("500"),t.tradeCurrency,function(r,n,a){return null!=r?(t.botLog&&(f.error("balance: "+n+" | balance-two: "+a),f.error(C(r))),e(r)):t.botTrade&&n<.001&&a<.001?(t.botLog&&f.error("balance: "+n+" | balance-two: "+a),e({error:"Err: No money!"})):e(null,{balance:n,balanceTwo:a})})}],function(e,t){return null!=e?r(e):r(null,{balance:t[1].balance,balanceTwo:t[1].balanceTwo})})}],function(e,n){var a,l,o,i,u,c,s,d,p,b,_,y,m,T,O,E,g;return null!=e?r(e):(ae=n[1],t.botLog&&f.info(xe+"\nРасчет депозита"),t.oneOrdersSell&&("poloniex"===t.exchange?(a=n[1].balanceTwo,n[1].balanceTwo=0):(a=n[1].balance,n[1].balance=0)),"poloniex"===t.exchange?(l=n[1].balanceTwo*n[0].price+n[1].balance,o=n[1].balance/n[0].price+n[1].balanceTwo):(l=n[1].balanceTwo/n[0].price+n[1].balance,o=n[1].balance*n[0].price+n[1].balanceTwo),u=t.depositLimit.currency?o>(i="poloniex"===t.exchange?t.depositLimit.currency/n[0].price:t.depositLimit.currency)?ke(100/(o/i),2):100:t.depositLimit.percent,c=0<u&&u<100?u:100,s=l*c/100,d=o*c/100,100===c?(t.botLog&&f.info("type:",0),p=0,b=0):n[1].balance>=s&&n[1].balanceTwo>=d?(t.botLog&&f.info("type:",1),p=n[1].balance-s/2,b=n[1].balanceTwo-d/2):n[1].balance>=s&&n[1].balanceTwo<d?(t.botLog&&f.info("type:",2),p="poloniex"===t.exchange?n[1].balance-(d-n[1].balanceTwo)*n[0].price:n[1].balance-(d-n[1].balanceTwo)/n[0].price,b=0):n[1].balance<s&&n[1].balanceTwo>=d?(t.botLog&&f.info("type:",3),p=0,b="poloniex"===t.exchange?n[1].balanceTwo-(s-n[1].balance)/n[0].price:n[1].balanceTwo-(s-n[1].balance)*n[0].price):n[1].balance<s&&n[1].balanceTwo<d&&(t.botLog&&f.info("type:",4),"poloniex"===t.exchange?(p=n[1].balance-(d-n[1].balanceTwo)*n[0].price,b=n[1].balanceTwo-(s-n[1].balance)/n[0].price):(p=n[1].balance-(d-n[1].balanceTwo)/n[0].price,b=n[1].balanceTwo-(s-n[1].balance)*n[0].price)),t.botLog&&(_=De(p,n[1].balance),y=De(b,n[1].balanceTwo),f.info(["reserved-deposit:",t.tradeCurrency.name.toUpperCase(),_+"% / "+y+"%",t.tradeCurrency.nameTwo.toUpperCase()].join(" "))),t.oneOrdersSell&&("poloniex"===t.exchange?b=a:p=a),v={name:p>0?p:0,nameTwo:b>0?b:0},m="poloniex"===t.exchange?d:s,t.countOrders?t.countOrders>=3||(t.countOrders=3):t.countOrders=m<=10?6:m<=200?15:m<=500?18:m<=1e3?21:25,T="poloniex"===t.exchange?t.poloniexMinOrders/n[0].price:pe+.001,fe=t.countOrders*t.multiplierOrdersExtra,t.sizeOrdersMartingale?1===t.martingaleType?(O=1+t.sizeOrdersMartingale/100,E=m/((Math.pow(O,t.countOrders)-1)/(O-1))):(X=t.sizeOrdersMartingale,E=m/t.countOrders-(t.countOrders-1)*X/2):E=m/t.countOrders,M=ke(E>T?E:T,ce),t.botLog&&(g=t.depositLimit.currency?t.depositLimit.currency+" "+("poloniex"===t.exchange?t.tradeCurrency.name.toUpperCase():t.tradeCurrency.nameTwo.toUpperCase()):t.depositLimit.percent+" %",f.info([xe+"\nРасчет переменных","Strategy: "+function(){switch(!1){case!t.oneOrdersSell:return"One Sell a lot Buy";case!t.bbands:return"BBANDS";default:return"Scalper"}}(),"balance: "+ke(n[1].balance)+" "+t.tradeCurrency.name.toUpperCase(),"balance-two: "+ke(n[1].balanceTwo)+" "+Ce(t.tradeCurrency.nameTwo),"deposit: "+l+" "+t.tradeCurrency.name.toUpperCase()+" или "+o+" "+t.tradeCurrency.nameTwo.toUpperCase(),"deposit-limit: "+g,"trade-deposit: "+s+" "+t.tradeCurrency.name.toUpperCase()+" | "+d+" "+t.tradeCurrency.nameTwo.toUpperCase(),"reserved-deposit: "+ke(v.name)+" "+t.tradeCurrency.name.toUpperCase()+" | "+ke(v.nameTwo)+" "+t.tradeCurrency.nameTwo.toUpperCase(),"count-orders: "+t.countOrders,"quantity-orders-in-blocks: "+(t.quantityOrdersInBlocks?t.quantityOrdersInBlocks:"OFF"),"size-static-order: "+M,"size-orders-martingale: "+(t.sizeOrdersMartingale?t.sizeOrdersMartingale:"OFF")+"    Тип: "+(1===t.martingaleType?"Exponential":"Linear"),xe].join("\n"))),r(null))})},_.on("message",function(e){var r,n,a,i,u,c,s,d,p,m,T,E;if(r=e.chat.id,t.myChatId||_.sendMessage(r,"Install your Telegram id: `"+r+"`",{parse_mode:"markdown"}),r===t.myChatId){if("Ордера"===e.text&&(n=function(){l.series([function(e){return b.balanceRequest(t.tradeCurrency,function(t,r,n){return null!=t?e(t):e(null,{balance:r,balanceTwo:n})})},function(e){return b.ordersRequest(t.tradeCurrency.pair,function(t,r){return null!=t?e(t):e(null,{data:r})})}],function(e,r){var a,l,i,u,c,s,d,p,f,_,m,T;a=[O()+":",xe],l="Balance: "+(null!=(i=r[0])?i.balance.toFixed(3):void 0)+" "+t.tradeCurrency.name.toUpperCase()+" | "+Ce(t.tradeCurrency.nameTwo)+(null!=(u=r[0])?u.balanceTwo.toFixed(3):void 0),null!=e?0===e.success?null!=(c=null!=(s=e.error)?s.split("send:")[1]:void 0)?(b.setNonce(c),n()):(d=C(e),a.push(d+"\n"+xe+"\n"+l),y(a.join("\n"))):y(e):(p={},f=0,_=0,m={},Object.keys(r[1].data).forEach(function(e){var n,a,l;n=r[1].data[e].rate*+("1e"+ce),null!=m[n]?(a=" | "+ ++p[n],l=ke(ke(m[n].split("|")[1].trim())+ke(r[1].data[e].amount)),m[n]=r[1].data[e].type+" | "+l+" | "+Ce(t.tradeCurrency.nameTwo)+r[1].data[e].rate+a):(p[n]=1,m[n]=r[1].data[e].type+" | "+ke(r[1].data[e].amount)+" | "+Ce(t.tradeCurrency.nameTwo)+r[1].data[e].rate),f+=r[1].data[e].amount,_+=r[1].data[e].amount*r[1].data[e].rate}),(a=o.concat(a,o.values(m))).push(xe+"\nCount: "+ke(f)+" | Sum: "+Ce(t.tradeCurrency.nameTwo)+ke(_)+"\n"+l),T=a.join("\n"),y(T))})})(),"История"===e.text&&(a=function(){b.tradeGetHistory(t.tradeCurrency.pair,10,function(e,r){var n,l,o;return null!=e?0===e.success?(n=null!=(l=e.error)?l.split("send:")[1]:void 0,null!=n?(b.setNonce(n),a()):y(C(e))):y(C(e)):(o=[],Object.keys(r).forEach(function(e){o.push(r[e].type+" | "+r[e].amount.toFixed(3)+" | "+Ce(t.tradeCurrency.nameTwo)+r[e].rate)}),o.push(O()+":\n"+xe),o.reverse(),y(o.join("\n")))})})(),"Закрыть активные ордера"===e.text&&(i={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Закрыть ордера!",callback_data:"close_orders_now"}]]})},y("*Вы уверены что хотите закрыть ордера?*",i)),"/start"!==(u=null!=(c=e.text)?c.toLowerCase():void 0)&&"главное меню"!==u||(i={reply_markup:JSON.stringify({keyboard:[[{text:"Ордера"},{text:"Котировки"},{text:"История"}],[{text:"Контроль"},{text:"Нотис"},{text:"Торговля"}],[{text:"Закрыть активные ордера"}]],resize_keyboard:!0})},y("Выберите:",i)),"Котировки"===e.text){if("btc-e"!==t.exchange)return void y("*Этот пункт не доступен для данной биржи*");i={reply_markup:JSON.stringify({keyboard:[[{text:"USD"},{text:"BTC"},{text:"OTHER"}],[{text:"Главное меню"}]],resize_keyboard:!0})},y("Валюта:",i)}if("Торговля"===e.text&&(i={reply_markup:JSON.stringify({keyboard:[[{text:"Сменить пару"},{text:"Тип"}],[{text:"Авто выход из пары"}],[{text:"Главное меню"}]],resize_keyboard:!0})},y("Выберите:",i)),"USD"===e.text&&(i={reply_markup:JSON.stringify({inline_keyboard:[[{text:"NMC",callback_data:"nmc_usd"},{text:"PPC",callback_data:"ppc_usd"},{text:"NVC",callback_data:"nvc_usd"},{text:"LTC",callback_data:"ltc_usd"},{text:"BTC",callback_data:"btc_usd"}],[{text:"DSH",callback_data:"dsh_usd"},{text:"ETH",callback_data:"eth_usd"},{text:"EUR",callback_data:"eur_usd"},{text:"RUR",callback_data:"usd_rur"}]]})},y("Символ:",i)),"BTC"===e.text&&(i={reply_markup:JSON.stringify({inline_keyboard:[[{text:"NMC",callback_data:"nmc_btc"},{text:"PPC",callback_data:"ppc_btc"},{text:"NVC",callback_data:"nvc_btc"},{text:"LTC",callback_data:"ltc_btc"}],[{text:"DSH",callback_data:"dsh_btc"},{text:"ETH",callback_data:"eth_btc"},{text:"RUR",callback_data:"btc_rur"},{text:"EUR",callback_data:"btc_eur"}]]})},y("Символ:",i)),"OTHER"===e.text&&(i={reply_markup:JSON.stringify({inline_keyboard:[[{text:"ETH/LTC",callback_data:"eth_ltc"},{text:"ETH/EUR",callback_data:"eth_eur"},{text:"ETH/RUR",callback_data:"eth_rur"}],[{text:"LTC/RUR",callback_data:"ltc_rur"},{text:"LTC/EUR",callback_data:"ltc_eur"},{text:"EUR/RUR",callback_data:"eur_rur"}]]})},y("Пара:",i)),"Контроль"===e.text&&(i={reply_markup:JSON.stringify({keyboard:[[{text:"Скорость"},{text:"Состояние"},{text:"Модули"}],[{text:"Главное меню"}]],resize_keyboard:!0})},y("Выберите:",i)),"Нотис"===e.text&&(i={reply_markup:JSON.stringify({keyboard:[[{text:"Мониторинг"},{text:"Уведомление"}],[{text:"Круг"}],[{text:"Главное меню"}]],resize_keyboard:!0})},y("Выберите:",i)),"Мониторинг"===e.text&&(i={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Старт",callback_data:"monitoring start"},{text:"Стоп",callback_data:"monitoring stop"}]]})},s=Ee.status?"Работает.":"Остановлен.",y((d=["Включает мониторинг возможных торговых пар. Уведомление раз в 5 минут.","Текущие состояние: "+s]).join("\n"),i)),"Уведомление"===e.text&&(i={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Старт",callback_data:"notification start"},{text:"Стоп",callback_data:"notification stop"}]]})},s=Oe.status?"Работает.":"Остановлен.",y((d=["Включает уведомления о скачках курса.","Текущие состояние: "+s]).join("\n"),i)),"Круг"===e.text&&at(),"Тип"===e.text&&(i={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Only buy",callback_data:"type buy"},{text:"Only sell",callback_data:"type sell"},{text:"Buy & Sell",callback_data:"type all"}]]})},d=["Текущий тип торговли "+le.toUpperCase(),"Новый тип:"],y(d.join("\n"),i)),"Сменить пару"===e.text){if("btc-e"!==t.exchange)return void y("*Этот пункт не доступен для данной биржи*");i={reply_markup:JSON.stringify({inline_keyboard:[[{text:"BTC/USD",callback_data:"trade btc_usd"},{text:"BTC/RUR",callback_data:"trade btc_rur"},{text:"BTC/EUR",callback_data:"trade btc_eur"}],[{text:"LTC/BTC",callback_data:"trade ltc_btc"},{text:"LTC/USD",callback_data:"trade ltc_usd"},{text:"LTC/RUR",callback_data:"trade ltc_rur"}],[{text:"LTC/EUR",callback_data:"trade ltc_eur"},{text:"NMC/BTC",callback_data:"trade nmc_btc"},{text:"NMC/USD",callback_data:"trade nmc_usd"}],[{text:"NVC/BTC",callback_data:"trade nvc_btc"},{text:"NVC/USD",callback_data:"trade nvc_usd"},{text:"PPC/BTC",callback_data:"trade ppc_btc"}],[{text:"PPC/USD",callback_data:"trade ppc_usd"},{text:"DSH/BTC",callback_data:"trade dsh_btc"},{text:"DSH/USD",callback_data:"trade dsh_usd"}],[{text:"ETH/BTC",callback_data:"trade eth_btc"},{text:"ETH/USD",callback_data:"trade eth_usd"},{text:"ETH/EUR",callback_data:"trade eth_eur"}],[{text:"ETH/LTC",callback_data:"trade eth_ltc"},{text:"ETH/RUR",callback_data:"trade eth_rur"},{text:"USD/RUR",callback_data:"trade usd_rur"}],[{text:"EUR/USD",callback_data:"trade eur_usd"},{text:"EUR/RUR",callback_data:"trade eur_rur"}]]})},d=["Текущая пара: *"+O()+"*","`Внимание! На новой паре должны быть средства для торгов, иначе переключение завершится ошибкой!`","Новая торгая пара:"],y(d.join("\n"),i)}return"Авто выход из пары"===e.text&&(t.oneOrdersSell?(F=0,ye=!0,d="Авто выход включен!"):d="На текущей стратегии данная функция недоступна!",y(d)),"Скорость"===e.text&&(i={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Normal",callback_data:"speed normal"},{text:"Extra",callback_data:"speed extra"}]]})},d=["Влияет на плотность стека ордеров, размер спреда и время закрытия неиспользованных ордеров","Время действия "+Re(D)+".","Текущая скорость: *"+ue+"*"].join("\n"),y(d,i)),"Состояние"===e.text&&(i={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Пауза",callback_data:"worker pause"},{text:"Продолжить",callback_data:"worker continued"}]]})},y("Текущие состояние: "+(s=w?"Пауза":"Работает"),i)),"Модули"===e.text&&(i={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Динам. время обновления "+(t.dynamicSettingsTime?"[Вкл]":"[Выкл]"),callback_data:"modules dynamic-settings-time"}],[{text:"Динам. распределение ордеров "+(t.dynamicOffsetOrders?"[Вкл]":"[Выкл]"),callback_data:"modules dynamic-offset-orders"}],[{text:"Определение тренда "+(t.trendDefinition?"[Вкл]":"[Выкл]"),callback_data:"modules trend-definition"}],[{text:"Контроль смены тренда "+(t.abruptChangeTrend?"[Вкл]":"[Выкл]"),callback_data:"modules abrupt-change-trend"}],[{text:"Стоп при большом изменении цены "+(t.dangerPriceStop?"[Вкл]":"[Выкл]"),callback_data:"modules danger-price-stop"}],[{text:"Включить все",callback_data:"modules all-modules-on"},{text:"Выключить все",callback_data:"modules all-modules-off"}],[{text:"Полосы Боллинджера "+(t.bbands?"[Вкл]":"[Выкл]"),callback_data:"modules bbands"}],[{text:"One Sell a lot Buy "+(t.oneOrdersSell?"[Вкл]":"[Выкл]"),callback_data:"modules one-orders-sell"}],[{text:"Лог "+(t.botLog?"[Вкл]":"[Выкл]"),callback_data:"modules bot-log"},{text:"Дебаг лог "+(t.logDebug?"[Вкл]":"[Выкл]"),callback_data:"modules log-debug"}]]})},y("*Модули обновления настроек:*",i)),"/info"===(null!=(u=e.text)?u.toLowerCase():void 0)&&y((d=["Список команд:\n","/version - версия бота","/help - параметры которые можно менять через Telegram","/config - возможные параметры конфигурации через конфигурационный файл","/martin - теоретический расчет ордеров Мартингейла (параметры берутся из конфига)"]).join("\n")),"/version"===(null!=(p=e.text)?p.toLowerCase():void 0)&&y("Версия бота: `"+t.versionBot+"`"),"/config"===(null!=(m=e.text)?m.toLowerCase():void 0)&&(d=["Бот на паре: "+O(),"EXCHANGE: "+t.exchange+" | Выбор биржи btc-e или poloniex","POLONIEX_FEE: "+t.poloniexFee+" | Комиссия на сделки биржи POLONIEX","TIME_UPDATE_AUTO_SETTINGS: "+D+" | время обновления авто настроек параметров (в мин)","DEPOSIT_LIMIT_PERCENT: "+t.depositLimit.percent+" | процент использования депозита","DEPOSIT_LIMIT_CURRENCY: "+t.depositLimit.currency+" | использования депозита в валюте","NOTIFICATION_PAIR: "+t.notificationPair+" | пары для уведомления (или all/all для всех)","NOTIFICATION_DEVIATION_PERCENT: "+t.notificationDeviation+" | насколько процентов должен увеличиться спред чтобы сработало уведомление","COUNT_ORDERS: "+t.countOrders+" | количество ордеров","QUANTITY_ORDERS_IN_BLOCKS: "+t.quantityOrdersInBlocks+" | количество ордеров в блоке","TIME_CLOSE_ORDERS: "+t.timeCloseOrders+" | сколько минут ждать перед закрытием неисполнившихся ордеров","TIME_CLOSE_ORDERS_INACTIVITY: "+t.timeCloseOrdersInactivity+" | закрытие после бездействия","OFFSET_ORDERS_POINTS: "+t.offsetOrdersPoints+" | отступ ордеров в пунктах","OFFSET_ORDERS_PERCENT: "+t.offsetOrdersPercent+" | отступ для ордеров в %","OFFSET_ORDERS_EXPONENTIAL: "+t.offsetOrdersExponential+" | отступ для ордеров по экспоненте в %","OFFSET_FIRST_ORDERS_PERCENT: "+t.offsetFirstOrdersPercent+" | отступ первого ордера в %","RANGE_OFFSET: "+t.rangeOffset+" | диапазон смещения ордеров в %","SIZE_ORDERS_MARTINGALE: "+X+" | размер ордера в % Мартингейла","MARTINGALE_TYPE: "+t.martingaleType+" | тип Мартингейла","STEP_BREAKEVEN_PERCENT: "+t.stepBreakevenPercent+" | процент отступа безубытка для торгов","DANGER_PRICE_STOP: "+t.dangerPriceStop+" | остановка бота при большом изменении цены","DYNAMIC_SETTINGS_TIME: "+t.dynamicSettingsTime+" | динамическое время обновления настроек","DYNAMIC_OFFSET_ORDERS: "+t.dynamicOffsetOrders+" | динамическое распределение ордеров","TREND_DEFINITION: "+t.trendDefinition+" | определение тренда","ABRUPT_CHANGE_TREND: "+t.abruptChangeTrend+" | быстрое изменение направления тренда","BBANDS: "+t.bbands+" | Стратегия Полосы Боллинджера","BBANDS_DEVIATION: "+t.bbandsDeviation+" | Отклонение","BBANDS_INTERVAL: "+t.bbandsInterval+" | Таймфрейм (в мин)","ONE_ORDERS_SELL: "+t.oneOrdersSell+" | Стратегия One Sell a lot Buy","ONE_ORDERS_SELL_PERCENT: "+F+" | Задает процент желаемой прибыли","ONE_ORDERS_SELL_OFFSET: "+t.oneOrdersSellOffset+" | Разница между ценой LastPrice и первым ордером buy в стеке ордеров в %","INTEGRITY_CONTROL_ORDERS: "+t.integrityControlOrders+" | Контроль целостности ордеров (soft - мягкий, hard - жесткий)"],y(d.join("\n\n"),{format:!1})),"/help"===(null!=(T=e.text)?T.toLowerCase():void 0)&&(d=["Бот на паре: "+O(),"Exchange: "+t.exchange.toUpperCase(),"TIME_UPDATE_AUTO_SETTINGS="+D+" | время обновления авто настроек параметров (в мин)","OFFSET_ORDERS_POINTS="+t.offsetOrdersPoints+" | отступ для ордеров в пунктах","OFFSET_ORDERS_PERCENT="+t.offsetOrdersPercent+" | отступ для ордеров в процентах","OFFSET_FIRST_ORDERS_PERCENT="+t.offsetFirstOrdersPercent+" | отступ первого ордера в процентах","STEP_BREAKEVEN_PERCENT="+t.stepBreakevenPercent+" | процент отступа безубытка для торгов","TIME_CLOSE_ORDERS="+t.timeCloseOrders+" | сколько минут ждать перед закрытием неисполнившихся ордеров","COUNT_ORDERS="+t.countOrders+" | количество ордеров (бот будет переазгружен)","QUANTITY_ORDERS_IN_BLOCKS="+t.quantityOrdersInBlocks+" | количество ордеров в блоке","SIZE_ORDERS_MARTINGALE="+X+" | размер ордера мартингейла (проценты или абсолютное число)","DEPOSIT_LIMIT_PERCENT="+t.depositLimit.percent+" | процент использования депозита (бот будет перезагружен)","DEPOSIT_LIMIT_CURRENCY="+t.depositLimit.currency+" | использования депозита в валюте (бот будет перезагружен)","ONE_ORDERS_SELL_PERCENT="+F+" | Задает процент желаемой прибыли","ONE_ORDERS_SELL_OFFSET="+t.oneOrdersSellOffset+" | Разница между ценой LastPrice и первым ордером buy в стеке ордеров в процентах","RESTART_TRADER_TIME="+t.restartTraderTime+" | Через сколько секунд рестартовать воркер после ошибки","INTEGRITY_CONTROL_ORDERS="+t.integrityControlOrders+" | Контроль целостности ордеров (soft - мягкий, hard - жесткий)"],y(d.join("\n\n"),{format:!1})),/(\D+)=(\w+)/.test(e.text)&&function(){var r,n,a;if(r=e.text.split("="),r[0]=r[0].toUpperCase(),"TIME_UPDATE_AUTO_SETTINGS"===(n=r[0])||"OFFSET_ORDERS_POINTS"===n||"OFFSET_ORDERS_PERCENT"===n||"OFFSET_FIRST_ORDERS_PERCENT"===n||"TIME_CLOSE_ORDERS"===n||"STEP_BREAKEVEN_PERCENT"===n||"DEPOSIT_LIMIT_PERCENT"===n||"DEPOSIT_LIMIT_CURRENCY"===n||"COUNT_ORDERS"===n||"QUANTITY_ORDERS_IN_BLOCKS"===n||"ONE_ORDERS_SELL_PERCENT"===n||"ONE_ORDERS_SELL_OFFSET"===n||"SIZE_ORDERS_MARTINGALE"===n||"RESTART_TRADER_TIME"===n||"INTEGRITY_CONTROL_ORDERS"===n){switch(a=o.camelCase(r[0]),r[0]){case"ONE_ORDERS_SELL_PERCENT":F=+r[1];break;case"SIZE_ORDERS_MARTINGALE":X=+r[1];break;case"DEPOSIT_LIMIT_PERCENT":t.depositLimit.percent=+r[1];break;case"DEPOSIT_LIMIT_CURRENCY":t.depositLimit.currency=+r[1];break;case"INTEGRITY_CONTROL_ORDERS":t.integrityControlOrders=r[1];break;default:t[a]=+r[1]}f.warn("SET "+r[0]+"="+r[1]),y("Настройки обновлены!"),"DEPOSIT_LIMIT_PERCENT"!==(n=r[0])&&"DEPOSIT_LIMIT_CURRENCY"!==n&&"COUNT_ORDERS"!==n||(w=!0,Ye(t.tradeCurrency.pair,function(e){w=!1,y("*Бот перезапущен!*")}))}}(),"/martin"===(null!=(E=e.text)?E.toLowerCase():void 0)?function(){var e,r,n,a,o,i,u;return e="poloniex"===t.exchange?Je(ae.balance,"name"):Je(ae.balanceTwo,"nameTwo"),r=$,n=!0,a=0,o=0,i=0,u=0,l.doWhilst(function(l){var c;return t.offsetFirstOrdersPercent&&n?(r-=B.first,n=!1):t.offsetOrdersExponential?(i+=t.offsetOrdersExponential,r=we(r,i)):r-=lt,a=e/r,t.sizeOrdersMartingale&&(o=o?1===t.martingaleType?Pe(o,t.sizeOrdersMartingale):o+X:M),c=a>o?o:a,e=(a-c)*r,u++,l(null)},function(){return a>M},function(){var t,n;return t=ke(De($,r)-100,2),n=["*Данные расчета Мартингейла*:"],1===u&&e<=0?n.push("`Недостаточно средств!`"):(n.push(["Количество ордеров: "+u,"Последняя цена: "+ke(r,ce),"*Разница между LastPrice и последним ордером: "+t+"%*"].join("\n")),0<t&&t<=2&&n.push("`При таких настройках депозита хватит на "+t+"% хода цены вниз!!! Не мало ли?`")),y(n.join("\n\n"))})}():void 0}}),_.on("callback_query",function(e){e.from.id===t.myChatId&&(/trade (\w*_(usd|rur|eur|btc|ltc))/.test(e.data)?Ke(e.data.substr(6)):/speed (normal|extra)/.test(e.data)?Xe(e.data.substr(6)):/worker (continued|pause)/.test(e.data)?Ze(e.data.substr(7)):/monitoring (start|stop)/.test(e.data)?et(e.data.substr(11)):/notification (start|stop)/.test(e.data)?tt(e.data.substr(13)):/type (buy|sell|all)/.test(e.data)?We(e.data.substr(5)):/modules (\w*)/.test(e.data)?Qe(e.data.substr(8)):/close_orders_now/.test(e.data)?Ve():$e(e.data))}),Ve=function(){y("Начато закрытие ордеров."),w=!0,U.all=1,setTimeout(function(){St(t.tradeCurrency.pair,function(e){var t,r;null!=e?0===e.success&&(null!=(t=null!=(r=e.error)?r.split("send:")[1]:void 0)?(b.setNonce(t),Ve()):y(C(e))):y("Активные ордера закрыты на паре: "+O()),w=!1})},i("2s"))},Ke=function(e){var r,n;y("Инициализировано изменение пары..."),w=!0,r=e.split("_")[0],n=e.split("_")[1],t.tradeCurrency.name===r&&t.tradeCurrency.nameTwo!==n?U.sell=1:t.tradeCurrency.name!==r&&t.tradeCurrency.nameTwo===n&&(U.buy=1),setTimeout(function(){St(t.tradeCurrency.pair,function(){t.tradeCurrency={name:r,nameTwo:n,pair:[r,n].join("_")},P=!0,ft(t.tradeCurrency.pair,function(e){var t,r;null!=e?(t=C(e),f.error(("Ошибка получения данных с сервера!\n"+t).red),r=["`Critical error: Ошибка получения данных с сервера!`","Бот поставлен на паузу, после обновления баланса необходимо перезапустить пару!","Ошибка: "+t].join("\n"),y(r),w=!0):(L=0,w=!1,y("Выполнено! Новая пара: "+O()))})})},i("5s"))},We=function(e){be="all"!==e,y("Выполнено! Новый тип "+(le=e).toUpperCase())},Xe=function(e){ct(e,function(){var t;return t=["Режим "+e.toUpperCase()+" включен.","Пара: "+O()],N=g(),f.info(t[0]),y(t.join(" "))})},Ze=function(e){y("Новое состояние: "+((w="pause"===e)?"Пауза":"Работает")+". Пара: "+O())},Qe=function(e){var r,n;/\all-modules/.test(e)?(r="all-modules-on"===e,t.dynamicSettingsTime=r,t.dynamicOffsetOrders=r,t.trendDefinition=r,t.abruptChangeTrend=r,t.dangerPriceStop=r,t.dynamicSettingsTime||(D=t.timeUpdateAutoSettings),y("Все модули "+(r?"включены":"выключены")+"!")):("one-orders-sell"===e&&(t.bbands=!1),"bbands"===e&&(t.oneOrdersSell=!1),n=e.replace(/\-./g,function(e,t,r){return e.replace("-","").toUpperCase()}),t[n]=!t[n],y(e.replace(/\-/g,"_").toUpperCase()+": "+t[n],{format:!1}))},$e=function(e){b.getTicker(e,function(r,n){var a,l,o,i,u,c,s,d,p,f,b;return null!=r?y(C(r)):(a=dt.pairs[e].decimal_places,l=n[e].last,o=n[e].sell,i=n[e].buy,u=ke(n[e].avg,a),c=ke(i-o,a),s=e.split("_")[1],d=Be(i,t.stepBreakevenPercent,a),p=c>d?"✔":"`✗`",f=l>u?"↑":"↓",b=[e.replace("_","/").toUpperCase()+":","sell: "+Ce(s)+o,"buy: "+Ce(s)+i,"last: "+Ce(s)+l,"avg: "+Ce(s)+u+" | "+f,"spread:   "+c+" | "+(c/d*100-100).toFixed()+"%","required: "+d+" "+p],y(b.join("\n")))})},et=function(e){var t;Ee.status="start"===e,clearInterval(Ee.interval),Ee.status?(t="Работает",rt(),Ee.interval=setInterval(function(){rt()},i("5m"))):t="Остановлен",y("Новое состояние: "+t)},tt=function(e){var t;null!=me&&me.length?(Oe.status="start"===e,clearInterval(Oe.interval),Oe.status?(t="Работает",nt()):t="Остановлен",y("Новое состояние: "+t)):y("`Внимание! Конфиг для уведомлений не задан!`")},rt=function(){var e;e=pt.join("-"),l.parallel([function(t){return b.getTicker(e,function(e,r){return null!=e?t(e):t(null,r)})},function(t){return b.getTrades(e,{limit:2},function(e,r){return null!=e?t(e):t(null,r)})}],function(e,r){var n,a,l,o,c,s;if(null!=e)return n=C(e),a="Error trading pairs available: "+n,y(a),void f.error(a.red);l=["Доступные пары для торгов:\n"],o=(new Date).getTime(),c=u.range(o-i("1m"),o),s=0,pt.forEach(function(e){var n,a,o,i,u,d,p,f,b,_,m,T,O;n=e.split("_")[1],a=e.split("_")[0],o=dt.pairs[e].decimal_places,i=r[0][e].last,u=r[0][e].sell,d=r[0][e].buy,p=r[0][e].vol,f=r[0][e].vol_cur,b=r[0][e].avg?r[0][e].avg:(u+d)/2,b=ke(b,o),_=ke(d-u,o),m=Be(d,t.stepBreakevenPercent,o),T=i>b?"↑":"↓",O=!r[1][e][0].timestamp||c.contains(1e3*r[1][e][0].timestamp)&&c.contains(1e3*r[1][e][1].timestamp),_>m&&O&&(s++,l.push(e.replace("_","/").toUpperCase()+"\nprice: "+d+" - "+u+"\navg:   "+b+" | "+T+"\nvol:  "+f+" "+Ce(a)+"\nvol:  "+p+" "+Ce(n)+"\nspread:   "+ve(_)+" | "+(_/m*100-100).toFixed()+"%\nrequired: "+ve(m)+"\n")),s>=20&&(y(l.join("\n")),s=0,l=[])}),setTimeout(function(){l.length&&y(l.join("\n"))},i("2s"))})},nt=function(){var r,n;null!=me&&me.length&&("all_all"===me[0]&&(me=pt),r=me.join("-"),n={},Oe.interval=setInterval(function(){b.getTicker(r,function(r,a){var l,o,u;return null==r?(u=0,o=[],me.forEach(function(r){var l,c,s,d,p,f,b,_,m,T,O,E;t.tradeCurrency.pair!==r&&e(r,pt)&&(n[r]||(l=dt.pairs[r].decimal_places,c=a[r].sell,s=a[r].buy,d=a[r].last,p=a[r].vol,f=a[r].vol_cur,b=a[r].avg?a[r].avg:(c+s)/2,b=ke(b,l),(_=ke(s-c,l))>Be(c,t.notificationDeviation,l)&&(u++,n[r]=!0,m=r.split("_")[1],T=r.split("_")[0],O=d<=c||d<=c+Le(3,l)?"down ↓":"up ↑",E=d>b?"↑":"↓",o.push(["Уведомление "+r.replace("_","/").toUpperCase()+":","directions: "+O,"sell: "+Ce(m)+c,"buy: "+Ce(m)+s,"last: "+Ce(m)+d,"avg: "+Ce(m)+b+" | "+E,"vol: "+f+" "+Ce(T),"vol: "+p+" "+Ce(m),"spread: "+ve(_)+"\n"].join("\n"))),u>=15&&(y(o.join("\n")),u=0,o=[]),setTimeout(function(){n[r]=!1,n.error=!1},i("15m"))))}),setTimeout(function(){o.length&&y(o.join("\n"))},i("2s"))):(l=C(r),o="Error notification price: "+l,f.error(o.red),n.error?void 0:(y(o),n.error=!0))})},i("5s")))},at=function(t,r){var n,a,l,o;null==t&&(t=.993),null==r&&(r=!1),n={},a={},l={},o={},pt.forEach(function(e){var t;t=e.split(/\s*_\s*/),n[t[0]]?n[t[0]].push(t[1]):n[t[0]]=[t[1]]}),b.getTicker(pt.join("-"),function(i,u){var c,s,d;if(null!=i)return c=C(i),y("Error: "+c);if(pt.forEach(function(e){a[e]=Ae(1,u[e].buy)}),pt.forEach(function(e){var t;t=e.split(/\s*_\s*/),n[t[0]].forEach(function(r){r!==t[1]&&(l[t[1]+"_"+t[0]+"_"+r]=Me(a[e],u[t[0]+"_"+r].sell))})}),Object.keys(l).forEach(function(r){var n,a;e((n=r.split(/\s*_\s*/))[0]+"_"+n[2],pt)&&(a=Ae(l[r],u[n[0]+"_"+n[2]].buy)),e(n[2]+"_"+n[0],pt)&&(a=Me(l[r],u[n[2]+"_"+n[0]].buy)),a>t&&(o[r+"_"+n[0]]=ke(a,5))}),s=["Проверка возможных вариантов перепродаж.","Показаны значения больше: "+t,"Значения меньше 1 убыточны:\n"],d=[],Object.keys(o).forEach(function(e){d.push([e.replace(/\_/g,"->"),o[e]])}),d.length?d.sort(function(e,t){return t[1]-e[1]}).forEach(function(e){s.push(e.join(": "))}):s.push("Нет подходящих вариантов"),!r||d.length)return y(s.join("\n"))})},ct=function(e,r){var n;return null!=e&&(n=e),null==r&&(r=function(){}),n||(n=L>fe?"extra":"normal"),L=0,"extra"===n?(lt=B.extra,ot=B.extra,ut=A,it=60*t.timeCloseOrdersExtra):(lt=B.buy,ot=B.sell,ut=j,it=60*t.timeCloseOrders),ue=n,r()},st=0,ft=function(e,t){return b.getInfo(function(r,n){if(null!=r)return t(r);try{dt=n,pt=Object.keys(n.pairs),ce=n.pairs[e].decimal_places,pe=n.pairs[e].min_amount,se=n.pairs[e].min_price,de=n.pairs[e].fee}catch(e){e,t("Not valid pair")}return Ye(e,function(r){var n,a;return r?(n=null!=(a=r.error)?a.split("send:")[1]:void 0,null!=n?(b.setNonce(n),ft(e,t)):(st++,st>5?(st=0,t(r)):ft(e,t))):t(null)})})},bt=function(e,t){return b.ordersRequest(e,function(e,r){return null!=e&&"no orders"!==e.error?t(e):t(null,r)})},_t=function(e,t){return b.getTicker(e,function(r,n){var a,l,o,i;return null!=r?t(r):(a=n[e].last,l=n[e].sell,o=n[e].buy,i=ke(o-l,ce),Z=ut<=Le(2)?i>=ut:i>ut,t(null,{lastPrice:a,bidPrice:l,askPrice:o,spread:i}))})},yt=function(e,r){return Z?b.balanceRequest(e,function(e,n,a){return null!=e?r(e):(n=Je(n,"name"),a=Je(a,"nameTwo"),"all"===le?n<pe&&a<pe?Q<t.ecoCountCycle&&Q++:Q>0&&(Q=0):Q=t.ecoCountCycle,r(null,{balance:n,balanceTwo:a}))}):r(null)},mt=function(e,t){return bt(e,function(e,r){var n;return null!=e?t(e):(V=null!=r?r:{},n=Ie(V),W={buy:n.buy,sell:n.sell},t(null))})},Tt=function(e){var r,n;return(r=o.findKey(V,["type","sell"]))&&ke(Y.amount-1e-7,8)>V[r].amount&&(f.info("SELL partially executed"),t.logDebug&&(n=[xe,"Старый sell: "+ke(Y.amount-1e-7,8)+"  Новый sell: "+V[r].amount,"Продано: "+ke(ke(Y.amount-1e-7,8)-V[r].amount,8)+" "]),J=V,Y.amount=V[r].amount,J["0000000001"]={rate:Y.priceBuy,amount:Y.amount},delete J[r],q={buy:0,sell:0},G={buy:0,sell:0},t.logDebug&&f.info(n.join("\n"))),K=!1,!r&&Y.id&&(f.info("SELL executed!"),U.buy=1,K=!0,Y={},J={},I=0,q={buy:0,sell:0},z={buy:0,sell:0},G={buy:0,sell:0},ye&&(w=!0,ye=!1,F=t.oneOrdersSellPercent,St(t.tradeCurrency.pair,function(){var e;e="Авто выход завершен!\nБот поставлен на паузу!",f.warn(e),y("*"+e+"*")}))),e(null)},Ot=0,Et=0,gt=function(e,r,n,a,i){var u;return u="poloniex"===t.exchange?r<pe||r*n<t.poloniexMinOrders:r<pe,u?i(null):0===o.size(J)?i(null):_e?i(null):l.series([function(e){return U.sell=1,St(a,e)},function(e){var n,a,l,i,u,c,s,d,p,b,_;return n=[],a=o.keys(V),l=o.keys(J),i=o.difference(l,a),t.logDebug&&n.push([xe,"Открытые ордера: "+a,"В кэше: "+l,"Купленные: "+i].join("\n")),u=0,c=0,s=0,i.forEach(function(e){s++,u+=+J[e].amount,c+=+J[e].amount*+J[e].rate,t.logDebug&&n.push("Ордер "+s+": "+e+"  Количество: "+ +J[e].amount+"  Цена: "+ +J[e].rate)}),s>0?(Y.priceBuy=c/u,t.logDebug&&n.push(["Сумма: "+c+"  Общий объем: "+u+"  Объем с комиссией: "+ke(we(u,de),8),"Средняя цена покупки: "+Y.priceBuy].join("\n")),d=Pe(c,2.5*de+F)/u,t.logDebug&&n.push(["Коммисия: "+de+"  Процент юзера: "+F+"   Общий процент: "+(2*de+F),"Увеличенная сумма на процент: "+Pe(c,2*de+F),"Цена продажи: "+d].join("\n")),p=o.findKey(V,["type","sell"]),t.logDebug&&n.push(["Сумма с баланса биржи: "+r,p?"Сумма на открытом ордере SELL: "+V[p].amount:void 0].join("\n")),b=r,"hard"===t.integrityControlOrders&&(_=we(u,de),b=r>=_?r:_),p&&(b=r+V[p].amount),Et&&(t.logDebug&&n.push("Уменьшить сумму "+b+" на "+ke(Et)+"%"),b=we(b,Et)),t.logDebug&&(n.push("Общая сумма продажи: "+b),f.info(n.join("\n"))),Y.amount=b,e(null,{rate:d,amount:b})):e(null,{rate:0,amount:0})}],function(r,l){return null!=r?i(r):l[1].rate>0?Ct(e,l[1].rate,l[1].amount,a,function(r){return null!=r?(Ot++,Ot>5?(Ot=0,Et=0,y("`5 ошибок подряд при установки SEll ордера.`"),i(r)):(f.warn("Попытка установить SELL №: "+Ot),Et+=.1,yt(t.tradeCurrency,function(r,l,o){var u;return null!=r?i(r):(u="poloniex"===t.exchange?o:l,gt(e,u,n,a,i))}))):(Ot=0,Et=0,i(null))}):i(null)})},xt=function(e,r,n,a,i){var u,c,s,d;if("poloniex"===t.exchange?r<pe||r*n<t.poloniexMinOrders:r<pe)return i(null);if(_e)return i(null);if(t.quantityOrdersInBlocks){if(t.quantityOrdersInBlocks<=W[e])return i(null);u=!0}return c=!0,H={buy:-1,sell:-1},"all"===le||le===e?r>=M?(void 0!==s&&null!==s||(s=n),l.doWhilst(function(l){var i,d,p;return oe?("sell"===e&&(s-=ot),"buy"===e&&(s+=lt),r/=2,Ct(e,s,r,a,l)):(t.logDebug&&(i=[xe]),"buy"===e?(t.oneOrdersSell&&(k||u)&&(k=!1,u=!1,o.isEmpty(V)||(c=!1,"object"==typeof(d=Ne(V,"min"))&&d.rate<n&&(s=d.rate),t.logDebug&&i.push("Последняя цена в стеке: "+s))),t.offsetFirstOrdersPercent&&c?(s-=B.first,t.logDebug&&i.push("Цена рынка: "+n+"   Цена First ордера: "+s),c=!1):t.offsetOrdersExponential?(t.logDebug&&i.push(["Отступ Exponential: Прошлый: "+G[e],"Новый: "+ke(G[e]+t.offsetOrdersExponential,8)].join("  ")),G[e]=G[e]+t.offsetOrdersExponential,s=we(s,G[e])):s-=lt,r=-1===H.buy?r:H.buy/s,t.logDebug&&(-1===H.buy?i.push("Общий объем: "+r):i.push(["Остаточный баланс: "+H.buy,"Цена: "+ke(s,8),"Общий объем: "+ke(H.buy/s,8)].join("   ")))):(t.offsetFirstOrdersPercent&&c?(s+=B.first,t.logDebug&&i.push("Цена First ордера: "+ke(s,8)),c=!1):t.offsetOrdersExponential?(t.logDebug&&i.push(["Отступ Exponential: Прошлый: "+G[e],"Новый: "+ke(G[e]+t.offsetOrdersExponential,8)].join("  ")),G[e]=G[e]+t.offsetOrdersExponential,s=Pe(s,G[e])):s+=ot,r=-1===H.sell?r:H.sell,t.logDebug&&(-1===H.sell?i.push("Общий объем: "+r):i.push(["Остаточный баланс: "+H.sell,"Цена: "+ke(s,8),"Общий объем: "+H.sell].join("  ")))),t.sizeOrdersMartingale?(q[e]?(t.logDebug&&(1===t.martingaleType?i.push(["Размер ордера: "+ke(q[e],8),"Размер мартина: "+t.sizeOrdersMartingale,"Новый размер ордера: "+ke(Pe(q[e],t.sizeOrdersMartingale),8)].join("  ")):i.push(["Размер ордера: "+ke(q[e],8),"Размер мартина: "+X,"Новый размер ордера: "+ke(q[e]+X,8)].join("  "))),q[e]=1===t.martingaleType?Pe(q[e],t.sizeOrdersMartingale):q[e]+X):q[e]=M,z[e]&&(t.logDebug&&i.push(["Кеш мартина: "+ke(z[e],8),"Старый размер ордера: "+ke(q[e],8)].join("  ")),q[e]=z[e],z[e]=0),p=r>q[e]?q[e]:r,t.logDebug&&i.push(["Баланс: "+r,"Размер ордера: "+ke(q[e],8)].join("  "))):(p=r>M?M:r,t.logDebug&&i.push(["Баланс: "+r,"Размер ордера: "+ke(M,8)].join("  "))),t.logDebug&&(i.push("Новый размер ордера: "+ke(p,8)+"  "+(ke(p,8)<.01?"| Ордер не установлен":"")),f.info(i.join("\n"))),Ct(e,s,p,a,l))},function(){return!(t.quantityOrdersInBlocks&&t.quantityOrdersInBlocks<=W[e])&&r>M},function(e){return i(null!=e?e:null)})):(t.oneOrdersSell&&"buy"===e&&"object"==typeof(d=Ne(V,"min"))&&d.rate<n&&(n=d.rate),t.offsetOrdersPercent&&("sell"===e&&(n+=ot),"buy"===e&&(n-=lt)),t.offsetOrdersExponential&&(G[e]=G[e]+t.offsetOrdersExponential,"sell"===e&&(n=we(n,G[e])),"buy"===e&&(n=Pe(n,G[e]))),t.dynamicOffsetOrders&&("sell"===e&&(n+=Le(1)),"buy"===e&&(n-=Le(1))),Ct(e,n,r,a,i)):i(null)},Ct=function(e,r,n,a,l){var i;return(r=ke(r,ce))>=se||(r=se),n=ke(n-1e-7,8),i="poloniex"===t.exchange?n<pe||n*r<t.poloniexMinOrders:n<pe,i?l(null):b.tradeSetOrder(a,e,r,n,function(a,i){var u,c,s;return null!=a?(t.sizeOrdersMartingale&&(z[e]=q[e]),k=!0,u=C(a),f.error(("Error: "+u+" | "+e+" | rate: "+r+" | amount: "+n).red),l(a)):(c=i.order_id>0?i.order_id:o.random(1e3,2e3),t.oneOrdersSell&&("buy"===e&&(J[c]={rate:r,amount:n}),"sell"===e&&(Y.id=c)),t.quantityOrdersInBlocks&&W[e]++,s="Open: "+e+" | id: "+c+" | rate: "+r+" | amount: "+n,f.info("buy"===e?s.green:s.yellow),"buy"===e?H.buy="poloniex"===t.exchange?Je(i.funds[t.tradeCurrency.name],"name"):Je(i.funds[t.tradeCurrency.nameTwo],"nameTwo"):H.sell="poloniex"===t.exchange?Je(i.funds[t.tradeCurrency.nameTwo],"nameTwo"):Je(i.funds[t.tradeCurrency.name],"name"),L++,l(null))})},St=function(e,t){return b.ordersRequest(e,function(e,r){var n,a,o;return I=g(),null!=e?0===e.success&&null==(null!=(n=e.error)?n.split("send:")[1]:void 0)?(a=C(e),f.warn(("Cancel orders: "+a).yellow),t(null)):t(e):(o=Object.keys(r),l.eachSeries(o,function(e,t){if(null==U.all){if(null!=U.buy&&"sell"===r[e].type)return t(null);if(null!=U.sell&&"buy"===r[e].type)return t(null)}return I-r[e].timestamp_created>(U.buy||U.sell||U.all||60)?Rt(e,r[e].type,r[e].amount,r[e].rate,t):t(null)},function(e){return U={all:null,buy:null,sell:null},t(null!=e?e:null)}))})},Rt=function(e,r,n,a,l){return b.tradeCancelOrder({order_id:e},function(o,i){return null!=o?l(o):(t.oneOrdersSell&&(delete J[e],"sell"===r&&(Y.id=0)),f.info(("Close: "+r+" | id: "+e+" | rate: "+a+" | amount: "+n).cyan),L>0&&L--,l(null))})},kt=function(){be||Se(I,t.timeCloseOrdersInactivity)&&St(t.tradeCurrency.pair,function(e){null!=e&&f.error("Orders inactivity: "+C(e))})},vt=function(){var e;Se(h,10)&&(e="Unknown error: Worker does not meet!",f.warn(e.red),It({error:e}))},ht=function(){h=g(),w?setTimeout(function(){ht()},i("30s")):l.series([function(e){return _t(t.tradeCurrency.pair,e)},function(e){return yt(t.tradeCurrency,e)}],function(e,r){var n,a,u,c;n=r[0],a=r[1],null!=e?(u=C(e),null!=(null!=(c=e.error)?c.split("send:")[1]:void 0)?f.warn(u):f.error(("Error: "+u).red),It(e)):(P&&He(n.askPrice,n.bidPrice,n.lastPrice,function(){return P=!1}),Z?l.series([function(e){return D>0&&h-N>60*D?He(n.askPrice,n.bidPrice,n.lastPrice,e):e(null)},function(e){return h-I>it?St(t.tradeCurrency.pair,e):e(null)},function(e){return t.quantityOrdersInBlocks?o.delay(mt,i("3s"),t.tradeCurrency.pair,e):e(null)},function(e){return t.botTrade&&S&&t.oneOrdersSell?Tt(e):e(null)},function(e){var r,l;return t.oneOrdersSell&&K?e(null):t.botTrade&&S?(r=oe?ie.ask:n.askPrice,l="poloniex"===t.exchange?a.balanceTwo:a.balance,t.oneOrdersSell?gt("sell",l,r,t.tradeCurrency.pair,e):(q.sell=0,G.sell=0,xt("sell",l,r,t.tradeCurrency.pair,e))):e(null)},function(e){var r,l;return t.oneOrdersSell&&K?e(null):t.botTrade&&S?(r=oe?ie.bid:n.bidPrice,l="poloniex"===t.exchange?a.balance/r:a.balanceTwo/r,t.oneOrdersSell?k||W.buy||(q.buy=0,G.buy=0):(q.buy=0,G.buy=0),xt("buy",l,r,t.tradeCurrency.pair,e)):e(null)}],function(e){var r;null!=e?(r=C(e),f.error(("ErrorTrader: "+r).red),It(e)):Q===t.ecoCountCycle?setTimeout(function(){ht()},i("2s")):ht()}):setTimeout(function(){ht()},i("5s")))})},It=function(e){var r,n,a,l;r="restart after "+parseInt(t.restartTraderTime)+" sec ...",f.warn(r),null==(n=null!=(a=e.error)?a.split("send:")[1]:void 0)&&(l=C(e),R.count++,R.text!==l&&(R.text=l,t.emailS&&"production"===process.env.NODE_ENV&&T(E(l+"\n\n"+r),function(e,t){})),t.notificationErrorCount&&R.count>t.notificationErrorCount&&(y("`Слишком много ошибок API. Требуется внимание пользователя!`"),R.count=0)),setTimeout(function(){f.warn("trader restart"),null!=n&&b.setNonce(n),ht()},i(parseInt(t.restartTraderTime)+"s"))},function(){t.myChatId||t.telegramOff?(f.info("Trader Bot starting..."),f.info("Exchange: "+t.exchange.toUpperCase()+" | v."+t.versionBot),ft(t.tradeCurrency.pair,function(e){var r;return null!=e&&(r=C(e),f.error(("Error getting parameters from the server!\n"+r).red),process.exit(0)),ht(),t.botTrade&&setInterval(function(){kt(),vt(),R.count=0},i("5m")),setInterval(function(){qe()},i(10*t.bbandsInterval+"s")),"production"===process.env.NODE_ENV&&y("Trader Bot started. Pair "+O()),f.info("Trader Bot started")})):f.warn("Get the user id in the Telegram")}()):f.warn("There is no token Telegram!")}).call(this);