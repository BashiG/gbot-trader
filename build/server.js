(function(){function e(e,r){for(var t=-1,n=r.length>>>0;++t<n;)if(e===r[t])return!0;return!1}var r,t,n,a,o,l,i,u,s,c,d,f,p,b,_,m,O,y,T,E,g,x,C,S,R,k,v,h,P,N,I,D,w,L,U,B,F,A,M,j,q,G,z,H,J,Y,V,K,W,X,Z,Q,$,ee,re,te,ne,ae,oe,le,ie,ue,se,ce,de,fe,pe,be,_e,me,Oe,ye,Te,Ee,ge,xe,Ce,Se,Re,ke,ve,he,Pe,Ne,Ie,De,we,Le,Ue,Be,Fe,Ae,Me,je,qe,Ge,ze,He,Je,Ye,Ve,Ke,We,Xe,Ze,Qe,$e,er,rr,tr,nr,ar,or,lr,ir,ur,sr,cr,dr,fr,pr,br,_r,mr;r=require("./conf"),t=require("./utils"),n=require("./api-btc-e"),a=require("./api-poloniex"),o=require("./log"),l=require("async"),i=require("lodash"),require("colors"),u=require("ms"),s=require("moment"),c=require("moment-range"),d=require("nodemailer"),f=require("node-telegram-bot-api"),p=require("ta-lib"),b=new o,s=c.extendMoment(s),r.tokenTelegram||r.telegramOff?(_="poloniex"===r.exchange?new a:new n,m=r.tokenTelegram&&!r.telegramOff?new f(r.tokenTelegram,{polling:!0}):new(function(){function e(){}return e.prototype,e.prototype.on=function(){},e.prototype.sendMessage=function(){},e}()),O=function(e,t){null==t&&(t={}),e.length>4096&&(e="*Слишком много информации для отображения*"),e.length||(e="*Error: Не удалось обработать ошибку*"),!1!==t.format&&(t.parse_mode="markdown"),delete t.format,m.sendMessage(r.myChatId,e,t)},y=d.createTransport(r.email),T=function(e,r){return y.sendMail(e,r)},E=function(){return r.tradeCurrency.pair.replace("_","/").toUpperCase()},g=function(e){return{from:r.email.auth.user,to:r.email.reportEmail,subject:"Error Script Trader",text:"time: "+(new Date).toString()+"\nPair: "+E()+"\n\nmessage: "+e+"\n\n---"}},x=function(e){return"object"==typeof e?e.hasOwnProperty("error")?e.error:e.hasOwnProperty("message")?e.message:t.objToString(e):e},C=!0,S={count:0,text:""},R=!1,k={name:0,nameTwo:0},v=t.currentTime(),h=t.currentTime(),P=t.currentTime(),N=r.timeUpdateAutoSettings,I=!0,D=!1,w=0,L={all:null,buy:null,sell:null},U={extra:0,buy:0,sell:0,first:0},B=r.oneOrdersSellPercent,F=0,A=0,M=0,j={buy:0,sell:0},q={buy:0,sell:0},G={buy:0,sell:0},z={},H={},J={id:0,priceBuy:0,amount:0},Y={},V=!1,K={buy:0,sell:0},W=0,X=!1,Z=0,Q=0,$=0,ee=0,re=[],te=[],ne={},ae="all",oe=!1,le={ask:0,bid:0},ie="normal",ue=0,se=0,ce=0,de=0,fe=0,pe=!1,be=!1,_e=!1,me=null!=(Oe=r.notificationPair)?Oe.toLowerCase().replace(/\//g,"_").split(/\s*,\s*/):void 0,ye={status:!1,interval:!1},Te={status:!1,interval:!1},Ee="-----------------------------------",ge=function(e){return r.symbol.hasOwnProperty(e)?r.symbol[e]:e.toUpperCase()+" "},xe=function(e,r){return null==r&&(r=ue),t.rounded(e/+("1e"+r),r)},Ce=function(e,r){return null==r&&(r=ue),t.rounded(e*+("1e"+r),r)},Se=function(e,r,n){var a;return null==r&&(r=0),null==n&&(n=ue),a=e/100*ce*2,t.rounded(t.amountPlusPercent(t.rounding(a,n),r),n)},Re=function(e,r){return t.rounded(t.amountPlusPercent(e,r),ue)},ke=function(e,r){return t.rounded(t.amountMinusPercent(e,r),ue)},ve=function(e,r){return t.amountMinusPercent(e/r,ce)},he=function(e,r){return t.amountMinusPercent(e*r,ce)},Pe=function(){r.bbands&&ee>0&&(te.push(ee),te.length>30&&te.splice(0,1))},Ne=function(e,r){var n,a;return n=e/100*r,a=1/+("1e"+ue),r>0&&(n>=a||(n=a)),t.rounded(n,ue)},Ie=function(e,r){var n,a,o;null==r&&(r=1),n=e.toString().split(".")[0];try{a=e.toString().split(".")[1].length}catch(e){a=1}return o=n>0?n>1e4?+("1e"+(a+1)):n>1e3?+("1e"+a):n>100?+("1e"+(a-1)):n>10?+("1e"+(a-2)):a>3?+("1e"+(a-3)):1:1,r*=o,t.rounded(r/+("1e"+a),a)},De=function(e,n,a,o){var l,u,s,c,d,f,_,m,y,T,g,x,S,R,k,v,B,M,q,G,z,H,V,K,W,X,Z,ne,_e,me,Oe,ye,Te,ge,xe,ve,he;return P=t.currentTime(),L={buy:null,sell:null},l=e.toString().length,u=n.toString().length,c={},c[l+""]=e,c[u+""]=n,s=c,d=Math.max(l,u),f=s[d],ue=er.pairs[r.tradeCurrency.pair].decimal_places,de=er.pairs[r.tradeCurrency.pair].min_amount,se=er.pairs[r.tradeCurrency.pair].min_price,ce=er.pairs[r.tradeCurrency.pair].fee,_=t.rounded(e-n,ue),m=Se(f,200),r.dynamicSettingsTime&&(re.push(a),re.length>50&&re.splice(0,1),y=i.max(re),T=i.min(re),r.botLog&&b.info([Ee,"price-array:","length: "+re.length,"max: "+y,"min: "+T,"change-time-settings: "+(t.percentageBetweenNumbers(y,T)>102)].join("\n")),t.percentageBetweenNumbers(y,T)>102?N=.1:N!==r.timeUpdateAutoSettings&&(N=r.timeUpdateAutoSettings)),r.abruptChangeTrend&&(g=Se(f,500)),r.dangerPriceStop&&(x=Re($,9),S=ke(Q,9)),r.dynamicOffsetOrders&&(k=_>=(R={current:Se(f,450),prev:Se(f,380),prev_2:Se(f,300)}).current||_>=R.prev||_>=R.prev_2),r.dynamicOffsetOrders&&k?(b.info("Dynamic market"),v=Ie(f,Ce(R.current)),B=1.5*r.stepBreakevenPercent):(v=Ie(f,r.offsetOrdersPoints),B=r.stepBreakevenPercent),v=function(){switch(!1){case!r.offsetOrdersPercent:return Ne(f,r.offsetOrdersPercent);case!r.rangeOffset:return Ne(f,t.rounded(r.rangeOffset/r.countOrders,2));default:return v}}(),M=1.3*v,q=Ne(f,r.offsetFirstOrdersPercent),G=r.offsetOrdersPercent?Ne(f):2,F=function(){switch(!1){case!r.bbands:case!r.oneOrdersSell:return 0;default:return Se(f,B)}}(),r.botLog&&(b.info(Ee),b.info("current-spread:",(t.noExp(_)+"")[_>F?"green":"white"]),b.info("spread-min-default:",t.noExp(F)),b.info("trend-spread:",t.noExp(m)),r.abruptChangeTrend&&b.info("immediate-spread:",g),b.info("trader-speed:",ie),b.info("price-prev:",$+" - "+Q),b.info("price-prev2:",le.ask+" - "+le.bid),r.dangerPriceStop&&(b.info("danger-price-ask:",x,!I&&e>=x?"Attention!".red:""),b.info("danger-price-bid:",S,!I&&n<=S?"Attention!".red:"")),r.dynamicOffsetOrders&&(b.info("spread_1_450:",R.current,_>=R.current?"Attention!".red:""),b.info("spread_2_380:",R.prev,_>=R.prev?"Attention!".red:""),b.info("spread_3_300:",R.prev_2,_>=R.prev_2?"Attention!".red:""),b.info("dynamic-market:",k))),r.dangerPriceStop&&!I&&(e>=x||n<=S)?(e>=x&&(L.buy=1),h=0,D=!0,z="DANGER PRICE: "+e+" - "+n+" | Bot Pause!",b.warn(z),void O("`"+z+"`")):(H=G,V=w>Math.round(fe/2)?M:v,r.botLog&&(b.info("offset-max-one:",(t.noExp(v)+"")[v===V?"green":"yellow"]),b.info("offset-type-max:",t.noExp(V)),r.offsetFirstOrdersPercent&&b.info("offset-first-orders:",t.noExp(q)),b.info(Ee)),pe||(ae="all",oe=!1),I?(r.bbands&&(C=!1),K=W=V):r.oneOrdersSell?(K=W=V,r.timeCloseOrders=1e5,r.timeCloseOrdersInactivity=r.timeCloseOrders,(X=t.searchFirstRate(Y,n))&&n>Re(X.rate,r.oneOrdersSellOffset)&&!J.id&&(L.buy=1,h=0,j={buy:0,sell:0})):r.bbands?(K=W=V,N=.1,Z=14,te.length>2*Z&&(ne=(c=p.BBANDS(te,20,r.bbandsDeviation)).middleband,_e=c.lowband,me=c.highband,Oe=p.RSI(i.clone(te).reverse(),Z),ye=p.average(Oe).mean,Te=p.average(ne).mean,ge=p.average(me).mean,xe=p.average(_e).mean,ve=ge>a&&a>Te,he=Te>a&&a>xe,ve&&(pe||(ae="sell"),C=99>ye&&ye>70),he&&(pe||(ae="buy"),C=1<ye&&ye<30),be=ve&&he,r.botLog&&b.info(["BBANDS:","highband: "+ge,"middleband: "+Te,"lowband: "+xe,"rsa: "+ye,"sell: "+ve,"buy: "+he,"bot trade: "+C,"orders-calculation-brake: "+be,Ee].join("\n")))):r.trendDefinition&&n>Q&&e>$&&_>m&&"normal"===ie?(b.info("Trend: UP"),K=H,W=V,pe||(ae="buy",L.sell=1,h=0,r.abruptChangeTrend&&_>g&&(b.info("Spread Immediate"),oe=!0,P=0))):r.trendDefinition&&n<Q&&e<$&&_>m&&"normal"===ie?(b.info("Trend: DOWN"),K=V,W=H,pe||(ae="sell",L.buy=1,h=0,r.abruptChangeTrend&&_>g&&(b.info("Spread Immediate"),oe=!0,P=0))):K=W=V,le={ask:$,bid:Q},Q=n,$=e,ee=a,A=Se(f),U={buy:K,sell:W,extra:Ie(f),first:q},Qe(null,function(){return b.info("Update: "+ae.toUpperCase()+" | "+e+" - "+n+" | "+a+" | "+E()),o(null)}))},we=function(e,r){var t,n;return t="name"===r?k.name:k.nameTwo,n=e-t,n>0?n:0},Le=function(e,n){return l.parallel([function(t){return r.botLog&&b.info(Ee+"\nПолучение цен"),_.getTicker(e,function(n,a){return null!=n?(r.botLog&&(b.error("Price: "+a[e].buy),b.error(x(n))),t(n)):t(null,{price:a[e].buy})})},function(t){return l.series([function(t){return r.botLog&&b.info(Ee+"\nЗакрытие всех позиций"),L.all=1,dr(e,function(e){return t(null!=e?e:null)})},function(e){return r.botLog&&b.info(Ee+"\nПолучение баланса"),i.delay(_.balanceRequest,u("500"),r.tradeCurrency,function(t,n,a){return null!=t?(r.botLog&&(b.error("balance: "+n+" | balance-two: "+a),b.error(x(t))),e(t)):r.botTrade&&n<r.minAvailableBalance&&a<r.minAvailableBalance?(r.botLog&&b.error("balance: "+n+" | balance-two: "+a),e({error:"Err: No money!"})):e(null,{balance:n,balanceTwo:a})})}],function(e,r){return null!=e?t(e):t(null,{balance:r[1].balance,balanceTwo:r[1].balanceTwo})})}],function(e,a){var o,l,i,u,s,c,d,f,p,_,m,O,y,T,E,g,x;return null!=e?n(e):(ne=a[1],r.botLog&&b.info(Ee+"\nРасчет депозита"),r.oneOrdersSell&&("poloniex"===r.exchange?(o=a[1].balanceTwo,a[1].balanceTwo=0):(o=a[1].balance,a[1].balance=0)),"poloniex"===r.exchange?(l=a[1].balanceTwo*a[0].price+a[1].balance,i=a[1].balance/a[0].price+a[1].balanceTwo):(l=a[1].balanceTwo/a[0].price+a[1].balance,i=a[1].balance*a[0].price+a[1].balanceTwo),s=r.depositLimit.currency?i>(u="poloniex"===r.exchange?r.depositLimit.currency/a[0].price:r.depositLimit.currency)?t.rounded(100/(i/u),2):100:r.depositLimit.percent,c=0<s&&s<100?s:100,d=l*c/100,f=i*c/100,100===c?(r.botLog&&b.info("type:",0),p=0,_=0):a[1].balance>=d&&a[1].balanceTwo>=f?(r.botLog&&b.info("type:",1),p=a[1].balance-d/2,_=a[1].balanceTwo-f/2):a[1].balance>=d&&a[1].balanceTwo<f?(r.botLog&&b.info("type:",2),p="poloniex"===r.exchange?a[1].balance-(f-a[1].balanceTwo)*a[0].price:a[1].balance-(f-a[1].balanceTwo)/a[0].price,_=0):a[1].balance<d&&a[1].balanceTwo>=f?(r.botLog&&b.info("type:",3),p=0,_="poloniex"===r.exchange?a[1].balanceTwo-(d-a[1].balance)/a[0].price:a[1].balanceTwo-(d-a[1].balance)*a[0].price):a[1].balance<d&&a[1].balanceTwo<f&&(r.botLog&&b.info("type:",4),"poloniex"===r.exchange?(p=a[1].balance-(f-a[1].balanceTwo)*a[0].price,_=a[1].balanceTwo-(d-a[1].balance)/a[0].price):(p=a[1].balance-(f-a[1].balanceTwo)/a[0].price,_=a[1].balanceTwo-(d-a[1].balance)*a[0].price)),r.botLog&&(m=t.percentageBetweenNumbers(p,a[1].balance),O=t.percentageBetweenNumbers(_,a[1].balanceTwo),b.info(["reserved-deposit:",r.tradeCurrency.name.toUpperCase(),m+"% / "+O+"%",r.tradeCurrency.nameTwo.toUpperCase()].join(" "))),r.oneOrdersSell&&("poloniex"===r.exchange?_=o:p=o),k={name:p>0?p:0,nameTwo:_>0?_:0},y="poloniex"===r.exchange?f:d,r.countOrders?r.countOrders>=3||(r.countOrders=3):r.countOrders=y<=10?6:y<=200?15:y<=500?18:y<=1e3?21:25,T="poloniex"===r.exchange?r.poloniexMinOrders/a[0].price:de+.001,fe=r.countOrders*r.multiplierOrdersExtra,r.sizeOrdersMartingale?1===r.martingaleType?(E=1+r.sizeOrdersMartingale/100,g=y/((Math.pow(E,r.countOrders)-1)/(E-1))):(W=r.sizeOrdersMartingale,g=y/r.countOrders-(r.countOrders-1)*W/2):g=y/r.countOrders,M=t.rounded(g>T?g:T,ue),r.botLog&&(x=r.depositLimit.currency?r.depositLimit.currency+" "+("poloniex"===r.exchange?r.tradeCurrency.name.toUpperCase():r.tradeCurrency.nameTwo.toUpperCase()):r.depositLimit.percent+" %",b.info([Ee+"\nРасчет переменных","Strategy: "+function(){switch(!1){case!r.oneOrdersSell:return"One Sell a lot Buy";case!r.bbands:return"BBANDS";default:return"Scalper"}}(),"balance: "+t.rounded(a[1].balance)+" "+r.tradeCurrency.name.toUpperCase(),"balance-two: "+t.rounded(a[1].balanceTwo)+" "+ge(r.tradeCurrency.nameTwo),"deposit: "+l+" "+r.tradeCurrency.name.toUpperCase()+" или "+i+" "+r.tradeCurrency.nameTwo.toUpperCase(),"deposit-limit: "+x,"trade-deposit: "+d+" "+r.tradeCurrency.name.toUpperCase()+" | "+f+" "+r.tradeCurrency.nameTwo.toUpperCase(),"reserved-deposit: "+t.rounded(k.name)+" "+r.tradeCurrency.name.toUpperCase()+" | "+t.rounded(k.nameTwo)+" "+r.tradeCurrency.nameTwo.toUpperCase(),"count-orders: "+r.countOrders,"quantity-orders-in-blocks: "+(r.quantityOrdersInBlocks?r.quantityOrdersInBlocks:"OFF"),"size-static-order: "+M,"size-orders-martingale: "+(r.sizeOrdersMartingale?r.sizeOrdersMartingale:"OFF")+"    Тип: "+(1===r.martingaleType?"Exponential":"Linear"),Ee].join("\n"))),d<r.minAvailableBalance&&f<r.minAvailableBalance&&(b.warn(Ee),b.warn("Недостаточно доступных средств для торговли!"),b.warn(Ee)),n(null))})},m.on("message",function(e){var n,a,o,u,s,c,d,f,p,y,T,g,C,S,R;if(n=e.chat.id,r.myChatId||m.sendMessage(n,"Install your Telegram id: `"+n+"`",{parse_mode:"markdown"}),n===r.myChatId){if("Ордера"===e.text&&(a=function(){l.series([function(e){return _.balanceRequest(r.tradeCurrency,function(r,t,n){return null!=r?e(r):e(null,{balance:t,balanceTwo:n})})},function(e){return _.ordersRequest(r.tradeCurrency.pair,function(r,t){return null!=r?e(r):e(null,{data:t})})}],function(e,n){var o,l,u,s,c,d,f,p,b,m,y,T;o=[E()+":",Ee],l="Balance: "+(null!=(u=n[0])?u.balance.toFixed(3):void 0)+" "+r.tradeCurrency.name.toUpperCase()+" | "+ge(r.tradeCurrency.nameTwo)+(null!=(s=n[0])?s.balanceTwo.toFixed(3):void 0),null!=e?0===e.success?null!=(c=null!=(d=e.error)?d.split("send:")[1]:void 0)?(_.setNonce(c),a()):(f=x(e),o.push(f+"\n"+Ee+"\n"+l),O(o.join("\n"))):O(e):(p={},b=0,m=0,y={},Object.keys(n[1].data).forEach(function(e){var a,o,l,i;a=n[1].data[e].rate*+("1e"+ue),o="sell"===n[1].data[e].type?"`sell`":"buy",null!=y[a]?(l=" | "+ ++p[a],i=t.rounded(t.rounded(y[a].split("|")[1].trim())+t.rounded(n[1].data[e].amount)),y[a]=o+" | "+i+" | "+ge(r.tradeCurrency.nameTwo)+n[1].data[e].rate+l):(p[a]=1,y[a]=o+" | "+t.rounded(n[1].data[e].amount)+" | "+ge(r.tradeCurrency.nameTwo)+n[1].data[e].rate),b+=n[1].data[e].amount,m+=n[1].data[e].amount*n[1].data[e].rate}),(o=i.concat(o,i.values(y))).push(Ee+"\nCount: "+t.rounded(b)+" | Sum: "+ge(r.tradeCurrency.nameTwo)+t.rounded(m)+"\n"+l),T=o.join("\n"),O(T))})})(),"История"===e.text&&(o=function(){_.tradeGetHistory(r.tradeCurrency.pair,15,function(e,t){var n,a,l;return null!=e?0===e.success?(n=null!=(a=e.error)?a.split("send:")[1]:void 0,null!=n?(_.setNonce(n),o()):O(x(e))):O(x(e)):(l=[],Object.keys(t).forEach(function(e){var n;n="sell"===t[e].type?"`sell`":"buy",l.push(n+" | "+t[e].amount.toFixed(3)+" | "+ge(r.tradeCurrency.nameTwo)+t[e].rate)}),l.push(E()+":\n"+Ee),l.reverse(),O(l.join("\n")))})})(),"Закрыть активные ордера"===e.text&&(u={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Закрыть ордера!",callback_data:"close_orders_now"}]]})},O("*Вы уверены что хотите закрыть ордера?*",u)),"/start"!==(s=null!=(c=e.text)?c.toLowerCase():void 0)&&"главное меню"!==s||(u={reply_markup:JSON.stringify({keyboard:[[{text:"Ордера"},{text:"Котировки"},{text:"История"}],[{text:"Контроль"},{text:"Нотис"},{text:"Торговля"}],[{text:"Закрыть активные ордера"}]],resize_keyboard:!0})},O("Выберите:",u)),"Котировки"===e.text){if("btc-e"!==r.exchange)return void O("*Этот пункт не доступен для данной биржи*");u={reply_markup:JSON.stringify({keyboard:[[{text:"USD"},{text:"BTC"},{text:"OTHER"}],[{text:"Главное меню"}]],resize_keyboard:!0})},O("Валюта:",u)}if("Торговля"===e.text&&(u={reply_markup:JSON.stringify({keyboard:[[{text:"Сменить пару"},{text:"Тип"}],[{text:"Изменить отступ"},{text:"Авто выход из пары"}],[{text:"Главное меню"}]],resize_keyboard:!0})},O("Выберите:",u)),"USD"===e.text&&(u={reply_markup:JSON.stringify({inline_keyboard:[[{text:"NMC",callback_data:"nmc_usd"},{text:"PPC",callback_data:"ppc_usd"},{text:"NVC",callback_data:"nvc_usd"},{text:"LTC",callback_data:"ltc_usd"},{text:"BTC",callback_data:"btc_usd"}],[{text:"DSH",callback_data:"dsh_usd"},{text:"ETH",callback_data:"eth_usd"},{text:"EUR",callback_data:"eur_usd"},{text:"RUR",callback_data:"usd_rur"}]]})},O("Символ:",u)),"BTC"===e.text&&(u={reply_markup:JSON.stringify({inline_keyboard:[[{text:"NMC",callback_data:"nmc_btc"},{text:"PPC",callback_data:"ppc_btc"},{text:"NVC",callback_data:"nvc_btc"},{text:"LTC",callback_data:"ltc_btc"}],[{text:"DSH",callback_data:"dsh_btc"},{text:"ETH",callback_data:"eth_btc"},{text:"RUR",callback_data:"btc_rur"},{text:"EUR",callback_data:"btc_eur"}]]})},O("Символ:",u)),"OTHER"===e.text&&(u={reply_markup:JSON.stringify({inline_keyboard:[[{text:"ETH/LTC",callback_data:"eth_ltc"},{text:"ETH/EUR",callback_data:"eth_eur"},{text:"ETH/RUR",callback_data:"eth_rur"}],[{text:"LTC/RUR",callback_data:"ltc_rur"},{text:"LTC/EUR",callback_data:"ltc_eur"},{text:"EUR/RUR",callback_data:"eur_rur"}]]})},O("Пара:",u)),"Контроль"===e.text&&(u={reply_markup:JSON.stringify({keyboard:[[{text:"Скорость"},{text:"Состояние"},{text:"Модули"}],[{text:"Главное меню"}]],resize_keyboard:!0})},O("Выберите:",u)),"Нотис"===e.text&&(u={reply_markup:JSON.stringify({keyboard:[[{text:"Мониторинг"},{text:"Уведомление"}],[{text:"Круг"}],[{text:"Главное меню"}]],resize_keyboard:!0})},O("Выберите:",u)),"Мониторинг"===e.text&&(u={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Старт",callback_data:"monitoring start"},{text:"Стоп",callback_data:"monitoring stop"}]]})},d=Te.status?"Работает.":"Остановлен.",O((f=["Включает мониторинг возможных торговых пар. Уведомление раз в 5 минут.","Текущие состояние: "+d]).join("\n"),u)),"Уведомление"===e.text&&(u={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Старт",callback_data:"notification start"},{text:"Стоп",callback_data:"notification stop"}]]})},d=ye.status?"Работает.":"Остановлен.",O((f=["Включает уведомления о скачках курса.","Текущие состояние: "+d]).join("\n"),u)),"Круг"===e.text&&Ve(),"Тип"===e.text&&(u={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Only buy",callback_data:"type buy"},{text:"Only sell",callback_data:"type sell"},{text:"Buy & Sell",callback_data:"type all"}]]})},f=["Текущий тип торговли "+ae.toUpperCase(),"Новый тип:"],O(f.join("\n"),u)),"Сменить пару"===e.text){if("btc-e"!==r.exchange)return void O("*Этот пункт не доступен для данной биржи*");u={reply_markup:JSON.stringify({inline_keyboard:[[{text:"BTC/USD",callback_data:"trade btc_usd"},{text:"BTC/RUR",callback_data:"trade btc_rur"},{text:"BTC/EUR",callback_data:"trade btc_eur"}],[{text:"LTC/BTC",callback_data:"trade ltc_btc"},{text:"LTC/USD",callback_data:"trade ltc_usd"},{text:"LTC/RUR",callback_data:"trade ltc_rur"}],[{text:"LTC/EUR",callback_data:"trade ltc_eur"},{text:"NMC/BTC",callback_data:"trade nmc_btc"},{text:"NMC/USD",callback_data:"trade nmc_usd"}],[{text:"NVC/BTC",callback_data:"trade nvc_btc"},{text:"NVC/USD",callback_data:"trade nvc_usd"},{text:"PPC/BTC",callback_data:"trade ppc_btc"}],[{text:"PPC/USD",callback_data:"trade ppc_usd"},{text:"DSH/BTC",callback_data:"trade dsh_btc"},{text:"DSH/USD",callback_data:"trade dsh_usd"}],[{text:"ETH/BTC",callback_data:"trade eth_btc"},{text:"ETH/USD",callback_data:"trade eth_usd"},{text:"ETH/EUR",callback_data:"trade eth_eur"}],[{text:"ETH/LTC",callback_data:"trade eth_ltc"},{text:"ETH/RUR",callback_data:"trade eth_rur"},{text:"USD/RUR",callback_data:"trade usd_rur"}],[{text:"EUR/USD",callback_data:"trade eur_usd"},{text:"EUR/RUR",callback_data:"trade eur_rur"}]]})},f=["Текущая пара: *"+E()+"*","`Внимание! На новой паре должны быть средства для торгов, иначе переключение завершится ошибкой!`","Новая торгая пара:"],O(f.join("\n"),u)}return"Изменить отступ"===e.text&&(r.offsetOrdersExponential?(p="%",y="Изменяет отсуп ордеров по экспоненте в %",T="Остальные: *"+r.offsetOrdersExponential+"%*"):r.offsetOrdersPercent?(p="%",y="Изменяет отсуп ордеров в процентах",T="Остальные: *"+r.offsetOrdersPercent+"%*"):r.rangeOffset?(p="%",y="Изменяет размер сетки ордеров в процентах",T="Разер сетки: *"+r.rangeOffset+"%*"):(p="",y="Изменяет отсуп первого ордера в процентах, всех остальных в пунктах.",T="Остальные: *"+r.offsetOrdersPoints+"*"),u={reply_markup:JSON.stringify({inline_keyboard:[[{text:"+ 0.1% First",callback_data:"offset_orders first_plus"},{text:"- 0.1% First",callback_data:"offset_orders first_minus"}],[{text:"+ 0.1"+p,callback_data:"offset_orders plus"},{text:"- 0.1"+p,callback_data:"offset_orders minus"}]]})},f=[y,"Текущий отступ:","Первый: *"+r.offsetFirstOrdersPercent+"%*",T].join("\n"),O(f,u)),"Авто выход из пары"===e.text&&(r.oneOrdersSell?(B=0,_e=!0,f="Авто выход включен!"):f="На текущей стратегии данная функция недоступна!",O(f)),"Скорость"===e.text&&(u={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Normal",callback_data:"speed normal"},{text:"Extra",callback_data:"speed extra"}]]})},f=["Влияет на плотность стека ордеров, размер спреда и время закрытия неиспользованных ордеров","Время действия "+t.declOfNum(N)+".","Текущая скорость: *"+ie+"*"].join("\n"),O(f,u)),"Состояние"===e.text&&(u={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Пауза",callback_data:"worker pause"},{text:"Продолжить",callback_data:"worker continued"}]]})},O("Текущие состояние: "+(d=D?"Пауза":"Работает"),u)),"Модули"===e.text&&(u={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Динам. время обновления "+(r.dynamicSettingsTime?"[Вкл]":"[Выкл]"),callback_data:"modules dynamic-settings-time"}],[{text:"Динам. распределение ордеров "+(r.dynamicOffsetOrders?"[Вкл]":"[Выкл]"),callback_data:"modules dynamic-offset-orders"}],[{text:"Определение тренда "+(r.trendDefinition?"[Вкл]":"[Выкл]"),callback_data:"modules trend-definition"}],[{text:"Контроль смены тренда "+(r.abruptChangeTrend?"[Вкл]":"[Выкл]"),callback_data:"modules abrupt-change-trend"}],[{text:"Стоп при большом изменении цены "+(r.dangerPriceStop?"[Вкл]":"[Выкл]"),callback_data:"modules danger-price-stop"}],[{text:"Включить все",callback_data:"modules all-modules-on"},{text:"Выключить все",callback_data:"modules all-modules-off"}],[{text:"Полосы Боллинджера "+(r.bbands?"[Вкл]":"[Выкл]"),callback_data:"modules bbands"}],[{text:"One Sell a lot Buy "+(r.oneOrdersSell?"[Вкл]":"[Выкл]"),callback_data:"modules one-orders-sell"}],[{text:"Лог "+(r.botLog?"[Вкл]":"[Выкл]"),callback_data:"modules bot-log"},{text:"Дебаг лог "+(r.logDebug?"[Вкл]":"[Выкл]"),callback_data:"modules log-debug"}]]})},O("*Модули обновления настроек:*",u)),"/info"===(null!=(s=e.text)?s.toLowerCase():void 0)&&O((f=["Список команд:\n","/version - версия бота","/help - параметры которые можно менять через Telegram","/config - возможные параметры конфигурации через конфигурационный файл","/martin - теоретический расчет ордеров Мартингейла (параметры берутся из конфига)"]).join("\n")),"/version"===(null!=(g=e.text)?g.toLowerCase():void 0)&&O("Версия бота: `"+r.versionBot+"`"),"/config"===(null!=(C=e.text)?C.toLowerCase():void 0)&&(f=["Бот на паре: "+E(),"EXCHANGE: "+r.exchange+" | Выбор биржи btc-e или poloniex","POLONIEX_FEE: "+r.poloniexFee+" | Комиссия на сделки биржи POLONIEX","TIME_UPDATE_AUTO_SETTINGS: "+N+" | время обновления авто настроек параметров (в мин)","DEPOSIT_LIMIT_PERCENT: "+r.depositLimit.percent+" | процент использования депозита","DEPOSIT_LIMIT_CURRENCY: "+r.depositLimit.currency+" | использования депозита в валюте","NOTIFICATION_PAIR: "+r.notificationPair+" | пары для уведомления (или all/all для всех)","NOTIFICATION_DEVIATION_PERCENT: "+r.notificationDeviation+" | насколько процентов должен увеличиться спред чтобы сработало уведомление","COUNT_ORDERS: "+r.countOrders+" | количество ордеров","QUANTITY_ORDERS_IN_BLOCKS: "+r.quantityOrdersInBlocks+" | количество ордеров в блоке","TIME_CLOSE_ORDERS: "+r.timeCloseOrders+" | сколько минут ждать перед закрытием неисполнившихся ордеров","TIME_CLOSE_ORDERS_INACTIVITY: "+r.timeCloseOrdersInactivity+" | закрытие после бездействия","OFFSET_ORDERS_POINTS: "+r.offsetOrdersPoints+" | отступ ордеров в пунктах","OFFSET_ORDERS_PERCENT: "+r.offsetOrdersPercent+" | отступ для ордеров в %","OFFSET_ORDERS_EXPONENTIAL: "+r.offsetOrdersExponential+" | отступ для ордеров по экспоненте в %","OFFSET_FIRST_ORDERS_PERCENT: "+r.offsetFirstOrdersPercent+" | отступ первого ордера в %","RANGE_OFFSET: "+r.rangeOffset+" | диапазон смещения ордеров в %","SIZE_ORDERS_MARTINGALE: "+W+" | размер ордера в % Мартингейла","MARTINGALE_TYPE: "+r.martingaleType+" | тип Мартингейла","STEP_BREAKEVEN_PERCENT: "+r.stepBreakevenPercent+" | процент отступа безубытка для торгов","DANGER_PRICE_STOP: "+r.dangerPriceStop+" | остановка бота при большом изменении цены","DYNAMIC_SETTINGS_TIME: "+r.dynamicSettingsTime+" | динамическое время обновления настроек","DYNAMIC_OFFSET_ORDERS: "+r.dynamicOffsetOrders+" | динамическое распределение ордеров","TREND_DEFINITION: "+r.trendDefinition+" | определение тренда","ABRUPT_CHANGE_TREND: "+r.abruptChangeTrend+" | быстрое изменение направления тренда","BBANDS: "+r.bbands+" | Стратегия Полосы Боллинджера","BBANDS_DEVIATION: "+r.bbandsDeviation+" | Отклонение","BBANDS_INTERVAL: "+r.bbandsInterval+" | Таймфрейм (в мин)","ONE_ORDERS_SELL: "+r.oneOrdersSell+" | Стратегия One Sell a lot Buy","ONE_ORDERS_SELL_PERCENT: "+B+" | Задает процент желаемой прибыли","ONE_ORDERS_SELL_OFFSET: "+r.oneOrdersSellOffset+" | Разница между ценой LastPrice и первым ордером buy в стеке ордеров в %","INTEGRITY_CONTROL_ORDERS: "+r.integrityControlOrders+" | Контроль целостности ордеров (soft - мягкий, hard - жесткий)"],O(f.join("\n\n"),{format:!1})),"/help"===(null!=(S=e.text)?S.toLowerCase():void 0)&&(f=["Бот на паре: "+E(),"Exchange: "+r.exchange.toUpperCase(),"TIME_UPDATE_AUTO_SETTINGS="+N+" | время обновления авто настроек параметров (в мин)","OFFSET_ORDERS_POINTS="+r.offsetOrdersPoints+" | отступ для ордеров в пунктах","OFFSET_ORDERS_PERCENT="+r.offsetOrdersPercent+" | отступ для ордеров в процентах","RANGE_OFFSET= "+r.rangeOffset+" | диапазон смещения ордеров в %","OFFSET_FIRST_ORDERS_PERCENT="+r.offsetFirstOrdersPercent+" | отступ первого ордера в процентах","STEP_BREAKEVEN_PERCENT="+r.stepBreakevenPercent+" | процент отступа безубытка для торгов","TIME_CLOSE_ORDERS="+r.timeCloseOrders+" | сколько минут ждать перед закрытием неисполнившихся ордеров","COUNT_ORDERS="+r.countOrders+" | количество ордеров (бот будет переазгружен)","QUANTITY_ORDERS_IN_BLOCKS="+r.quantityOrdersInBlocks+" | количество ордеров в блоке","SIZE_ORDERS_MARTINGALE="+W+" | размер ордера мартингейла (проценты или абсолютное число)","DEPOSIT_LIMIT_PERCENT="+r.depositLimit.percent+" | процент использования депозита (бот будет перезагружен)","DEPOSIT_LIMIT_CURRENCY="+r.depositLimit.currency+" | использования депозита в валюте (бот будет перезагружен)","ONE_ORDERS_SELL_PERCENT="+B+" | Задает процент желаемой прибыли","ONE_ORDERS_SELL_OFFSET="+r.oneOrdersSellOffset+" | Разница между ценой LastPrice и первым ордером buy в стеке ордеров в процентах","RESTART_TRADER_TIME="+r.restartTraderTime+" | Через сколько секунд рестартовать воркер после ошибки","INTEGRITY_CONTROL_ORDERS="+r.integrityControlOrders+" | Контроль целостности ордеров (soft - мягкий, hard - жесткий)"],O(f.join("\n\n"),{format:!1})),/(\D+)=(\w+)/.test(e.text)&&function(){var t,n,a;if(t=e.text.split("="),t[0]=t[0].toUpperCase(),"TIME_UPDATE_AUTO_SETTINGS"===(n=t[0])||"OFFSET_ORDERS_POINTS"===n||"OFFSET_ORDERS_PERCENT"===n||"RANGE_OFFSET"===n||"OFFSET_FIRST_ORDERS_PERCENT"===n||"TIME_CLOSE_ORDERS"===n||"STEP_BREAKEVEN_PERCENT"===n||"DEPOSIT_LIMIT_PERCENT"===n||"DEPOSIT_LIMIT_CURRENCY"===n||"COUNT_ORDERS"===n||"QUANTITY_ORDERS_IN_BLOCKS"===n||"ONE_ORDERS_SELL_PERCENT"===n||"ONE_ORDERS_SELL_OFFSET"===n||"SIZE_ORDERS_MARTINGALE"===n||"RESTART_TRADER_TIME"===n||"INTEGRITY_CONTROL_ORDERS"===n){switch(a=i.camelCase(t[0]),t[0]){case"ONE_ORDERS_SELL_PERCENT":B=+t[1];break;case"SIZE_ORDERS_MARTINGALE":W=+t[1];break;case"DEPOSIT_LIMIT_PERCENT":r.depositLimit.percent=+t[1];break;case"DEPOSIT_LIMIT_CURRENCY":r.depositLimit.currency=+t[1];break;case"INTEGRITY_CONTROL_ORDERS":r.integrityControlOrders=t[1];break;default:r[a]=+t[1]}b.warn("SET "+t[0]+"="+t[1]),O("Настройки обновлены!"),"DEPOSIT_LIMIT_PERCENT"!==(n=t[0])&&"DEPOSIT_LIMIT_CURRENCY"!==n&&"COUNT_ORDERS"!==n||(D=!0,Le(r.tradeCurrency.pair,function(e){var r;null!=e?(r=x(e),b.error(r),O("`"+r+"`")):(D=!1,O("*Бот перезапущен!*"))}))}}(),"/martin"===(null!=(R=e.text)?R.toLowerCase():void 0)?function(){var e,n,a,o,i,u,s;return e="poloniex"===r.exchange?we(ne.balance,"name"):we(ne.balanceTwo,"nameTwo"),n=Q,a=!0,o=0,i=0,u=0,s=0,l.doWhilst(function(l){var c;return r.offsetFirstOrdersPercent&&a?(n-=U.first,a=!1):r.offsetOrdersExponential?(u+=r.offsetOrdersExponential,n=t.amountMinusPercent(n,u)):n-=Ke,o=e/n,r.sizeOrdersMartingale&&(i=i?1===r.martingaleType?t.amountPlusPercent(i,r.sizeOrdersMartingale):i+W:M),c=o>i?i:o,e=(o-c)*n,s++,l(null)},function(){return o>M},function(){var r,a;return r=t.rounded(t.percentageBetweenNumbers(Q,n)-100,2),a=["*Данные расчета Мартингейла*:"],1===s&&e<=0?a.push("`Недостаточно средств!`"):(a.push(["Количество ордеров: "+s,"Последняя цена: "+t.rounded(n,ue),"*Разница между LastPrice и последним ордером: "+r+"%*"].join("\n")),0<r&&r<=2&&a.push("`При таких настройках депозита хватит на "+r+"% хода цены вниз!!! Не мало ли?`")),O(a.join("\n\n"))})}():void 0}}),m.on("callback_query",function(e){if(e.from.id===r.myChatId)switch(!1){case!/trade (\w*_(usd|rur|eur|btc|ltc))/.test(e.data):Be(e.data.substr(6));break;case!/speed (normal|extra)/.test(e.data):Ae(e.data.substr(6));break;case!/worker (continued|pause)/.test(e.data):Me(e.data.substr(7));break;case!/monitoring (start|stop)/.test(e.data):ze(e.data.substr(11));break;case!/notification (start|stop)/.test(e.data):He(e.data.substr(13));break;case!/type (buy|sell|all)/.test(e.data):Fe(e.data.substr(5));break;case!/modules (\w*)/.test(e.data):qe(e.data.substr(8));break;case!/offset_orders (plus|minus)/.test(e.data):case!/offset_orders (first_plus|first_minus)/.test(e.data):je(e.data.substr(14));break;case!/close_orders_now/.test(e.data):Ue();break;default:Ge(e.data)}}),Ue=function(){O("Начато закрытие ордеров."),D=!0,L.all=1,setTimeout(function(){dr(r.tradeCurrency.pair,function(e){var r,t;null!=e?0===e.success&&(null!=(r=null!=(t=e.error)?t.split("send:")[1]:void 0)?(_.setNonce(r),Ue()):O(x(e))):O("Активные ордера закрыты на паре: "+E()),D=!1})},u("2s"))},Be=function(e){var t,n;O("Инициализировано изменение пары..."),D=!0,t=e.split("_")[0],n=e.split("_")[1],r.tradeCurrency.name===t&&r.tradeCurrency.nameTwo!==n?L.sell=1:r.tradeCurrency.name!==t&&r.tradeCurrency.nameTwo===n&&(L.buy=1),setTimeout(function(){dr(r.tradeCurrency.pair,function(){r.tradeCurrency={name:t,nameTwo:n,pair:[t,n].join("_")},I=!0,tr(r.tradeCurrency.pair,function(e){var r,t;null!=e?(r=x(e),b.error(("Ошибка получения данных с сервера!\n"+r).red),t=["`Critical error: Ошибка получения данных с сервера!`","Бот поставлен на паузу, после обновления баланса необходимо перезапустить пару!","Ошибка: "+r].join("\n"),O(t),D=!0):(w=0,D=!1,O("Выполнено! Новая пара: "+E()))})})},u("5s"))},Fe=function(e){pe="all"!==e,O("Выполнено! Новый тип "+(ae=e).toUpperCase())},Ae=function(e){Qe(e,function(){var r;return r=["Режим "+e.toUpperCase()+" включен.","Пара: "+E()],P=t.currentTime(),b.info(r[0]),O(r.join(" "))})},Me=function(e){O("Новое состояние: `"+((D="pause"===e)?"Пауза":"Работает")+"`. Пара: "+E())},je=function(e){var n,a,o;n="plus"===e||"first_plus"===e?.1:-.1,"plus"!==e&&"minus"!==e||(r.offsetOrdersExponential?(r.offsetOrdersExponential=t.rounded(r.offsetOrdersExponential+n,1),r.offsetOrdersExponential>=.1||(r.offsetOrdersExponential=.1),a="Остальные: *"+r.offsetOrdersExponential+"%*"):r.offsetOrdersPercent?(r.offsetOrdersPercent=t.rounded(r.offsetOrdersPercent+n,1),r.offsetOrdersPercent>=.1||(r.offsetOrdersPercent=.1),a="Остальные: *"+r.offsetOrdersPercent+"%*"):r.rangeOffset?(r.rangeOffset=t.rounded(r.rangeOffset+n,1),r.rangeOffset>=.1||(r.rangeOffset=.1),a="Размер сетки: *"+r.rangeOffset+"%*"):(r.offsetOrdersPoints=t.rounded(r.offsetOrdersPoints+n,1),r.offsetOrdersPoints>=.1||(r.offsetOrdersPoints=.1),a="Остальные: *"+r.offsetOrdersPoints+"*")),"first_plus"!==e&&"first_minus"!==e||(r.offsetFirstOrdersPercent=t.rounded(r.offsetFirstOrdersPercent+n,1),r.offsetFirstOrdersPercent>=0||(r.offsetFirstOrdersPercent=0)),o=["Новый отступ на паре "+E()+":","Первый: *"+r.offsetFirstOrdersPercent+"%*",a||void 0].join("\n"),O(o+"")},qe=function(e){var t,n;/\all-modules/.test(e)?(t="all-modules-on"===e,r.dynamicSettingsTime=t,r.dynamicOffsetOrders=t,r.trendDefinition=t,r.abruptChangeTrend=t,r.dangerPriceStop=t,r.dynamicSettingsTime||(N=r.timeUpdateAutoSettings),O("Все модули "+(t?"включены":"выключены")+"!")):("one-orders-sell"===e&&(r.bbands=!1),"bbands"===e&&(r.oneOrdersSell=!1),n=e.replace(/\-./g,function(e,r,t){return e.replace("-","").toUpperCase()}),r[n]=!r[n],O(e.replace(/\-/g,"_").toUpperCase()+": "+r[n],{format:!1}))},Ge=function(e){_.getTicker(e,function(n,a){var o,l,i,u,s,c,d,f,p,b,_;return null!=n?O(x(n)):(o=er.pairs[e].decimal_places,l=a[e].last,i=a[e].sell,u=a[e].buy,s=t.rounded(a[e].avg,o),c=t.rounded(u-i,o),d=e.split("_")[1],f=Se(u,r.stepBreakevenPercent,o),p=c>f?"✔":"`✗`",b=l>s?"↑":"`↓`",_=[e.replace("_","/").toUpperCase()+":","sell: "+ge(d)+i,"buy: "+ge(d)+u,"last: "+ge(d)+l,"avg: "+ge(d)+s+" | "+b,"spread:   "+c+" | "+(c/f*100-100).toFixed()+"%","required: "+f+" "+p],O(_.join("\n")))})},ze=function(e){var r;Te.status="start"===e,clearInterval(Te.interval),Te.status?(r="Работает",Je(),Te.interval=setInterval(function(){Je()},u("5m"))):r="Остановлен",O("Новое состояние: "+r)},He=function(e){var r;null!=me&&me.length?(ye.status="start"===e,clearInterval(ye.interval),ye.status?(r="Работает",Ye()):r="Остановлен",O("Новое состояние: "+r)):O("`Внимание! Конфиг для уведомлений не задан!`")},Je=function(){var e;e=rr.join("-"),l.parallel([function(r){return _.getTicker(e,function(e,t){return null!=e?r(e):r(null,t)})},function(r){return _.getTrades(e,{limit:2},function(e,t){return null!=e?r(e):r(null,t)})}],function(e,n){var a,o,l,i,c,d;if(null!=e)return a=x(e),o="Error trading pairs available: "+a,O(o),void b.error(o.red);l=["Доступные пары для торгов:\n"],i=(new Date).getTime(),c=s.range(i-u("1m"),i),d=0,rr.forEach(function(e){var a,o,i,u,s,f,p,b,_,m,y,T,E;a=e.split("_")[1],o=e.split("_")[0],i=er.pairs[e].decimal_places,u=n[0][e].last,s=n[0][e].sell,f=n[0][e].buy,p=n[0][e].vol,b=n[0][e].vol_cur,_=n[0][e].avg?n[0][e].avg:(s+f)/2,_=t.rounded(_,i),m=t.rounded(f-s,i),y=Se(f,r.stepBreakevenPercent,i),T=u>_?"↑":"`↓`",E=!n[1][e][0].timestamp||c.contains(1e3*n[1][e][0].timestamp)&&c.contains(1e3*n[1][e][1].timestamp),m>y&&E&&(d++,l.push(e.replace("_","/").toUpperCase()+"\nprice: "+f+" - "+s+"\navg:   "+_+" | "+T+"\nvol:  "+b+" "+ge(o)+"\nvol:  "+p+" "+ge(a)+"\nspread:   "+t.noExp(m)+" | "+(m/y*100-100).toFixed()+"%\nrequired: "+t.noExp(y)+"\n")),d>=20&&(O(l.join("\n")),d=0,l=[])}),setTimeout(function(){l.length&&O(l.join("\n"))},u("2s"))})},Ye=function(){var n,a;null!=me&&me.length&&("all_all"===me[0]&&(me=rr),n=me.join("-"),a={},ye.interval=setInterval(function(){_.getTicker(n,function(n,o){var l,i,s;return null==n?(s=0,i=[],me.forEach(function(n){var l,c,d,f,p,b,_,m,y,T,E,g;r.tradeCurrency.pair!==n&&e(n,rr)&&(a[n]||(l=er.pairs[n].decimal_places,c=o[n].sell,d=o[n].buy,f=o[n].last,p=o[n].vol,b=o[n].vol_cur,_=o[n].avg?o[n].avg:(c+d)/2,_=t.rounded(_,l),(m=t.rounded(d-c,l))>Se(c,r.notificationDeviation,l)&&(s++,a[n]=!0,y=n.split("_")[1],T=n.split("_")[0],E=f<=c||f<=c+xe(3,l)?"down ↓":"up ↑",g=f>_?"↑":"`↓`",i.push(["Уведомление "+n.replace("_","/").toUpperCase()+":","directions: "+E,"sell: "+ge(y)+c,"buy: "+ge(y)+d,"last: "+ge(y)+f,"avg: "+ge(y)+_+" | "+g,"vol: "+b+" "+ge(T),"vol: "+p+" "+ge(y),"spread: "+t.noExp(m)+"\n"].join("\n"))),s>=15&&(O(i.join("\n")),s=0,i=[]),setTimeout(function(){a[n]=!1,a.error=!1},u("15m"))))}),setTimeout(function(){i.length&&O(i.join("\n"))},u("2s"))):(l=x(n),i="Error notification price: "+l,b.error(i.red),a.error?void 0:(O(i),a.error=!0))})},u("5s")))},Ve=function(r,n){var a,o,l,i;null==r&&(r=.993),null==n&&(n=!1),a={},o={},l={},i={},rr.forEach(function(e){var r;r=e.split(/\s*_\s*/),a[r[0]]?a[r[0]].push(r[1]):a[r[0]]=[r[1]]}),_.getTicker(rr.join("-"),function(u,s){var c,d,f;return null!=u?(c=x(u),O("Error: "+c)):(rr.forEach(function(e){o[e]=ve(1,s[e].buy)}),rr.forEach(function(e){var r;r=e.split(/\s*_\s*/),a[r[0]].forEach(function(t){t!==r[1]&&(l[r[1]+"_"+r[0]+"_"+t]=he(o[e],s[r[0]+"_"+t].sell))})}),Object.keys(l).forEach(function(n){var a,o;e((a=n.split(/\s*_\s*/))[0]+"_"+a[2],rr)&&(o=ve(l[n],s[a[0]+"_"+a[2]].buy)),e(a[2]+"_"+a[0],rr)&&(o=he(l[n],s[a[2]+"_"+a[0]].buy)),o>r&&(i[n+"_"+a[0]]=t.rounded(o,5))}),d=["Проверка возможных вариантов перепродаж.","Показаны значения больше: "+r,"Значения меньше 1 убыточны:\n"],f=[],Object.keys(i).forEach(function(e){f.push([e.replace(/\_/g,"->"),i[e]])}),f.length?f.sort(function(e,r){return r[1]-e[1]}).forEach(function(e){d.push(e.join(": "))}):d.push("Нет подходящих вариантов"),!n||f.length?O(d.join("\n")):void 0)})},Qe=function(e,t){var n;return null!=e&&(n=e),null==t&&(t=function(){}),n||(n=w>fe?"extra":"normal"),w=0,"extra"===n?(Ke=U.extra,We=U.extra,Ze=A,Xe=60*r.timeCloseOrdersExtra):(Ke=U.buy,We=U.sell,Ze=F,Xe=60*r.timeCloseOrders),ie=n,t()},$e=0,tr=function(e,r){return _.getInfo(function(t,n){if(null!=t)return r(t);try{er=n,rr=Object.keys(n.pairs),ue=n.pairs[e].decimal_places,de=n.pairs[e].min_amount,se=n.pairs[e].min_price,ce=n.pairs[e].fee}catch(e){r("Not valid pair")}return Le(e,function(t){var n,a;return t?(n=null!=(a=t.error)?a.split("send:")[1]:void 0,null!=n?(_.setNonce(n),tr(e,r)):($e++,$e>5?($e=0,r(t)):tr(e,r))):r(null)})})},nr=function(e,r){return _.ordersRequest(e,function(e,t){return null!=e&&"no orders"!==e.error?r(e):r(null,t)})},ar=function(e,r){return _.getTicker(e,function(n,a){var o,l,i,u;return null!=n?r(n):(o=a[e].last,l=a[e].sell,i=a[e].buy,u=t.rounded(i-l,ue),X=Ze<=xe(2)?u>=Ze:u>Ze,r(null,{lastPrice:o,bidPrice:l,askPrice:i,spread:u}))})},or=function(e,t){return X?_.balanceRequest(e,function(e,n,a){return null!=e?t(e):(n=we(n,"name"),a=we(a,"nameTwo"),"all"===ae?n<de&&a<de?Z<r.ecoCountCycle&&Z++:Z>0&&(Z=0):Z=r.ecoCountCycle,t(null,{balance:n,balanceTwo:a}))}):t(null)},lr=function(e,r){return nr(e,function(e,n){var a;return null!=e?r(e):(Y=null!=n?n:{},a=t.quantityOrdersType(Y),K={buy:a.buy,sell:a.sell},r(null))})},ir=function(e,n){var a,o;return(a=i.findKey(Y,["type","sell"]))&&t.rounded(J.amount-1e-7,8)>Y[a].amount&&(b.info("SELL partially executed"),r.logDebug&&(o=[Ee,"Старый sell: "+t.rounded(J.amount-1e-7,8)+"  Новый sell: "+Y[a].amount,"Продано: "+t.rounded(t.rounded(J.amount-1e-7,8)-Y[a].amount,8)+" "]),H=Y,J.amount=Y[a].amount,H["0000000001"]={rate:J.priceBuy,amount:J.amount},delete H[a],j={buy:0,sell:0},G={buy:0,sell:0},r.logDebug&&b.info(o.join("\n"))),V=!1,!a&&J.id&&(b.info("SELL executed!"),L.buy=1,V=!0,J={},H={},h=0,j={buy:0,sell:0},q={buy:0,sell:0},G={buy:0,sell:0},_e&&(D=!0,_e=!1,B=r.oneOrdersSellPercent,dr(e,function(e){var r;null!=e&&b.error(x(e)),r="Авто выход завершен!  Бот поставлен на паузу!",b.warn(r),O("*"+r+"*")}))),n(null)},ur=function(e,n,a,o,u){var s;return s="poloniex"===r.exchange?n<de||n*a<r.poloniexMinOrders:n<de,s?u(null):0===i.size(H)?u(null):l.series([function(e){return L.sell=1,dr(o,e)},function(e){var a,o,l,u,s,c,d,f,p,_,m;return a=[],o=i.keys(Y),l=i.keys(H),u=i.difference(l,o),r.logDebug&&a.push([Ee,"Открытые ордера: "+o,"В кэше: "+l,"Купленные: "+u].join("\n")),s=0,c=0,d=0,u.forEach(function(e){d++,s+=+H[e].amount,c+=+H[e].amount*+H[e].rate,r.logDebug&&a.push("Ордер "+d+": "+e+"  Количество: "+ +H[e].amount+"  Цена: "+ +H[e].rate)}),d>0?(J.priceBuy=c/s,r.logDebug&&a.push(["Сумма: "+c+"  Общий объем: "+s+"  Объем с комиссией: "+t.rounded(t.amountMinusPercent(s,ce),8),"Средняя цена покупки: "+J.priceBuy].join("\n")),f=t.amountPlusPercent(c,2.5*ce+B)/s,r.logDebug&&a.push(["Коммисия: "+ce+"  Процент юзера: "+B+"   Общий процент: "+(2*ce+B),"Увеличенная сумма на процент: "+t.amountPlusPercent(c,2*ce+B),"Цена продажи: "+f].join("\n")),p=i.findKey(Y,["type","sell"]),r.logDebug&&a.push(["Сумма с баланса биржи: "+n,p?"Сумма на открытом ордере SELL: "+Y[p].amount:void 0].join("\n")),_=n,"hard"===r.integrityControlOrders&&(m=t.amountMinusPercent(s,ce),_=n>=m?n:m,a.push("Разница между кэшем и балансом биржи: "+t.rounded(m-n))),p&&(_=n+Y[p].amount),r.logDebug&&(a.push("Общая сумма продажи: "+_),b.info(a.join("\n"))),J.amount=_,e(null,{rate:f,amount:_})):e(null,{rate:0,amount:0})}],function(r,t){return null!=r?u(r):t[1].rate>0?cr(e,t[1].rate,t[1].amount,o,function(e){return u(null!=e?e:null)}):u(null)})},sr=function(e,n,a,o,u){var s,c,d,f;if("poloniex"===r.exchange?n<de||n*a<r.poloniexMinOrders:n<de)return u(null);if(be)return u(null);if(r.quantityOrdersInBlocks){if(r.quantityOrdersInBlocks<=K[e])return u(null);s=!0}return c=!0,z={buy:-1,sell:-1},"all"===ae||ae===e?n>=M?(void 0!==d&&null!==d||(d=a),l.doWhilst(function(l){var u,f,p;return oe?("sell"===e&&(d-=We),"buy"===e&&(d+=Ke),n/=2,cr(e,d,n,o,l)):(r.logDebug&&(u=[Ee]),"buy"===e?(r.oneOrdersSell&&(R||s)&&(R=!1,s=!1,i.isEmpty(Y)||(c=!1,"object"==typeof(f=t.searchRate(Y,"min"))&&f.rate<a&&(d=f.rate),r.logDebug&&u.push("Последняя цена в стеке: "+d))),r.offsetFirstOrdersPercent&&c?(d-=U.first,r.logDebug&&u.push("Цена рынка: "+a+"   Цена First ордера: "+d),c=!1):r.offsetOrdersExponential?(r.logDebug&&u.push(["Отступ Exponential: Прошлый: "+G[e],"Новый: "+t.rounded(G[e]+r.offsetOrdersExponential,8)].join("  ")),G[e]=G[e]+r.offsetOrdersExponential,d=t.amountMinusPercent(d,G[e])):d-=Ke,n=-1===z.buy?n:z.buy/d,r.logDebug&&(-1===z.buy?u.push("Общий объем: "+n):u.push(["Остаточный баланс: "+z.buy,"Цена: "+t.rounded(d,8),"Общий объем: "+t.rounded(z.buy/d,8)].join("   ")))):(r.offsetFirstOrdersPercent&&c?(d+=U.first,r.logDebug&&u.push("Цена First ордера: "+t.rounded(d,8)),c=!1):r.offsetOrdersExponential?(r.logDebug&&u.push(["Отступ Exponential: Прошлый: "+G[e],"Новый: "+t.rounded(G[e]+r.offsetOrdersExponential,8)].join("  ")),G[e]=G[e]+r.offsetOrdersExponential,d=t.amountPlusPercent(d,G[e])):d+=We,n=-1===z.sell?n:z.sell,r.logDebug&&(-1===z.sell?u.push("Общий объем: "+n):u.push(["Остаточный баланс: "+z.sell,"Цена: "+t.rounded(d,8),"Общий объем: "+z.sell].join("  ")))),r.sizeOrdersMartingale?(j[e]?(r.logDebug&&(1===r.martingaleType?u.push(["Размер ордера: "+t.rounded(j[e],8),"Размер мартина: "+r.sizeOrdersMartingale,"Новый размер ордера: "+t.rounded(t.amountPlusPercent(j[e],r.sizeOrdersMartingale),8)].join("  ")):u.push(["Размер ордера: "+t.rounded(j[e],8),"Размер мартина: "+W,"Новый размер ордера: "+t.rounded(j[e]+W,8)].join("  "))),j[e]=1===r.martingaleType?t.amountPlusPercent(j[e],r.sizeOrdersMartingale):j[e]+W):j[e]=M,q[e]&&(r.logDebug&&u.push(["Кеш мартина: "+t.rounded(q[e],8),"Старый размер ордера: "+t.rounded(j[e],8)].join("  ")),j[e]=q[e],q[e]=0),p=n>j[e]?j[e]:n,r.logDebug&&u.push(["Баланс: "+n,"Размер ордера: "+t.rounded(j[e],8)].join("  "))):(p=n>M?M:n,r.logDebug&&u.push(["Баланс: "+n,"Размер ордера: "+t.rounded(M,8)].join("  "))),r.logDebug&&(u.push("Новый размер ордера: "+t.rounded(p,8)+"  "+(t.rounded(p,8)<.01?"| Ордер не установлен":"")),b.info(u.join("\n"))),cr(e,d,p,o,l))},function(){return!(r.quantityOrdersInBlocks&&r.quantityOrdersInBlocks<=K[e])&&n>M},function(e){return u(null!=e?e:null)})):(r.oneOrdersSell&&"buy"===e&&"object"==typeof(f=t.searchRate(Y,"min"))&&f.rate<a&&(a=f.rate),r.offsetOrdersPercent&&("sell"===e&&(a+=We),"buy"===e&&(a-=Ke)),r.offsetOrdersExponential&&(G[e]=G[e]+r.offsetOrdersExponential,"sell"===e&&(a=t.amountMinusPercent(a,G[e])),"buy"===e&&(a=t.amountPlusPercent(a,G[e]))),r.dynamicOffsetOrders&&("sell"===e&&(a+=xe(1)),"buy"===e&&(a-=xe(1))),cr(e,a,n,o,u)):u(null)},cr=function(e,n,a,o,l){var u;return(n=t.rounded(n,ue))>=se||(n=se),a=t.rounded(a-1e-7,8),u="poloniex"===r.exchange?a<de||a*n<r.poloniexMinOrders:a<de,u?l(null):_.tradeSetOrder(o,e,n,a,function(t,o){var u,s,c;return null!=t?(r.sizeOrdersMartingale&&(q[e]=j[e]),R=!0,u=x(t),b.error(("Error: "+u+" | "+e+" | rate: "+n+" | amount: "+a).red),l(t)):(s=o.order_id>0?o.order_id:i.random(1e3,2e3),r.oneOrdersSell&&("buy"===e&&(H[s]={rate:n,amount:a}),"sell"===e&&(J.id=s)),r.quantityOrdersInBlocks&&K[e]++,c="Open: "+e+" | id: "+s+" | rate: "+n+" | amount: "+a,b.info("buy"===e?c.green:c.yellow),"buy"===e?z.buy="poloniex"===r.exchange?we(o.funds[r.tradeCurrency.name],"name"):we(o.funds[r.tradeCurrency.nameTwo],"nameTwo"):z.sell="poloniex"===r.exchange?we(o.funds[r.tradeCurrency.nameTwo],"nameTwo"):we(o.funds[r.tradeCurrency.name],"name"),w++,l(null))})},dr=function(e,r){return _.ordersRequest(e,function(e,n){var a,o,i;return h=t.currentTime(),null!=e?0===e.success&&null==(null!=(a=e.error)?a.split("send:")[1]:void 0)?(o=x(e),b.warn(("Cancel orders: "+o).yellow),r(null)):r(e):(i=Object.keys(n),l.eachSeries(i,function(e,r){if(null==L.all){if(null!=L.buy&&"sell"===n[e].type)return r(null);if(null!=L.sell&&"buy"===n[e].type)return r(null)}return h-n[e].timestamp_created>(L.buy||L.sell||L.all||60)?fr(e,n[e].type,n[e].amount,n[e].rate,r):r(null)},function(e){return L={all:null,buy:null,sell:null},r(null!=e?e:null)}))})},fr=function(e,t,n,a,o){return _.tradeCancelOrder({order_id:e},function(l,i){return null!=l?o(l):(r.oneOrdersSell&&(delete H[e],"sell"===t&&(J.id=0)),b.info(("Close: "+t+" | id: "+e+" | rate: "+a+" | amount: "+n).cyan),w>0&&w--,o(null))})},pr=function(){pe||t.timeIsOver(h,r.timeCloseOrdersInactivity)&&dr(r.tradeCurrency.pair,function(e){null!=e&&b.error("Orders inactivity: "+x(e))})},br=function(){var e;t.timeIsOver(v,10)&&(e="Unknown error: Worker does not meet!",b.warn(e.red),mr({error:e}))},_r=function(){v=t.currentTime(),D?setTimeout(function(){_r()},u("30s")):l.series([function(e){return ar(r.tradeCurrency.pair,e)},function(e){return or(r.tradeCurrency,e)}],function(e,t){var n,a,o,s;n=t[0],a=t[1],null!=e?(o=x(e),null!=(null!=(s=e.error)?s.split("send:")[1]:void 0)?b.warn(o):b.error(("ErrorData: "+o).red),mr(e)):(I&&De(n.askPrice,n.bidPrice,n.lastPrice,function(){return I=!1}),X?l.series([function(e){return N>0&&v-P>60*N?De(n.askPrice,n.bidPrice,n.lastPrice,e):e(null)},function(e){return v-h>Xe?dr(r.tradeCurrency.pair,e):e(null)},function(e){return r.quantityOrdersInBlocks||r.oneOrdersSell?i.delay(lr,u("3s"),r.tradeCurrency.pair,e):e(null)},function(e){return r.botTrade&&C&&r.oneOrdersSell?ir(r.tradeCurrency.pair,e):e(null)},function(e){var t,o;return r.oneOrdersSell&&V?e(null):r.botTrade&&C?(t=oe?le.ask:n.askPrice,o="poloniex"===r.exchange?a.balanceTwo:a.balance,r.oneOrdersSell?ur("sell",o,t,r.tradeCurrency.pair,e):(j.sell=0,G.sell=0,sr("sell",o,t,r.tradeCurrency.pair,e))):e(null)},function(e){var t,o;return r.oneOrdersSell&&V?e(null):r.botTrade&&C?(t=oe?le.bid:n.bidPrice,o="poloniex"===r.exchange?a.balance/t:a.balanceTwo/t,r.oneOrdersSell?R||K.buy||(j.buy=0,G.buy=0):(j.buy=0,G.buy=0),sr("buy",o,t,r.tradeCurrency.pair,e)):e(null)}],function(e){var t;null!=e?(t=x(e),b.error(("ErrorTrader: "+t).red),mr(e)):Z===r.ecoCountCycle?setTimeout(function(){_r()},u("2s")):_r()}):setTimeout(function(){_r()},u("5s")))})},mr=function(e){var t,n,a,o;t="restart after "+parseInt(r.restartTraderTime)+" sec ...",b.warn(t),null==(n=null!=(a=e.error)?a.split("send:")[1]:void 0)&&(o=x(e),S.count++,S.text!==o&&(S.text=o,r.isEmail&&"production"===process.env.NODE_ENV&&T(g(o+"\n\n"+t),function(e,r){})),r.notificationErrorCount&&S.count>r.notificationErrorCount&&(O("`Слишком много ошибок API. Требуется внимание пользователя!`"),S.count=0)),setTimeout(function(){b.warn("trader restart"),null!=n&&_.setNonce(n),_r()},u(parseInt(r.restartTraderTime)+"s"))},function(){r.myChatId||r.telegramOff?(b.info("Trader Bot starting..."),b.info("Exchange: "+r.exchange.toUpperCase()+" | v."+r.versionBot),tr(r.tradeCurrency.pair,function(e){var t;return null!=e&&(t=x(e),b.error(("Error getting parameters from the server!\n"+t).red),process.exit(0)),_r(),r.botTrade&&setInterval(function(){pr(),br(),S.count=0},u("5m")),setInterval(function(){Pe()},u(10*r.bbandsInterval+"s")),"production"===process.env.NODE_ENV&&O("Trader Bot started. Pair "+E()),b.info("Trader Bot started")})):b.warn("Get the user id in the Telegram")}()):b.warn("There is no token Telegram!")}).call(this);