(function(){function e(e,t){for(var r=-1,n=t.length>>>0;++r<n;)if(e===t[r])return!0;return!1}var t,r,n,a,l,o,i,c,s,u,d,p,b,_,f,m,g,y,T,O,E,x,C,S,k,v,w,h,R,N,P,I,D,L,U,B,F,j,A,M,q,z,H,J,G,V,K,Y,W,Q,X,Z,$,ee,te,re,ne,ae,le,oe,ie,ce,se,ue,de,pe,be,_e,fe,me,ge,ye,Te,Oe,Ee,xe,Ce,Se,ke,ve,we,he,Re,Ne,Pe,Ie,De,Le,Ue,Be,Fe,je,Ae,Me,qe,ze,He,Je,Ge,Ve,Ke,Ye,We,Qe,Xe,Ze,$e,et,tt,rt,nt,at,lt,ot,it,ct,st,ut,dt,pt,bt,_t,ft,mt,gt,yt,Tt,Ot;if(t=require("./conf"),r=require("./api-btc-e"),n=require("./api-poloniex"),a=require("async"),l=require("lodash"),require("colors"),o=require("ms"),i=require("moment"),c=require("moment-range"),s=require("nodemailer"),u=require("node-telegram-bot-api"),d=require("ta-lib"),i=c.extendMoment(i),!t.tokenTelegram)return void console.log("There is no token Telegram!".red);p="poloniex"===t.exchange?new n:new r,b=new u(t.tokenTelegram,{polling:!0}),_=function(e,r){e.length>4096&&(e="Слишком много информации для отображения"),e.length||(e="Error: Не удалось обработать ошибку"),b.sendMessage(t.myChatId,e,r)},f=s.createTransport(t.email),m=function(e,t){return f.sendMail(e,t)},g=function(){return t.tradeCurrency.pair.replace("_","/").toUpperCase()},y=function(e){return{from:t.email.auth.user,to:t.email.reportEmail,subject:"Error Script Trader",text:"time: "+(new Date).toString()+"\nPair: "+g()+"\n\nmessage: "+e+"\n\n---"}},T=function(){return(new Date).toLocaleTimeString("en-US",{timeZone:t.timeZone,hour12:!1})},O=function(){return Math.round((new Date).getTime()/1e3)},E=function(e){var t;return t="",Object.keys(e).forEach(function(r){if(e.hasOwnProperty(r))return t+=r+" :: "+e[r]+"\n"}),t},x=function(e){return"object"==typeof e?e.hasOwnProperty("error")?e.error:e.hasOwnProperty("message")?e.message:E(e):e},C=!0,S={count:0,text:""},k=!1,v={name:0,nameTwo:0},w=O(),h=O(),R=O(),N=t.timeUpdateAutoSettings,P=!0,I=!1,D=0,L={all:null,buy:null,sell:null},U={extra:0,buy:0,sell:0,first:0},B=0,F=0,j=0,A={buy:0,sell:0},M={buy:0,sell:0},q={},z={},H={id:0,priceBuy:0,amount:0},J={},G=!1,V=0,K=0,Y=!1,W=0,Q=0,X=0,Z=0,$=[],ee=[],te={},re="all",ne=!1,ae={ask:0,bid:0},le="normal",oe=0,ie=0,ce=0,se=0,ue=0,de=!1,pe=!1,be=!1,_e=null!=(fe=t.notificationPair)?fe.toLowerCase().replace(/\//g,"_").split(/\s*,\s*/):void 0,me={status:!1,interval:!1},ge={status:!1,interval:!1},ye={btc:"฿",usd:"$",eur:"€",rur:"₽",ltc:"L"},Te="-----------------------------------",Oe=function(e){return ye.hasOwnProperty(e)?ye[e]:e+" "},Ee=function(e,t){return O()-e>=60*t},xe=function(e,t){var r,n,a;return null!=t&&(r=t),r||(r=e>=1?["минута","минуты","минут"]:["секунда","секунды","секунд"],e=e<1?60*e:e),n=[2,0,1,1,1,2],a=r[e%100>4&&e%100<20?2:n[e%10<5?e%10:5]],e+" "+a},Ce=function(e,t){return null==t&&(t=3),+(+e).toFixed(t)},Se=function(e){return e.toFixed(10).replace(/(.*0\.0*[1-9]*)0+\d*/g,"$1")},ke=function(e,t){var r,n,a;return r=[],l.forIn(e,function(e,t){r.push(e)}),n=r.sort(function(e,t){return t.rate-e.rate}),a=l.findKey(n,function(e){return e.rate<=t}),n[a]},ve=function(e,t){var r,n;return r=[],l.forIn(e,function(e,n){"min"===t&&"buy"!==e.type||"max"===t&&"sell"!==e.type||r.push(e)}),n=r.sort(function(e,t){return t.rate-e.rate}),"min"===t?l.last(n):l.head(n)},we=function(e,t){return t>0?+(100*e/t).toFixed(1):0},he=function(e,t){return e*(1+t/100)},Re=function(e,t){return e*(1-t/100)},Ne=function(e,t){return null==t&&(t=oe),Ce(e/+("1e"+t),t)},Pe=function(e,t){return null==t&&(t=oe),Ce(e*+("1e"+t),t)},Ie=function(e,t,r){var n,a;return null==t&&(t=0),null==r&&(r=oe),n=e/100*ce*2,a=Math.ceil(n*+("1e"+r))/+("1e"+r),Ce(he(a,t),r)},De=function(e,t){return Ce(he(e,t),oe)},Le=function(e,t){return Ce(Re(e,t),oe)},Ue=function(e,t){return Re(e/t,ce)},Be=function(e,t){return Re(e*t,ce)},Fe=function(){t.bbands&&Z>0&&(ee.push(Z),ee.length>30&&ee.splice(0,1))},je=function(e,t){var r,n;return null==t&&(t=.1),r=e/100*t,n=1/+("1e"+oe),r>=n||(r=n),Ce(r,oe)},Ae=function(e,t){var r,n,a;null==t&&(t=1),r=e.toString().split(".")[0];try{n=e.toString().split(".")[1].length}catch(e){n=1}return a=r>0?r>1e4?+("1e"+(n+1)):r>1e3?+("1e"+n):r>100?+("1e"+(n-1)):r>10?+("1e"+(n-2)):n>3?+("1e"+(n-3)):1:1,t*=a,Ce(t/+("1e"+n),n)},Me=function(e,r,n){var a,o,i,c,s,u,p,b,f,m,y,E,x,S,k,v,w,j,A,M,q,z,G,V,K,Y,W,te,be,_e,fe,me,ge,ye,Oe,Ee,xe;if(R=O(),L={buy:null,sell:null},a=e.toString().length,o=r.toString().length,c={},c[a+""]=e,c[o+""]=r,i=c,s=Math.max(a,o),u=i[s],oe=it.pairs[t.tradeCurrency.pair].decimal_places,se=it.pairs[t.tradeCurrency.pair].min_amount,ie=it.pairs[t.tradeCurrency.pair].min_price,ce=it.pairs[t.tradeCurrency.pair].fee,p=Ce(e-r,oe),b=Ie(u,200),t.dynamicSettingsTime&&($.push(n),$.length>50&&$.splice(0,1),f=l.max($),m=l.min($),t.botLog&&console.log([Te,"price-array:","length: "+$.length,"max: "+f,"min: "+m,"change-time-settings: "+(we(f,m)>102)].join("\n")),we(f,m)>102?N=.1:N!==t.timeUpdateAutoSettings&&(N=t.timeUpdateAutoSettings)),t.abruptChangeTrend&&(y=Ie(u,500)),t.dangerPriceStop&&(E=De(X,9),x=Le(Q,9)),t.dynamicOffsetOrders&&(S={current:Ie(u,450),prev:Ie(u,380),prev_2:Ie(u,300)},k=p>=S.current||p>=S.prev||p>=S.prev_2),t.dynamicOffsetOrders&&k?(console.log("["+T()+"]: Dynamic market"),v=Ae(u,Pe(S.current)),w=1.5*t.stepBreakevenPercent):(v=Ae(u,t.offsetOrdersPoints),w=t.stepBreakevenPercent),v=function(){switch(!1){case!t.offsetOrdersPercent:return je(u,t.offsetOrdersPercent);case!t.rangeOffset:return je(u,Ce(t.rangeOffset/t.countOrders,2));default:return v}}(),j=1.3*v,A=je(u,t.offsetFirstOrdersPercent),M=t.offsetOrdersPercent?je(u):2,B=function(){switch(!1){case!t.bbands:case!t.oneOrdersSell:return 0;default:return Ie(u,w)}}(),t.botLog&&(console.log(Te),console.log("current-spread:",(Se(p)+"")[p>B?"green":"white"]),console.log("spread-min-default:",Se(B)),console.log("trend-spread:",Se(b)),t.abruptChangeTrend&&console.log("immediate-spread:",y),console.log("trader-speed:",le),console.log("price-prev:",X+" - "+Q),console.log("price-prev2:",ae.ask+" - "+ae.bid),t.dangerPriceStop&&(console.log("danger-price-ask:",E,!P&&e>=E?"Attention!".red:""),console.log("danger-price-bid:",x,!P&&r<=x?"Attention!".red:"")),t.dynamicOffsetOrders&&(console.log("spread_1_450:",S.current,p>=S.current?"Attention!".red:""),console.log("spread_2_380:",S.prev,p>=S.prev?"Attention!".red:""),console.log("spread_3_300:",S.prev_2,p>=S.prev_2?"Attention!".red:""),console.log("dynamic-market:",k))),t.dangerPriceStop&&!P&&(e>=E||r<=x))return e>=E&&(L.buy=1),h=0,I=!0,q="DANGER PRICE: "+e+" - "+r+" | Bot Pause!",console.log("["+T()+"]: "+q),void _(q+"");z=M,G=D>Math.round(ue/2)?j:v,t.botLog&&(console.log("offset-max-one:",(Se(v)+"")[v===G?"green":"yellow"]),console.log("offset-type-max:",Se(G)),t.offsetFirstOrdersPercent&&console.log("offset-first-orders:",Se(A)),console.log(Te)),de||(re="all",ne=!1),P?(t.bbands&&(C=!1),V=K=G):t.oneOrdersSell?(V=K=G,t.timeCloseOrders=1e5,t.timeCloseOrdersInactivity=t.timeCloseOrders,(Y=ke(J,r))&&r>De(Y.rate,t.oneOrdersSellOffset)&&!H.id&&(L.buy=1,h=0)):t.bbands?(V=K=G,N=.1,W=14,ee.length>2*W&&(c=d.BBANDS(ee,20,t.bbandsDeviation),te=c.middleband,be=c.lowband,_e=c.highband,fe=d.RSI(l.clone(ee).reverse(),W),me=d.average(fe).mean,ge=d.average(te).mean,ye=d.average(_e).mean,Oe=d.average(be).mean,Ee=ye>n&&n>ge,xe=ge>n&&n>Oe,Ee&&(de||(re="sell"),C=99>me&&me>70),xe&&(de||(re="buy"),C=1<me&&me<30),pe=Ee&&xe,t.botLog&&console.log(["BBANDS:","highband: "+ye,"middleband: "+ge,"lowband: "+Oe,"rsa: "+me,"sell: "+Ee,"buy: "+xe,"bot trade: "+C,"orders-calculation-brake: "+pe,Te].join("\n")))):t.trendDefinition&&r>Q&&e>X&&p>b&&"normal"===le?(console.log("["+T()+"]: Trend: UP"),V=z,K=G,de||(re="buy",L.sell=1,h=0,t.abruptChangeTrend&&p>y&&(console.log("["+T()+"]: Spread Immediate"),ne=!0,R=0))):t.trendDefinition&&r<Q&&e<X&&p>b&&"normal"===le?(console.log("["+T()+"]: Trend: DOWN"),V=G,K=z,de||(re="sell",L.buy=1,h=0,t.abruptChangeTrend&&p>y&&(console.log("["+T()+"]: Spread Immediate"),ne=!0,R=0))):V=K=G,ae={ask:X,bid:Q},Q=r,X=e,Z=n,F=Ie(u),U={buy:V,sell:K,extra:Ae(u),first:A},lt(),console.log("["+T()+"]: Update: "+re.toUpperCase()+" | "+e+" - "+r+" | "+n+" | "+g())},qe=function(e,t){var r,n;return r="name"===t?v.name:v.nameTwo,n=e-r,n>0?n:0},ze=function(e,r){return a.parallel([function(r){return t.botLog&&console.log(Te+"\nПолучение цен"),p.getTicker(e,function(n,a){return null!=n?(t.botLog&&(console.log("Price: "+a[e].buy),console.log(x(n))),r(n)):r(null,{price:a[e].buy})})},function(r){return a.series([function(r){return t.botLog&&console.log(Te+"\nЗакрытие всех позиций"),L.all=1,ft(e,function(e){return r(null!=e?e:null)})},function(e){return t.botLog&&console.log(Te+"\nПолучение баланса"),p.balanceRequest(t.tradeCurrency,function(r,n,a){return null!=r?(t.botLog&&(console.log("balance: "+n+" | balance-two: "+a),console.log(x(r))),e(r)):t.botTrade&&n<.001&&a<.001?(t.botLog&&console.log("balance: "+n+" | balance-two: "+a),e({error:"Err: No money!"})):e(null,{balance:n,balanceTwo:a})})}],function(e,t){return null!=e?r(e):r(null,{balance:t[1].balance,balanceTwo:t[1].balanceTwo})})}],function(e,n){var a,l,o,i,c,s,u,d,p,b,_,f,m,g,y;return null!=e?r(e):(te=n[1],t.botLog&&console.log(Te+"\nРасчет депозита"),a=0<(l=t.depositLimit)&&l<100?t.depositLimit:100,t.oneOrdersSell&&("poloniex"===t.exchange?(o=n[1].balanceTwo,n[1].balanceTwo=0):(o=n[1].balance,n[1].balance=0)),"poloniex"===t.exchange?(i=n[1].balanceTwo*n[0].price+n[1].balance,c=n[1].balance/n[0].price+n[1].balanceTwo):(i=n[1].balanceTwo/n[0].price+n[1].balance,c=n[1].balance*n[0].price+n[1].balanceTwo),s=i*a/100,u=c*a/100,100===a?(t.botLog&&console.log("type:",0),d=0,p=0):n[1].balance>=s&&n[1].balanceTwo>=u?(t.botLog&&console.log("type:",1),d=n[1].balance-s/2,p=n[1].balanceTwo-u/2):n[1].balance>=s&&n[1].balanceTwo<u?(t.botLog&&console.log("type:",2),d="poloniex"===t.exchange?n[1].balance-(u-n[1].balanceTwo)*n[0].price:n[1].balance-(u-n[1].balanceTwo)/n[0].price,p=0):n[1].balance<s&&n[1].balanceTwo>=u?(t.botLog&&console.log("type:",3),d=0,p="poloniex"===t.exchange?n[1].balanceTwo-(s-n[1].balance)/n[0].price:n[1].balanceTwo-(s-n[1].balance)*n[0].price):n[1].balance<s&&n[1].balanceTwo<u&&(t.botLog&&console.log("type:",4),"poloniex"===t.exchange?(d=n[1].balance-(u-n[1].balanceTwo)*n[0].price,p=n[1].balanceTwo-(s-n[1].balance)/n[0].price):(d=n[1].balance-(u-n[1].balanceTwo)/n[0].price,p=n[1].balanceTwo-(s-n[1].balance)*n[0].price)),t.botLog&&(b=we(d,n[1].balance),_=we(p,n[1].balanceTwo),console.log(["reserved-deposit:",t.tradeCurrency.name.toUpperCase(),b+"% / "+_+"%",t.tradeCurrency.nameTwo.toUpperCase()].join(" "))),t.oneOrdersSell&&("poloniex"===t.exchange?p=o:d=o),v={name:d>0?d:0,nameTwo:p>0?p:0},f="poloniex"===t.exchange?u:s,t.countOrders?t.countOrders>=3||(t.countOrders=3):t.countOrders=f<=10?6:f<=200?15:f<=500?18:f<=1e3?21:25,m="poloniex"===t.exchange?t.poloniexMinOrders/n[0].price:se,ue=t.countOrders*t.multiplierOrdersExtra,t.sizeOrdersMartingale?1===t.martingaleType?(g=1+t.sizeOrdersMartingale/100,y=f/((Math.pow(g,t.countOrders)-1)/(g-1))):(K=n[0].price-Re(n[0].price,t.sizeOrdersMartingale),y=f/t.countOrders-(t.countOrders-1)*K/2):y=f/t.countOrders,j=Ce(y>m?y:m,oe),t.botLog&&console.log([Te+"\nРасчет переменных","balance: "+Ce(n[1].balance)+" "+t.tradeCurrency.name.toUpperCase(),"balance-two: "+Ce(n[1].balanceTwo)+" "+Oe(t.tradeCurrency.nameTwo),"deposit: "+i+" "+t.tradeCurrency.name.toUpperCase()+" или "+c+" "+t.tradeCurrency.nameTwo.toUpperCase(),"percent-deposit: "+t.depositLimit+" %","trade-deposit: "+s+" "+t.tradeCurrency.name.toUpperCase()+" | "+u+" "+t.tradeCurrency.nameTwo.toUpperCase(),"reserved-deposit: "+Ce(v.name)+" "+t.tradeCurrency.name.toUpperCase()+" | "+Ce(v.nameTwo)+" "+t.tradeCurrency.nameTwo.toUpperCase(),"count-orders: "+t.countOrders,"quantity-orders-in-blocks: "+(t.quantityOrdersInBlocks?t.quantityOrdersInBlocks:"OFF"),"size-static-order: "+j,"size-orders-martingale: "+(t.sizeOrdersMartingale?t.sizeOrdersMartingale:"OFF")+"    Тип: "+(1===t.martingaleType?"Exponential":"Linear"),Te].join("\n")),r(null))})},b.on("message",function(e){var r,n,o,i,c,s,u,d,f,m,y;if(r=e.chat.id,t.myChatId||b.sendMessage(r,"Install your Telegram id: "+r),r===t.myChatId){if("Ордера"===e.text&&(n=function(){a.series([function(e){return p.balanceRequest(t.tradeCurrency,function(t,r,n){return null!=t?e(t):e(null,{balance:r,balanceTwo:n})})},function(e){return p.ordersRequest(t.tradeCurrency.pair,function(t,r){return null!=t?e(t):e(null,{data:r})})}],function(e,r){var a,o,i,c,s,u,d,b,f,m,y,T;a=[g()+":",Te],o="Balance: "+(null!=(i=r[0])?i.balance.toFixed(3):void 0)+" "+t.tradeCurrency.name.toUpperCase()+" | "+Oe(t.tradeCurrency.nameTwo)+(null!=(c=r[0])?c.balanceTwo.toFixed(3):void 0),null!=e?0===e.success?(s=null!=(u=e.error)?u.split("send:")[1]:void 0,null!=s?(p.setNonce(s),n()):(d=x(e),a.push(d+"\n"+Te+"\n"+o),_(a.join("\n")))):_(e):(b={},f=0,m=0,y={},Object.keys(r[1].data).forEach(function(e){var n,a,l;n=r[1].data[e].rate*+("1e"+oe),null!=y[n]?(++b[n],a=" | "+b[n],l=Ce(Ce(y[n].split("|")[1].trim())+Ce(r[1].data[e].amount)),y[n]=r[1].data[e].type+" | "+l+" | "+Oe(t.tradeCurrency.nameTwo)+r[1].data[e].rate+a):(b[n]=1,y[n]=r[1].data[e].type+" | "+Ce(r[1].data[e].amount)+" | "+Oe(t.tradeCurrency.nameTwo)+r[1].data[e].rate),f+=r[1].data[e].amount,m+=r[1].data[e].amount*r[1].data[e].rate}),a=l.concat(a,l.values(y)),a.push(Te+"\nCount: "+Ce(f)+" | Sum: "+Oe(t.tradeCurrency.nameTwo)+Ce(m)+"\n"+o),T=a.join("\n"),_(T))})})(),"История"===e.text&&(o=function(){p.tradeGetHistory(t.tradeCurrency.pair,10,function(e,r){var n,a,l;return null!=e?0===e.success?(n=null!=(a=e.error)?a.split("send:")[1]:void 0,null!=n?(p.setNonce(n),o()):_(x(e))):_(x(e)):(l=[],Object.keys(r).forEach(function(e){l.push(r[e].type+" | "+r[e].amount.toFixed(3)+" | "+Oe(t.tradeCurrency.nameTwo)+r[e].rate)}),l.push(g()+":\n"+Te),l.reverse(),_(l.join("\n")))})})(),"Закрыть активные ордера"===e.text&&(i={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Закрыть ордера!",callback_data:"close_orders_now"}]]})},_("*Вы уверены что хотите закрыть ордера?*",i)),"/config"===(null!=(c=e.text)?c.toLowerCase():void 0)&&(s=["Бот на паре: "+g(),"EXCHANGE: "+t.exchange+" | Выбор биржи btc-e или poloniex","POLONIEX_FEE: "+t.poloniexFee+" | Комиссия на сделки биржи POLONIEX","TIME_UPDATE_AUTO_SETTINGS: "+N+" | время обновления авто настроек параметров (в мин)","DEPOSIT_LIMIT: "+t.depositLimit+" | процент использования депозита","NOTIFICATION_PAIR: "+t.notificationPair+" | пары для уведомления (или all/all для всех)","NOTIFICATION_DEVIATION_PERCENT: "+t.notificationDeviation+" | насколько процентов должен увеличиться спред чтобы сработало уведомление","COUNT_ORDERS: "+t.countOrders+" | количество ордеров","QUANTITY_ORDERS_IN_BLOCKS: "+t.quantityOrdersInBlocks+" | количество ордеров в блоке","TIME_CLOSE_ORDERS: "+t.timeCloseOrders+" | сколько минут ждать перед закрытием неисполнившихся ордеров","TIME_CLOSE_ORDERS_INACTIVITY: "+t.timeCloseOrdersInactivity+" | закрытие после бездействия","OFFSET_ORDERS_POINTS: "+t.offsetOrdersPoints+" | отступ ордеров в пунктах","OFFSET_ORDERS_PERCENT: "+t.offsetOrdersPercent+" | отступ для ордеров в %","OFFSET_FIRST_ORDERS_PERCENT: "+t.offsetFirstOrdersPercent+" | отступ первого ордера в %","RANGE_OFFSET: "+t.rangeOffset+" | диапазон смещения ордеров в %","SIZE_ORDERS_MARTINGALE: "+t.sizeOrdersMartingale+" | размер ордера в % Мартингейла","MARTINGALE_TYPE: "+t.martingaleType+" | тип Мартингейла","STEP_BREAKEVEN_PERCENT: "+t.stepBreakevenPercent+" | процент отступа безубытка для торгов","DANGER_PRICE_STOP: "+t.dangerPriceStop+" | остановка бота при большом изменении цены","DYNAMIC_SETTINGS_TIME: "+t.dynamicSettingsTime+" | динамическое время обновления настроек","DYNAMIC_OFFSET_ORDERS: "+t.dynamicOffsetOrders+" | динамическое распределение ордеров","TREND_DEFINITION: "+t.trendDefinition+" | определение тренда","ABRUPT_CHANGE_TREND: "+t.abruptChangeTrend+" | быстрое изменение направления тренда","BBANDS: "+t.bbands+" | Стратегия Полосы Боллинджера","BBANDS_DEVIATION: "+t.bbandsDeviation+" | Отклонение","BBANDS_INTERVAL: "+t.bbandsInterval+" | Таймфрейм (в мин)","ONE_ORDERS_SELL: "+t.oneOrdersSell+" | Стратегия One Sell a lot Buy","ONE_ORDERS_SELL_PERCENT: "+t.oneOrdersSellPercent+" | Насколько увеличить среднюю цену продажи в процентах","ONE_ORDERS_SELL_OFFSET: "+t.oneOrdersSellOffset+" | Разница между ценой LastPrice и первым ордером buy в стеке ордеров в процентах"],_(s.join("\n\n"))),"/version"===(null!=(u=e.text)?u.toLowerCase():void 0)&&_("Версия бота: "+t.versionBot),"/start"!==(d=null!=(f=e.text)?f.toLowerCase():void 0)&&"главное меню"!==d||(i={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({keyboard:[[{text:"Ордера"},{text:"Котировки"},{text:"История"}],[{text:"Контроль"},{text:"Нотис"},{text:"Торговля"}],[{text:"Закрыть активные ордера"}]],resize_keyboard:!0})},_("Выберите:",i)),"Котировки"===e.text){if("btc-e"!==t.exchange)return void _("Этот пункт не доступен для данной биржи");i={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({keyboard:[[{text:"USD"},{text:"BTC"},{text:"OTHER"}],[{text:"Главное меню"}]],resize_keyboard:!0})},_("Валюта:",i)}if("Торговля"===e.text&&(i={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({keyboard:[[{text:"Сменить пару"},{text:"Тип"}],[{text:"Авто выход из пары"}],[{text:"Главное меню"}]],resize_keyboard:!0})},_("Выберите:",i)),"USD"===e.text&&(i={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"NMC",callback_data:"nmc_usd"},{text:"PPC",callback_data:"ppc_usd"},{text:"NVC",callback_data:"nvc_usd"},{text:"LTC",callback_data:"ltc_usd"},{text:"BTC",callback_data:"btc_usd"}],[{text:"DSH",callback_data:"dsh_usd"},{text:"ETH",callback_data:"eth_usd"},{text:"EUR",callback_data:"eur_usd"},{text:"RUR",callback_data:"usd_rur"}]]})},_("Символ:",i)),"BTC"===e.text&&(i={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"NMC",callback_data:"nmc_btc"},{text:"PPC",callback_data:"ppc_btc"},{text:"NVC",callback_data:"nvc_btc"},{text:"LTC",callback_data:"ltc_btc"}],[{text:"DSH",callback_data:"dsh_btc"},{text:"ETH",callback_data:"eth_btc"},{text:"RUR",callback_data:"btc_rur"},{text:"EUR",callback_data:"btc_eur"}]]})},_("Символ:",i)),"OTHER"===e.text&&(i={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"ETH/LTC",callback_data:"eth_ltc"},{text:"ETH/EUR",callback_data:"eth_eur"},{text:"ETH/RUR",callback_data:"eth_rur"}],[{text:"LTC/RUR",callback_data:"ltc_rur"},{text:"LTC/EUR",callback_data:"ltc_eur"},{text:"EUR/RUR",callback_data:"eur_rur"}]]})},_("Пара:",i)),"Контроль"===e.text&&(i={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({keyboard:[[{text:"Скорость"},{text:"Состояние"},{text:"Модули"}],[{text:"Главное меню"}]],resize_keyboard:!0})},_("Выберите:",i)),"Нотис"===e.text&&(i={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({keyboard:[[{text:"Мониторинг"},{text:"Уведомление"}],[{text:"Круг"}],[{text:"Главное меню"}]],resize_keyboard:!0})},_("Выберите:",i)),"Мониторинг"===e.text&&(i={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Старт",callback_data:"monitoring start"},{text:"Стоп",callback_data:"monitoring stop"}]]})},m=ge.status?"Работает.":"Остановлен.",s=["Включает мониторинг возможных торговых пар. Уведомление раз в 5 минут.","Текущие состояние: "+m],_(s.join("\n"),i)),"Уведомление"===e.text&&(i={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Старт",callback_data:"notification start"},{text:"Стоп",callback_data:"notification stop"}]]})},m=me.status?"Работает.":"Остановлен.",s=["Включает уведомления о скачках курса.","Текущие состояние: "+m],_(s.join("\n"),i)),"Круг"===e.text&&et(),"Тип"===e.text&&(i={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Only buy",callback_data:"type buy"},{text:"Only sell",callback_data:"type sell"},{text:"Buy & Sell",callback_data:"type all"}]]})},s=["Текущий тип торговли "+re.toUpperCase(),"Новый тип:"],_(s.join("\n"),i)),"Сменить пару"===e.text){if("btc-e"!==t.exchange)return void _("Этот пункт не доступен для данной биржи");i={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"BTC/USD",callback_data:"trade btc_usd"},{text:"BTC/RUR",callback_data:"trade btc_rur"},{text:"BTC/EUR",callback_data:"trade btc_eur"}],[{text:"LTC/BTC",callback_data:"trade ltc_btc"},{text:"LTC/USD",callback_data:"trade ltc_usd"},{text:"LTC/RUR",callback_data:"trade ltc_rur"}],[{text:"LTC/EUR",callback_data:"trade ltc_eur"},{text:"NMC/BTC",callback_data:"trade nmc_btc"},{text:"NMC/USD",callback_data:"trade nmc_usd"}],[{text:"NVC/BTC",callback_data:"trade nvc_btc"},{text:"NVC/USD",callback_data:"trade nvc_usd"},{text:"PPC/BTC",callback_data:"trade ppc_btc"}],[{text:"PPC/USD",callback_data:"trade ppc_usd"},{text:"DSH/BTC",callback_data:"trade dsh_btc"},{text:"DSH/USD",callback_data:"trade dsh_usd"}],[{text:"ETH/BTC",callback_data:"trade eth_btc"},{text:"ETH/USD",callback_data:"trade eth_usd"},{text:"ETH/EUR",callback_data:"trade eth_eur"}],[{text:"ETH/LTC",callback_data:"trade eth_ltc"},{text:"ETH/RUR",callback_data:"trade eth_rur"},{text:"USD/RUR",callback_data:"trade usd_rur"}],[{text:"EUR/USD",callback_data:"trade eur_usd"},{text:"EUR/RUR",callback_data:"trade eur_rur"}]]})},s=["Текущая пара "+g(),"Внимание! На новой паре должны быть средства для торгов, иначе переключение завершится ошибкой!","Новая торгая пара:"],_(s.join("\n"),i)}return"Авто выход из пары"===e.text&&(t.oneOrdersSell?(t.oneOrdersSellPercent=0,be=!0,s="Авто выход включен!"):s="На текущей стратегии данная функция недоступна",_(s)),"Скорость"===e.text&&(i={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Normal",callback_data:"speed normal"},{text:"Extra",callback_data:"speed extra"}]]})},s=["Влияет на плотность стека ордеров, размер спреда и время закрытия неиспользованных ордеров","Время действия "+xe(N)+".","Текущая скорость: "+le].join("\n"),_(s,i)),"Состояние"===e.text&&(i={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Пауза",callback_data:"worker pause"},{text:"Продолжить",callback_data:"worker continued"}]]})},m=I?"Пауза":"Работает",_("Текущие состояние: "+m,i)),"Модули"===e.text&&(i={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Динам. время обновления "+(t.dynamicSettingsTime?"[Вкл]":"[Выкл]"),callback_data:"modules dynamic-settings-time"}],[{text:"Динам. распределение ордеров "+(t.dynamicOffsetOrders?"[Вкл]":"[Выкл]"),callback_data:"modules dynamic-offset-orders"}],[{text:"Определение тренда "+(t.trendDefinition?"[Вкл]":"[Выкл]"),callback_data:"modules trend-definition"}],[{text:"Контроль смены тренда "+(t.abruptChangeTrend?"[Вкл]":"[Выкл]"),callback_data:"modules abrupt-change-trend"}],[{text:"Стоп при большом изменении цены "+(t.dangerPriceStop?"[Вкл]":"[Выкл]"),callback_data:"modules danger-price-stop"}],[{text:"Включить все",callback_data:"modules all-modules-on"},{text:"Выключить все",callback_data:"modules all-modules-off"}],[{text:"Полосы Боллинджера "+(t.bbands?"[Вкл]":"[Выкл]"),callback_data:"modules bbands"}],[{text:"One Sell a lot Buy "+(t.oneOrdersSell?"[Вкл]":"[Выкл]"),callback_data:"modules one-orders-sell"}],[{text:"Лог "+(t.botLog?"[Вкл]":"[Выкл]"),callback_data:"modules bot-log"},{text:"Дебаг лог "+(t.botLog?"[Вкл]":"[Выкл]"),callback_data:"modules log-debug"}]]})},_("*Модули обновления настроек:*",i)),"/help"===(null!=(d=e.text)?d.toLowerCase():void 0)&&(s=["Бот на паре: "+g(),"Exchange: "+t.exchange.toUpperCase(),"TIME_UPDATE_AUTO_SETTINGS="+N+" | время обновления авто настроек параметров (в мин)","OFFSET_ORDERS_POINTS="+t.offsetOrdersPoints+" | отступ для ордеров в пунктах","OFFSET_ORDERS_PERCENT="+t.offsetOrdersPercent+" | отступ для ордеров в процентах","OFFSET_FIRST_ORDERS_PERCENT="+t.offsetFirstOrdersPercent+" | отступ первого ордера в процентах","STEP_BREAKEVEN_PERCENT="+t.stepBreakevenPercent+" | процент отступа безубытка для торгов","TIME_CLOSE_ORDERS="+t.timeCloseOrders+" | сколько минут ждать перед закрытием неисполнившихся ордеров","COUNT_ORDERS="+t.countOrders+" | количество ордеров (бот будет переазгружен)","QUANTITY_ORDERS_IN_BLOCKS="+t.quantityOrdersInBlocks+" | количество ордеров в блоке","DEPOSIT_LIMIT="+t.depositLimit+" | процент использования депозита (бот будет перезагружен)","ONE_ORDERS_SELL_PERCENT="+t.oneOrdersSellPercent+" | Насколько увеличить среднюю цену продажи в процентах","ONE_ORDERS_SELL_OFFSET="+t.oneOrdersSellOffset+" | Разница между ценой LastPrice и первым ордером buy в стеке ордеров в процентах"],_(s.join("\n\n"))),/(\D+)=(\d+)/.test(e.text)&&function(){var r,n,a;r=e.text.split("="),r[0]=r[0].toUpperCase(),"OFFSET_ORDERS_POINTS"!==(n=r[0])&&"TIME_UPDATE_AUTO_SETTINGS"!==n&&"OFFSET_ORDERS_PERCENT"!==n&&"OFFSET_FIRST_ORDERS_PERCENT"!==n&&"TIME_CLOSE_ORDERS"!==n&&"STEP_BREAKEVEN_PERCENT"!==n&&"DEPOSIT_LIMIT"!==n&&"COUNT_ORDERS"!==n&&"QUANTITY_ORDERS_IN_BLOCKS"!==n&&"ONE_ORDERS_SELL_PERCENT"!==n&&"ONE_ORDERS_SELL_OFFSET"!==n||(a=l.camelCase(r[0]),t[a]=+r[1],console.log("SET "+r[0]+"="+r[1]),_("Настройки обновлены!"),"DEPOSIT_LIMIT"!==(n=r[0])&&"COUNT_ORDERS"!==n||(I=!0,ze(t.tradeCurrency.pair,function(e){I=!1,_("Бот перезапущен!")})))}(),"/info"===(null!=(y=e.text)?y.toLowerCase():void 0)?function(){var e,r,n,l,o,i;return e="poloniex"===t.exchange?qe(te.balance,"name"):qe(te.balanceTwo,"nameTwo"),r=Q,n=!0,l=0,o=0,i=0,a.doWhilst(function(a){var c;return t.offsetFirstOrdersPercent&&n?(r-=U.first,n=!1):r-=tt,l=e/r,t.sizeOrdersMartingale&&(o=o?1===t.martingaleType?he(o,t.sizeOrdersMartingale):o+K:j),c=l>o?o:l,e=(l-c)*r,i++,a(null)},function(){return l>j},function(){var t,n;return t=Ce(we(Q,r)-100,2),n=["Данные расчета Мартингейла"],1===i&&e<0?n.push("Недостаточно средств!"):(n.push(["Количество ордеров: "+i,"Последняя цена: "+Ce(r,oe),"*Разница между LastPrice и последним ордером: "+t+"%*"].join("\n")),0<t&&t<2&&n.push("Юный друг при таких настройках тебе хватит депо на "+t+"% хода цены вниз!!! очнись бля")),_(n.join("\n\n"),{parse_mode:"markdown"})})}():void 0}}),b.on("callback_query",function(e){e.from.id===t.myChatId&&(/trade (\w*_(usd|rur|eur|btc|ltc))/.test(e.data)?Je(e.data.substr(6)):/speed (normal|extra)/.test(e.data)?Ve(e.data.substr(6)):/worker (continued|pause)/.test(e.data)?Ke(e.data.substr(7)):/monitoring (start|stop)/.test(e.data)?Qe(e.data.substr(11)):/notification (start|stop)/.test(e.data)?Xe(e.data.substr(13)):/type (buy|sell|all)/.test(e.data)?Ge(e.data.substr(5)):/modules (\w*)/.test(e.data)?Ye(e.data.substr(8)):/close_orders_now/.test(e.data)?He():We(e.data))}),He=function(){_("Начато закрытие ордеров..."),I=!0,L.all=1,setTimeout(function(){ft(t.tradeCurrency.pair,function(e){var t,r;null!=e?0===e.success&&(t=null!=(r=e.error)?r.split("send:")[1]:void 0,null!=t?(p.setNonce(t),He()):_(x(e))):_("Активные ордера закрыты на паре: "+g()),I=!1})},o("2s"))},Je=function(e){var r,n;_("Инициализировано изменение пары..."),I=!0,r=e.split("_")[0],n=e.split("_")[1],t.tradeCurrency.name===r&&t.tradeCurrency.nameTwo!==n?L.sell=1:t.tradeCurrency.name!==r&&t.tradeCurrency.nameTwo===n&&(L.buy=1),setTimeout(function(){ft(t.tradeCurrency.pair,function(){t.tradeCurrency={name:r,nameTwo:n,pair:[r,n].join("_")},P=!0,st(t.tradeCurrency.pair,function(e){var t,r;null!=e?(t=x(e),console.log(("["+T()+"]: Ошибка получения данных с сервера!\n"+t).red),r=["Critical error: Ошибка получения данных с сервера!","Бот поставлен на паузу, после обновления баланса необходимо перезапустить пару!","Ошибка: "+t].join("\n"),_(r),I=!0):(D=0,I=!1,_("Выполнено! Новая пара "+g()))})})},o("5s"))},Ge=function(e){re=e,de="all"!==e,_("Выполнено! Новый тип "+re.toUpperCase())},Ve=function(e){var t;lt(e),t=["Режим "+e.toUpperCase()+" включен.","Пара: "+g()],R=O(),console.log(("\n["+T()+"]: "+t[0]+"\n").green),_(t.join(" "))},Ke=function(e){var t;I="pause"===e,t=I?"Пауза":"Работает",_("Новое состояние: "+t+". Пара: "+g())},Ye=function(e){var r,n;/\all-modules/.test(e)?(r="all-modules-on"===e,t.dynamicSettingsTime=r,t.dynamicOffsetOrders=r,t.trendDefinition=r,t.abruptChangeTrend=r,t.dangerPriceStop=r,t.dynamicSettingsTime||(N=t.timeUpdateAutoSettings),_("Все модули "+(r?"включены":"выключены")+"!")):("one-orders-sell"===e&&(t.bbands=!1),"bbands"===e&&(t.oneOrdersSell=!1),n=e.replace(/\-./g,function(e,t,r){return e.replace("-","").toUpperCase()}),t[n]=!t[n],_(e.replace(/\-/g,"_").toUpperCase()+": "+t[n]))},We=function(e){p.getTicker(e,function(r,n){var a,l,o,i,c,s,u,d,p,b,f;return null!=r?_(x(r)):(a=it.pairs[e].decimal_places,l=n[e].last,o=n[e].sell,i=n[e].buy,c=Ce(n[e].avg,a),s=Ce(i-o,a),u=e.split("_")[1],d=Ie(i,t.stepBreakevenPercent,a),p=s>d?"✔":"✗",b=l>c?"↑":"↓",f=[e.replace("_","/").toUpperCase()+":","sell: "+Oe(u)+o,"buy: "+Oe(u)+i,"last: "+Oe(u)+l,"avg: "+Oe(u)+c+" | "+b,"spread:   "+s+" | "+(s/d*100-100).toFixed()+"%","required: "+d+" "+p],_(f.join("\n")))})},Qe=function(e){var t;ge.status="start"===e,clearInterval(ge.interval),ge.status?(t="Работает",Ze(),ge.interval=setInterval(function(){Ze()},o("5m"))):t="Остановлен",_("Новое состояние: "+t)},Xe=function(e){var t;if(null==_e||!_e.length)return void _("Внимание! Конфиг для уведомлений не задан!");me.status="start"===e,clearInterval(me.interval),me.status?(t="Работает",$e()):t="Остановлен",_("Новое состояние: "+t)},Ze=function(){var e;e=ct.join("-"),a.parallel([function(t){return p.getTicker(e,function(e,r){return null!=e?t(e):t(null,r)})},function(t){return p.getTrades(e,{limit:2},function(e,r){return null!=e?t(e):t(null,r)})}],function(e,r){var n,a,l,c,s,u;if(null!=e)return n=x(e),a="Error trading pairs available: "+n,_(a),void console.log(a.red);l=["Доступные пары для торгов:\n"],c=(new Date).getTime(),s=i.range(c-o("1m"),c),u=0,ct.forEach(function(e){var n,a,o,i,c,d,p,b,f,m,g,y,T;n=e.split("_")[1],a=e.split("_")[0],o=it.pairs[e].decimal_places,i=r[0][e].last,c=r[0][e].sell,d=r[0][e].buy,p=r[0][e].vol,b=r[0][e].vol_cur,f=r[0][e].avg?r[0][e].avg:(c+d)/2,f=Ce(f,o),m=Ce(d-c,o),g=Ie(d,t.stepBreakevenPercent,o),y=i>f?"↑":"↓",T=!r[1][e][0].timestamp||s.contains(1e3*r[1][e][0].timestamp)&&s.contains(1e3*r[1][e][1].timestamp),m>g&&T&&(u++,l.push(e.replace("_","/").toUpperCase()+"\nprice: "+d+" - "+c+"\navg:   "+f+" | "+y+"\nvol_cur: "+b+" "+Oe(a)+"\nvol:        "+p+" "+Oe(n)+"\nspread:   "+Se(m)+" | "+(m/g*100-100).toFixed()+"%\nrequired: "+Se(g)+"\n")),u>=20&&(_(l.join("\n")),u=0,l=[])}),setTimeout(function(){l.length&&_(l.join("\n"))},o("2s"))})},$e=function(){var r,n;null!=_e&&_e.length&&("all_all"===_e[0]&&(_e=ct),r=_e.join("-"),n={},me.interval=setInterval(function(){p.getTicker(r,function(r,a){var l,i,c;return null==r?(c=0,i=[],_e.forEach(function(r){var l,s,u,d,p,b,f,m,g,y,T,O,E;t.tradeCurrency.pair!==r&&e(r,ct)&&(n[r]||(l=it.pairs[r].decimal_places,s=a[r].sell,u=a[r].buy,d=a[r].last,p=a[r].vol,b=a[r].vol_cur,f=a[r].avg?a[r].avg:(s+u)/2,f=Ce(f,l),m=Ce(u-s,l),g=Ie(s,t.notificationDeviation,l),m>g&&(c++,n[r]=!0,y=r.split("_")[1],T=r.split("_")[0],O=d<=s||d<=s+Ne(3,l)?"down ↓":"up ↑",E=d>f?"↑":"↓",i.push(["Уведомление "+r.replace("_","/").toUpperCase()+":","directions: "+O,"sell: "+Oe(y)+s,"buy: "+Oe(y)+u,"last: "+Oe(y)+d,"avg: "+Oe(y)+f+" | "+E,"vol_cur: "+b+" "+Oe(T),"vol: "+p+" "+Oe(y),"spread: "+Se(m)+"\n"].join("\n"))),c>=15&&(_(i.join("\n")),c=0,i=[]),setTimeout(function(){n[r]=!1,n.error=!1},o("15m"))))}),setTimeout(function(){i.length&&_(i.join("\n"))},o("2s"))):(l=x(r),i="Error notification price: "+l,console.log(i.red),n.error?void 0:(_(i),n.error=!0))})},o("5s")))},et=function(t,r){var n,a,l,o;null==t&&(t=.993),null==r&&(r=!1),n={},a={},l={},o={},ct.forEach(function(e){var t;t=e.split(/\s*_\s*/),
n[t[0]]?n[t[0]].push(t[1]):n[t[0]]=[t[1]]}),p.getTicker(ct.join("-"),function(i,c){var s,u,d,p;return null!=i?(s=x(i),_("Error: "+s)):(ct.forEach(function(e){a[e]=Ue(1,c[e].buy)}),ct.forEach(function(e){var t;t=e.split(/\s*_\s*/),n[t[0]].forEach(function(r){r!==t[1]&&(l[t[1]+"_"+t[0]+"_"+r]=Be(a[e],c[t[0]+"_"+r].sell))})}),Object.keys(l).forEach(function(r){var n,a;n=r.split(/\s*_\s*/),e(n[0]+"_"+n[2],ct)&&(a=Ue(l[r],c[n[0]+"_"+n[2]].buy)),e(n[2]+"_"+n[0],ct)&&(a=Be(l[r],c[n[2]+"_"+n[0]].buy)),a>t&&(o[r+"_"+n[0]]=Ce(a,5))}),u=["Проверка возможных вариантов перепродаж.","Показаны значения больше: "+t,"Значения меньше 1 убыточны:\n"],d=[],Object.keys(o).forEach(function(e){d.push([e.replace(/\_/g,"->"),o[e]])}),d.length?(p=d.sort(function(e,t){return t[1]-e[1]}),p.forEach(function(e){u.push(e.join(": "))})):u.push("Нет подходящих вариантов"),!r||d.length?_(u.join("\n")):void 0)})},lt=function(e){var r;null!=e&&(r=e),r||(r=D>ue?"extra":"normal"),D=0,"extra"===r?(tt=U.extra,rt=U.extra,at=F,nt=60*t.timeCloseOrdersExtra):(tt=U.buy,rt=U.sell,at=B,nt=60*t.timeCloseOrders),le=r},ot=0,st=function(e,t){return p.getInfo(function(r,n){if(null!=r)return t(r);try{it=n,ct=Object.keys(n.pairs),oe=n.pairs[e].decimal_places,se=n.pairs[e].min_amount,ie=n.pairs[e].min_price,ce=n.pairs[e].fee}catch(e){t("Not valid pair")}return ze(e,function(r){var n,a;return r?(n=null!=(a=r.error)?a.split("send:")[1]:void 0,null!=n?(p.setNonce(n),st(e,t)):(ot++,ot>5?(ot=0,t(r)):st(e,t))):t(null)})})},ut=function(e,t){return p.getTicker(e,function(r,n){var a,l,o,i;return null!=r?t(r):(a=n[e].last,l=n[e].sell,o=n[e].buy,i=Ce(o-l,oe),Y=at<=Ne(2)?i>=at:i>at,t(null,{lastPrice:a,bidPrice:l,askPrice:o,spread:i}))})},dt=function(e,r){return Y?p.balanceRequest(e,function(e,n,a){return null!=e?r(e):(n=qe(n,"name"),a=qe(a,"nameTwo"),"all"===re?n<se&&a<se?W<t.ecoCountCycle&&W++:W>0&&(W=0):W=t.ecoCountCycle,r(null,{balance:n,balanceTwo:a}))}):r(null)},pt=function(e,r,n,o,i){var c;return c="poloniex"===t.exchange?r*n<t.poloniexMinOrders:r<se,c?i(null):0===l.size(z)?i(null):pe?i(null):a.series([function(e){return L.sell=1,ft(o,e)},function(e){var n,a,o,i,c,s,u,d,p;return n=[],a=l.keys(J),o=l.keys(z),i=l.difference(o,a),t.logDebug&&n.push(["Открытые ордера: "+a,"В кэше: "+o,"Купленные: difference"].join("\n")),c=0,s=0,u=0,i.forEach(function(e){u++,c+=+z[e].amount,s+=+z[e].amount*+z[e].rate,t.logDebug&&n.push("Ордер: "+e+"  Количество: "+ +z[e].amount+"  Цена: "+ +z[e].rate)}),u>0?(H.priceBuy=s/c,t.logDebug&&n.push(["Сумма: "+s+"  Общий объем: "+c,"Средняя цена покупки: "+H.priceBuy].join("\n")),d=he(s,2.5*ce+t.oneOrdersSellPercent)/c,t.logDebug&&n.push(["Коммисия: "+ce+"  Процент юзера: "+t.oneOrdersSellPercent+"   Общий процент: "+(2*ce+t.oneOrdersSellPercent),"Увеличенная сумма на процент: "+he(s,2*ce+t.oneOrdersSellPercent),"Цена продажи: "+d].join("\n")),p=l.findKey(J,["type","sell"]),t.logDebug&&n.push(["Сумма с баланса биржи: "+r,p?"Сумма на открытом ордере SELL: "+J[p].amount:void 0].join("\n")),p&&(r+=J[p].amount),t.logDebug&&(n.push("Общая сумма продажи: "+r),console.log(n.join("\n"))),H.amount=r,e(null,{rate:d})):e(null,{rate:0})}],function(t,n){return null!=t?i(t):n[1].rate>0?_t(e,n[1].rate,r,o,i):i(null)})},bt=function(e,r,n,o,i){var c,s,u,d;if(r<se)return i(null);if(pe)return i(null);if(t.quantityOrdersInBlocks){if(t.quantityOrdersInBlocks<=V)return i(null);c=!0}return s=!0,q={buy:-1,sell:-1},"all"===re||re===e?r>=j?(void 0!==u&&null!==u||(u=n),a.doWhilst(function(a){var i,d;return ne?("sell"===e&&(u-=rt),"buy"===e&&(u+=tt),r/=2,_t(e,u,r,o,a)):("buy"===e?((k||c)&&(k=!1,c=!1,l.isEmpty(J)||(s=!1,"object"==typeof(i=ve(J,"min"))&&i.rate<n&&(u=i.rate))),t.offsetFirstOrdersPercent&&s?(u-=U.first,s=!1):u-=tt,r=-1===q.buy?r:q.buy/u):(t.offsetFirstOrdersPercent&&s?(u+=U.first,s=!1):u+=rt,r=-1===q.sell?r:q.sell),t.sizeOrdersMartingale?(A[e]?A[e]=1===t.martingaleType?he(A[e],t.sizeOrdersMartingale):A[e]+K:A[e]=j,M[e]&&(A[e]=M[e],M[e]=0),d=r>A[e]?A[e]:r):d=r>j?j:r,_t(e,u,d,o,a))},function(){return!(t.quantityOrdersInBlocks&&t.quantityOrdersInBlocks<=V)&&r>j},function(e){return i(null!=e?e:null)})):(t.oneOrdersSell&&"buy"===e&&"object"==typeof(d=ve(J,"min"))&&d.rate<n&&(n=d.rate),t.offsetOrdersPercent&&("sell"===e&&(n+=rt),"buy"===e&&(n-=tt)),t.dynamicOffsetOrders&&("sell"===e&&(n+=Ne(1)),"buy"===e&&(n-=Ne(1))),_t(e,n,r,o,i)):i(null)},_t=function(e,r,n,a,o){var i;return r=Ce(r,oe),r>=ie||(r=ie),n=Ce(n-1e-7,8),i="poloniex"===t.exchange?n*r<t.poloniexMinOrders:n<se,i?o(null):p.tradeSetOrder(a,e,r,n,function(a,i){var c,s,u;return null!=a?(t.sizeOrdersMartingale&&(M[e]=A[e]),k=!0,c=x(a),console.log(("["+T()+"]: Error: "+c+" | "+e+" | rate: "+r+" | amount: "+n).red),o(a)):(s="["+T()+"]: Open: "+e+" | rate: "+r+" | amount: "+n,t.oneOrdersSell&&(u=0==i.order_id?l.random(1e8,2e8).toString():i.order_id,"buy"===e?(z[u]={rate:r,amount:n},t.quantityOrdersInBlocks&&V++):H.id=u),"buy"===e?q.buy="poloniex"===t.exchange?qe(i.funds[t.tradeCurrency.name],"name"):qe(i.funds[t.tradeCurrency.nameTwo],"nameTwo"):q.sell="poloniex"===t.exchange?qe(i.funds[t.tradeCurrency.nameTwo],"nameTwo"):qe(i.funds[t.tradeCurrency.name],"name"),console.log("buy"===e?s.green:s.yellow),D++,o(null))})},ft=function(e,t){return p.ordersRequest(e,function(e,r){var n,l,o;return h=O(),null!=e?0===e.success&&null==(null!=(n=e.error)?n.split("send:")[1]:void 0)?(l=x(e),console.log(("["+T()+"] Cancel orders: "+l).yellow),t(null)):t(e):(o=Object.keys(r),a.eachSeries(o,function(e,t){return null!=L.buy&&"sell"===r[e].type?t(null):null!=L.sell&&"buy"===r[e].type?t(null):h-r[e].timestamp_created>(L.buy||L.sell||L.all||60)?mt(e,r[e].type,r[e].amount,r[e].rate,t):t(null)},function(e){return L={all:null,buy:null,sell:null},t(null!=e?e:null)}))})},mt=function(e,r,n,a,l){return p.tradeCancelOrder({order_id:e},function(o,i){return null!=o?l(o):(t.oneOrdersSell&&delete z[e],console.log(("["+T()+"]: Close: "+r+" | rate: "+a+" | amount: "+n).cyan),D>0&&D--,l(null))})},gt=function(){de||Ee(h,t.timeCloseOrdersInactivity)&&ft(t.tradeCurrency.pair,function(e){null!=e&&console.log("["+T()+"]: Orders inactivity: "+x(e))})},yt=function(){var e;Ee(w,10)&&(e="Unknown error: Worker does not meet!",console.log(("["+T()+"]: "+e).red),Ot({error:e}))},Tt=function(){w=O(),I?setTimeout(function(){Tt()},o("30s")):a.series([function(e){return ut(t.tradeCurrency.pair,e)},function(e){return dt(t.tradeCurrency,e)}],function(e,r){var n;null!=e?(n=x(e),console.log(("Error: "+n).red),Ot(e)):(P&&(Me(r[0].askPrice,r[0].bidPrice,r[0].lastPrice),P=!1),Y?a.series([function(e){return N>0&&w-R>60*N&&Me(r[0].askPrice,r[0].bidPrice,r[0].lastPrice),e(null)},function(e){return w-h>nt?ft(t.tradeCurrency.pair,e):e(null)},function(e){return t.oneOrdersSell?p.ordersRequest(t.tradeCurrency.pair,function(r,n){var a;return J=null!=n?n:{},t.quantityOrdersInBlocks&&(V=l.size(J)),a=l.findKey(J,["type","sell"]),a&&Ce(H.amount-1e-7,8)>J[a].amount&&(t.logDebug&&console.log("SELL partially executed"),z=J,z["0000000001"]={rate:H.priceBuy,amount:J[a].amount},delete z[a],A={buy:0,sell:0}),G=!1,!a&&H.id&&(t.logDebug&&console.log("SELL executed!"),L.buy=1,G=!0,H={},z={},h=0,A={buy:0,sell:0},M={buy:0,sell:0},be&&(I=!0,be=!1,ft(t.tradeCurrency.pair,function(){_("Авто выход завершен!\nБот поставлен на паузу!")}))),e(null)}):e(null)},function(e){var n,a;return t.oneOrdersSell&&G?e(null):t.botTrade&&C?(n=ne?ae.ask:r[0].askPrice,a="poloniex"===t.exchange?r[1].balanceTwo:r[1].balance,t.oneOrdersSell?pt("sell",a,n,t.tradeCurrency.pair,e):(A.sell=0,bt("sell",a,n,t.tradeCurrency.pair,e))):e(null)},function(e){var n,a;return t.oneOrdersSell&&G?e(null):t.botTrade&&C?(n=ne?ae.bid:r[0].bidPrice,a="poloniex"===t.exchange?r[1].balance/n:r[1].balanceTwo/n,t.oneOrdersSell?k||V||(A.buy=0):A.buy=0,bt("buy",a,n,t.tradeCurrency.pair,e)):e(null)}],function(e){var r;null!=e?(r=x(e),console.log(("ErrorTrader: "+r).red),Ot(e)):W===t.ecoCountCycle?setTimeout(function(){Tt()},o("2s")):Tt()}):setTimeout(function(){Tt()},o("5s")))})},Ot=function(e){var r,n,a,l;r="restart after "+parseInt(t.restartTraderTime)+" sec ...",console.log("["+T()+"]: "+r),n=null!=(a=e.error)?a.split("send:")[1]:void 0,null==n&&(l=x(e),S.count++,S.text!==l&&(S.text=l,t.emailS&&"production"===process.env.NODE_ENV&&m(y(l+"\n\n"+r),function(e,t){})),t.notificationErrorCount&&S.count>t.notificationErrorCount&&(_("*Слишком много ошибок API. Требуется внимание пользователя!*",{parse_mode:"markdown"}),S.count=0)),setTimeout(function(){console.log(("["+T()+"]: trader restart").bgGreen),null!=n&&p.setNonce(n),Tt()},o(parseInt(t.restartTraderTime)+"s"))},function(){if(!t.myChatId)return void console.log("Get the user id in the Telegram");console.log("["+T()+"]: Trader Bot starting..."),console.log("["+T()+"]: Exchange: "+t.exchange.toUpperCase()+" | v."+t.versionBot),st(t.tradeCurrency.pair,function(e){var r;return null!=e&&(r=x(e),console.log(("["+T()+"]: Error getting parameters from the server!\n"+r).red),process.exit(0)),Tt(),t.botTrade&&setInterval(function(){gt(),yt(),S.count=0},o("5m")),setInterval(function(){Fe()},o(10*t.bbandsInterval+"s")),"production"===process.env.NODE_ENV&&_("Trader Bot started. Pair "+g()),console.log("["+T()+"]: Trader Bot started")})}()}).call(this);