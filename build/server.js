(function(){function e(e,t){for(var r=-1,n=t.length>>>0;++r<n;)if(e===t[r])return!0;return!1}var t,r,n,a,o,l,c,i,s,u,d,p,b,_,m,f,g,y,T,x,C,k,v,E,O,w,S,h,R,N,P,U,I,D,L,B,j,A,M,F,q,H,J,V,G,W,z,K,X,Y,Z,$,Q,ee,te,re,ne,ae,oe,le,ce,ie,se,ue,de,pe,be,_e,me,fe,ge,ye,Te,xe,Ce,ke,ve,Ee,Oe,we,Se,he,Re,Ne,Pe,Ue,Ie,De,Le,Be,je,Ae,Me,Fe,qe,He,Je,Ve,Ge,We,ze,Ke,Xe,Ye,Ze,$e,Qe,et,tt,rt,nt,at;if(t=require("./conf"),r=require("./api-btc-e"),n=require("./api-poloniex"),a=require("async"),o=require("lodash"),require("colors"),l=require("ms"),c=require("moment"),i=require("moment-range"),s=require("nodemailer"),u=require("node-telegram-bot-api"),d=require("ta-lib"),c=i.extendMoment(c),!t.tokenTelegram)return void console.log("There is no token Telegram!".red);p="poloniex"===t.exchange?new n:new r,b=new u(t.tokenTelegram,{polling:!0}),_=function(e,r){e.length>4096&&(e="Слишком много информации для отображения"),e.length||(e="Error: Не удалось обработать ошибку"),b.sendMessage(t.myChatId,e,r)},m=s.createTransport(t.email),f=function(e,t){return m.sendMail(e,t)},g=function(){return t.tradeCurrency.pair.replace("_","/").toUpperCase()},y=function(e){return{from:t.email.auth.user,to:t.email.reportEmail,subject:"Error Script Trader",text:"time: "+(new Date).toString()+"\nPair: "+g()+"\n\nmessage: "+e+"\n\n---"}},T=function(){return(new Date).toLocaleTimeString("en-US",{timeZone:t.timeZone,hour12:!1})},x=function(){return Math.round((new Date).getTime()/1e3)},C=function(e){var t;return t="",Object.keys(e).forEach(function(r){if(e.hasOwnProperty(r))return t+=r+" :: "+e[r]+"\n"}),t},k=function(e){return"object"==typeof e?e.hasOwnProperty("error")?e.error:e.hasOwnProperty("message")?e.message:C(e):e},v=!0,E=null,O={name:0,nameTwo:0},w=x(),S=x(),h=x(),R=t.timeUpdateAutoSettings,N=!0,P=!1,U=0,I={all:null,buy:null,sell:null},D={extra:0,buy:0,sell:0},L=0,B=0,j=0,A={buy:0,sell:0},M=!1,F=0,q=0,H=0,J=0,V=[],G=[],W="all",z=!1,K={ask:0,bid:0},X="normal",Y=0,Z=0,$=0,Q=0,ee=0,te=!1,re=!1,ne=null!=(ae=t.notificationPair)?ae.toLowerCase().replace(/\//g,"_").split(/\s*,\s*/):void 0,oe={spread:!1,eco:!1,settings:!1},le={status:!1,interval:!1},ce={status:!1,interval:!1},ie={btc:"฿",usd:"$",eur:"€",rur:"₽",ltc:"L"},se="-----------------------------------",ue=function(e){return ie.hasOwnProperty(e)?ie[e]:e+" "},de=function(e,t){return x()-e>=60*t},pe=function(e,t){var r,n,a;return null!=t&&(r=t),r||(r=e>=1?["минута","минуты","минут"]:["секунда","секунды","секунд"],e=e<1?60*e:e),n=[2,0,1,1,1,2],a=r[e%100>4&&e%100<20?2:n[e%10<5?e%10:5]],e+" "+a},be=function(e,t){return null==t&&(t=3),+(+e).toFixed(t)},_e=function(e){return e.toFixed(10).replace(/(.*0\.0*[1-9]*)0+\d*/g,"$1")},me=function(e,t){return t>0?+(100*e/t).toFixed(1):0},fe=function(e,t){return null==t&&(t=Y),be(e/+("1e"+t),t)},ge=function(e,t){return null==t&&(t=Y),be(e*+("1e"+t),t)},ye=function(e,t,r){var n,a,o;return null==t&&(t=0),null==r&&(r=Y),n=e/100*$*2,a=Math.ceil(n*+("1e"+r))/+("1e"+r),o=a*(1+t/100),be(o,r)},Te=function(e,t){return be(e/100*(100+t),Y)},xe=function(e,t){return be(100*e/(100+t),Y)},Ce=function(e,t){return e/t*(1-$/100)},ke=function(e,t){return e*t*(1-$/100)},ve=function(){t.bbands&&J>0&&(G.push(J),G.length>30&&G.splice(0,1))},Ee=function(e,t){var r;return null==t&&(t=.1),r=e/100*t,1/+("1e"+Y),be(r,Y)},Oe=function(e,t){var r,n,a;null==t&&(t=1),r=e.toString().split(".")[0];try{n=e.toString().split(".")[1].length}catch(e){e,n=1}return a=r>0?r>1e4?+("1e"+(n+1)):r>1e3?+("1e"+n):r>100?+("1e"+(n-1)):r>10?+("1e"+(n-2)):n>3?+("1e"+(n-3)):1:1,t*=a,be(t/+("1e"+n),n)},we=function(e,r,n){var a,l,c,i,s,u,p,b,m,f,y,C,k,E,O,w,j,A,M,F,ne,ae,oe,le,ce,ie,ue,de,pe,fe,Ce,ke,ve,we,Se;if(h=x(),I={buy:null,sell:null},a=e.toString().length,l=r.toString().length,i={},i[a+""]=e,i[l+""]=r,c=i,s=Math.max(a,l),u=c[s],Y=We.pairs[t.tradeCurrency.pair].decimal_places,Q=We.pairs[t.tradeCurrency.pair].min_amount,Z=We.pairs[t.tradeCurrency.pair].min_price,$=We.pairs[t.tradeCurrency.pair].fee,p=be(e-r,Y),b=ye(u,200),t.dynamicSettingsTime&&(V.push(n),V.length>50&&V.splice(0,1),m=o.max(V),f=o.min(V),t.botLog&&console.log([se,"price-array:","length: "+V.length,"max: "+m,"min: "+f,"change-time-settings: "+(me(m,f)>102)].join("\n")),me(m,f)>102?R=.1:R!==t.timeUpdateAutoSettings&&(R=t.timeUpdateAutoSettings)),t.abruptChangeTrend&&(y=ye(u,500)),t.dangerPriceStop&&(C=Te(H,9),k=xe(q,9)),t.dynamicOffsetOrders&&(E={current:ye(u,450),prev:ye(u,380),prev_2:ye(u,300)},O=p>=E.current||p>=E.prev||p>=E.prev_2),t.dynamicOffsetOrders&&O?(console.log("["+T()+"]: Dynamic market"),w=t.offsetOrdersPercent?Ee(u,t.offsetOrdersPercent):Oe(u,ge(E.current)),j=1.5*t.stepBreakevenPercent):(w=t.offsetOrdersPercent?Ee(u,t.offsetOrdersPercent):Oe(u,t.offsetOrdersPoints),j=t.stepBreakevenPercent),A=1.3*w,M=t.offsetOrdersPercent?Ee(u):2,L=ye(u,j),t.botLog&&(console.log(se),console.log("current-spread:",(_e(p)+"")[p>L?"green":"white"]),console.log("spread-min-default:",_e(L)),console.log("trend-spread:",_e(b)),t.abruptChangeTrend&&console.log("immediate-spread:",y),console.log("trader-speed:",X),console.log("price-prev:",H+" - "+q),console.log("price-prev2:",K.ask+" - "+K.bid),t.dangerPriceStop&&(console.log("danger-price-ask:",C,!N&&e>=C?"Attention!".red:""),console.log("danger-price-bid:",k,!N&&r<=k?"Attention!".red:"")),t.dynamicOffsetOrders&&(console.log("spread_1_450:",E.current,p>=E.current?"Attention!".red:""),console.log("spread_2_380:",E.prev,p>=E.prev?"Attention!".red:""),console.log("spread_3_300:",E.prev_2,p>=E.prev_2?"Attention!".red:""),console.log("dynamic-market:",O))),t.dangerPriceStop&&!N&&(e>=C||r<=k))return e>=C&&(I.buy=1),S=0,P=!0,F="DANGER PRICE: "+e+" - "+r+" | Bot Pause!",console.log("["+T()+"]: "+F),void _(F+"");ne=M,ae=U>Math.round(ee/2)?A:w,t.botLog&&(console.log("offset-max-one:",(_e(w)+"")[w===t.offsetOrdersPoints?"green":"yellow"]),console.log("offset-type-max:",_e(ae)),console.log(se)),te||(W="all",z=!1),N?oe=le=ae:t.bbands?(oe=le=ae,L=0,R=.1,ce=14,G.length>2*ce&&(i=d.BBANDS(G,20,t.bbandsDeviation),ie=i.middleband,ue=i.lowband,de=i.highband,pe=d.RSI(o.clone(G).reverse(),ce),fe=d.average(pe).mean,Ce=d.average(ie).mean,ke=d.average(de).mean,ve=d.average(ue).mean,we=ke>n&&n>Ce,Se=Ce>n&&n>ve,we&&(W="sell"),Se&&(W="buy"),v=99>fe&&fe>68||1<fe&&fe<33,re=we&&Se,t.botLog&&console.log(["BBANDS:","highband: "+ke,"middleband: "+Ce,"lowband: "+ve,"rsa: "+fe,"sell: "+we,"buy: "+Se,"bot trade: "+v,"orders-calculation-brake: "+re,se].join("\n")))):t.trendDefinition&&r>q&&e>H&&p>b&&"normal"===X?(console.log("["+T()+"]: Trend: UP"),oe=ne,le=ae,te||(W="buy",I.sell=1,S=0,t.abruptChangeTrend&&p>y&&(console.log("["+T()+"]: Spread Immediate"),z=!0,h=0))):t.trendDefinition&&r<q&&e<H&&p>b&&"normal"===X?(console.log("["+T()+"]: Trend: DOWN"),oe=ae,le=ne,te||(W="sell",I.buy=1,S=0,t.abruptChangeTrend&&p>y&&(console.log("["+T()+"]: Spread Immediate"),z=!0,h=0))):oe=le=ae,K={ask:H,bid:q},q=r,H=e,J=n,B=ye(u),D={buy:oe,sell:le,extra:Oe(u)},Ve(),console.log("["+T()+"]: Update: "+W.toUpperCase()+" | "+e+" - "+r+" | "+n+" | "+g())},Se=function(e,t){var r,n;return r="name"===t?O.name:O.nameTwo,n=be(e-r,8),n>0?n:0},he=function(e,r){return a.parallel([function(r){return t.botLog&&console.log(se+"\nПолучение цен"),p.getTicker(e,function(n,a){return null!=n?(t.botLog&&(console.log("Price: "+a[e].buy),console.log(k(n))),r(n)):r(null,{price:a[e].buy})})},function(r){return a.series([function(r){return t.botLog&&console.log(se+"\nЗакрытие всех позиций"),I.all=1,Qe(e,function(e){return r(null!=e?e:null)})},function(e){return t.botLog&&console.log(se+"\nПолучение баланса"),p.balanceRequest(t.tradeCurrency,function(r,n,a){return null!=r?(t.botLog&&(console.log("balance: "+n+" | balance-two: "+a),console.log(k(r))),e(r)):t.botTrade&&n<("btc"===t.tradeCurrency.name.toLowerCase()?.01:.1)&&a<("btc"===t.tradeCurrency.nameTwo.toLowerCase()?.01:.1)?(t.botLog&&console.log("balance: "+n+" | balance-two: "+a),e({error:"Err: No money!"})):e(null,{balance:n,balanceTwo:a})})}],function(e,t){return null!=e?r(e):r(null,{balance:t[1].balance,balanceTwo:t[1].balanceTwo})})}],function(e,n){var a,o,l,c,i,s,u,d,p,b,_,m;return null!=e?r(e):(t.botLog&&console.log(se+"\nРасчет депозита"),a=0<(o=t.depositLimit)&&o<100?t.depositLimit:100,"poloniex"===t.exchange?(l=n[1].balanceTwo*n[0].price+n[1].balance,c=n[1].balance/n[0].price+n[1].balanceTwo):(l=n[1].balanceTwo/n[0].price+n[1].balance,c=n[1].balance*n[0].price+n[1].balanceTwo),i=l*a/100,s=c*a/100,100===a?(t.botLog&&console.log("type:",0),u=0,d=0):n[1].balance>=i&&n[1].balanceTwo>=s?(t.botLog&&console.log("type:",1),u=n[1].balance-i/2,d=n[1].balanceTwo-s/2):n[1].balance>=i&&n[1].balanceTwo<s?(t.botLog&&console.log("type:",2),u="poloniex"===t.exchange?n[1].balance-(s-n[1].balanceTwo)*n[0].price:n[1].balance-(s-n[1].balanceTwo)/n[0].price,d=0):n[1].balance<i&&n[1].balanceTwo>=s?(t.botLog&&console.log("type:",3),u=0,d="poloniex"===t.exchange?n[1].balanceTwo-(i-n[1].balance)/n[0].price:n[1].balanceTwo-(i-n[1].balance)*n[0].price):n[1].balance<i&&n[1].balanceTwo<s&&(t.botLog&&console.log("type:",4),"poloniex"===t.exchange?(u=n[1].balance-(s-n[1].balanceTwo)*n[0].price,d=n[1].balanceTwo-(i-n[1].balance)/n[0].price):(u=n[1].balance-(s-n[1].balanceTwo)/n[0].price,d=n[1].balanceTwo-(i-n[1].balance)*n[0].price)),t.botLog&&(p=me(u,n[1].balance),b=me(d,n[1].balanceTwo),console.log(["reserved-deposit:",t.tradeCurrency.name.toUpperCase(),p+"% / "+b+"%",t.tradeCurrency.nameTwo.toUpperCase()].join(" "))),O={name:u>0?u:0,nameTwo:d>0?d:0},_="poloniex"===t.exchange?s:i,t.countOrders?t.countOrders>=3||(t.countOrders=3):t.countOrders=_<=10?6:_<=200?15:_<=500?18:_<=1e3?21:25,m="poloniex"===t.exchange?t.poloniexMinOrders/n[0].price:Q,ee=t.countOrders*t.multiplierOrdersExtra,j=be((o=_/t.countOrders)>m?o:m,Y),t.botLog&&console.log([se+"\nРасчет переменных","balance: "+be(n[1].balance)+" "+t.tradeCurrency.name.toUpperCase(),"balance-two: "+be(n[1].balanceTwo)+" "+ue(t.tradeCurrency.nameTwo),"deposit: "+l+" "+t.tradeCurrency.name.toUpperCase()+" или "+c+" "+t.tradeCurrency.nameTwo.toUpperCase(),"percent-deposit: "+t.depositLimit+" %","trade-deposit: "+i+" "+t.tradeCurrency.name.toUpperCase()+" | "+s+" "+t.tradeCurrency.nameTwo.toUpperCase(),"reserved-deposit: "+be(O.name)+" "+t.tradeCurrency.name.toUpperCase()+" | "+be(O.nameTwo)+" "+t.tradeCurrency.nameTwo.toUpperCase(),"count-orders: "+t.countOrders,"size-static-order: "+j,se].join("\n")),r(null))})},b.on("message",function(e){var r,n,c,i,s,u,d,m,f,y,T;if(r=e.chat.id,t.myChatId||b.sendMessage(r,"Install your Telegram id: "+r),r===t.myChatId&&("Ордера"===e.text&&(n=function(){a.series([function(e){return p.balanceRequest(t.tradeCurrency,function(t,r,n){return null!=t?e(t):e(null,{balance:r,balanceTwo:n})})},function(e){return p.ordersRequest(t.tradeCurrency.pair,function(t,r){return null!=t?e(t):e(null,{data:r})})}],function(e,r){var a,l,c,i,s,u,d,b,m,f,y,T;a=[g()+":",se],l="Balance: "+(null!=(c=r[0])?c.balance.toFixed(3):void 0)+" "+t.tradeCurrency.name.toUpperCase()+" | "+ue(t.tradeCurrency.nameTwo)+(null!=(i=r[0])?i.balanceTwo.toFixed(3):void 0),null!=e?0===e.success?(s=null!=(u=e.error)?u.split("send:")[1]:void 0,null!=s?(p.setNonce(s),n()):(d=k(e),a.push(d+"\n"+se+"\n"+l),_(a.join("\n")))):_(e):(b={},m=0,f=0,y={},Object.keys(r[1].data).forEach(function(e){var n,a,o;n=r[1].data[e].rate*+("1e"+Y),null!=y[n]?(++b[n],a=" | "+b[n],o=be(be(y[n].split("|")[1].trim())+be(r[1].data[e].amount)),y[n]=r[1].data[e].type+" | "+o+" | "+ue(t.tradeCurrency.nameTwo)+r[1].data[e].rate+a):(b[n]=1,y[n]=r[1].data[e].type+" | "+be(r[1].data[e].amount)+" | "+ue(t.tradeCurrency.nameTwo)+r[1].data[e].rate),m+=r[1].data[e].amount,f+=r[1].data[e].amount*r[1].data[e].rate}),a=o.concat(a,o.values(y)),a.push(se+"\nCount: "+be(m)+" | Sum: "+ue(t.tradeCurrency.nameTwo)+be(f)+"\n"+l),T=a.join("\n"),_(T))})})(),"История"===e.text&&(c=function(){p.tradeGetHistory(t.tradeCurrency.pair,10,function(e,r){var n,a,o;return null!=e?0===e.success?(n=null!=(a=e.error)?a.split("send:")[1]:void 0,null!=n?(p.setNonce(n),c()):_(k(e))):_(k(e)):(o=[],Object.keys(r).forEach(function(e){o.push(r[e].type+" | "+r[e].amount.toFixed(3)+" | "+ue(t.tradeCurrency.nameTwo)+r[e].rate)}),o.push(g()+":\n"+se),o.reverse(),_(o.join("\n")))})})(),"Закрыть активные ордера"===e.text&&(i=function(){P=!0,I.all=1,setTimeout(function(){Qe(t.tradeCurrency.pair,function(e){var t,r;null!=e?0===e.success&&(t=null!=(r=e.error)?r.split("send:")[1]:void 0,null!=t?(p.setNonce(t),i()):_(k(e))):_("Активные ордера закрыты на паре: "+g()),P=!1})},l("2s"))})(),"/config"===(null!=(s=e.text)?s.toLowerCase():void 0)&&(u=["Бот на паре "+g(),"TIME_UPDATE_AUTO_SETTINGS: "+R+" | время обновления авто настроек параметров (в мин)","DEPOSIT_LIMIT: "+t.depositLimit+" | процент использования депозита","NOTIFICATION_PAIR: "+t.notificationPair+" | пары для уведомления","NOTIFICATION_DEVIATION_PERCENT: "+t.notificationDeviation+" | процент отклонения от текущей цены чтобы сработало уведомление","COUNT_ORDERS: "+t.countOrders+" | количество ордеров","TIME_CLOSE_ORDERS: "+t.timeCloseOrders+" | сколько минут ждать перед закрытием неисполнившихся ордеров","TIME_CLOSE_ORDERS_INACTIVITY: "+t.timeCloseOrdersInactivity+" | закрытие после бездействия","OFFSET_ORDERS_POINTS: "+t.offsetOrdersPoints+" | отступ ордеров в пунктах","OFFSET_ORDERS_PERCENT: "+t.offsetOrdersPercent+" | отступ для ордеров в процентах","STEP_BREAKEVEN_PERCENT: "+t.stepBreakevenPercent+" | процент отступа безубытка для торгов","DANGER_PRICE_STOP: "+t.dangerPriceStop+" | остановка бота при большом изменении цены","DYNAMIC_SETTINGS_TIME: "+t.dynamicSettingsTime+" | динамическое время обновления настроек","DYNAMIC_OFFSET_ORDERS: "+t.dynamicOffsetOrders+" | динамическое распределение ордеров","TREND_DEFINITION: "+t.trendDefinition+" | определение тренда","ABRUPT_CHANGE_TREND: "+t.abruptChangeTrend+" | быстрое изменение направления тренда","BBANDS: "+t.bbands+" | полосы Боллинджера","BBANDS_DEVIATION: "+t.bbandsDeviation+" | Отклонение","BBANDS_INTERVAL: "+t.bbandsInterval+" | Таймфрейм (в мин)","EXCHANGE: "+t.exchange+" | Выбор биржи btc-e or poloniex","POLONIEX_FEE: "+t.poloniexFee+" | Комиссия на сделки биржи POLONIEX"],_(u.join("\n\n"))),"/version"===(null!=(d=e.text)?d.toLowerCase():void 0)&&_("Версия бота: "+t.versionBot),t.masterWorker)){if("/start"!==(m=null!=(f=e.text)?f.toLowerCase():void 0)&&"главное меню"!==m||(y={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({keyboard:[[{text:"Ордера"},{text:"Котировки"},{text:"История"}],[{text:"Контроль"},{text:"Нотис"},{text:"Торговля"}],[{text:"Закрыть активные ордера"}]],resize_keyboard:!0})},_("Выберите:",y)),"Котировки"===e.text){if("btc-e"!==t.exchange)return void _("Этот пункт не доступен для данной биржи");y={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({keyboard:[[{text:"USD"},{text:"BTC"},{text:"OTHER"}],[{text:"Главное меню"}]],resize_keyboard:!0})},_("Валюта:",y)}if("Торговля"===e.text&&(y={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({keyboard:[[{text:"Сменить пару"},{text:"Тип"}],[{text:"Главное меню"}]],resize_keyboard:!0})},_("Выберите:",y)),"USD"===e.text&&(y={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"NMC",callback_data:"nmc_usd"},{text:"PPC",callback_data:"ppc_usd"},{text:"NVC",callback_data:"nvc_usd"},{text:"LTC",callback_data:"ltc_usd"},{text:"BTC",callback_data:"btc_usd"}],[{text:"DSH",callback_data:"dsh_usd"},{text:"ETH",callback_data:"eth_usd"},{text:"EUR",callback_data:"eur_usd"},{text:"RUR",callback_data:"usd_rur"}]]})},_("Символ:",y)),"BTC"===e.text&&(y={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"NMC",callback_data:"nmc_btc"},{text:"PPC",callback_data:"ppc_btc"},{text:"NVC",callback_data:"nvc_btc"},{text:"LTC",callback_data:"ltc_btc"}],[{text:"DSH",callback_data:"dsh_btc"},{text:"ETH",callback_data:"eth_btc"},{text:"RUR",callback_data:"btc_rur"},{text:"EUR",callback_data:"btc_eur"}]]})},_("Символ:",y)),"OTHER"===e.text&&(y={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"ETH/LTC",callback_data:"eth_ltc"},{text:"ETH/EUR",callback_data:"eth_eur"},{text:"ETH/RUR",callback_data:"eth_rur"}],[{text:"LTC/RUR",callback_data:"ltc_rur"},{text:"LTC/EUR",callback_data:"ltc_eur"},{text:"EUR/RUR",callback_data:"eur_rur"}]]})},_("Пара:",y)),"Контроль"===e.text&&(y={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({keyboard:[[{text:"Скорость"},{text:"Состояние"},{text:"Модули"}],[{text:"Главное меню"}]],resize_keyboard:!0})},_("Выберите:",y)),"Нотис"===e.text&&(y={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({keyboard:[[{text:"Мониторинг"},{text:"Уведомление"}],[{text:"Круг"}],[{text:"Главное меню"}]],resize_keyboard:!0})},_("Выберите:",y)),"Мониторинг"===e.text&&(y={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Старт",callback_data:"monitoring start"},{text:"Стоп",callback_data:"monitoring stop"}]]})},T=ce.status?"Работает.":"Остановлен.",u=["Включает мониторинг возможных торговых пар. Уведомление раз в 5 минут.","Текущие состояние: "+T],_(u.join("\n"),y)),"Уведомление"===e.text&&(y={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Старт",callback_data:"notification start"},{text:"Стоп",callback_data:"notification stop"}]]})},T=le.status?"Работает.":"Остановлен.",u=["Включает уведомления о скачках курса.","Текущие состояние: "+T],_(u.join("\n"),y)),"Круг"===e.text&&Me(),"Тип"===e.text&&(y={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Only buy",callback_data:"type buy"},{text:"Only sell",callback_data:"type sell"},{text:"Buy & Sell",callback_data:"type all"}]]})},u=["Текущий тип торговли "+W.toUpperCase(),"Новый тип:"],_(u.join("\n"),y)),"Сменить пару"===e.text){if("btc-e"!==t.exchange)return void _("Этот пункт не доступен для данной биржи");y={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"BTC/USD",callback_data:"trade btc_usd"},{text:"BTC/RUR",callback_data:"trade btc_rur"},{text:"BTC/EUR",callback_data:"trade btc_eur"}],[{text:"LTC/BTC",callback_data:"trade ltc_btc"},{text:"LTC/USD",callback_data:"trade ltc_usd"},{text:"LTC/RUR",callback_data:"trade ltc_rur"}],[{text:"LTC/EUR",callback_data:"trade ltc_eur"},{text:"NMC/BTC",callback_data:"trade nmc_btc"},{text:"NMC/USD",callback_data:"trade nmc_usd"}],[{text:"NVC/BTC",callback_data:"trade nvc_btc"},{text:"NVC/USD",callback_data:"trade nvc_usd"},{text:"PPC/BTC",callback_data:"trade ppc_btc"}],[{text:"PPC/USD",callback_data:"trade ppc_usd"},{text:"DSH/BTC",callback_data:"trade dsh_btc"},{text:"DSH/USD",callback_data:"trade dsh_usd"}],[{text:"ETH/BTC",callback_data:"trade eth_btc"},{text:"ETH/USD",callback_data:"trade eth_usd"},{text:"ETH/EUR",callback_data:"trade eth_eur"}],[{text:"ETH/LTC",callback_data:"trade eth_ltc"},{text:"ETH/RUR",callback_data:"trade eth_rur"},{text:"USD/RUR",callback_data:"trade usd_rur"}],[{text:"EUR/USD",callback_data:"trade eur_usd"},{text:"EUR/RUR",callback_data:"trade eur_rur"}]]})},u=["Текущая пара "+g(),"Внимание! На новой паре должны быть средства для торгов, иначе переключение завершится ошибкой!","Новая торгая пара:"],_(u.join("\n"),y)}return"Скорость"===e.text&&(y={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Normal",callback_data:"speed normal"},{text:"Extra",callback_data:"speed extra"}]]})},u=["Влияет на плотность стека ордеров, размер спреда и время закрытия неиспользованных ордеров","Время действия "+pe(R)+".","Текущая скорость: "+X].join("\n"),_(u,y)),"Состояние"===e.text&&(y={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Пауза",callback_data:"worker pause"},{text:"Продолжить",callback_data:"worker continued"}]]})},T=P?"Пауза":"Работает",_("Текущие состояние: "+T,y)),"Модули"===e.text&&(y={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Динам. время обновления "+(t.dynamicSettingsTime?"[Выкл]":"[Вкл]"),callback_data:"modules dynamic-settings-time"}],[{text:"Динам. распределение ордеров "+(t.dynamicOffsetOrders?"[Выкл]":"[Вкл]"),callback_data:"modules dynamic-offset-orders"}],[{text:"Определение тренда "+(t.trendDefinition?"[Выкл]":"[Вкл]"),callback_data:"modules trend-definition"}],[{text:"Контроль смены тренда "+(t.abruptChangeTrend?"[Выкл]":"[Вкл]"),callback_data:"modules abrupt-change-trend"}],[{text:"Стоп при большом изменении цены "+(t.dangerPriceStop?"[Выкл]":"[Вкл]"),callback_data:"modules danger-price-stop"}],[{text:"Включить все",callback_data:"modules all-modules-on"},{text:"Выключить все",callback_data:"modules all-modules-off"}],[{text:"Полосы Боллинджера "+(t.bbands?"[Выкл]":"[Вкл]"),callback_data:"modules bbands"}],[{text:"Вывод лога "+(t.botLog?"[Выкл]":"[Вкл]"),callback_data:"modules bot-log"}]]})},_("*Модули обновления настроек:*",y)),"/help"===(null!=(m=e.text)?m.toLowerCase():void 0)&&(u=["Бот на паре "+g(),"TIME_UPDATE_AUTO_SETTINGS="+R+" | время обновления авто настроек параметров (в мин)","OFFSET_ORDERS_POINTS="+t.offsetOrdersPoints+" | отступ ордеров в пунктах","OFFSET_ORDERS_PERCENT="+t.offsetOrdersPercent+" | отступ для ордеров в процентах","STEP_BREAKEVEN_PERCENT="+t.stepBreakevenPercent+" | процент отступа безубытка для торгов","TIME_CLOSE_ORDERS="+t.timeCloseOrders+" | сколько минут ждать перед закрытием неисполнившихся ордеров","COUNT_ORDERS="+t.countOrders+" | количество ордеров","DEPOSIT_LIMIT="+t.depositLimit+" | процент использования депозита"],_(u.join("\n\n"))),/(\D+)=(\d+)/.test(e.text)?function(){var r,n,a;r=e.text.split("="),r[0]=r[0].toUpperCase(),"OFFSET_ORDERS_POINTS"!==(n=r[0])&&"TIME_UPDATE_AUTO_SETTINGS"!==n&&"OFFSET_ORDERS_PERCENT"!==n&&"TIME_CLOSE_ORDERS"!==n&&"STEP_BREAKEVEN_PERCENT"!==n&&"DEPOSIT_LIMIT"!==n&&"COUNT_ORDERS"!==n||(a=o.camelCase(r[0]),t[a]=+r[1],console.log("SET "+r[0]+"="+r[1]),_("Настройки обновлены!"),"DEPOSIT_LIMIT"!==(n=r[0])&&"COUNT_ORDERS"!==n||(P=!0,he(t.tradeCurrency.pair,function(e){P=!1,_("Бот перезапущен!")})))}():void 0}}),b.on("callback_query",function(e){e.from.id===t.myChatId&&(/trade (\w*_(usd|rur|eur|btc|ltc))/.test(e.data)?Re(e.data.substr(6)):/speed (normal|extra)/.test(e.data)?Pe(e.data.substr(6)):/worker (continued|pause)/.test(e.data)?Ue(e.data.substr(7)):/monitoring (start|stop)/.test(e.data)?Le(e.data.substr(11)):/notification (start|stop)/.test(e.data)?Be(e.data.substr(13)):/type (buy|sell|all)/.test(e.data)?Ne(e.data.substr(5)):/modules (\w*)/.test(e.data)?Ie(e.data.substr(8)):De(e.data))}),Re=function(e){var r,n;t.masterWorker&&(_("Инициализировано изменение пары..."),P=!0,r=e.split("_")[0],n=e.split("_")[1],t.tradeCurrency.name===r&&t.tradeCurrency.nameTwo!==n?I.sell=1:t.tradeCurrency.name!==r&&t.tradeCurrency.nameTwo===n&&(I.buy=1),setTimeout(function(){Qe(t.tradeCurrency.pair,function(){t.tradeCurrency={name:r,nameTwo:n,pair:[r,n].join("_")},N=!0,Ke(t.tradeCurrency.pair,function(e){var t,r;null!=e?(t=k(e),console.log(("["+T()+"]: Ошибка получения данных с сервера!\n"+t).red),r=["Critical error: Ошибка получения данных с сервера!","Бот поставлен на паузу, после обновления баланса необходимо перезапустить пару!","Ошибка: "+t].join("\n"),_(r),P=!0):(U=0,P=!1,_("Выполнено! Новая пара "+g()))})})},l("5s")))},Ne=function(e){t.masterWorker&&(W=e,te="all"!==e,_("Выполнено! Новый тип "+W.toUpperCase()))},Pe=function(e){var t;Ve(e),t=["Режим "+e.toUpperCase()+" включен.","Пара: "+g()],h=x(),console.log(("\n["+T()+"]: "+t[0]+"\n").green),_(t.join(" "))},Ue=function(e){var t;P="pause"===e,t=P?"Пауза":"Работает",_("Новое состояние: "+t+". Пара: "+g())},Ie=function(e){var r,n;/\all-modules/.test(e)?(r="all-modules-on"===e,t.dynamicSettingsTime=r,t.dynamicOffsetOrders=r,t.trendDefinition=r,t.abruptChangeTrend=r,t.dangerPriceStop=r,t.dynamicSettingsTime||(R=t.timeUpdateAutoSettings),_("Все модули "+(r?"включены":"выключены")+"!")):(n=e.replace(/\-./g,function(e,t,r){return e.replace("-","").toUpperCase()}),t[n]=!t[n],_(e.replace(/\-/g,"_").toUpperCase()+": "+t[n]))},De=function(e){t.masterWorker&&p.getTicker(e,function(r,n){var a,o,l,c,i,s,u,d,p,b,m;return null!=r?_(k(r)):(a=We.pairs[e].decimal_places,o=n[e].last,l=n[e].sell,c=n[e].buy,i=be(n[e].avg,a),s=be(c-l,a),u=e.split("_")[1],d=ye(c,t.stepBreakevenPercent,a),p=s>d?"✔":"✗",b=o>i?"↑":"↓",m=[e.replace("_","/").toUpperCase()+":","sell: "+ue(u)+l,"buy: "+ue(u)+c,"last: "+ue(u)+o,"avg: "+ue(u)+i+" | "+b,"spread:   "+s+" | "+(s/d*100-100).toFixed()+"%","required: "+d+" "+p],_(m.join("\n")))})},Le=function(e){var r;t.masterWorker&&(ce.status="start"===e,clearInterval(ce.interval),ce.status?(r="Работает",je(),ce.interval=setInterval(function(){je()},l("5m"))):r="Остановлен",_("Новое состояние: "+r))},Be=function(e){var r;if(t.masterWorker){if(null==ne||!ne.length)return void _("Внимание! Конфиг для уведомлений не задан!");le.status="start"===e,clearInterval(le.interval),le.status?(r="Работает",Ae()):r="Остановлен",_("Новое состояние: "+r)}},je=function(){var e;e=ze.join("-"),a.parallel([function(t){return p.getTicker(e,function(e,r){return null!=e?t(e):t(null,r)})},function(t){return p.getTrades(e,{limit:2},function(e,r){return null!=e?t(e):t(null,r)})}],function(e,r){var n,a,o,i,s,u;if(null!=e)return n=k(e),a="Error trading pairs available: "+n,_(a),void console.log(a.red);o=["Доступные пары для торгов:\n"],i=(new Date).getTime(),s=c.range(i-l("1m"),i),u=0,ze.forEach(function(e){var n,a,l,c,i,d,p,b,m,f,g,y,T;n=e.split("_")[1],a=e.split("_")[0],l=We.pairs[e].decimal_places,c=r[0][e].last,i=r[0][e].sell,d=r[0][e].buy,p=r[0][e].vol,b=r[0][e].vol_cur,m=r[0][e].avg?r[0][e].avg:(i+d)/2,m=be(m,l),f=be(d-i,l),g=ye(d,t.stepBreakevenPercent,l),y=c>m?"↑":"↓",T=!r[1][e][0].timestamp||s.contains(1e3*r[1][e][0].timestamp)&&s.contains(1e3*r[1][e][1].timestamp),f>g&&T&&(u++,o.push(e.replace("_","/").toUpperCase()+"\nprice: "+d+" - "+i+"\navg:   "+m+" | "+y+"\nvol_cur: "+b+" "+ue(a)+"\nvol:        "+p+" "+ue(n)+"\nspread:   "+_e(f)+" | "+(f/g*100-100).toFixed()+"%\nrequired: "+_e(g)+"\n")),u>=20&&(_(o.join("\n")),u=0,o=[])}),setTimeout(function(){o.length&&_(o.join("\n"))},l("2s"))})},Ae=function(){var r,n;t.masterWorker&&null!=ne&&ne.length&&("all_all"===ne[0]&&(ne=ze),r=ne.join("-"),n={},le.interval=setInterval(function(){p.getTicker(r,function(r,a){var o,c,i;return null==r?(i=0,c=[],ne.forEach(function(r){var o,s,u,d,p,b,m,f,g,y,T,x,C;t.tradeCurrency.pair!==r&&e(r,ze)&&(n[r]||(o=We.pairs[r].decimal_places,s=a[r].sell,u=a[r].buy,d=a[r].last,p=a[r].vol,b=a[r].vol_cur,m=a[r].avg?a[r].avg:(s+u)/2,m=be(m,o),f=be(u-s,o),g=ye(s,t.notificationDeviation,o),f>g&&(i++,n[r]=!0,y=r.split("_")[1],T=r.split("_")[0],x=d<=s||d<=s+fe(3,o)?"down ↓":"up ↑",C=d>m?"↑":"↓",c.push(["Уведомление "+r.replace("_","/").toUpperCase()+":","directions: "+x,"sell: "+ue(y)+s,"buy: "+ue(y)+u,"last: "+ue(y)+d,"avg: "+ue(y)+m+" | "+C,"vol_cur: "+b+" "+ue(T),"vol: "+p+" "+ue(y),"spread: "+_e(f)+"\n"].join("\n"))),i>=15&&(_(c.join("\n")),i=0,c=[]),setTimeout(function(){n[r]=!1,n.error=!1},l("15m"))))}),setTimeout(function(){c.length&&_(c.join("\n"))},l("2s"))):(o=k(r),c="Error notification price: "+o,console.log(c.red),n.error?void 0:(_(c),n.error=!0))})},l("5s")))},Me=function(t,r){var n,a,o,l;null==t&&(t=.993),null==r&&(r=!1),n={},a={},o={},l={},ze.forEach(function(e){var t;t=e.split(/\s*_\s*/),n[t[0]]?n[t[0]].push(t[1]):n[t[0]]=[t[1]]}),p.getTicker(ze.join("-"),function(c,i){var s,u,d,p;if(null!=c)return s=k(c),_("Error: "+s);if(ze.forEach(function(e){a[e]=Ce(1,i[e].buy)}),ze.forEach(function(e){var t;t=e.split(/\s*_\s*/),n[t[0]].forEach(function(r){r!==t[1]&&(o[t[1]+"_"+t[0]+"_"+r]=ke(a[e],i[t[0]+"_"+r].sell))})}),Object.keys(o).forEach(function(r){var n,a;n=r.split(/\s*_\s*/),e(n[0]+"_"+n[2],ze)&&(a=Ce(o[r],i[n[0]+"_"+n[2]].buy)),e(n[2]+"_"+n[0],ze)&&(a=ke(o[r],i[n[2]+"_"+n[0]].buy)),a>t&&(l[r+"_"+n[0]]=be(a,5))}),u=["Проверка возможных вариантов перепродаж.","Показаны значения больше: "+t,"Значения меньше 1 убыточны:\n"],d=[],Object.keys(l).forEach(function(e){d.push([e.replace(/\_/g,"->"),l[e]])}),d.length?(p=d.sort(function(e,t){return t[1]-e[1]}),p.forEach(function(e){u.push(e.join(": "))})):u.push("Нет подходящих вариантов"),!r||d.length)return _(u.join("\n"))})},Ve=function(e){var r;null!=e&&(r=e),r||(r=U>ee?"extra":"normal"),U=0,"extra"===r?(Fe=D.extra,qe=D.extra,Je=B,He=60*t.timeCloseOrdersExtra):(Fe=D.buy,qe=D.sell,Je=L,He=60*t.timeCloseOrders),X=r},Ge=0,Ke=function(e,t){return p.getInfo(function(r,n){if(null!=r)return t(r);try{We=n,ze=Object.keys(n.pairs),Y=n.pairs[e].decimal_places,Q=n.pairs[e].min_amount,Z=n.pairs[e].min_price,$=n.pairs[e].fee}catch(e){e,t("Not valid pair")}return he(e,function(r){var n,a;return r?(n=null!=(a=r.error)?a.split("send:")[1]:void 0,null!=n?(p.setNonce(n),Ke(e,t)):(Ge++,Ge>5?(Ge=0,t(r)):Ke(e,t))):t(null)})})},Xe=function(e,t){return p.getTicker(e,function(r,n){var a,o,l,c;return null!=r?t(r):(a=n[e].last,o=n[e].sell,l=n[e].buy,c=be(l-o,Y),M=Je<=fe(2)?c>=Je:c>Je,t(null,{lastPrice:a,bidPrice:o,askPrice:l,spread:c}))})},Ye=function(e,r){return M?p.balanceRequest(e,function(e,n,a){return null!=e?r(e):(n=Se(n,"name"),a=Se(a,"nameTwo"),"all"===W?n<Q&&a<Q?F<t.ecoCountCycle&&F++:F>0&&(F=0):F=t.ecoCountCycle,r(null,{balance:n,balanceTwo:a}))}):r(null)},Ze=function(e,r,n,o,l){var c;return r<Q?l(null):re?l(null):(A={buy:0,sell:0},"all"===W||W===e?r>=j?(void 0!==c&&null!==c||(c=n),a.doWhilst(function(t){return z?("sell"===e&&(c-=qe),"buy"===e&&(c+=Fe),r/=2,$e(e,c,r,o,t)):("buy"===e?(c-=Fe,r=A.buy/c||r):(c+=qe,r=A.sell||r),r>j?$e(e,c,j,o,t):$e(e,c,r/2,o,t))},function(){return r>j},function(e){return l(null!=e?e:null)})):(t.dynamicOffsetOrders&&("sell"===e&&(n+=fe(2)),"buy"===e&&(n-=fe(2))),$e(e,n,r,o,l)):l(null))},$e=function(e,r,n,a,o){var l;return r=be(r,Y),r>=Z||(r=Z),n=be(n,8),l="poloniex"===t.exchange?n*r<t.poloniexMinOrders:n<Q,l?o(null):p.tradeSetOrder(a,e,r,n,function(a,l){var c,i;return null!=a?(c=k(a),console.log(("["+T()+"]: Error: "+c+" | "+e+" | rate: "+r+" | amount: "+n).red),o(a)):(i="["+T()+"]: Open: "+e+" | rate: "+r+" | amount: "+n,"buy"===e?A.buy="poloniex"===t.exchange?Se(l.funds[t.tradeCurrency.name],"name"):Se(l.funds[t.tradeCurrency.nameTwo],"nameTwo"):A.sell="poloniex"===t.exchange?Se(l.funds[t.tradeCurrency.nameTwo],"nameTwo"):Se(l.funds[t.tradeCurrency.name],"name"),console.log("buy"===e?i.green:i.yellow),U++,o(null))})},Qe=function(e,t){return p.ordersRequest(e,function(e,r){var n,o,l;return S=x(),null!=e?0===e.success&&null==(null!=(n=e.error)?n.split("send:")[1]:void 0)?(o=k(e),console.log(("["+T()+"] Cancel orders: "+o).yellow),t(null)):t(e):(l=Object.keys(r),a.eachSeries(l,function(e,t){return null!=I.buy&&"sell"===r[e].type?t(null):null!=I.sell&&"buy"===r[e].type?t(null):S-r[e].timestamp_created>(I.buy||I.sell||I.all||60)?et(e,r[e].type,r[e].amount,r[e].rate,t):t(null)},function(e){return I={all:null,buy:null,sell:null},t(null!=e?e:null)}))})},et=function(e,t,r,n,a){return p.tradeCancelOrder({order_id:e},function(e,o){return null!=e?a(e):(console.log(("["+T()+"]: Close: "+t+" | rate: "+n+" | amount: "+r).cyan),U>0&&U--,a(null))})},tt=function(){te||de(S,t.timeCloseOrdersInactivity)&&Qe(t.tradeCurrency.pair,function(e){})},rt=function(){var e;de(w,10)&&(e="Unknown error: Worker Stop!",console.log(("["+T()+"]: "+e).red),at({error:e}))},nt=function(){w=x(),P?setTimeout(function(){nt()},l("30s")):a.series([function(e){return Xe(t.tradeCurrency.pair,e)},function(e){return Ye(t.tradeCurrency,e)}],function(e,r){var n;null!=e?(n=k(e),console.log(("Error: "+n).red),at(e)):(N&&(we(r[0].askPrice,r[0].bidPrice,r[0].lastPrice),N=!1),M?a.series([function(e){
return R>0&&w-h>60*R&&we(r[0].askPrice,r[0].bidPrice,r[0].lastPrice),e(null)},function(e){return w-S>He?Qe(t.tradeCurrency.pair,e):e(null)},function(e){var n,a;return t.botTrade&&v?(n=z?K.bid:r[0].bidPrice,a="poloniex"===t.exchange?r[1].balance/n:r[1].balanceTwo/n,Ze("buy",a,n,t.tradeCurrency.pair,e)):e(null)},function(e){var n,a;return t.botTrade&&v?(n=z?K.ask:r[0].askPrice,a="poloniex"===t.exchange?r[1].balanceTwo:r[1].balance,Ze("sell",a,n,t.tradeCurrency.pair,e)):e(null)}],function(e){var r;null!=e?(r=k(e),console.log(("ErrorTrader: "+r).red),at(e)):F===t.ecoCountCycle?(clearTimeout(oe.eco),oe.eco=setTimeout(function(){nt()},l("2s"))):nt()}):(clearTimeout(oe.spread),oe.spread=setTimeout(function(){nt()},l(t.restartServerTime+"s"))))})},at=function(e){var r,n,a,o;r="restart using "+t.restartServerTime+" sec ...",console.log("["+T()+"]: "+r),n=null!=(a=e.error)?a.split("send:")[1]:void 0,null==n&&(o=k(e),E!==o&&(E=o,t.emailS&&"production"===process.env.NODE_ENV&&f(y(o+"\n\n"+r),function(e,t){}))),setTimeout(function(){console.log(("["+T()+"]: trader restart").bgGreen),null!=n&&p.setNonce(n),nt()},l(t.restartServerTime+"s"))},function(){t.myChatId&&(console.log("["+T()+"]: Trader Bot starting..."),console.log("["+T()+"]: Exchange: "+t.exchange.toUpperCase()+" | v."+t.versionBot),Ke(t.tradeCurrency.pair,function(e){var r;return null!=e&&(r=k(e),console.log(("["+T()+"]: Error getting parameters from the server!\n"+r).red),process.exit(0)),nt(),t.botTrade&&setInterval(function(){tt(),rt()},l("5m")),setInterval(function(){ve()},l(10*t.bbandsInterval+"s")),"production"===process.env.NODE_ENV&&_("Trader Bot started. Pair "+g()),console.log("["+T()+"]: Trader Bot started")}))}()}).call(this);