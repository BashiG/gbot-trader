(function(){function cb(a,b){for(var c=-1,d=b.length>>>0;++c<d;)if(a===b[c])return!0;return!1}var a,b,c,d,e,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,aa,ba,ca,da,ea,fa,ga,ha,ia,ja,ka,la,ma,na,oa,pa,qa,ra,sa,ta,ua,va,wa,xa,ya,za,Aa,Ba,Ca,Da,Ea,Fa,Ga,Ha,Ia,Ja,Ka,La,Ma,Na,Oa,Pa,Qa,Ra,Sa,Ta,Ua,Va,Wa,Xa,Ya,Za,$a,_a,ab,bb;if(a=require("./conf"),b=require("./api-btc-e"),c=require("./api-poloniex"),d=require("async"),e=require("lodash"),require("colors"),g=require("ms"),h=require("moment"),i=require("moment-range"),j=require("nodemailer"),k=require("node-telegram-bot-api"),l=require("ta-lib"),h=i.extendMoment(h),!a.tokenTelegram)return void console.log("There is no token Telegram!".red);m="poloniex"===a.exchange?new c:new b,n=new k(a.tokenTelegram,{polling:!0}),o=function(b,c){b.length>4096&&(b="Слишком много информации для отображения"),n.sendMessage(a.myChatId,b,c)},p=j.createTransport(a.email),q=function(a,b){return p.sendMail(a,b)},r=function(){return a.tradeCurrency.pair.replace("_","/").toUpperCase()},s=function(b){return{from:a.email.auth.user,to:a.email.reportEmail,subject:"Error Script Trader",text:"time: "+(new Date).toString()+"\nPair: "+r()+"\n\nmessage: "+b+"\n\n---"}},t=function(){return(new Date).toLocaleTimeString("en-US",{timeZone:a.timeZone,hour12:!1})},u=function(){return Math.round((new Date).getTime()/1e3)},v=!0,w=null,x={name:0,nameTwo:0},y=u(),z=u(),A=u(),B=a.timeUpdateAutoSettings,C=!0,D=!1,E=0,F={all:null,buy:null,sell:null},G={extra:0,buy:0,sell:0},H=0,I=0,J=0,K={buy:0,sell:0},L=!1,M=0,N=0,O=0,P=0,Q=[],R=[],S="all",T=!1,U={ask:0,bid:0},V="normal",W=0,X=0,Y=0,Z=0,$=0,_=!1,aa=!1,ba=null!=(ca=a.notificationPair)?ca.toLowerCase().replace(/\//g,"_").split(/\s*,\s*/):void 0,da={spread:!1,eco:!1},ea={status:!1,interval:!1},fa={status:!1,interval:!1},ga={btc:"฿",usd:"$",eur:"€",rur:"₽",ltc:"L"},ha="-----------------------------------",ia=function(a){return ga.hasOwnProperty(a)?ga[a]:a+" "},ja=function(a,b){return u()-a>=60*b},ka=function(a,b){var c,d,e;return null!=b&&(c=b),c||(c=a>=1?["минута","минуты","минут"]:["секунда","секунды","секунд"],a=a<1?60*a:a),d=[2,0,1,1,1,2],e=c[a%100>4&&a%100<20?2:d[a%10<5?a%10:5]],a+" "+e},la=function(a,b){return null==b&&(b=3),+(+a).toFixed(b)},ma=function(a){return a.toFixed(10).replace(/(.*0\.0*[1-9]*)0+\d*/g,"$1")},na=function(a,b){return b>0?+(100*a/b).toFixed(1):0},oa=function(a,b){return null==b&&(b=W),la(a/+("1e"+b),b)},pa=function(a,b){return null==b&&(b=W),la(a*+("1e"+b),b)},qa=function(a,b,c){var d,e,f;return null==b&&(b=0),null==c&&(c=W),d=a/100*Y*2,e=Math.ceil(d*+("1e"+c))/+("1e"+c),f=e*(1+b/100),la(f,c)},ra=function(a,b){return la(a/100*(100+b),W)},sa=function(a,b){return la(100*a/(100+b),W)},ta=function(a,b){return a/b*(1-Y/100)},ua=function(a,b){return a*b*(1-Y/100)},va=function(){a.bbands&&P>0&&(R.push(P),R.length>30&&R.splice(0,1))},wa=function(a,b){var c,d,e;return null==b&&(b=1),b=a<.001?1:b,c=a.toString().split(".")[0],d=a.toString().split(".")[1].length,e=c>0?c>1e4?+("1e"+(d+1)):c>1e3?+("1e"+d):c>100?+("1e"+(d-1)):c>10?+("1e"+(d-2)):d>3?+("1e"+(d-3)):1:1,b*=e,la(b/+("1e"+d),d)},xa=function(b,c,d){var f,g,h,i,j,k,m,n,p,q,s,w,x,y,J,K,L,M,ba,ca,da,ea,fa,ga,ia,ja,ka,oa,ta,ua,va,xa,ya,za;if(A=u(),F={buy:null,sell:null},f=b.toString().length,g=c.toString().length,i={},i[f+""]=b,i[g+""]=c,h=i,j=Math.max(f,g),k=h[j],W=Ra.pairs[a.tradeCurrency.pair].decimal_places,Z=Ra.pairs[a.tradeCurrency.pair].min_amount,X=Ra.pairs[a.tradeCurrency.pair].min_price,Y=Ra.pairs[a.tradeCurrency.pair].fee,m=la(b-c,W),n=qa(k,200),a.dynamicSettingsTime&&(Q.push(d),Q.length>50&&Q.splice(0,1),p=e.max(Q),q=e.min(Q),a.botLog&&console.log([ha,"price-array:","length: "+Q.length,"max: "+p,"min: "+q,"change-time-settings: "+(na(p,q)>102)].join("\n")),na(p,q)>102?B=.1:B!==a.timeUpdateAutoSettings&&(B=a.timeUpdateAutoSettings)),a.abruptChangeTrend&&(s=qa(k,500)),a.dangerPriceStop&&(w=ra(O,9),x=sa(N,9)),a.dynamicOffsetOrders&&(y={current:qa(k,450),prev:qa(k,380),prev_2:qa(k,300)},J=m>=y.current||m>=y.prev||m>=y.prev_2),a.dynamicOffsetOrders&&J?(console.log("["+t()+"]: Dynamic market"),K=pa(y.current),L=1.3*K,M=1.5*a.stepBreakevenPercentConfig):(K=a.offsetMaxOneConfig,L=a.offsetMaxTwoConfig,M=a.stepBreakevenPercentConfig),H=qa(k,M),a.botLog&&(console.log(ha),console.log("current-spread:",(ma(m)+"")[m>H?"green":"white"]),console.log("spread-min-default:",ma(H)),console.log("trend-spread:",ma(n)),a.abruptChangeTrend&&console.log("immediate-spread:",s),console.log("trader-speed:",V),console.log("price-prev:",O+" - "+N),console.log("price-prev2:",U.ask+" - "+U.bid),a.dangerPriceStop&&(console.log("danger-price-ask:",w,!C&&b>=w?"Attention!".red:""),console.log("danger-price-bid:",x,!C&&c<=x?"Attention!".red:"")),a.dynamicOffsetOrders&&(console.log("spread_1_450:",y.current,m>=y.current?"Attention!".red:""),console.log("spread_2_380:",y.prev,m>=y.prev?"Attention!".red:""),console.log("spread_3_300:",y.prev_2,m>=y.prev_2?"Attention!".red:""),console.log("dynamic-market:",J))),a.dangerPriceStop&&!C&&(b>=w||c<=x))return b>=w&&(F.buy=1),z=0,D=!0,ba="DANGER PRICE: "+b+" - "+c+" | Bot Pause!",console.log("["+t()+"]: "+ba),void o(ba+"");ca=2,da=E>Math.round($/2)?L:K,a.botLog&&(console.log("offset-max-one:",(K+"")[K===a.offsetMaxOneConfig?"green":"yellow"]),console.log("offset-type-max:",da),console.log(ha)),_||(S="all",T=!1),C?ea=fa=da:a.bbands?(ea=fa=da,H=0,B=.1,ga=14,R.length>2*ga&&(i=l.BBANDS(R,20,a.bbandsDeviation),ia=i.middleband,ja=i.lowband,ka=i.highband,oa=l.RSI(e.clone(R).reverse(),ga),ta=l.average(oa).mean,ua=l.average(ia).mean,va=l.average(ka).mean,xa=l.average(ja).mean,ya=va>d&&d>ua,za=ua>d&&d>xa,ya&&(S="sell"),za&&(S="buy"),v=99>ta&&ta>68||1<ta&&ta<33,aa=ya&&za,a.botLog&&console.log(["BBANDS:","highband: "+va,"middleband: "+ua,"lowband: "+xa,"rsa: "+ta,"sell: "+ya,"buy: "+za,"bot trade: "+v,"orders-calculation-brake: "+aa,ha].join("\n")))):a.trendDefinition&&c>N&&b>O&&m>n&&"normal"===V?(console.log("["+t()+"]: Trend: UP"),ea=ca,fa=da,_||(S="buy",F.sell=1,z=0,a.abruptChangeTrend&&m>s&&(console.log("["+t()+"]: Spread Immediate"),T=!0,A=0))):a.trendDefinition&&c<N&&b<O&&m>n&&"normal"===V?(console.log("["+t()+"]: Trend: DOWN"),ea=da,fa=ca,_||(S="sell",F.buy=1,z=0,a.abruptChangeTrend&&m>s&&(console.log("["+t()+"]: Spread Immediate"),T=!0,A=0))):ea=fa=da,U={ask:O,bid:N},N=c,O=b,P=d,I=qa(k),G={buy:wa(k,ea),sell:wa(k,fa),extra:wa(k)},Pa(),console.log("["+t()+"]: Update: "+S.toUpperCase()+" | "+b+" - "+c+" | "+d+" | "+r())},ya=function(a,b){var c,d;return c="name"===b?x.name:x.nameTwo,d=la(a-la(c,2),8),d>0?d:0},za=function(b,c){return C?d.parallel([function(c){return a.botLog&&console.log(ha+"\nПолучение цен"),m.getTicker(b,function(a,d){return a?c(a):c(null,{price:d[b].buy})})},function(c){return d.series([function(c){return a.botLog&&console.log(ha+"\nЗакрытие всех позиций"),F.all=1,Ya(b,function(a){return c(null!=a?a:null)})},function(b){return a.botLog&&console.log(ha+"\nПолучение баланса"),m.balanceRequest(a.tradeCurrency,function(c,d,e){return c?b(c):a.botTrade&&d<.1&&e<("btc"===a.tradeCurrency.nameTwo?.01:.1)?b({error:"Err: No money!"}):b(null,{balance:d,balanceTwo:e})})}],function(a,b){return a?c(a):c(null,{balance:b[1].balance,balanceTwo:b[1].balanceTwo})})}],function(b,d){var e,f,g,h,i,j,k,l,m,n;return b?c(b):(a.botLog&&console.log(ha+"\nРасчет депозита"),a.depositPercent=0<(e=a.depositPercent)&&e<100?a.depositPercent:99.5,f=la(d[1].balanceTwo/d[0].price+d[1].balance),g=la(f*a.depositPercent/100),h=la(d[1].balance*d[0].price+d[1].balanceTwo),i=la(h*a.depositPercent/100),la(d[1].balance)>=g&&la(d[1].balanceTwo)>=i?(a.botLog&&console.log("type:",1),j=d[1].balance-g/2,k=d[1].balanceTwo-i/2):la(d[1].balance)>=g&&la(d[1].balanceTwo)<i?(a.botLog&&console.log("type:",2),j=d[1].balance-(i-d[1].balanceTwo)/d[0].price,k=0):la(d[1].balance)<g&&la(d[1].balanceTwo)>=i?(a.botLog&&console.log("type:",3),j=0,k=d[1].balanceTwo-(g-d[1].balance)*d[0].price):(a.botLog&&console.log("type:",4),j=0,k=0),a.botLog&&(l=na(j,d[1].balance),m=na(k,d[1].balanceTwo),console.log(["reserved-deposit:",a.tradeCurrency.name.toUpperCase(),l+"% / "+m+"%",a.tradeCurrency.nameTwo.toUpperCase()].join(" "))),x={name:j>0?j:0,nameTwo:k>0?k:0},a.countOrders?a.countOrders>=6||(a.countOrders=6):a.countOrders=g<=200?15:g<=500?18:g<=1e3?21:25,n=g>6?a.countOrders:Math.round(a.countOrders/2),$=n*a.multiplierOrdersExtra,J=(e=la(g/n))>Z?e:Z,a.botLog&&console.log([ha+"\nРасчет переменных","balance: "+la(d[1].balance)+" "+a.tradeCurrency.name.toUpperCase(),"balance-two: "+la(d[1].balanceTwo)+" "+ia(a.tradeCurrency.nameTwo),"deposit: "+f+" "+a.tradeCurrency.name.toUpperCase()+" или "+h+" "+a.tradeCurrency.nameTwo.toUpperCase(),"percent-deposit: "+a.depositPercent+" %","trade-deposit: "+g+" "+a.tradeCurrency.name.toUpperCase()+" | "+i+" "+a.tradeCurrency.nameTwo.toUpperCase(),"reserved-deposit: "+la(x.name)+" "+a.tradeCurrency.name.toUpperCase()+" | "+la(x.nameTwo)+" "+a.tradeCurrency.nameTwo.toUpperCase(),"count-orders: "+n,"size-static-order: "+J,ha].join("\n")),c(null))}):c(null)},n.on("message",function(b){var c,f,h,i,j,k,l,p,q,s,t;if(c=b.chat.id,a.myChatId||n.sendMessage(c,"Install your Telegram id: "+c),c===a.myChatId&&("Ордера"===b.text&&(f=function(){d.series([function(b){return m.balanceRequest(a.tradeCurrency,function(a,c,d){return a?b(a):b(null,{balance:c,balanceTwo:d})})},function(b){return m.ordersRequest(a.tradeCurrency.pair,function(a,c){return a?b(a):b(null,{data:c})})}],function(b,c){var d,g,h,i,j,k,l,n,p,q,s;d=[r()+":",ha],g="Balance: "+(null!=(h=c[0])?h.balance.toFixed(3):void 0)+" "+a.tradeCurrency.name.toUpperCase()+" | "+ia(a.tradeCurrency.nameTwo)+(null!=(i=c[0])?i.balanceTwo.toFixed(3):void 0),b?0===b.success?(j=null!=(k=b.error)?k.split("send:")[1]:void 0,null!=j?(m.setNonce(j),f()):(d.push(b.error+"\n"+ha+"\n"+g),o(d.join("\n")))):o(b):(l={},n=0,p=0,q={},Object.keys(c[1].data).forEach(function(b){var d,e,f;d=c[1].data[b].rate*+("1e"+W),null!=q[d]?(++l[d],e=" | "+l[d],f=la(la(q[d].split("|")[1].trim())+la(c[1].data[b].amount)),q[d]=c[1].data[b].type+" | "+f+" | "+ia(a.tradeCurrency.nameTwo)+c[1].data[b].rate+e):(l[d]=1,q[d]=c[1].data[b].type+" | "+la(c[1].data[b].amount)+" | "+ia(a.tradeCurrency.nameTwo)+c[1].data[b].rate),n+=c[1].data[b].amount,p+=c[1].data[b].amount*c[1].data[b].rate}),d=e.concat(d,e.values(q)),d.push(ha+"\nCount: "+la(n)+" | Sum: "+ia(a.tradeCurrency.nameTwo)+la(p)+"\n"+g),s=d.join("\n"),o(s))})})(),"История"===b.text&&(h=function(){m.tradeGetHistory(a.tradeCurrency.pair,10,function(b,c){var d,e,f;return b?0===b.success?(d=null!=(e=b.error)?e.split("send:")[1]:void 0,null!=d?(m.setNonce(d),h()):o(b.error)):o(b):(f=[],Object.keys(c).forEach(function(b){f.push(c[b].type+" | "+c[b].amount.toFixed(3)+" | "+ia(a.tradeCurrency.nameTwo)+c[b].rate)}),f.push(r()+":\n"+ha),f.reverse(),o(f.join("\n")))})})(),"Закрыть активные ордера"===b.text&&(i=function(){D=!0,F.all=1,setTimeout(function(){Ya(a.tradeCurrency.pair,function(a){var b,c;a?0===a.success&&(b=null!=(c=a.error)?c.split("send:")[1]:void 0,null!=b?(m.setNonce(b),i()):o(a.error)):o("Активные ордера закрыты на паре: "+r()),D=!1})},g("2s"))})(),"/config"===(null!=(j=b.text)?j.toLowerCase():void 0)&&(k=["Бот на паре "+r(),"TIME_UPDATE_AUTO_SETTINGS: "+B+" | время обновления авто настроек параметров (в мин)","DEPOSIT_LIMIT: "+a.depositPercent+" | процент использования депозита","NOTIFICATION_PAIR: "+a.notificationPair+" | пары для уведомления","NOTIFICATION_DEVIATION_PERCENT: "+a.notificationDeviation+" | процент отклонения от текущей цены чтобы сработало уведомление","COUNT_ORDERS: "+a.countOrders+" | количество ордеров","TIME_CLOSE_ORDERS: "+a.timeCloseOrdersDefault+" | сколько минут ждать перед закрытием неисполнившихся ордеров","TIME_CLOSE_ORDERS_INACTIVITY: "+a.timeCloseOrdersInactivity+" | закрытие после бездействия","OFFSET_MAX_ONE: "+a.offsetMaxOneConfig+" | отступ для 1 типа ордеров","OFFSET_MAX_TWO: "+a.offsetMaxTwoConfig+" | отступ для 2 типа ордеров","STEP_BREAKEVEN_PERCENT: "+a.stepBreakevenPercentConfig+" | процент отступа безубытка для торгов","DANGER_PRICE_STOP: "+a.dangerPriceStop+" | остановка бота при большом изменении цены","DYNAMIC_SETTINGS_TIME: "+a.dynamicSettingsTime+" | динамическое время обновления настроек","DYNAMIC_OFFSET_ORDERS: "+a.dynamicOffsetOrders+" | динамическое распределение ордеров","TREND_DEFINITION: "+a.trendDefinition+" | определение тренда","ABRUPT_CHANGE_TREND: "+a.abruptChangeTrend+" | быстрое изменение направления тренда","BBANDS: "+a.bbands+" | полосы Боллинджера","BBANDS_DEVIATION: "+a.bbandsDeviation+" | Отклонение","BBANDS_INTERVAL: "+a.bbandsInterval+" | Таймфрейм (в мин)"],o(k.join("\n\n"))),"/version"===(null!=(l=b.text)?l.toLowerCase():void 0)&&o("Версия бота: "+a.versionBot),a.masterWorker))return"/start"!==(p=null!=(q=b.text)?q.toLowerCase():void 0)&&"главное меню"!==p||(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({keyboard:[[{text:"Ордера"},{text:"Котировки"},{text:"История"}],[{text:"Контроль"},{text:"Нотис"},{text:"Торговля"}],[{text:"Закрыть активные ордера"}]],resize_keyboard:!0})},o("Выберите:",s)),"Котировки"===b.text&&"btc-e"===a.exchange&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({keyboard:[[{text:"USD"},{text:"BTC"},{text:"OTHER"}],[{text:"Главное меню"}]],resize_keyboard:!0})},o("Валюта:",s)),"Торговля"===b.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({keyboard:[[{text:"Сменить пару"},{text:"Тип"}],[{text:"Главное меню"}]],resize_keyboard:!0})},o("Выберите:",s)),"USD"===b.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"NMC",callback_data:"nmc_usd"},{text:"PPC",callback_data:"ppc_usd"},{text:"NVC",callback_data:"nvc_usd"},{text:"LTC",callback_data:"ltc_usd"},{text:"BTC",callback_data:"btc_usd"}],[{text:"DSH",callback_data:"dsh_usd"},{text:"ETH",callback_data:"eth_usd"},{text:"EUR",callback_data:"eur_usd"},{text:"RUR",callback_data:"usd_rur"}]]})},o("Символ:",s)),"BTC"===b.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"NMC",callback_data:"nmc_btc"},{text:"PPC",callback_data:"ppc_btc"},{text:"NVC",callback_data:"nvc_btc"},{text:"LTC",callback_data:"ltc_btc"}],[{text:"DSH",callback_data:"dsh_btc"},{text:"ETH",callback_data:"eth_btc"},{text:"RUR",callback_data:"btc_rur"},{text:"EUR",callback_data:"btc_eur"}]]})},o("Символ:",s)),"OTHER"===b.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"ETH/LTC",callback_data:"eth_ltc"},{text:"ETH/EUR",callback_data:"eth_eur"},{text:"ETH/RUR",callback_data:"eth_rur"}],[{text:"LTC/RUR",callback_data:"ltc_rur"},{text:"LTC/EUR",callback_data:"ltc_eur"},{text:"EUR/RUR",callback_data:"eur_rur"}]]})},o("Пара:",s)),"Контроль"===b.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({keyboard:[[{text:"Скорость"},{text:"Состояние"},{text:"Модули"}],[{text:"Главное меню"}]],resize_keyboard:!0})},o("Выберите:",s)),"Нотис"===b.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({keyboard:[[{text:"Мониторинг"},{text:"Уведомление"}],[{text:"Круг"}],[{text:"Главное меню"}]],resize_keyboard:!0})},o("Выберите:",s)),"Мониторинг"===b.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Старт",callback_data:"monitoring start"},{text:"Стоп",callback_data:"monitoring stop"}]]})},t=fa.status?"Работает.":"Остановлен.",k=["Включает мониторинг возможных торговых пар. Уведомление раз в 5 минут.","Текущие состояние: "+t],o(k.join("\n"),s)),"Уведомление"===b.text&&"btc-e"===a.exchange&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Старт",callback_data:"notification start"},{text:"Стоп",callback_data:"notification stop"}]]})},t=ea.status?"Работает.":"Остановлен.",k=["Включает уведомления о скачках курса.","Текущие состояние: "+t],o(k.join("\n"),s)),"Круг"===b.text&&Ka(),"Тип"===b.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Only buy",callback_data:"type buy"},{text:"Only sell",callback_data:"type sell"},{text:"Buy & Sell",callback_data:"type all"}]]})},k=["Текущий тип торговли "+S.toUpperCase(),"Новый тип:"],o(k.join("\n"),s)),"Сменить пару"===b.text&&"btc-e"===a.exchange&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"BTC/USD",callback_data:"trade btc_usd"},{text:"BTC/RUR",callback_data:"trade btc_rur"},{text:"BTC/EUR",callback_data:"trade btc_eur"}],[{text:"LTC/BTC",callback_data:"trade ltc_btc"},{text:"LTC/USD",callback_data:"trade ltc_usd"},{text:"LTC/RUR",callback_data:"trade ltc_rur"}],[{text:"LTC/EUR",callback_data:"trade ltc_eur"},{text:"NMC/BTC",callback_data:"trade nmc_btc"},{text:"NMC/USD",callback_data:"trade nmc_usd"}],[{text:"NVC/BTC",callback_data:"trade nvc_btc"},{text:"NVC/USD",callback_data:"trade nvc_usd"},{text:"PPC/BTC",callback_data:"trade ppc_btc"}],[{text:"PPC/USD",callback_data:"trade ppc_usd"},{text:"DSH/BTC",callback_data:"trade dsh_btc"},{text:"DSH/USD",callback_data:"trade dsh_usd"}],[{text:"ETH/BTC",callback_data:"trade eth_btc"},{text:"ETH/USD",callback_data:"trade eth_usd"},{text:"ETH/EUR",callback_data:"trade eth_eur"}],[{text:"ETH/LTC",callback_data:"trade eth_ltc"},{text:"ETH/RUR",callback_data:"trade eth_rur"},{text:"USD/RUR",callback_data:"trade usd_rur"}],[{text:"EUR/USD",callback_data:"trade eur_usd"},{text:"EUR/RUR",callback_data:"trade eur_rur"}]]})},k=["Текущая пара "+r(),"Внимание! На новой паре должны быть средства для торгов, иначе переключение завершится ошибкой!","Новая торгая пара:"],o(k.join("\n"),s)),"Скорость"===b.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Normal",callback_data:"speed normal"},{text:"Extra",callback_data:"speed extra"}]]})},k=["Влияет на плотность стека ордеров, размер спреда и время закрытия неиспользованных ордеров","Время действия "+ka(B)+".","Текущая скорость: "+V].join("\n"),o(k,s)),"Состояние"===b.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Пауза",callback_data:"worker pause"},{text:"Продолжить",callback_data:"worker continued"}]]})},t=D?"Пауза":"Работает",o("Текущие состояние: "+t,s)),"Модули"===b.text?(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Динам. время обновления "+(a.dynamicSettingsTime?"[Выкл]":"[Вкл]"),callback_data:"modules dynamic-settings-time"}],[{text:"Динам. распределение ордеров "+(a.dynamicOffsetOrders?"[Выкл]":"[Вкл]"),callback_data:"modules dynamic-offset-orders"}],[{text:"Определение тренда "+(a.trendDefinition?"[Выкл]":"[Вкл]"),callback_data:"modules trend-definition"}],[{text:"Контроль смены тренда "+(a.abruptChangeTrend?"[Выкл]":"[Вкл]"),callback_data:"modules abrupt-change-trend"}],[{text:"Стоп при большом изменении цены "+(a.dangerPriceStop?"[Выкл]":"[Вкл]"),callback_data:"modules danger-price-stop"}],[{text:"Включить все",callback_data:"modules all-modules-on"},{text:"Выключить все",callback_data:"modules all-modules-off"}],[{text:"Полосы Боллинджера "+(a.bbands?"[Выкл]":"[Вкл]"),callback_data:"modules bbands"}],[{text:"Вывод лога "+(a.botLog?"[Выкл]":"[Вкл]"),callback_data:"modules bot-log"}]]})},o("*Модули обновления настроек:*",s)):void 0}),n.on("callback_query",function(b){b.from.id===a.myChatId&&(/trade (\w*_(usd|rur|eur|btc|ltc))/.test(b.data)?Aa(b.data.substr(6)):/speed (normal|extra)/.test(b.data)?Ca(b.data.substr(6)):/worker (continued|pause)/.test(b.data)?Da(b.data.substr(7)):/monitoring (start|stop)/.test(b.data)?Ga(b.data.substr(11)):/notification (start|stop)/.test(b.data)?Ha(b.data.substr(13)):/type (buy|sell|all)/.test(b.data)?Ba(b.data.substr(5)):/modules (\w*)/.test(b.data)?Ea(b.data.substr(8)):Fa(b.data))}),Aa=function(b){var c,d;a.masterWorker&&(o("Инициализировано изменение пары..."),D=!0,c=b.split("_")[0],d=b.split("_")[1],a.tradeCurrency.name===c&&a.tradeCurrency.nameTwo!==d?F.sell=1:a.tradeCurrency.name!==c&&a.tradeCurrency.nameTwo===d&&(F.buy=1),setTimeout(function(){Ya(a.tradeCurrency.pair,function(){a.tradeCurrency={name:c,nameTwo:d,pair:[c,d].join("_")},C=!0,Ta(a.tradeCurrency.pair,function(a){var b;a?(console.log(("["+t()+"]: Ошибка получения данных с сервера!\n"+a.error).red),b=["Critical error: Ошибка получения данных с сервера!","Бот поставлен на паузу, после обновления баланса необходимо перезапустить пару!","Ошибка: "+a.error].join("\n"),o(b),D=!0):(E=0,D=!1,o("Выполнено! Новая пара "+r()))})})},g("5s")))},Ba=function(b){a.masterWorker&&(S=b,_="all"!==b,o("Выполнено! Новый тип "+S.toUpperCase()))},Ca=function(a){var b;Pa(a),b=["Режим "+a.toUpperCase()+" включен.","Пара: "+r()],A=u(),console.log(("\n["+t()+"]: "+b[0]+"\n").green),o(b.join(" "))},Da=function(a){var b;D="pause"===a,b=D?"Пауза":"Работает",o("Новое состояние: "+b+". Пара: "+r())},Ea=function(b){var c,d;/\all-modules/.test(b)?(c="all-modules-on"===b,a.dynamicSettingsTime=c,a.dynamicOffsetOrders=c,a.trendDefinition=c,a.abruptChangeTrend=c,a.dangerPriceStop=c,a.dynamicSettingsTime||(B=a.timeUpdateAutoSettings),o("Все модули "+(c?"включены":"выключены")+"!")):(d=b.replace(/\-./g,function(a,b,c){return a.replace("-","").toUpperCase()}),a[d]=!a[d],o(b.replace(/\-/g,"_").toUpperCase()+": "+a[d]))},Fa=function(b){a.masterWorker&&m.getTicker(b,function(c,d){var e,f,g,h,i,j,k,l,m,n,p;return c?o(c.error):(e=Ra.pairs[b].decimal_places,f=d[b].last,g=d[b].sell,h=d[b].buy,i=la(d[b].avg,e),j=la(h-g,e),k=b.split("_")[1],l=qa(h,a.stepBreakevenPercentConfig,e),m=j>l?"✔":"✗",n=f>i?"↑":"↓",p=[b.replace("_","/").toUpperCase()+":","sell: "+ia(k)+g,"buy: "+ia(k)+h,"last: "+ia(k)+f,"avg: "+ia(k)+i+" | "+n,"spread:   "+j+" | "+(j/l*100-100).toFixed()+"%","required: "+l+" "+m],o(p.join("\n")))})},Ga=function(b){var c;a.masterWorker&&(fa.status="start"===b,clearInterval(fa.interval),fa.status?(c="Работает",Ia(),fa.interval=setInterval(function(){Ia()},g("5m"))):c="Остановлен",o("Новое состояние: "+c))},Ha=function(b){var c;if(a.masterWorker){if(null==ba||!ba.length)return void o("Внимание! Конфиг для уведомлений не задан!");ea.status="start"===b,clearInterval(ea.interval),ea.status?(c="Работает",Ja()):c="Остановлен",o("Новое состояние: "+c)}},Ia=function(){var b;b=Sa.join("-"),d.parallel([function(a){return m.getTicker(b,function(b,c){return b?a(b):a(null,c)})},function(a){return m.getTrades(b,{limit:2},function(b,c){return b?a(b):a(null,c)})}],function(b,c){var e,f,i,j;if(b)return e="Error trading pairs available: "+b.error,o(e),void console.log(e.red);f=[],i=(new Date).getTime(),j=h.range(i-g("1m"),i),d.each(Sa,function(b,d){var e,g,h,i,k,l,m,n,o;return e=Ra.pairs[b].decimal_places,g=c[0][b].last,h=c[0][b].sell,i=c[0][b].buy,k=c[0][b].avg?c[0][b].avg:(h+i)/2,k=la(k,e),l=la(i-h,e),m=qa(i,a.stepBreakevenPercentConfig,e),n=g>k?"↑":"↓",o=!c[1][b][0].timestamp||j.contains(1e3*c[1][b][0].timestamp)&&j.contains(1e3*c[1][b][1].timestamp),l>m&&o?(f.push(b.replace("_","/").toUpperCase()+"\nprice: "+i+" - "+h+"\navg:   "+k+" | "+n+"\nspread:   "+ma(l)+" | "+(l/m*100-100).toFixed()+"%\nrequired: "+ma(m)+"\n"),d(null)):d(null)}),setTimeout(function(){f.length&&(f.push("Доступные пары для торгов:\n"),f.reverse(),o(f.join("\n")))},g("2s"))})},Ja=function(){var b,c;a.masterWorker&&null!=ba&&ba.length&&(b=ba.join("-"),c={},ea.interval=setInterval(function(){m.getTicker(b,function(b,e){var f;return b?(f="Error notification price: "+b.error,console.log(f.red),c.error?void 0:(o(f),c.error=!0)):d.each(ba,function(b,d){var f,h,i,j,k,l,m,n,p,q,r;return a.tradeCurrency.pair===b?d(null):(f=Ra.pairs[b].decimal_places,h=e[b].sell,i=e[b].buy,j=e[b].last,k=la(e[b].avg,f),l=la(i-h,f),m=qa(h,a.notificationDeviation,f),l>m&&(n=b.split("_")[1],p=j<=h||j<=h+oa(3,f)?"down ↓":"up ↑",q=j>k?"↑":"↓",r=["Уведомление "+b.replace("_","/").toUpperCase()+":","directions: "+p,"sell: "+ia(n)+h,"buy: "+ia(n)+i,"last: "+ia(n)+j,"avg: "+ia(n)+k+" | "+q,"spread: "+l],c[b]||(c[b]=!0,o(r.join("\n")),setTimeout(function(){c[b]=!1,c.error=!1},g("15m")))),d(null))})})},g("2s")))},Ka=function(a,b){var c,d,e,f;null==a&&(a=.993),null==b&&(b=!1),c={},d={},e={},f={},Sa.forEach(function(a){var b;b=a.split(/\s*_\s*/),c[b[0]]?c[b[0]].push(b[1]):c[b[0]]=[b[1]]}),m.getTicker(Sa.join("-"),function(g,h){var i,j,k;if(g)return o("Error: "+g.error);if(Sa.forEach(function(a){d[a]=ta(1,h[a].buy)}),Sa.forEach(function(a){var b;b=a.split(/\s*_\s*/),c[b[0]].forEach(function(c){c!==b[1]&&(e[b[1]+"_"+b[0]+"_"+c]=ua(d[a],h[b[0]+"_"+c].sell))})}),Object.keys(e).forEach(function(b){var c,d;c=b.split(/\s*_\s*/),cb(c[0]+"_"+c[2],Sa)&&(d=ta(e[b],h[c[0]+"_"+c[2]].buy)),cb(c[2]+"_"+c[0],Sa)&&(d=ua(e[b],h[c[2]+"_"+c[0]].buy)),d>a&&(f[b+"_"+c[0]]=la(d,5))}),i=["Проверка возможных вариантов перепродаж.","Показаны значения больше: "+a,"Значения меньше 1 убыточны:\n"],j=[],Object.keys(f).forEach(function(a){j.push([a.replace(/\_/g,"->"),f[a]])}),j.length?(k=j.sort(function(a,b){return b[1]-a[1]}),k.forEach(function(a){i.push(a.join(": "))})):i.push("Нет подходящих вариантов"),!b||j.length)return o(i.join("\n"))})},Pa=function(b){var c;null!=b&&(c=b),c||(c=E>$?"extra":"normal"),E=0,"extra"===c?(La=G.extra,Ma=G.extra,Oa=I,Na=60*a.timeCloseOrdersExtra):(La=G.buy,Ma=G.sell,Oa=H,Na=60*a.timeCloseOrdersDefault),V=c},Qa=0,Ta=function(a,b){return m.getInfo(function(c,d){if(c)return b(c);try{Ra=d,Sa=Object.keys(d.pairs),W=d.pairs[a].decimal_places,Z=d.pairs[a].min_amount,X=d.pairs[a].min_price,Y=d.pairs[a].fee}catch(a){a,b("Not valid pair")}return za(a,function(c){var d,e;return c?(d=null!=(e=c.error)?e.split("send:")[1]:void 0,null!=d?(m.setNonce(d),Ta(a,b)):(Qa++,Qa>5?(Qa=0,b(c)):Ta(a,b))):b(null)})})},Ua=function(a,b){return m.getTicker(a,function(c,d){var e,f,g,h;return c?b(c):(e=d[a].last,f=d[a].sell,g=d[a].buy,h=la(g-f,W),L=Oa<=oa(2)?h>=Oa:h>Oa,b(null,{lastPrice:e,bidPrice:f,askPrice:g,spread:h}))})},Va=function(b,c){return L?m.balanceRequest(b,function(b,d,e){return b?c(b):(d=ya(d,"name"),e=ya(e,"nameTwo"),"all"===S?d<Z&&e<Z?M<a.ecoCountCycle&&M++:M>0&&(M=0):M=a.ecoCountCycle,c(null,{balance:d,balanceTwo:e}))}):c(null)},Wa=function(b,c,e,f,g){var h;return c<Z?g(null):aa?g(null):(K={buy:0,sell:0},"all"===S||S===b?c>=J?(void 0!==h&&null!==h||(h=e),d.doWhilst(function(a){return T?("sell"===b&&(h-=Ma),"buy"===b&&(h+=La),c=la(c/2),Xa(b,h,c,f,a)):("buy"===b?(h-=La,c=la(K.buy/h)||c):(h+=Ma,c=K.sell||c),c>J?Xa(b,h,J,f,a):Xa(b,h,la(c/2),f,a))},function(){return c>la(J/2)},function(a){return g(null!=a?a:null)})):(a.bbands&&("sell"===b&&(e+=oa(1)),"buy"===b&&(e-=oa(1))),Xa(b,e,c,f,g)):g(null))},Xa=function(b,c,d,e,f){return d<Z?f(null):(c=la(c,W),c>=X||(c=X),d=la(d,8),m.tradeSetOrder(e,b,c,d,function(e,g){var h;return e?(console.log(("["+t()+"]: Error: "+b+" | rate: "+c+" | amount: "+d).red),f(e)):(h="["+t()+"]: Open: "+b+" | rate: "+c+" | amount: "+d,"buy"===b?K.buy=ya(g.funds[a.tradeCurrency.nameTwo],"nameTwo"):K.sell=ya(g.funds[a.tradeCurrency.name],"name"),console.log("buy"===b?h.green:h.yellow),E++,f(null))}))},Ya=function(a,b){return m.ordersRequest(a,function(a,c){var e,f;return z=u(),a?0===a.success&&null==(null!=(e=a.error)?e.split("send:")[1]:void 0)?(console.log(("["+t()+"] Cancel orders: "+a.error).yellow),b(null)):b(a):(f=Object.keys(c),d.eachSeries(f,function(a,b){return null!=F.buy&&"sell"===c[a].type?b(null):null!=F.sell&&"buy"===c[a].type?b(null):z-c[a].timestamp_created>(F.buy||F.sell||F.all||60)?Za(a,c[a].type,c[a].amount,c[a].rate,b):b(null)},function(a){return F={all:null,buy:null,sell:null},b(null!=a?a:null)}))})},Za=function(a,b,c,d,e){return m.tradeCancelOrder({order_id:a},function(a,f){return a?e(a):(console.log(("["+t()+"]: Close: "+b+" | rate: "+d+" | amount: "+c).cyan),E>0&&E--,e(null))})},$a=function(){_||ja(z,a.timeCloseOrdersInactivity)&&Ya(a.tradeCurrency.pair,function(a){})},_a=function(){var a;ja(y,10)&&(a="Unknown error: Worker Stop!",console.log(("["+t()+"]: "+a).red),bb({error:a}))},ab=function(){y=u(),D?setTimeout(function(){ab()},g("30s")):d.series([function(b){return Ua(a.tradeCurrency.pair,b)},function(b){return Va(a.tradeCurrency,b)}],function(b,c){var e;b?(e="object"==typeof b?b.error:b,console.log(("Error: "+e).red),bb(b)):(C&&(xa(c[0].askPrice,c[0].bidPrice,c[0].lastPrice),C=!1),L?d.series([function(a){return B>0&&y-A>60*B&&xa(c[0].askPrice,c[0].bidPrice,c[0].lastPrice),a(null)},function(b){return y-z>Na?Ya(a.tradeCurrency.pair,b):b(null)},function(b){var d,e;return a.botTrade&&v?(d=la(c[1].balanceTwo/c[0].askPrice),e=T?U.bid:c[0].bidPrice,Wa("buy",d,e,a.tradeCurrency.pair,b)):b(null)},function(b){var d;return a.botTrade&&v?(d=T?U.ask:c[0].askPrice,Wa("sell",c[1].balance,d,a.tradeCurrency.pair,b)):b(null)}],function(b){b?(console.log(("ErrorTrader: "+b).red),bb(b)):M===a.ecoCountCycle?(clearTimeout(da.eco),da.eco=setTimeout(function(){ab()},g("2s"))):ab()}):(clearTimeout(da.spread),da.spread=setTimeout(function(){ab()},g(a.restartServerTime+"s"))))})},bb=function(b){var c,d,e;c="restart using "+a.restartServerTime+" sec ...",console.log("["+t()+"]: "+c),d=null!=(e=b.error)?e.split("send:")[1]:void 0,null==d&&w!==b.error&&(w=b.error,a.emailS&&"production"===process.env.NODE_ENV&&q(s(b.error+"\n\n"+c),function(a,b){})),setTimeout(function(){console.log(("["+t()+"]: trader restart").bgGreen),null!=d&&m.setNonce(d),ab()},g(a.restartServerTime+"s"))},function(){a.myChatId&&(console.log("["+t()+"]: Trader Bot starting..."),Ta(a.tradeCurrency.pair,function(b){var c;return b&&(c="object"==typeof b&&b.error?b.error:b,console.log(("["+t()+"]: Error getting parameters from the server!\n"+c).red),process.exit(0)),ab(),a.botTrade&&setInterval(function(){$a(),_a()},g("5m")),setInterval(function(){va()},g(10*a.bbandsInterval+"s")),"production"===process.env.NODE_ENV&&o("Trader Bot started. Pair "+r()),console.log("["+t()+"]: Trader Bot started")}))}()}).call(this);