(function(){function e(e,r){for(var t=-1,n=r.length>>>0;++t<n;)if(e===r[t])return!0;return!1}var r,t,n,a,o,l,i,u,s,c,d,f,p,b,_,m,y,O,T,E,g,C,S,x,v,R,k,P,h,N,I,w,D,L,U,B,F,A,j,M,q,z,G,H,J,Y,V,K,W,X,Z,Q,$,ee,re,te,ne,ae,oe,le,ie,ue,se,ce,de,fe,pe,be,_e,me,ye,Oe,Te,Ee,ge,Ce,Se,xe,ve,Re,ke,Pe,he,Ne,Ie,we,De,Le,Ue,Be,Fe,Ae,je,Me,qe,ze,Ge,He,Je,Ye,Ve,Ke,We,Xe,Ze,Qe,$e,er,rr,tr,nr,ar,or,lr,ir,ur,sr,cr,dr,fr,pr,br,_r,mr,yr,Or,Tr,Er,gr,Cr;r=require("fs"),t=require("path"),n=require("./conf"),a=require("./utils"),o=require("./log"),l=require("async"),i=require("lodash"),require("colors"),u=require("ms"),s=require("moment"),c=require("moment-range"),d=require("nodemailer"),f=require("node-telegram-bot-api"),p=require("ta-lib"),b=new o,_=t.join(__dirname,"/api"),m=r.readdirSync(_),e(n.exchange+".js",m)?(y=require(t.format({dir:_,name:n.exchange})),O=new y,s=c.extendMoment(s),n.tokenTelegram||n.telegramOff?(T=n.tokenTelegram&&!n.telegramOff?new f(n.tokenTelegram,{polling:!0}):new(function(){function e(){}return e.prototype,e.prototype.on=function(){},e.prototype.sendMessage=function(){},e}()),E=function(e,r){null==r&&(r={}),e.length>4096&&(e="*Слишком много информации для отображения*"),e.length||(e="*Error: Не удалось обработать ошибку*"),!1!==r.format&&(r.parse_mode="markdown"),delete r.format,T.sendMessage(n.myChatId,e,r)},g=d.createTransport(n.email),C=function(e,r){return g.sendMail(e,r)},S=function(){return n.tradeCurrency.pair.replace("_","/").toUpperCase()},x=function(e){return{from:n.email.auth.user,to:n.email.reportEmail,subject:"Error Script Trader",text:"time: "+(new Date).toString()+"\nPair: "+S()+"\n\nmessage: "+e+"\n\n---"}},v=function(e){return"object"==typeof e?e.hasOwnProperty("error")?e.error:e.hasOwnProperty("message")?e.message:a.objToString(e):e},R=!0,k={count:0,text:""},P=!1,h={},N={name:0,nameTwo:0},I=a.currentTime(),w=a.currentTime(),D=a.currentTime(),L=n.timeUpdateAutoSettings,U=!0,B=!1,F={all:null,buy:null,sell:null},A={extra:0,buy:0,sell:0,first:0},j={buy:0,sell:0},M={id:0,priceBuy:0,amount:0},q=n.oneOrdersSellPercent,z=0,G=0,H=0,J={buy:0,sell:0},Y=0,V={buy:0,sell:0},K={},W={},X={},Z=!1,Q={buy:0,sell:0},$=0,ee=0,re=!1,te=0,ne=0,ae=0,oe=0,le=[],ie=[],ue="all",se=!1,ce={ask:0,bid:0},de="normal",fe=0,pe=0,be=0,_e=0,me=!1,ye=!1,Oe=!1,Te=null!=(Ee=n.notificationPair)?Ee.toLowerCase().replace(/\//g,"_").split(/\s*,\s*/):void 0,ge={status:!1,interval:!1},Ce={status:!1,interval:!1},Se={ordersAll:0,ordersExecuted:0,error:0},xe="-----------------------------------",ve=function(e){return n.symbol.hasOwnProperty(e)?n.symbol[e.toLowerCase()]:e.toUpperCase()+" "},Re=function(e,r){return null==r&&(r=fe),a.rounded(e/+("1e"+r),r)},ke=function(e,r){return null==r&&(r=fe),a.rounded(e*+("1e"+r),r)},Pe=function(e,r,t){var n;return null==r&&(r=0),null==t&&(t=fe),n=e/100*be*2,a.rounded(a.amountPlusPercent(a.rounding(n,t),r),t)},he=function(e,r){return a.rounded(a.amountPlusPercent(e,r),fe)},Ne=function(e,r){return a.rounded(a.amountMinusPercent(e,r),fe)},Ie=function(e,r){return a.amountMinusPercent(e/r,be)},we=function(e,r){return a.amountMinusPercent(e*r,be)},De=function(e,r,t){var a,o;return"inverse"===n.directionCurrency?(a=r*t+e,o=e/t+r):(a=r/t+e,o=e*t+r),{deposit:a,depositTwo:o}},Le=function(){n.bbands&&oe>0&&(ie.push(oe),ie.length>30&&ie.splice(0,1))},Ue=function(e,r){var t,n;return t=e/100*r,n=1/+("1e"+fe),r>0&&(t>=n||(t=n)),a.rounded(t,fe)},Be=function(e,r){var t,n,o;null==r&&(r=1),t=e.toString().split(".")[0];try{n=e.toString().split(".")[1].length}catch(e){n=1}return o=t>0?t>1e4?+("1e"+(n+1)):t>1e3?+("1e"+n):t>100?+("1e"+(n-1)):t>10?+("1e"+(n-2)):n>3?+("1e"+(n-3)):1:1,r*=o,a.rounded(r/+("1e"+n),n)},Fe=function(e,r,t,o){var l,u,s,c,d,f,_,m,y,O,T,g,C,x,v,k,P,h,N,I,j,q,H,Y,V,K,W,Z,Q,re,te,Oe,Te,Ee,ge,Ce,Se;return D=a.currentTime(),F={buy:null,sell:null},l=e.toString().length,u=r.toString().length,c={},c[l+""]=e,c[u+""]=r,s=c,d=Math.max(l,u),f=s[d],fe=or.pairs[n.tradeCurrency.pair].decimal_places,_e=or.pairs[n.tradeCurrency.pair].min_amount,pe=or.pairs[n.tradeCurrency.pair].min_price,be=or.pairs[n.tradeCurrency.pair].fee,_=a.rounded(e-r,fe),m=Pe(f,200),n.dynamicSettingsTime&&(le.push(t),le.length>50&&le.splice(0,1),y=i.max(le),O=i.min(le),n.botLog&&b.info([xe,"price-array:","length: "+le.length,"max: "+y,"min: "+O,"change-time-settings: "+(a.percentageBetweenNumbers(y,O)>102)].join("\n")),a.percentageBetweenNumbers(y,O)>102?L=.1:L!==n.timeUpdateAutoSettings&&(L=n.timeUpdateAutoSettings)),n.abruptChangeTrend&&(T=Pe(f,500)),n.dangerPriceStop&&(g=he(ae,9),C=Ne(ne,9)),n.dynamicOffsetOrders&&(v=_>=(x={current:Pe(f,450),prev:Pe(f,380),prev_2:Pe(f,300)}).current||_>=x.prev||_>=x.prev_2),n.dynamicOffsetOrders&&v?(b.info("Dynamic market"),k=Be(f,ke(x.current)),P=1.5*n.stepBreakevenPercent):(k=Be(f,n.offsetOrdersPoints),P=n.stepBreakevenPercent),k=function(){switch(!1){case!n.offsetOrdersPercent:return Ue(f,n.offsetOrdersPercent);case!n.rangeOffset:return Ue(f,a.rounded(n.rangeOffset/n.countOrders,2));default:return k}}(),h=1.3*k,N=Ue(f,n.offsetFirstOrdersPercent),I=n.offsetOrdersPercent?Ue(f):2,z=function(){switch(!1){case!n.bbands:case!n.oneOrdersSell:return 0;default:return Pe(f,P)}}(),n.botLog&&(b.info(xe),b.info("current-spread:",(a.noExp(_)+"")[_>z?"green":"white"]),b.info("spread-min-default:",a.noExp(z)),b.info("trend-spread:",a.noExp(m)),n.abruptChangeTrend&&b.info("immediate-spread:",T),b.info("trader-speed:",de),b.info("price-prev:",ae+" - "+ne),b.info("price-prev2:",ce.ask+" - "+ce.bid),n.dangerPriceStop&&(b.info("danger-price-ask:",g,!U&&e>=g?"Attention!".red:""),b.info("danger-price-bid:",C,!U&&r<=C?"Attention!".red:"")),n.dynamicOffsetOrders&&(b.info("spread_1_450:",x.current,_>=x.current?"Attention!".red:""),b.info("spread_2_380:",x.prev,_>=x.prev?"Attention!".red:""),b.info("spread_3_300:",x.prev_2,_>=x.prev_2?"Attention!".red:""),b.info("dynamic-market:",v))),n.dangerPriceStop&&!U&&(e>=g||r<=C)?(e>=g&&(F.buy=1),w=0,B=!0,j="DANGER PRICE: "+e+" - "+r+" | Bot Pause!",b.warn(j),void E("`"+j+"`")):(q=I,H=$>Math.round(ee/2)?h:k,n.botLog&&(b.info("offset-max-one:",(a.noExp(k)+"")[k===H?"green":"yellow"]),b.info("offset-type-max:",a.noExp(H)),n.offsetFirstOrdersPercent&&b.info("offset-first-orders:",a.noExp(N)),b.info(xe)),me||(ue="all",se=!1),U?(n.bbands&&(R=!1),Y=V=H):n.oneOrdersSell?(Y=V=H,n.timeCloseOrders=1e5,n.timeCloseOrdersInactivity=n.timeCloseOrders,(K=a.searchFirstRate(X,r))&&r>he(K.rate,n.oneOrdersSellOffset)&&!M.id&&(F.buy=1,w=0,J={buy:0,sell:0})):n.bbands?(Y=V=H,L=.1,W=14,ie.length>2*W&&(Z=(c=p.BBANDS(ie,20,n.bbandsDeviation)).middleband,Q=c.lowband,re=c.highband,te=p.RSI(i.clone(ie).reverse(),W),Oe=p.average(te).mean,Te=p.average(Z).mean,Ee=p.average(re).mean,ge=p.average(Q).mean,Ce=Ee>t&&t>Te,Se=Te>t&&t>ge,Ce&&(me||(ue="sell"),R=99>Oe&&Oe>70),Se&&(me||(ue="buy"),R=1<Oe&&Oe<30),ye=Ce&&Se,n.botLog&&b.info(["BBANDS:","highband: "+Ee,"middleband: "+Te,"lowband: "+ge,"rsa: "+Oe,"sell: "+Ce,"buy: "+Se,"bot trade: "+R,"orders-calculation-brake: "+ye,xe].join("\n")))):n.trendDefinition&&r>ne&&e>ae&&_>m&&"normal"===de?(b.info("Trend: UP"),Y=q,V=H,me||(ue="buy",F.sell=1,w=0,n.abruptChangeTrend&&_>T&&(b.info("Spread Immediate"),se=!0,D=0))):n.trendDefinition&&r<ne&&e<ae&&_>m&&"normal"===de?(b.info("Trend: DOWN"),Y=H,V=q,me||(ue="sell",F.buy=1,w=0,n.abruptChangeTrend&&_>T&&(b.info("Spread Immediate"),se=!0,D=0))):Y=V=H,ce={ask:ae,bid:ne},ne=r,ae=e,oe=t,G=Pe(f),A={buy:Y,sell:V,extra:Be(f),first:N},nr(null,function(){return b.info("Update: "+ue.toUpperCase()+" | "+e+" - "+r+" | "+t+" | "+S()),o(null)}))},Ae=function(e,r){var t,n;return t="name"===r?N.name:N.nameTwo,n=e-t,n>0?n:0},je=function(e,r){return l.parallel([function(r){return n.botLog&&b.info(xe+"\nПолучение цен"),O.getTicker(e,function(t,a){return null!=t?(n.botLog&&(b.error("Price: "+a[e].buy),b.error(v(t))),r(t)):r(null,{price:a[e].buy})})},function(r){return l.series([function(r){return n.botLog&&b.info(xe+"\nЗакрытие всех позиций"),F.all=1,yr(e,function(e){return r(null!=e?e:null)})},function(e){return n.botLog&&b.info(xe+"\nПолучение баланса"),i.delay(O.balanceRequest,u("500"),n.tradeCurrency,function(r,t,a){return null!=r?(n.botLog&&(b.error("balance: "+t+" | balance-two: "+a),b.error(v(r))),e(r)):n.botTrade&&t<n.minAvailableBalance&&a<n.minAvailableBalance?(n.botLog&&b.error("balance: "+t+" | balance-two: "+a),e({error:"Err: No money!"})):e(null,{balance:t,balanceTwo:a})})}],function(e,t){return null!=e?r(e):r(null,{balance:t[1].balance,balanceTwo:t[1].balanceTwo})})}],function(e,t){var o,l,u,s,c,d,f,p,_,m,y,O,T,E,g,C,S,x;return null!=e?r(e):(h=i.clone(t[1]),n.botLog&&b.info(xe+"\nРасчет депозита"),n.oneOrdersSell&&("inverse"===n.directionCurrency?(o=t[1].balanceTwo,t[1].balanceTwo=0):(o=t[1].balance,t[1].balance=0)),l=De(t[1].balance,t[1].balanceTwo,t[0].price),u=l.deposit,s=l.depositTwo,d=n.depositLimit.currency?s>(c="inverse"===n.directionCurrency?n.depositLimit.currency/t[0].price:n.depositLimit.currency)?a.rounded(100/(s/c),2):100:n.depositLimit.percent,f=0<d&&d<100?d:100,p=u*f/100,_=s*f/100,100===f?(n.botLog&&b.info("type:",0),m=0,y=0):t[1].balance>=p&&t[1].balanceTwo>=_?(n.botLog&&b.info("type:",1),m=t[1].balance-p/2,y=t[1].balanceTwo-_/2):t[1].balance>=p&&t[1].balanceTwo<_?(n.botLog&&b.info("type:",2),m="inverse"===n.directionCurrency?t[1].balance-(_-t[1].balanceTwo)*t[0].price:t[1].balance-(_-t[1].balanceTwo)/t[0].price,y=0):t[1].balance<p&&t[1].balanceTwo>=_?(n.botLog&&b.info("type:",3),m=0,y="inverse"===n.directionCurrency?t[1].balanceTwo-(p-t[1].balance)/t[0].price:t[1].balanceTwo-(p-t[1].balance)*t[0].price):t[1].balance<p&&t[1].balanceTwo<_&&(n.botLog&&b.info("type:",4),"inverse"===n.directionCurrency?(m=t[1].balance-(_-t[1].balanceTwo)*t[0].price,y=t[1].balanceTwo-(p-t[1].balance)/t[0].price):(m=t[1].balance-(_-t[1].balanceTwo)/t[0].price,y=t[1].balanceTwo-(p-t[1].balance)*t[0].price)),n.botLog&&(O=a.percentageBetweenNumbers(m,t[1].balance),T=a.percentageBetweenNumbers(y,t[1].balanceTwo),b.info(["reserved-deposit:",n.tradeCurrency.name.toUpperCase(),O+"% / "+T+"%",n.tradeCurrency.nameTwo.toUpperCase()].join(" "))),n.oneOrdersSell&&("inverse"===n.directionCurrency?y=o:m=o),N={name:m>0?m:0,nameTwo:y>0?y:0},E="inverse"===n.directionCurrency?_:p,n.countOrders?n.countOrders>=3||(n.countOrders=3):n.countOrders=function(){switch(!1){case!(E<=10):return 6;case!(E<=200):return 15;case!(E<=500):return 18;case!(E<=1e3):return 21;default:return 25}}(),g="inverse"===n.directionCurrency?n.minSizeOrder/t[0].price:_e+.001,ee=n.countOrders*n.multiplierOrdersExtra,n.sizeOrdersMartingale?1===n.martingaleType?(C=1+n.sizeOrdersMartingale/100,S=E/((Math.pow(C,n.countOrders)-1)/(C-1))):(Y=n.sizeOrdersMartingale,S=E/n.countOrders-(n.countOrders-1)*Y/2):S=E/n.countOrders,H=a.rounded(S>g?S:g,fe),n.botLog&&(x=n.depositLimit.currency?n.depositLimit.currency+" "+("inverse"===n.directionCurrency?n.tradeCurrency.name.toUpperCase():n.tradeCurrency.nameTwo.toUpperCase()):n.depositLimit.percent+" %",b.info([xe+"\nРасчет переменных","Strategy: "+function(){switch(!1){case!n.oneOrdersSell:return"One Sell a lot Buy";case!n.bbands:return"BBANDS";default:return"Scalper"}}(),"balance: "+a.rounded(t[1].balance)+" "+n.tradeCurrency.name.toUpperCase(),"balance-two: "+a.rounded(t[1].balanceTwo)+" "+ve(n.tradeCurrency.nameTwo),"deposit: "+u+" "+n.tradeCurrency.name.toUpperCase()+" или "+s+" "+n.tradeCurrency.nameTwo.toUpperCase(),"deposit-limit: "+x,"trade-deposit: "+p+" "+n.tradeCurrency.name.toUpperCase()+" | "+_+" "+n.tradeCurrency.nameTwo.toUpperCase(),"reserved-deposit: "+a.rounded(N.name)+" "+n.tradeCurrency.name.toUpperCase()+" | "+a.rounded(N.nameTwo)+" "+n.tradeCurrency.nameTwo.toUpperCase(),"count-orders: "+n.countOrders,"quantity-orders-in-blocks: "+(n.quantityOrdersInBlocks?n.quantityOrdersInBlocks:"OFF"),"size-static-order: "+H,"size-orders-martingale: "+(n.sizeOrdersMartingale?n.sizeOrdersMartingale:"OFF")+"    Тип: "+(1===n.martingaleType?"Exponential":"Linear"),xe].join("\n"))),p<n.minAvailableBalance&&_<n.minAvailableBalance&&(b.warn(xe),b.warn("Недостаточно доступных средств для торговли!"),b.warn(xe)),r(null))})},T.on("message",function(e){var r,t,o,u,s,c,d,f,p,_,m,y,g,C,x;if(r=e.chat.id,n.myChatId||T.sendMessage(r,"Install your Telegram id: `"+r+"`",{parse_mode:"markdown"}),r===n.myChatId){if("Ордера"===e.text&&(t=function(){l.series([function(e){return O.balanceRequest(n.tradeCurrency,function(r,t,n){return null!=r?e(r):e(null,{balance:t,balanceTwo:n})})},function(e){return O.ordersRequest(n.tradeCurrency.pair,function(r,t){return null!=r?e(r):e(null,{data:t})})}],function(e,r){var o,l,u,s,c,d,f,p,b,_,m,y;o=[S()+":",xe],l="Balance: "+(null!=(u=r[0])?u.balance.toFixed(3):void 0)+" "+n.tradeCurrency.name.toUpperCase()+" | "+ve(n.tradeCurrency.nameTwo)+(null!=(s=r[0])?s.balanceTwo.toFixed(3):void 0),null!=e?0===e.success?null!=(c=null!=(d=e.error)?d.split("send:")[1]:void 0)?(O.setNonce(c),t()):(f=v(e),o.push(f+"\n"+xe+"\n"+l),E(o.join("\n"))):E("`"+v(e)+"`"):(p={},b=0,_=0,m={},Object.keys(r[1].data).forEach(function(e){var t,o,l,i;t=r[1].data[e].rate*+("1e"+fe),o="sell"===r[1].data[e].type?"`sell`":"buy",null!=m[t]?(l=" | "+ ++p[t],i=a.rounded(a.rounded(m[t].split("|")[1].trim())+a.rounded(r[1].data[e].amount)),m[t]=o+" | "+i+" | "+ve(n.tradeCurrency.nameTwo)+r[1].data[e].rate+l):(p[t]=1,m[t]=o+" | "+a.rounded(r[1].data[e].amount)+" | "+ve(n.tradeCurrency.nameTwo)+r[1].data[e].rate),b+=r[1].data[e].amount,_+=r[1].data[e].amount*r[1].data[e].rate}),(o=i.concat(o,i.values(m))).push(xe+"\nCount: "+a.rounded(b)+" | Sum: "+ve(n.tradeCurrency.nameTwo)+a.rounded(_)+"\n"+l),y=o.join("\n"),E(y))})})(),"История"===e.text&&(o=function(){O.tradeGetHistory(n.tradeCurrency.pair,15,function(e,r){var t,a,l;return null!=e?0===e.success?(t=null!=(a=e.error)?a.split("send:")[1]:void 0,null!=t?(O.setNonce(t),o()):E("`"+v(e)+"`")):E("`"+v(e)+"`"):(l=[],Object.keys(r).forEach(function(e){var t;t="sell"===r[e].type?"`sell`":"buy",l.push(t+" | "+r[e].amount.toFixed(3)+" | "+ve(n.tradeCurrency.nameTwo)+r[e].rate)}),l.push(S()+":\n"+xe),l.reverse(),E(l.join("\n")))})})(),"Закрыть активные ордера"===e.text&&(u={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Закрыть ордера!",callback_data:"close_orders_now"}]]})},E("*Вы уверены что хотите закрыть ордера?*",u)),"/start"!==(s=null!=(c=e.text)?c.toLowerCase():void 0)&&"главное меню"!==s||(u={reply_markup:JSON.stringify({keyboard:[[{text:"Ордера"},{text:"Котировки"},{text:"История"}],[{text:"Контроль"},{text:"Нотис"},{text:"Торговля"}],[{text:"Закрыть активные ордера"}]],resize_keyboard:!0})},E("Выберите:",u)),"Котировки"===e.text){if("btc-e"!==n.exchange)return void E("*Этот пункт не доступен для данной биржи*");u={reply_markup:JSON.stringify({keyboard:[[{text:"USD"},{text:"BTC"},{text:"OTHER"}],[{text:"Главное меню"}]],resize_keyboard:!0})},E("Валюта:",u)}if("Торговля"===e.text&&(u={reply_markup:JSON.stringify({keyboard:[[{text:"Сменить пару"},{text:"Тип"}],[{text:"Изменить отступ"},{text:"Авто выход из пары"}],[{text:"Главное меню"}]],resize_keyboard:!0})},E("Выберите:",u)),"USD"===e.text&&(u={reply_markup:JSON.stringify({inline_keyboard:[[{text:"NMC",callback_data:"nmc_usd"},{text:"PPC",callback_data:"ppc_usd"},{text:"NVC",callback_data:"nvc_usd"},{text:"LTC",callback_data:"ltc_usd"},{text:"BTC",callback_data:"btc_usd"}],[{text:"DSH",callback_data:"dsh_usd"},{text:"ETH",callback_data:"eth_usd"},{text:"EUR",callback_data:"eur_usd"},{text:"RUR",callback_data:"usd_rur"}]]})},E("Символ:",u)),"BTC"===e.text&&(u={reply_markup:JSON.stringify({inline_keyboard:[[{text:"NMC",callback_data:"nmc_btc"},{text:"PPC",callback_data:"ppc_btc"},{text:"NVC",callback_data:"nvc_btc"},{text:"LTC",callback_data:"ltc_btc"}],[{text:"DSH",callback_data:"dsh_btc"},{text:"ETH",callback_data:"eth_btc"},{text:"RUR",callback_data:"btc_rur"},{text:"EUR",callback_data:"btc_eur"}]]})},E("Символ:",u)),"OTHER"===e.text&&(u={reply_markup:JSON.stringify({inline_keyboard:[[{text:"ETH/LTC",callback_data:"eth_ltc"},{text:"ETH/EUR",callback_data:"eth_eur"},{text:"ETH/RUR",callback_data:"eth_rur"}],[{text:"LTC/RUR",callback_data:"ltc_rur"},{text:"LTC/EUR",callback_data:"ltc_eur"},{text:"EUR/RUR",callback_data:"eur_rur"}]]})},E("Пара:",u)),"Контроль"===e.text&&(u={reply_markup:JSON.stringify({keyboard:[[{text:"Скорость"},{text:"Состояние"},{text:"Модули"}],[{text:"Главное меню"}]],resize_keyboard:!0})},E("Выберите:",u)),"Нотис"===e.text&&(u={reply_markup:JSON.stringify({keyboard:[[{text:"Мониторинг"},{text:"Уведомление"}],[{text:"Круг"}],[{text:"Главное меню"}]],resize_keyboard:!0})},E("Выберите:",u)),"Мониторинг"===e.text&&(u={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Старт",callback_data:"monitoring start"},{text:"Стоп",callback_data:"monitoring stop"}]]})},d=Ce.status?"Работает.":"Остановлен.",E((f=["Включает мониторинг возможных торговых пар. Уведомление раз в 5 минут.","Текущие состояние: "+d]).join("\n"),u)),"Уведомление"===e.text&&(u={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Старт",callback_data:"notification start"},{text:"Стоп",callback_data:"notification stop"}]]})},d=ge.status?"Работает.":"Остановлен.",E((f=["Включает уведомления о скачках курса.","Текущие состояние: "+d]).join("\n"),u)),"Круг"===e.text&&Qe(),"Тип"===e.text&&(u={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Only buy",callback_data:"type buy"},{text:"Only sell",callback_data:"type sell"},{text:"Buy & Sell",callback_data:"type all"}]]})},f=["Текущий тип торговли "+ue.toUpperCase(),"Новый тип:"],E(f.join("\n"),u)),"Сменить пару"===e.text){if("btc-e"!==n.exchange)return void E("*Этот пункт не доступен для данной биржи*");u={reply_markup:JSON.stringify({inline_keyboard:[[{text:"BTC/USD",callback_data:"trade btc_usd"},{text:"BTC/RUR",callback_data:"trade btc_rur"},{text:"BTC/EUR",callback_data:"trade btc_eur"}],[{text:"LTC/BTC",callback_data:"trade ltc_btc"},{text:"LTC/USD",callback_data:"trade ltc_usd"},{text:"LTC/RUR",callback_data:"trade ltc_rur"}],[{text:"LTC/EUR",callback_data:"trade ltc_eur"},{text:"NMC/BTC",callback_data:"trade nmc_btc"},{text:"NMC/USD",callback_data:"trade nmc_usd"}],[{text:"NVC/BTC",callback_data:"trade nvc_btc"},{text:"NVC/USD",callback_data:"trade nvc_usd"},{text:"PPC/BTC",callback_data:"trade ppc_btc"}],[{text:"PPC/USD",callback_data:"trade ppc_usd"},{text:"DSH/BTC",callback_data:"trade dsh_btc"},{text:"DSH/USD",callback_data:"trade dsh_usd"}],[{text:"ETH/BTC",callback_data:"trade eth_btc"},{text:"ETH/USD",callback_data:"trade eth_usd"},{text:"ETH/EUR",callback_data:"trade eth_eur"}],[{text:"ETH/LTC",callback_data:"trade eth_ltc"},{text:"ETH/RUR",callback_data:"trade eth_rur"},{text:"USD/RUR",callback_data:"trade usd_rur"}],[{text:"EUR/USD",callback_data:"trade eur_usd"},{text:"EUR/RUR",callback_data:"trade eur_rur"}]]})},f=["Текущая пара: *"+S()+"*","`Внимание! На новой паре должны быть средства для торгов, иначе переключение завершится ошибкой!`","Новая торгая пара:"],E(f.join("\n"),u)}return"Изменить отступ"===e.text&&(n.offsetOrdersExponential?(p="%",_="Изменяет отсуп ордеров по экспоненте в %",m="Остальные: *"+n.offsetOrdersExponential+"%*"):n.offsetOrdersPercent?(p="%",_="Изменяет отсуп ордеров в процентах",m="Остальные: *"+n.offsetOrdersPercent+"%*"):n.rangeOffset?(p="%",_="Изменяет размер сетки ордеров в процентах",m="Разер сетки: *"+n.rangeOffset+"%*"):(p="",_="Изменяет отсуп первого ордера в процентах, всех остальных в пунктах.",m="Остальные: *"+n.offsetOrdersPoints+"*"),u={reply_markup:JSON.stringify({inline_keyboard:[[{text:"+ 0.1% First",callback_data:"offset_orders first_plus"},{text:"- 0.1% First",callback_data:"offset_orders first_minus"}],[{text:"+ 0.1"+p,callback_data:"offset_orders plus"},{text:"- 0.1"+p,callback_data:"offset_orders minus"}]]})},f=[_,"Текущий отступ:","Первый: *"+n.offsetFirstOrdersPercent+"%*",m].join("\n"),E(f,u)),"Авто выход из пары"===e.text&&(n.oneOrdersSell?(q=0,Oe=!0,f="Авто выход включен!"):f="На текущей стратегии данная функция недоступна!",E(f)),"Скорость"===e.text&&(u={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Normal",callback_data:"speed normal"},{text:"Extra",callback_data:"speed extra"}]]})},f=["Влияет на плотность стека ордеров, размер спреда и время закрытия неиспользованных ордеров","Время действия "+a.declOfNum(L)+".","Текущая скорость: *"+de+"*"].join("\n"),E(f,u)),"Состояние"===e.text&&(u={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Пауза",callback_data:"worker pause"},{text:"Продолжить",callback_data:"worker continued"}]]})},E("Текущие состояние: "+(d=B?"Пауза":"Работает"),u)),"Модули"===e.text&&(u={reply_markup:JSON.stringify({inline_keyboard:[[{text:"Динам. время обновления "+(n.dynamicSettingsTime?"[Вкл]":"[Выкл]"),callback_data:"modules dynamic-settings-time"}],[{text:"Динам. распределение ордеров "+(n.dynamicOffsetOrders?"[Вкл]":"[Выкл]"),callback_data:"modules dynamic-offset-orders"}],[{text:"Определение тренда "+(n.trendDefinition?"[Вкл]":"[Выкл]"),callback_data:"modules trend-definition"}],[{text:"Контроль смены тренда "+(n.abruptChangeTrend?"[Вкл]":"[Выкл]"),callback_data:"modules abrupt-change-trend"}],[{text:"Стоп при большом изменении цены "+(n.dangerPriceStop?"[Вкл]":"[Выкл]"),callback_data:"modules danger-price-stop"}],[{text:"Включить все",callback_data:"modules all-modules-on"},{text:"Выключить все",callback_data:"modules all-modules-off"}],[{text:"Полосы Боллинджера "+(n.bbands?"[Вкл]":"[Выкл]"),callback_data:"modules bbands"}],[{text:"One Sell a lot Buy "+(n.oneOrdersSell?"[Вкл]":"[Выкл]"),callback_data:"modules one-orders-sell"}],[{text:"Лог "+(n.botLog?"[Вкл]":"[Выкл]"),callback_data:"modules bot-log"},{text:"Дебаг лог "+(n.logDebug?"[Вкл]":"[Выкл]"),callback_data:"modules log-debug"}]]})},E("*Модули обновления настроек:*",u)),"/info"===(null!=(s=e.text)?s.toLowerCase():void 0)&&E((f=["Список команд:\n","/version - версия бота","/help - параметры которые можно менять через Telegram","/config - возможные параметры конфигурации через конфигурационный файл","/martin - теоретический расчет ордеров Мартингейла (параметры берутся из конфига)"]).join("\n")),"/version"===(null!=(y=e.text)?y.toLowerCase():void 0)&&E("Версия бота: `"+n.versionBot+"`"),"/config"===(null!=(g=e.text)?g.toLowerCase():void 0)&&(f=["Бот на паре: "+S(),"EXCHANGE: "+n.exchange+" | Выбор биржи btc-e или poloniex","POLONIEX_FEE: "+n.poloniexFee+" | Комиссия на сделки биржи POLONIEX","TIME_UPDATE_AUTO_SETTINGS: "+L+" | время обновления авто настроек параметров (в мин)","DEPOSIT_LIMIT_PERCENT: "+n.depositLimit.percent+" | процент использования депозита","DEPOSIT_LIMIT_CURRENCY: "+n.depositLimit.currency+" | использования депозита в валюте","NOTIFICATION_PAIR: "+n.notificationPair+" | пары для уведомления (или all/all для всех)","NOTIFICATION_DEVIATION_PERCENT: "+n.notificationDeviation+" | насколько процентов должен увеличиться спред чтобы сработало уведомление","COUNT_ORDERS: "+n.countOrders+" | количество ордеров","QUANTITY_ORDERS_IN_BLOCKS: "+n.quantityOrdersInBlocks+" | количество ордеров в блоке","TIME_CLOSE_ORDERS: "+n.timeCloseOrders+" | сколько минут ждать перед закрытием неисполнившихся ордеров","TIME_CLOSE_ORDERS_INACTIVITY: "+n.timeCloseOrdersInactivity+" | закрытие после бездействия","OFFSET_ORDERS_POINTS: "+n.offsetOrdersPoints+" | отступ ордеров в пунктах","OFFSET_ORDERS_PERCENT: "+n.offsetOrdersPercent+" | отступ для ордеров в %","OFFSET_ORDERS_EXPONENTIAL: "+n.offsetOrdersExponential+" | отступ для ордеров по экспоненте в %","OFFSET_FIRST_ORDERS_PERCENT: "+n.offsetFirstOrdersPercent+" | отступ первого ордера в %","RANGE_OFFSET: "+n.rangeOffset+" | диапазон смещения ордеров в %","SIZE_ORDERS_MARTINGALE: "+Y+" | размер ордера в % Мартингейла","MARTINGALE_TYPE: "+n.martingaleType+" | тип Мартингейла","STEP_BREAKEVEN_PERCENT: "+n.stepBreakevenPercent+" | процент отступа безубытка для торгов","DANGER_PRICE_STOP: "+n.dangerPriceStop+" | остановка бота при большом изменении цены","DYNAMIC_SETTINGS_TIME: "+n.dynamicSettingsTime+" | динамическое время обновления настроек","DYNAMIC_OFFSET_ORDERS: "+n.dynamicOffsetOrders+" | динамическое распределение ордеров","TREND_DEFINITION: "+n.trendDefinition+" | определение тренда","ABRUPT_CHANGE_TREND: "+n.abruptChangeTrend+" | быстрое изменение направления тренда","BBANDS: "+n.bbands+" | Стратегия Полосы Боллинджера","BBANDS_DEVIATION: "+n.bbandsDeviation+" | Отклонение","BBANDS_INTERVAL: "+n.bbandsInterval+" | Таймфрейм (в мин)","ONE_ORDERS_SELL: "+n.oneOrdersSell+" | Стратегия One Sell a lot Buy","ONE_ORDERS_SELL_PERCENT: "+q+" | Задает процент желаемой прибыли","ONE_ORDERS_SELL_OFFSET: "+n.oneOrdersSellOffset+" | Разница между ценой LastPrice и первым ордером buy в стеке ордеров в %","INTEGRITY_CONTROL_ORDERS: "+n.integrityControlOrders+" | Контроль целостности ордеров (soft - мягкий, hard - жесткий)"],E(f.join("\n\n"),{format:!1})),"/help"===(null!=(C=e.text)?C.toLowerCase():void 0)&&(f=["Бот на паре: "+S()+" | Exchange: "+n.exchange.toUpperCase(),"TIME_UPDATE_AUTO_SETTINGS="+L+" | время обновления авто настроек параметров (в мин)","OFFSET_ORDERS_POINTS="+n.offsetOrdersPoints+" | отступ для ордеров в пунктах","OFFSET_ORDERS_PERCENT="+n.offsetOrdersPercent+" | отступ для ордеров в процентах","RANGE_OFFSET= "+n.rangeOffset+" | диапазон смещения ордеров в %","OFFSET_FIRST_ORDERS_PERCENT="+n.offsetFirstOrdersPercent+" | отступ первого ордера в процентах","STEP_BREAKEVEN_PERCENT="+n.stepBreakevenPercent+" | процент отступа безубытка для торгов","TIME_CLOSE_ORDERS="+n.timeCloseOrders+" | сколько минут ждать перед закрытием неисполнившихся ордеров","COUNT_ORDERS="+n.countOrders+" | количество ордеров (бот будет переазгружен)","QUANTITY_ORDERS_IN_BLOCKS="+n.quantityOrdersInBlocks+" | количество ордеров в блоке","SIZE_ORDERS_MARTINGALE="+Y+" | размер ордера мартингейла (проценты или абсолютное число)","DEPOSIT_LIMIT_PERCENT="+n.depositLimit.percent+" | процент использования депозита (бот будет перезагружен)","DEPOSIT_LIMIT_CURRENCY="+n.depositLimit.currency+" | использования депозита в валюте (бот будет перезагружен)","ONE_ORDERS_SELL_PERCENT="+q+" | Задает процент желаемой прибыли","ONE_ORDERS_SELL_OFFSET="+n.oneOrdersSellOffset+" | Разница между ценой LastPrice и первым ордером buy в стеке ордеров в процентах","RESTART_TRADER_TIME="+n.restartTraderTime+" | Через сколько секунд рестартовать воркер после ошибки","INTEGRITY_CONTROL_ORDERS="+n.integrityControlOrders+" | Контроль целостности ордеров (soft - мягкий, hard - жесткий)"],E(f.join("\n\n"),{format:!1})),/(\D+)=(\w+)/.test(e.text)&&function(){var r,t,a;if(r=e.text.split("="),r[0]=r[0].toUpperCase(),"TIME_UPDATE_AUTO_SETTINGS"===(t=r[0])||"OFFSET_ORDERS_POINTS"===t||"OFFSET_ORDERS_PERCENT"===t||"RANGE_OFFSET"===t||"OFFSET_FIRST_ORDERS_PERCENT"===t||"TIME_CLOSE_ORDERS"===t||"STEP_BREAKEVEN_PERCENT"===t||"DEPOSIT_LIMIT_PERCENT"===t||"DEPOSIT_LIMIT_CURRENCY"===t||"COUNT_ORDERS"===t||"QUANTITY_ORDERS_IN_BLOCKS"===t||"ONE_ORDERS_SELL_PERCENT"===t||"ONE_ORDERS_SELL_OFFSET"===t||"SIZE_ORDERS_MARTINGALE"===t||"RESTART_TRADER_TIME"===t||"INTEGRITY_CONTROL_ORDERS"===t){switch(a=i.camelCase(r[0]),r[0]){case"ONE_ORDERS_SELL_PERCENT":q=+r[1];break;case"SIZE_ORDERS_MARTINGALE":Y=+r[1];break;case"DEPOSIT_LIMIT_PERCENT":n.depositLimit.percent=+r[1];break;case"DEPOSIT_LIMIT_CURRENCY":n.depositLimit.currency=+r[1];break;case"INTEGRITY_CONTROL_ORDERS":n.integrityControlOrders=r[1];break;default:n[a]=+r[1]}b.warn("SET "+r[0]+"="+r[1]),E("Настройки обновлены!"),"DEPOSIT_LIMIT_PERCENT"!==(t=r[0])&&"DEPOSIT_LIMIT_CURRENCY"!==t&&"COUNT_ORDERS"!==t||(B=!0,je(n.tradeCurrency.pair,function(e){var r;null!=e?(r=v(e),b.error(r),E("`"+r+"`")):(B=!1,E("*Бот перезапущен!*"))}))}}(),"/martin"===(null!=(x=e.text)?x.toLowerCase():void 0)?function(){var e,r,t,o,i,u,s;return e="inverse"===n.directionCurrency?Ae(h.balance,"name"):Ae(h.balanceTwo,"nameTwo"),r=ne,t=!0,o=0,i=0,u=0,s=0,l.doWhilst(function(l){var c;return n.offsetFirstOrdersPercent&&t?(r-=A.first,t=!1):n.offsetOrdersExponential?(u+=n.offsetOrdersExponential,r=a.amountMinusPercent(r,u)):r-=$e,o=e/r,n.sizeOrdersMartingale&&(i=i?1===n.martingaleType?a.amountPlusPercent(i,n.sizeOrdersMartingale):i+Y:H),c=o>i?i:o,e=(o-c)*r,s++,l(null)},function(){return o>H},function(){var t,n;return t=a.rounded(a.percentageBetweenNumbers(ne,r)-100,2),n=["*Данные расчета Мартингейла*:"],1===s&&e<=0?n.push("`Недостаточно средств!`"):(n.push(["Количество ордеров: "+s,"Последняя цена: "+a.rounded(r,fe),"*Разница между LastPrice и последним ордером: "+t+"%*"].join("\n")),0<t&&t<=2&&n.push("`При таких настройках депозита хватит на "+t+"% хода цены вниз!!! Не мало ли?`")),E(n.join("\n\n"))})}():void 0}}),T.on("callback_query",function(e){if(e.from.id===n.myChatId)switch(!1){case!/trade (\w*_(usd|rur|eur|btc|ltc))/.test(e.data):qe(e.data.substr(6));break;case!/speed (normal|extra)/.test(e.data):Ge(e.data.substr(6));break;case!/worker (continued|pause)/.test(e.data):He(e.data.substr(7));break;case!/monitoring (start|stop)/.test(e.data):Ke(e.data.substr(11));break;case!/notification (start|stop)/.test(e.data):We(e.data.substr(13));break;case!/type (buy|sell|all)/.test(e.data):ze(e.data.substr(5));break;case!/modules (\w*)/.test(e.data):Ye(e.data.substr(8));break;case!/offset_orders (plus|minus)/.test(e.data):case!/offset_orders (first_plus|first_minus)/.test(e.data):Je(e.data.substr(14));break;case!/close_orders_now/.test(e.data):Me();break;default:Ve(e.data)}}),Me=function(){E("Начато закрытие ордеров."),B=!0,F.all=1,setTimeout(function(){yr(n.tradeCurrency.pair,function(e){var r,t;null!=e?0===e.success&&(null!=(r=null!=(t=e.error)?t.split("send:")[1]:void 0)?(O.setNonce(r),Me()):E("`"+v(e)+"`")):(E("Активные ордера закрыты на паре: "+S()),dr(function(e){if(null!=e)return E("`"+v(e)+"`")})),B=!1})},u("2s"))},qe=function(e){var r,t;E("Инициализировано изменение пары..."),B=!0,r=e.split("_")[0],t=e.split("_")[1],n.tradeCurrency.name===r&&n.tradeCurrency.nameTwo!==t?F.sell=1:n.tradeCurrency.name!==r&&n.tradeCurrency.nameTwo===t&&(F.buy=1),setTimeout(function(){yr(n.tradeCurrency.pair,function(){n.tradeCurrency={name:r,nameTwo:t,pair:[r,t].join("_")},U=!0,ir(n.tradeCurrency.pair,function(e){var r,t;null!=e?(r=v(e),b.error(("Ошибка получения данных с сервера!\n"+r).red),t=["`Critical error: Ошибка получения данных с сервера!`","Бот поставлен на паузу, после обновления баланса необходимо перезапустить пару!","Ошибка: "+r].join("\n"),E(t),B=!0):($=0,B=!1,E("Выполнено! Новая пара: "+S()))})})},u("5s"))},ze=function(e){me="all"!==e,E("Выполнено! Новый тип "+(ue=e).toUpperCase())},Ge=function(e){nr(e,function(){var r;return r=["Режим "+e.toUpperCase()+" включен.","Пара: "+S()],D=a.currentTime(),b.info(r[0]),E(r.join(" "))})},He=function(e){E("Новое состояние: `"+((B="pause"===e)?"Пауза":"Работает")+"`. Пара: "+S())},Je=function(e){var r,t,o;r="plus"===e||"first_plus"===e?.1:-.1,"plus"!==e&&"minus"!==e||(n.offsetOrdersExponential?(n.offsetOrdersExponential=a.rounded(n.offsetOrdersExponential+r,1),n.offsetOrdersExponential>=.1||(n.offsetOrdersExponential=.1),t="Остальные: *"+n.offsetOrdersExponential+"%*"):n.offsetOrdersPercent?(n.offsetOrdersPercent=a.rounded(n.offsetOrdersPercent+r,1),n.offsetOrdersPercent>=.1||(n.offsetOrdersPercent=.1),t="Остальные: *"+n.offsetOrdersPercent+"%*"):n.rangeOffset?(n.rangeOffset=a.rounded(n.rangeOffset+r,1),n.rangeOffset>=.1||(n.rangeOffset=.1),t="Размер сетки: *"+n.rangeOffset+"%*"):(n.offsetOrdersPoints=a.rounded(n.offsetOrdersPoints+r,1),n.offsetOrdersPoints>=.1||(n.offsetOrdersPoints=.1),t="Остальные: *"+n.offsetOrdersPoints+"*")),"first_plus"!==e&&"first_minus"!==e||(n.offsetFirstOrdersPercent=a.rounded(n.offsetFirstOrdersPercent+r,1),n.offsetFirstOrdersPercent>=0||(n.offsetFirstOrdersPercent=0)),o=["Новый отступ на паре "+S()+":","Первый: *"+n.offsetFirstOrdersPercent+"%*",t||void 0].join("\n"),E(o+"")},Ye=function(e){var r,t;/\all-modules/.test(e)?(r="all-modules-on"===e,n.dynamicSettingsTime=r,n.dynamicOffsetOrders=r,n.trendDefinition=r,n.abruptChangeTrend=r,n.dangerPriceStop=r,n.dynamicSettingsTime||(L=n.timeUpdateAutoSettings),E("Все модули "+(r?"включены":"выключены")+"!")):("one-orders-sell"===e&&(n.bbands=!1),"bbands"===e&&(n.oneOrdersSell=!1),t=e.replace(/\-./g,function(e,r,t){return e.replace("-","").toUpperCase()}),n[t]=!n[t],E(e.replace(/\-/g,"_").toUpperCase()+": "+n[t],{format:!1}))},Ve=function(e){O.getTicker(e,function(r,t){var o,l,i,u,s,c,d,f,p,b,_;return null!=r?E("`"+v(r)+"`"):(o=or.pairs[e].decimal_places,l=t[e].last,i=t[e].sell,u=t[e].buy,s=t[e].avg?t[e].avg:(i+u)/2,s=a.rounded(s,o),c=a.rounded(u-i,o),d=e.split("_")[1],f=Pe(u,n.stepBreakevenPercent,o),p=c>f?"✔":"`✗`",b=l>s?"↑":"`↓`",_=[e.replace("_","/").toUpperCase()+":","sell: "+ve(d)+i,"buy: "+ve(d)+u,"last: "+ve(d)+l,"avg: "+ve(d)+s+" | "+b,"spread:   "+c+" | "+(c/f*100-100).toFixed()+"%","required: "+f+" "+p],E(_.join("\n")))})},Ke=function(e){var r;Ce.status="start"===e,clearInterval(Ce.interval),Ce.status?(r="Работает",Xe(),Ce.interval=setInterval(function(){Xe()},u("5m"))):r="Остановлен",E("Новое состояние: "+r)},We=function(e){var r;null!=Te&&Te.length?(ge.status="start"===e,clearInterval(ge.interval),ge.status?(r="Работает",Ze()):r="Остановлен",E("Новое состояние: "+r)):E("`Внимание! Конфиг для уведомлений не задан!`")},Xe=function(){var e;e=lr.join("-"),l.parallel([function(r){return O.getTicker(e,function(e,t){return null!=e?r(e):r(null,t)})},function(r){return O.getTrades(e,{limit:2},function(e,t){return null!=e?r(e):r(null,t)})}],function(e,r){var t,o,l,i,c,d;if(null!=e)return t=v(e),o="Error trading pairs available: "+t,E(o),void b.error(o.red);l=["Доступные пары для торгов:\n"],i=(new Date).getTime(),c=s.range(i-u("1m"),i),d=0,lr.forEach(function(e){var t,o,i,u,s,f,p,b,_,m,y,O,T;t=e.split("_")[1],o=e.split("_")[0],i=or.pairs[e].decimal_places,u=r[0][e].last,s=r[0][e].sell,f=r[0][e].buy,p=r[0][e].vol,b=r[0][e].vol_cur,_=r[0][e].avg?r[0][e].avg:(s+f)/2,_=a.rounded(_,i),m=a.rounded(f-s,i),y=Pe(f,n.stepBreakevenPercent,i),O=u>_?"↑":"`↓`",T=!r[1][e][0].timestamp||c.contains(1e3*r[1][e][0].timestamp)&&c.contains(1e3*r[1][e][1].timestamp),m>y&&T&&(d++,l.push(e.replace("_","/").toUpperCase()+"\nprice: "+f+" - "+s+"\navg:   "+_+" | "+O+"\nvol:  "+b+" "+ve(o)+"\nvol:  "+p+" "+ve(t)+"\nspread:   "+a.noExp(m)+" | "+(m/y*100-100).toFixed()+"%\nrequired: "+a.noExp(y)+"\n")),d>=20&&(E(l.join("\n")),d=0,l=[])}),setTimeout(function(){l.length&&E(l.join("\n"))},u("2s"))})},Ze=function(){var r,t;null!=Te&&Te.length&&("all_all"===Te[0]&&(Te=lr),r=Te.join("-"),t={},ge.interval=setInterval(function(){O.getTicker(r,function(r,o){var l,i,s;return null==r?(s=0,i=[],Te.forEach(function(r){var l,c,d,f,p,b,_,m,y,O,T,g;n.tradeCurrency.pair!==r&&e(r,lr)&&(t[r]||(l=or.pairs[r].decimal_places,c=o[r].sell,d=o[r].buy,f=o[r].last,p=o[r].vol,b=o[r].vol_cur,_=o[r].avg?o[r].avg:(c+d)/2,_=a.rounded(_,l),(m=a.rounded(d-c,l))>Pe(c,n.notificationDeviation,l)&&(s++,t[r]=!0,y=r.split("_")[1],O=r.split("_")[0],T=f<=c||f<=c+Re(3,l)?"down ↓":"up ↑",g=f>_?"↑":"`↓`",i.push(["Уведомление "+r.replace("_","/").toUpperCase()+":","directions: "+T,"sell: "+ve(y)+c,"buy: "+ve(y)+d,"last: "+ve(y)+f,"avg: "+ve(y)+_+" | "+g,"vol: "+b+" "+ve(O),"vol: "+p+" "+ve(y),"spread: "+a.noExp(m)+"\n"].join("\n"))),s>=15&&(E(i.join("\n")),s=0,i=[]),setTimeout(function(){t[r]=!1,t.error=!1},u("15m"))))}),setTimeout(function(){i.length&&E(i.join("\n"))},u("2s"))):(l=v(r),i="Error notification price: "+l,b.error(i.red),t.error?void 0:(E(i),t.error=!0))})},u("5s")))},Qe=function(r,t){var n,o,l,i;null==r&&(r=.993),null==t&&(t=!1),n={},o={},l={},i={},lr.forEach(function(e){var r;r=e.split(/\s*_\s*/),n[r[0]]?n[r[0]].push(r[1]):n[r[0]]=[r[1]]}),O.getTicker(lr.join("-"),function(u,s){var c,d,f;return null!=u?(c=v(u),E("`Error: "+c+"`")):(lr.forEach(function(e){o[e]=Ie(1,s[e].buy)}),lr.forEach(function(e){var r;r=e.split(/\s*_\s*/),n[r[0]].forEach(function(t){t!==r[1]&&(l[r[1]+"_"+r[0]+"_"+t]=we(o[e],s[r[0]+"_"+t].sell))})}),Object.keys(l).forEach(function(t){var n,o;e((n=t.split(/\s*_\s*/))[0]+"_"+n[2],lr)&&(o=Ie(l[t],s[n[0]+"_"+n[2]].buy)),e(n[2]+"_"+n[0],lr)&&(o=we(l[t],s[n[2]+"_"+n[0]].buy)),o>r&&(i[t+"_"+n[0]]=a.rounded(o,5))}),d=["Проверка возможных вариантов перепродаж.","Показаны значения больше: "+r,"Значения меньше 1 убыточны:\n"],f=[],Object.keys(i).forEach(function(e){f.push([e.replace(/\_/g,"->"),i[e]])}),f.length?f.sort(function(e,r){return r[1]-e[1]}).forEach(function(e){d.push(e.join(": "))}):d.push("Нет подходящих вариантов"),!t||f.length?E(d.join("\n")):void 0)})},nr=function(e,r){var t;return null!=e&&(t=e),null==r&&(r=function(){}),t||(t=$>ee?"extra":"normal"),$=0,"extra"===t?($e=A.extra,er=A.extra,tr=G,rr=60*n.timeCloseOrdersExtra):($e=A.buy,er=A.sell,tr=z,rr=60*n.timeCloseOrders),de=t,r()},ar=0,ir=function(e,r){return O.getInfo(function(t,n){if(null!=t)return r(t);try{or=n,lr=Object.keys(n.pairs),fe=n.pairs[e].decimal_places,_e=n.pairs[e].min_amount,pe=n.pairs[e].min_price,be=n.pairs[e].fee}catch(e){r("Not valid pair")}return i.delay(je,u("3s"),e,function(t){var n,a;return t?(n=null!=(a=t.error)?a.split("send:")[1]:void 0,null!=n?(O.setNonce(n),ir(e,r)):(ar++,ar>=5?(ar=0,r(t)):ir(e,r))):r(null)})})},ur=function(e,r){return O.ordersRequest(e,function(e,t){return null!=e&&"no orders"!==e.error?r(e):r(null,t)})},sr=function(e,r){return O.getTicker(e,function(t,n){var o,l,i,u;return null!=t?r(t):(o=n[e].last,l=n[e].sell,i=n[e].buy,u=a.rounded(i-l,fe),re=tr<=Re(2)?u>=tr:u>tr,r(null,{lastPrice:o,bidPrice:l,askPrice:i,spread:u}))})},cr=function(e,r){return re?O.balanceRequest(e,function(e,t,a){return null!=e?r(e):(t=Ae(t,"name"),a=Ae(a,"nameTwo"),"all"===ue?t<_e&&a<_e?te<n.ecoCountCycle&&te++:te>0&&(te=0):te=n.ecoCountCycle,r(null,{balance:t,balanceTwo:a}))}):r(null)},dr=function(e){return oe?i.delay(O.balanceRequest,u("3s"),n.tradeCurrency,function(r,t,o){var l,i,u,s,c,d,f;return null!=r?e(r):(l=De(Ae(h.balance,"name"),Ae(h.balanceTwo,"nameTwo"),oe),i=De(Ae(t,"name"),Ae(o,"nameTwo"),oe),u=a.rounded(i.deposit-l.deposit,5),s=a.rounded(i.depositTwo-l.depositTwo,5),c=u>=0?u:"`"+u+"`",d=s>=0?s:"`"+s+"`",f=["*Анализ торговли за сессию:*",c+" "+ve(n.tradeCurrency.name),d+" "+ve(n.tradeCurrency.nameTwo),"Установлено ордеров: "+Se.ordersAll,"Исполнено ордеров: "+Se.ordersExecuted,"Перезапусков: "+Se.error],E(f.join("\n")),e(null))}):e(null)},fr=function(e,r){return ur(e,function(e,t){var n;return null!=e?r(e):(X=null!=t?t:{},n=a.quantityOrdersType(X),Q={buy:n.buy,sell:n.sell},r(null))})},pr=function(e,r){var t,o;return(t=i.findKey(X,["type","sell"]))&&a.rounded(M.amount-1e-7,8)>X[t].amount&&(b.info("SELL partially executed"),n.logDebug&&(o=[xe,"Старый sell: "+a.rounded(M.amount-1e-7,8)+"  Новый sell: "+X[t].amount,"Продано: "+a.rounded(a.rounded(M.amount-1e-7,8)-X[t].amount,8)+" "]),W=X,M.amount=X[t].amount,W["0000000001"]={rate:M.priceBuy,amount:M.amount},delete W[t],J={buy:0,sell:0},j={buy:0,sell:0},n.logDebug&&b.info(o.join("\n"))),Z=!1,!t&&M.id&&(b.info("SELL executed!"),F.buy=1,Z=!0,M={},W={},w=0,J={buy:0,sell:0},V={buy:0,sell:0},j={buy:0,sell:0},Oe&&(B=!0,Oe=!1,q=n.oneOrdersSellPercent,yr(e,function(e){var r;null!=e&&b.error(v(e)),r="Авто выход завершен!  Бот поставлен на паузу!",b.warn(r),E("*"+r+"*")}))),r(null)},br=function(e,r,t,o,u){var s;return s="inverse"===n.directionCurrency?r<_e||r*t<n.minSizeOrder:r<_e,s?u(null):0===i.size(W)?u(null):l.series([function(e){return F.sell=1,yr(o,e)},function(e){var t,o,l,u,s,c,d,f,p,_,m;return t=[],o=i.keys(X),l=i.keys(W),u=i.difference(l,o),n.logDebug&&t.push([xe,"Открытые ордера: "+o,"В кэше: "+l,"Купленные: "+u].join("\n")),s=0,c=0,d=0,u.forEach(function(e){d++,s+=+W[e].amount,c+=+W[e].amount*+W[e].rate,n.logDebug&&t.push("Ордер "+d+": "+e+"  Количество: "+ +W[e].amount+"  Цена: "+ +W[e].rate)}),d>0?(M.priceBuy=c/s,n.logDebug&&t.push(["Сумма: "+c+"  Общий объем: "+s+"  Объем с комиссией: "+a.rounded(a.amountMinusPercent(s,be),8),"Средняя цена покупки: "+M.priceBuy].join("\n")),f=a.amountPlusPercent(c,2.5*be+q)/s,n.logDebug&&t.push(["Коммисия: "+be+"  Процент юзера: "+q+"   Общий процент: "+(2*be+q),"Увеличенная сумма на процент: "+a.amountPlusPercent(c,2*be+q),"Цена продажи: "+f].join("\n")),p=i.findKey(X,["type","sell"]),n.logDebug&&t.push(["Сумма с баланса биржи: "+r,p?"Сумма на открытом ордере SELL: "+X[p].amount:void 0].join("\n")),_=r,"hard"===n.integrityControlOrders&&(m=a.amountMinusPercent(s,be),_=r>=m?r:m,t.push("Разница между кэшем и балансом биржи: "+a.rounded(m-r))),p&&(_=r+X[p].amount),n.logDebug&&(t.push("Общая сумма продажи: "+_),b.info(t.join("\n"))),M.amount=_,e(null,{rate:f,amount:_})):e(null,{rate:0,amount:0})}],function(r,t){return null!=r?u(r):t[1].rate>0?mr(e,t[1].rate,t[1].amount,o,function(e){return u(null!=e?e:null)}):u(null)})},_r=function(e,r,t,o,u){var s,c,d;if("inverse"===n.directionCurrency?r<_e||r*t<n.minSizeOrder:r<_e)return u(null);if(ye)return u(null);if(n.quantityOrdersInBlocks){if(n.quantityOrdersInBlocks<=Q[e])return u(null);s=!0}return c=!0,K={buy:-1,sell:-1},"all"===ue||ue===e?(void 0!==d&&null!==d||(d=t),l.doWhilst(function(l){var u,f,p;return se?("sell"===e&&(d-=er),"buy"===e&&(d+=$e),r/=2,mr(e,d,r,o,l)):(n.logDebug&&(u=[xe]),"buy"===e?(n.oneOrdersSell&&(P||s)&&(P=!1,s=!1,i.isEmpty(X)||(c=!1,"object"==typeof(f=a.searchRate(X,"min"))&&f.rate<t&&(d=f.rate),n.logDebug&&u.push("Последняя цена в стеке: "+d))),n.offsetFirstOrdersPercent&&c?(d-=A.first,n.logDebug&&u.push("Цена рынка: "+t+"   Цена First ордера: "+d),c=!1):n.offsetOrdersExponential?(n.logDebug&&u.push(["Отступ Exponential: Прошлый: "+j[e],"Новый: "+a.rounded(j[e]+n.offsetOrdersExponential,8)].join("  ")),j[e]=j[e]+n.offsetOrdersExponential,d=a.amountMinusPercent(d,j[e])):d-=$e,r=-1===K.buy?r:K.buy/d,n.logDebug&&(-1===K.buy?u.push("Общий объем: "+r):u.push(["Остаточный баланс: "+K.buy,"Цена: "+a.rounded(d,8),"Общий объем: "+a.rounded(K.buy/d,8)].join("   ")))):(n.offsetFirstOrdersPercent&&c?(d+=A.first,n.logDebug&&u.push("Цена First ордера: "+a.rounded(d,8)),c=!1):n.offsetOrdersExponential?(n.logDebug&&u.push(["Отступ Exponential: Прошлый: "+j[e],"Новый: "+a.rounded(j[e]+n.offsetOrdersExponential,8)].join("  ")),j[e]=j[e]+n.offsetOrdersExponential,d=a.amountPlusPercent(d,j[e])):d+=er,r=-1===K.sell?r:K.sell,n.logDebug&&(-1===K.sell?u.push("Общий объем: "+r):u.push(["Остаточный баланс: "+K.sell,"Цена: "+a.rounded(d,8),"Общий объем: "+K.sell].join("  ")))),n.sizeOrdersMartingale?(J[e]?(n.logDebug&&(1===n.martingaleType?u.push(["Размер ордера: "+a.rounded(J[e],8),"Размер мартина: "+n.sizeOrdersMartingale,"Новый размер ордера: "+a.rounded(a.amountPlusPercent(J[e],n.sizeOrdersMartingale),8)].join("  ")):u.push(["Размер ордера: "+a.rounded(J[e],8),"Размер мартина: "+Y,"Новый размер ордера: "+a.rounded(J[e]+Y,8)].join("  "))),J[e]=1===n.martingaleType?a.amountPlusPercent(J[e],n.sizeOrdersMartingale):J[e]+Y):J[e]=H,V[e]&&(n.logDebug&&u.push(["Кеш мартина: "+a.rounded(V[e],8),"Старый размер ордера: "+a.rounded(J[e],8)].join("  ")),J[e]=V[e],V[e]=0),p=r>J[e]?J[e]:r,n.logDebug&&u.push(["Баланс: "+a.rounded(r,8),"Размер ордера: "+a.rounded(J[e],8)].join("  "))):(p=r>H?H:r,n.logDebug&&u.push(["Баланс: "+a.rounded(r,8),"Размер ордера: "+a.rounded(H,8)].join("  "))),n.logDebug&&(u.push("Новый размер ордера: "+a.rounded(p,8)+"  "+(a.rounded(p,8)<.01?"| Ордер не установлен":"")),b.info(u.join("\n"))),mr(e,d,p,o,l))},function(){return!(n.quantityOrdersInBlocks&&n.quantityOrdersInBlocks<=Q[e])&&r>H},function(e){return u(null!=e?e:null)})):u(null)},mr=function(e,r,t,o,l){var u;return(r=a.rounded(r,fe))>=pe||(r=pe),t=a.rounded(t-1e-7,8),u="inverse"===n.directionCurrency?t<_e||t*r<n.minSizeOrder:t<_e,u?l(null):O.tradeSetOrder(o,e,r,t,function(a,o){var u,s,c;return null!=a?(n.sizeOrdersMartingale&&(V[e]=J[e]),P=!0,u=v(a),b.error(("Error: "+u+" | "+e+" | rate: "+r+" | amount: "+t).red),l(a)):(s=0!=o.order_id?o.order_id:i.random(1e3,2e3),n.oneOrdersSell&&("buy"===e&&(W[s]={rate:r,amount:t}),"sell"===e&&(M.id=s)),n.quantityOrdersInBlocks&&Q[e]++,c="Open: "+e+" | id: "+s+" | rate: "+r+" | amount: "+t,b.info("buy"===e?c.green:c.yellow),"buy"===e?K.buy="inverse"===n.directionCurrency?Ae(o.funds[n.tradeCurrency.name],"name"):Ae(o.funds[n.tradeCurrency.nameTwo],"nameTwo"):K.sell="inverse"===n.directionCurrency?Ae(o.funds[n.tradeCurrency.nameTwo],"nameTwo"):Ae(o.funds[n.tradeCurrency.name],"name"),$++,Se.ordersAll++,Se.ordersExecuted++,l(null))})},yr=function(e,r){return O.ordersRequest(e,function(e,t){var n,o,i;return w=a.currentTime(),null!=e?0===e.success&&null==(null!=(n=e.error)?n.split("send:")[1]:void 0)?(o=v(e),b.warn(("Cancel orders: "+o).yellow),r(null)):r(e):(i=Object.keys(t),l.eachSeries(i,function(e,r){if(null==F.all){if(null!=F.buy&&"sell"===t[e].type)return r(null);if(null!=F.sell&&"buy"===t[e].type)return r(null)}return w-t[e].timestamp_created>(F.buy||F.sell||F.all||60)?Or(e,t[e].type,t[e].amount,t[e].rate,r):r(null)},function(e){return F={all:null,buy:null,sell:null},r(null!=e?e:null)}))})},Or=function(e,r,t,a,o){return O.tradeCancelOrder({order_id:e},function(l,i){return null!=l?o(l):(n.oneOrdersSell&&(delete W[e],"sell"===r&&(M.id=0)),b.info(("Close: "+r+" | id: "+e+" | rate: "+a+" | amount: "+t).cyan),$>0&&$--,Se.ordersExecuted>0&&Se.ordersExecuted--,o(null))})},Tr=function(){me||a.timeIsOver(w,n.timeCloseOrdersInactivity)&&yr(n.tradeCurrency.pair,function(e){null!=e&&b.error("Orders inactivity: "+v(e))})},Er=function(){var e;a.timeIsOver(I,10)&&(e="Unknown error: Worker does not meet!",b.warn(e.red),Cr({error:e}))},gr=function(){I=a.currentTime(),B?setTimeout(function(){gr()},u("30s")):l.series([function(e){return sr(n.tradeCurrency.pair,e)},function(e){return cr(n.tradeCurrency,e)}],function(e,r){var t,a,o,s;t=r[0],a=r[1],null!=e?(o=v(e),null!=(null!=(s=e.error)?s.split("send:")[1]:void 0)?b.warn(o):b.error(("ErrorData: "+o).red),Cr(e)):(U&&Fe(t.askPrice,t.bidPrice,t.lastPrice,function(){return U=!1}),re?l.series([function(e){return L>0&&I-D>60*L?Fe(t.askPrice,t.bidPrice,t.lastPrice,e):e(null)},function(e){return I-w>rr?yr(n.tradeCurrency.pair,e):e(null)},function(e){return n.quantityOrdersInBlocks||n.oneOrdersSell?i.delay(fr,u("3s"),n.tradeCurrency.pair,e):e(null)},function(e){return n.botTrade&&R&&n.oneOrdersSell?pr(n.tradeCurrency.pair,e):e(null)},function(e){var r,o;return n.oneOrdersSell&&Z?e(null):n.botTrade&&R?(r=se?ce.ask:t.askPrice,o="inverse"===n.directionCurrency?a.balanceTwo:a.balance,n.oneOrdersSell?br("sell",o,r,n.tradeCurrency.pair,e):(J.sell=0,j.sell=0,_r("sell",o,r,n.tradeCurrency.pair,e))):e(null)},function(e){var r,o;return n.oneOrdersSell&&Z?e(null):n.botTrade&&R?(r=se?ce.bid:t.bidPrice,o="inverse"===n.directionCurrency?a.balance/r:a.balanceTwo/r,n.oneOrdersSell?P||Q.buy||(J.buy=0,j.buy=0):(J.buy=0,j.buy=0),_r("buy",o,r,n.tradeCurrency.pair,e)):e(null)}],function(e){var r;null!=e?(r=v(e),b.error(("ErrorTrader: "+r).red),Cr(e)):te===n.ecoCountCycle?setTimeout(function(){gr()},u("2s")):gr()}):setTimeout(function(){gr()},u("5s")))})},Cr=function(e){var r,t,a,o,l;a="restart after "+(t=null!=(t=(r=v(e)).match(/timeout to (.*) seconds/))?parseInt(t[1])+10:n.restartTraderTime)+" sec ...",b.warn(a),null==(o=null!=(l=e.error)?l.split("send:")[1]:void 0)&&(k.count++,k.text!==r&&(k.text=r,n.isEmail&&"production"===process.env.NODE_ENV&&C(x(r+"\n\n"+a),function(e,r){})),n.notificationErrorCount&&k.count>n.notificationErrorCount&&(E("`Слишком много ошибок API. Требуется внимание пользователя!`"),k.count=0)),setTimeout(function(){b.warn("trader restart"),Se.error++,null!=o&&O.setNonce(o),gr()},u(t+"s"))},function(){n.myChatId||n.telegramOff?(b.info("Trader Bot starting..."),b.info("Exchange: "+n.exchange.toUpperCase()+" | v."+n.versionBot),ir(n.tradeCurrency.pair,function(e){var r;return null!=e&&(r=v(e),b.error(("Error getting parameters from the server!\n"+r).red),process.exit(0)),gr(),n.botTrade&&setInterval(function(){Tr(),Er(),k.count=0},u("5m")),setInterval(function(){Le()},u(10*n.bbandsInterval+"s")),"production"===process.env.NODE_ENV&&E("Trader Bot started. Pair "+S()),b.info("Trader Bot started")})):b.warn("Get the user id in the Telegram")}()):b.warn("There is no token Telegram!")):b.error("Не найдено Api биржи!")}).call(this);